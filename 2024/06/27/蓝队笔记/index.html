

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/bz.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="z2zQAQ">
  <meta name="keywords" content="">
  
    <meta name="description" content="面向hw，应急蓝队">
<meta property="og:type" content="article">
<meta property="og:title" content="蓝队笔记">
<meta property="og:url" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Welcome to my world">
<meta property="og:description" content="面向hw，应急蓝队">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/image-20240627161826663.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/TVzebfwneormWox5u6Rc5RM0ne6.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/image-20240627162018816.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/FcYTbAtNmorqJ7x0WQpctu9onac.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/SIj7bi47ior9pXxlTvccfOplnag.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/QU71bN1s7oqej9xtJCRcdKvknmc.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/image-20240627162645478.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/SWF3b6fXyoi5UzxjU3pcmeVTneg.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/GSxkb1iVNo7s3dxL6nkcKAaonYi.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/H3efbvKvloVa4XxGDHWcNcdAnyb.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/JDrebv3Vvo1Gz9xyp6jcOMnJnMf.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/KzL5bLE0qoJCDoxIYzwcyF5mnQb.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/CvxDbdbYoo7e7xxC8xXcx2RSnid.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/G27ob7ITvoTlMCx6wkfc0X0Unzc.png">
<meta property="article:published_time" content="2024-06-27T14:23:00.000Z">
<meta property="article:modified_time" content="2024-06-28T07:03:28.759Z">
<meta property="article:author" content="z2zQAQ">
<meta property="article:tag" content="蓝队">
<meta property="article:tag" content="应急响应">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/image-20240627161826663.png">
  
  
  
  <title>蓝队笔记 - Welcome to my world</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/cloudedGlass.css">
<link rel="stylesheet" href="/z2z_custom/custom.css">
<link rel="stylesheet" href="/css/mac.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":80,"cursorChar":"__","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body><!-- hexo injector body_begin start --><div id="web_bg"></div><!-- hexo injector body_begin end -->
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>z2zQAQ</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/moon.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="蓝队笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-06-27 22:23" pubdate>
          2024年6月27日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          29k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          242 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">蓝队笔记</h1>
            
            
              <div class="markdown-body">
                
                <p>通篇摘录，尚待学习&#x3D; &#x3D;</p>
<h1 id="应急响应"><a href="#应急响应" class="headerlink" title="应急响应"></a>应急响应</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://bypass007.github.io/Emergency-Response-Notes/Summary/">https://bypass007.github.io/Emergency-Response-Notes/Summary/</a></p>
</blockquote>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/image-20240627161826663.png" srcset="/img/loading.gif" lazyload alt="image-20240627161826663"></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/APfr2ctaq1GHNpJeSxQ3EQ">https://mp.weixin.qq.com/s/APfr2ctaq1GHNpJeSxQ3EQ</a></p>
</blockquote>
<p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/TVzebfwneormWox5u6Rc5RM0ne6.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h3 id="应急前沟通"><a href="#应急前沟通" class="headerlink" title="应急前沟通"></a>应急前沟通</h3><blockquote>
<p>现场现象是什么?如何发现的?(依据是什么) ?<br>什么时候发现的?<br>目前是否有做物理隔离(断网) ?<br>受害机器是哪个?<br>受害服务有几台?(1 台&#x2F;N 台)<br>最先发现是哪台 ?<br>这台服务器对外有哪些服务?<br>这台服务器于其他机器是否处于同一个内网?<br>操作系统类型?<br>是否有公网映射业务?<br>远程管理方式?<br>网络边界有没有流量监控设备?<br>主机侧是否有 EDR 等安全设备</p>
</blockquote>
<p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/image-20240627162018816.png" srcset="/img/loading.gif" lazyload alt="image-20240627162018816"></p>
<h3 id="问题处置"><a href="#问题处置" class="headerlink" title="问题处置"></a>问题处置</h3><blockquote>
<p>事件判断:判断是否是安全事件，何种安全事件，勒索、挖矿、断网、DDoS等等。以及安全事件的危害程度 </p>
<p>临时处置:给出客户临时处置建议，断网隔离，保护现场环境，切断供给链</p>
<p>深入分析:收集客户信息和中毒主机信息，包括<strong>样本，日志分析、进程分析、启动项分析、样本分析</strong>。 </p>
<p>清理处置:直接杀掉进程，删除文件，打补丁，抑或是修复文件。 产出报告:整理并输出完整的安全事件报告</p>
</blockquote>
<p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/FcYTbAtNmorqJ7x0WQpctu9onac.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h2 id="事件分析"><a href="#事件分析" class="headerlink" title="事件分析"></a>事件分析</h2><h3 id="Web-攻击"><a href="#Web-攻击" class="headerlink" title="Web 攻击"></a><strong>Web 攻击</strong></h3><p><strong>相关表现:</strong> 页面被篡改、恶意推广、黑词黑页、webshell<br><strong>相关危害:</strong> 导致搜索引擎告警、微信等 app 分享告警、首页敏感内容、拖库、内网沦陷等排查<br><strong>要点:</strong> 能否多个环境下复现异常现象;确定相关资产是否存在;恶意文件是否确实存在于服务器上<br><strong>操作要点:</strong> 备份文件;webshell 后门查杀;web 日志分析;web 中间件缓存处理;web 中间件配置检查;重启 web 中间件;服务器后门检查;<br><strong>防护措施:</strong> 加固相关 web 应用，修改相关系统的所有用户密码</p>
<h3 id="链路劫持"><a href="#链路劫持" class="headerlink" title="链路劫持"></a><strong>链路劫持</strong></h3><p><strong>相关表现:</strong> 区域性服务不可用或返回异常内容<br><strong>相关危害:</strong> 导致搜索引擎告警、微信等 app 分享告警、首页敏感内容等<br><strong>排查要点:</strong> 能否多个环境下复现异常现象;确定相关资产是否存在;恶意文件是否确实存在于服务器上<br><strong>操作要点:</strong> 跨地区、运营商进行测试，确定受影响范围:在能复现的环境中判断是 DNS 劫持还是 HTTP 劫持<br><strong>防护措施:</strong> 重要业务部署 https</p>
<h3 id="代理隧道"><a href="#代理隧道" class="headerlink" title="代理隧道"></a><strong>代理隧道</strong></h3><p><strong>相关表现:</strong> 持续性或间断性外连行为，通常为 tcp 协议，对内网多个主机有访问行为<br><strong>相关危害:</strong> 作为跳板机攻击其他内网资产<br><strong>排查要点:</strong> 确定存在代理隧道的跳板机，通常为某时间段内集中访问内网多种资源的机器，判断隧道类型<br><strong>防护措施:</strong> 完善内网 acl，服务器按业务需要通过白名单策略访问外网</p>
<h3 id="替换系统命令"><a href="#替换系统命令" class="headerlink" title="替换系统命令"></a><strong>替换系统命令</strong></h3><p><strong>相关表现:</strong> 无明显表现<br><strong>相关危害:</strong> 将后门、木马持久化在系统中:窃取账号、密码等重要凭证<br><strong>排查要点:</strong> 使用包管理自带的包校验功能验证文件完整性，分析恶意文件行为，确定影响面<br><strong>操作要点:</strong> 使用静态链接的 busybox;重新安装被替换的包<br><strong>命令:</strong></p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ada">rpm -Va<br>dpkg <span class="hljs-comment">--verify</span><br></code></pre></td></tr></table></figure>

<h3 id="ld-so-preload-动态链接库劫持"><a href="#ld-so-preload-动态链接库劫持" class="headerlink" title="ld.so.preload 动态链接库劫持"></a><strong>ld.so.preload 动态链接库劫持</strong></h3><p><strong>相关表现:</strong> 无明显表现<br><strong>相关危害:</strong> 将后门、木马持久化在系统中:窃取账号、密码等重要凭证<br><strong>排查要点:</strong> 检查&#x2F;etc&#x2F;ld.so.preload，ld.so(如&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.27.so)<br><strong>操作要点:</strong> 使用静态链接的 busybox; 重启被注入恶意模块的进程，必要时直接重启系统</p>
<h3 id="内核态-rootkit"><a href="#内核态-rootkit" class="headerlink" title="内核态 rootkit"></a><strong>内核态 rootkit</strong></h3><p><strong>相关表现:</strong> 无明显表现<br><strong>相关危害:</strong> 将后门、木马持久化在系统中:隐藏文件、进程等信息<br><strong>排查要点:</strong> 确定是否存在无法使用常规命令查看的文件、进程;<br><strong>操作要点:</strong> 使用 tyton 内核态 rootkit 检测工具检测:检查&#x2F;etc&#x2F;modules 是否有未知的内核模块</p>
<h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a><strong>计划任务</strong></h3><p><strong>相关表现:</strong> 特定时间间隔触发木马、后门、网络链接、DNS 请求、篡改页面等行为<br><strong>相关危害:</strong> 将后门、木马持久化在系统中:周期性篡改页面、拉取数据等<br><strong>排查要点:</strong> 判断是否存在周期性出现的异常现象，检查&#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs&#x2F;，&#x2F;etc&#x2F;cron.*等常用计划任务配置文件<br><strong>操作要点:</strong> 停止计划任务服务后再操作;注意辨别利用\r 回车符的障眼法小技巧</p>
<h3 id="远控木马"><a href="#远控木马" class="headerlink" title="远控木马"></a><strong>远控木马</strong></h3><p><strong>相关表现:</strong> 有持续或间断性的对外网络链接或 DNS 请求等通信行为<br><strong>相关危害:</strong> 窃取系统资料、作为跳板进一步攻击内网其他机器<br><strong>排查要点:</strong> 关注 tcp、udp、icmp 等一切网络行为，检查注册表、服务、开机目录、计划任务等一系列常见的持久化点<br><strong>操作要点:</strong> 检查网络连接，以及 IDS 设备上的异常远控告警</p>
<h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a><strong>Windows</strong></h2><h3 id="账号安全"><a href="#账号安全" class="headerlink" title="账号安全"></a>账号安全</h3><p>1.弱口令，远程端口</p>
<p>2.可疑账号 <code>lusrmgr.msc</code></p>
<p>3.隐藏账号，克隆账号</p>
<p>​	a.打开注册表</p>
<p>​	b.D 盾查杀</p>
<p>4.日志</p>
<p>​	a、Win+R 打开运行，输入“eventvwr.msc”，回车运行，打开“事件查看器”。</p>
<p>​	b、导出 Windows 日志–安全，利用 Log Parser 进行分析。</p>
<h3 id="异常端口，进程"><a href="#异常端口，进程" class="headerlink" title="异常端口，进程"></a>异常端口，进程</h3><p>1、检查端口连接情况，是否有远程连接、可疑连接。</p>
<ul>
<li>检查方法：</li>
<li>a、netstat -ano 查看目前的网络连接，定位可疑的 ESTABLISHED</li>
<li>b、根据 netstat 定位出的 pid，再通过 tasklist 命令进行进程定位 tasklist | findstr “PID”</li>
</ul>
<p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/SIj7bi47ior9pXxlTvccfOplnag.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p>2、进程</p>
<ul>
<li>检查方法：</li>
<li>a、开始–运行–输入 msinfo32，依次点击“软件环境 → 正在运行任务”就可以查看到进程的详细信息，比如进程路径、进程 ID、文件创建日期、启动时间等。</li>
<li>b、打开 D 盾_web 查杀工具，进程查看，关注没有签名信息的进程。</li>
<li>c、通过微软官方提供的 Process Explorer 等工具进行排查 。</li>
<li>d、查看可疑的进程及其子进程。可以通过观察以下内容：</li>
</ul>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">解释<br>      没有签名验证信息的进程<br>      没有描述信息的进程<br>      进程的属主<br>      进程的路径是否合法<br>      <span class="hljs-meta">CPU</span>或内存资源占用长时间过高的进程<br></code></pre></td></tr></table></figure>

<p>3、小技巧：</p>
<p>a、查看端口对应的 PID： netstat -ano | findstr “port”</p>
<p>b、查看进程对应的 PID：任务管理器–查看–选择列–PID 或者 tasklist | findstr “PID”</p>
<p>c、查看进程对应的程序位置：</p>
<p>任务管理器–选择对应进程–右键打开文件位置</p>
<p>运行输入 wmic，cmd 界面 输入 process</p>
<p>d、tasklist &#x2F;svc 进程–PID–服务</p>
<p>e、查看 Windows 服务所对应的端口：<code> %system%/system32/drivers/etc/services</code>（一般 %system% 就是 C:\Windows）</p>
<h3 id="启动项，计划任务，服务"><a href="#启动项，计划任务，服务" class="headerlink" title="启动项，计划任务，服务"></a>启动项，计划任务，服务</h3><p>1、检查服务器是否有异常的启动项。</p>
<ul>
<li>检查方法：</li>
<li>a、登录服务器，单击【开始】&gt;【所有程序】&gt;【启动】，默认情况下此目录在是一个空目录，确认是否有非业务程序在该目录下。</li>
<li>b、单击开始菜单 &gt;【运行】，输入 <strong>msconfig</strong>，查看是否存在命名异常的启动项目，是则取消勾选命名异常的启动项目，并到命令中显示的路径删除文件。</li>
<li>c、单击【开始】&gt;【运行】，输入 regedit，打开注册表，查看开机启动项是否正常，特别注意如下三个注册表项： <code>HKEY_CURRENT_USER\software\micorsoft\windows\currentversion\run HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Runonce</code> 检查右侧是否有启动异常的项目，如有请删除，并建议安装杀毒软件进行病毒查杀，清除残留病毒或木马。</li>
<li>d、利用安全软件查看启动项、开机时间管理等。</li>
<li>e、组策略，运行 gpedit.msc。</li>
</ul>
<p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/QU71bN1s7oqej9xtJCRcdKvknmc.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p>2、检查计划任务</p>
<ul>
<li>检查方法：</li>
<li>a、单击【开始】&gt;【设置】&gt;【控制面板】&gt;【任务计划】，查看计划任务属性，便可以发现木马文件的路径。</li>
<li>b、单击【开始】&gt;【运行】；输入 <strong>cmd</strong>，然后输入 <strong>at</strong>，检查计算机与网络上的其它计算机之间的会话或计划任务，如有，则确认是否为正常连接。</li>
</ul>
<p>3、服务自启动</p>
<ul>
<li>检查方法：单击【开始】&gt;【运行】，输入 <strong>services.msc</strong>，注意服务状态和启动类型，检查是否有异常服务。</li>
</ul>
<h3 id="系统信息"><a href="#系统信息" class="headerlink" title="系统信息"></a>系统信息</h3><p>1、查看系统版本以及补丁信息</p>
<ul>
<li>检查方法：单击【开始】&gt;【运行】，输入 <strong>systeminfo</strong>，查看系统信息</li>
</ul>
<p>2、查找可疑目录及文件</p>
<ul>
<li>检查方法：<ul>
<li>a、 查看用户目录，新建账号会在这个目录生成一个用户目录，查看是否有新建用户目录。</li>
<li><code> Window 2003 C:\Documents and Settings</code><br><code> Window 2008R2 C:\Users\</code></li>
</ul>
</li>
</ul>
<p>3、得到发现 WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？</p>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/image-20240627162645478.png" srcset="/img/loading.gif" lazyload alt="image-20240627162645478"></p>
<p><strong>系统日志</strong></p>
<ul>
<li>分析方法：</li>
<li>a、前提：开启审核策略，若日后系统出现故障、安全事故则可以查看系统的日志文件，排除故障，追查入侵者的信息等。</li>
<li>b、Win+R 打开运行，输入“eventvwr.msc”，回车运行，打开“事件查看器”。</li>
<li>C、导出应用程序日志、安全日志、系统日志，利用 Log Parser 进行分析。</li>
<li><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/SWF3b6fXyoi5UzxjU3pcmeVTneg.png" srcset="/img/loading.gif" lazyload alt="截图"></li>
</ul>
<p><strong>WEB 访问日志</strong></p>
<ul>
<li>分析方法：</li>
<li>a、找到中间件的 web 日志，打包到本地方便进行分析。</li>
<li>b、推荐工具：Window 下，推荐用 EmEditor 进行日志分析，支持大文本，搜索效率还不错。</li>
<li>Linux 下，使用 Shell 命令组合查询分析</li>
</ul>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a><strong>常用命令</strong></h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">获取本机用户列表: net user</span><br><span class="hljs-section">本机管理员: net localgroup administrators</span><br><span class="hljs-section">查看当前会话: net session</span><br><span class="hljs-section">查看当前运行的服务: net start</span><br><span class="hljs-section">远程连接: net use</span><br><span class="hljs-section">查看当前用户下的共享目录: net share</span><br><span class="hljs-section">最近打开的文件:</span><br>%UserProfile%\Recent<br>%APPDATA%\Microsoft\Windows\Recent<br><span class="hljs-section">查找文件中的字符串: findstr /m /i /s &quot;hello&quot; *.txt</span><br><span class="hljs-section">查看网络连接: netstat - ano</span><br><span class="hljs-section">操作系统的详细配置信息: systeminfo</span><br><span class="hljs-section">获取系统进程信息: Wmic process</span><br><span class="hljs-section">根据应用程序查找PID: wmic process where name=&quot;cmd.exe” get processid,executablepath,name</span><br><span class="hljs-section">根据PID查找应用程序: wmic process where processid=&quot;1” get executablepath,name</span><br><span class="hljs-section">获取系统进程信息:tasklist</span><br>对于要查询特定dll的调用情况，可以使用命令tasklist /m dll名称<br><span class="hljs-section">计算样本MD5: certutil -hashfile %样本文件名% MD5</span><br></code></pre></td></tr></table></figure>

<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a><strong>工具</strong></h3><p>病毒分析</p>
<p>病毒查杀</p>
<p>病毒动态</p>
<p>在线扫描</p>
<p>webshell 查杀</p>
<p><strong>PChunter</strong><br>系统信息监控工具，主要拿来看数字签名<br>黑色是微软认证的<br>粉红色是未认证的<br>红色是可疑进程</p>
<p><strong>Autoruns</strong><br>启动项、计划任务等动态监测工具</p>
<p><strong>Process Explorer</strong><br>应用程序监测工具<br>数据量很大，需要过滤</p>
<p><strong>TCPView</strong><br>其实就是 <code>netstat -ano</code> 的输出，但是可视化方便处理</p>
<p><strong>Microsoft Network Monitor</strong><br>很小的一个流量监控软件<br>安装完需要重启，可以监测单个程序进程</p>
<p><strong>D 盾</strong><br>查杀 webshell</p>
<p><strong>Everything</strong><br>快速查找文件和目录</p>
<p><strong>sysmon</strong><br>微软开发的系统监控工具，常用来判断挖矿后门等等</p>
<p><strong>火绒剑</strong></p>
<p><strong>威胁分析平台</strong></p>
<p><strong>BeaconEye</strong><br>监测 CS 木马后门特征</p>
<p><strong>DumpIt</strong><br>内存取证工具，需要 dump 整个系统，取证空间占用太大，不建议使用<br>替代工具:<code>FTK Imager</code> 和 <code>WinPMem</code></p>
<p><strong>Volatility</strong><br>内存取证工具</p>
<h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a><strong>Linux</strong></h2><p>账号安全，历史命令，异常端口，开机启动、服务，异常文件，&#x2F;tmp&#x2F;user&#x2F;bin 目录、进程</p>
<h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-strong">**top和ps -aux**</span><br>查看系统资源占用<br></code></pre></td></tr></table></figure>

<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-strong">**netstat -antpl**</span><br>查看网络连接以及其对应可执行程序<br></code></pre></td></tr></table></figure>

<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-strong">**lsof**</span><br>查看开放端口的进程<br></code></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">**登录信息查看**<br><span class="hljs-section">显示错误的尝试登录信息: lastb</span><br><span class="hljs-section">显示系统用户最近的登录信息: last</span><br><span class="hljs-section">现实所有的用户最近的登录信息: lastlog</span><br></code></pre></td></tr></table></figure>

<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">**<span class="hljs-keyword">grep</span>**<br>查找符合条件的字符串:netstat -antpl <span class="hljs-keyword">lgrep</span> <span class="hljs-number">22</span><br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">**crontab**<br>查看定时任务: crontab -<span class="hljs-number">1</span> 、 cat <span class="hljs-regexp">/etc/</span>crontab<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">**历史命令**<br>查看历史命令: <span class="hljs-built_in">history</span>、<span class="hljs-built_in">cat</span> ~/.bash <span class="hljs-built_in">history</span><br></code></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs makefile">**校验RPM软件包**<br><span class="hljs-section">校验RPM软件包: rpm -Va、dpkg -verify</span><br>S：表示对应文件的大小 (Size) 不一致<br><span class="hljs-section">M: 表示对于文件的mode不一致</span><br><span class="hljs-section">5:表示对应文件的MD5不一致</span><br><span class="hljs-section">D:表示文件的major和minor号不一致</span><br><span class="hljs-section">L:表示文件的符号连接内容不一致</span><br><span class="hljs-section">U:表示文件的owner不一致</span><br><span class="hljs-section">G: 表示文件的group不一致</span><br><span class="hljs-section">T:表示文件的修改时间不一致</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">**其它**<br>登录成功的IP<br>grep “Accepted” /var/log/secure | awk ‘&#123;<span class="hljs-built_in">print</span> <span class="hljs-variable">$11</span>&#125;’ | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br>定位有爆破行为的IP<br>grep “Failed password” /var/log/secure awk ‘&#123;<span class="hljs-built_in">print</span> <span class="hljs-variable">$11</span>&#125;’ | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br>查看隐藏进程<br>ps -ef awk ‘&#123;<span class="hljs-built_in">print</span> <span class="hljs-variable">$11</span>&#125;’ | <span class="hljs-built_in">sort</span> -n | <span class="hljs-built_in">uniq</span> &gt;1<br><span class="hljs-built_in">ls</span> /proc | <span class="hljs-built_in">sort</span> -n | <span class="hljs-built_in">uniq</span> &gt;2<br>diff 1 2<br></code></pre></td></tr></table></figure>

<h3 id="账号安全-1"><a href="#账号安全-1" class="headerlink" title="账号安全"></a>账号安全</h3><p><strong>基本使用：</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ruby">解释<br><span class="hljs-number">1</span>、用户信息文件/etc/passwd<br><span class="hljs-symbol">root:</span><span class="hljs-symbol">x:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:root</span><span class="hljs-symbol">:/root</span><span class="hljs-symbol">:/bin/bash</span><br><span class="hljs-symbol">account:</span><span class="hljs-symbol">password:</span><span class="hljs-variable constant_">UID</span><span class="hljs-symbol">:GID</span><span class="hljs-symbol">:GECOS</span><span class="hljs-symbol">:directory</span><span class="hljs-symbol">:shell</span><br>用户名：密码：用户<span class="hljs-variable constant_">ID</span>：组<span class="hljs-variable constant_">ID</span>：用户说明：家目录：登陆之后shell<br>注意：无密码只允许本机登陆，远程不允许登陆<br><span class="hljs-number">2</span>、影子文件/etc/shadow<br><span class="hljs-symbol">root:</span>$<span class="hljs-number">6</span><span class="hljs-variable">$oGs1PqhL2p</span>3ZetrE<span class="hljs-variable">$X7o7bzoouHQVSEmSgsYN5UD4</span>.kMHx6qgbTqwNVC5oOAouXvcjQSt.<span class="hljs-title class_">Ft7ql1WpkopY0UV9ajBwUt1DpYxTCVv</span>I/<span class="hljs-symbol">:</span><span class="hljs-number">16809</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">99999</span><span class="hljs-symbol">:</span><span class="hljs-number">7</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span>:<br>用户名：加密密码：密码最后一次修改日期：两次密码的修改时间间隔：密码有效期：密码修改到期到的警告天数：密码过期之后的宽限天数：账号失效时间：保留<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">who</span>     查看当前登录用户（<span class="hljs-built_in">tty</span>本地登陆  pts远程登录）<br>w       查看系统信息，想知道某一时刻用户的行为<br><span class="hljs-built_in">uptime</span>  查看登陆多久、多少用户，负载<br></code></pre></td></tr></table></figure>

<p><strong>入侵排查：</strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gradle">解释<br><span class="hljs-number">1</span>、查询特权用户特权用户(uid 为<span class="hljs-number">0</span>)<br>[root@localhost ~]# awk -F: <span class="hljs-string">&#x27;$3==0&#123;print $1&#125;&#x27;</span> <span class="hljs-regexp">/etc/</span>passwd<br><span class="hljs-number">2</span>、查询可以远程登录的帐号信息<br>[root@localhost ~]# awk <span class="hljs-string">&#x27;/\$1|\$6/&#123;print $1&#125;&#x27;</span> <span class="hljs-regexp">/etc/</span>shadow<br><span class="hljs-number">3</span>、除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限<br>[root@localhost ~]# more <span class="hljs-regexp">/etc/</span>sudoers | <span class="hljs-keyword">grep</span> -v <span class="hljs-string">&quot;^#\|^$&quot;</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;ALL=(ALL)&quot;</span><br><span class="hljs-number">4</span>、禁用或删除多余及可疑的帐号<br>    usermod -L user    禁用帐号，帐号无法登录，<span class="hljs-regexp">/etc/</span>shadow第二栏为!开头<br>    userdel user       删除user用户<br>    userdel -r user    将删除user用户，并且将/home目录下的user目录一并删除<br></code></pre></td></tr></table></figure>

<h3 id="历史命令"><a href="#历史命令" class="headerlink" title="历史命令"></a>历史命令</h3><p><strong>基本使用：</strong></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs clean">解释<br>通过.bash_history查看帐号执行过的系统命令<br><span class="hljs-number">1</span>、root的历史命令<br>histroy<br><span class="hljs-number">2</span>、打开/home各帐号目录下的.bash_history，查看普通帐号的历史命令<br>为历史的命令增加登录的IP地址、执行命令时间等信息：<br><span class="hljs-number">1</span>）保存<span class="hljs-number">1</span>万条命令<br>sed -i <span class="hljs-string">&#x27;s/^HISTSIZE=1000/HISTSIZE=10000/g&#x27;</span> /etc/profile<br><span class="hljs-number">2</span>）在/etc/profile的文件尾部添加如下行数配置信息：<br>######jiagu history xianshi#########<br>USER_IP=`who -u am i <span class="hljs-number">2</span>&gt;/dev/null | awk <span class="hljs-string">&#x27;&#123;print $NF&#125;&#x27;</span> | sed -e <span class="hljs-string">&#x27;s/[()]//g&#x27;</span>`<br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;$USER_IP&quot;</span> = <span class="hljs-string">&quot;&quot;</span> ]<br>then<br>USER_IP=`hostname`<br>fi<br><span class="hljs-keyword">export</span> HISTTIMEFORMAT=<span class="hljs-string">&quot;%F %T $USER_IP `whoami` &quot;</span><br>shopt -s histappend<br><span class="hljs-keyword">export</span> PROMPT_COMMAND=<span class="hljs-string">&quot;history -a&quot;</span><br>######### jiagu history xianshi ##########<br><span class="hljs-number">3</span>）source /etc/profile让配置生效<br>生成效果： <span class="hljs-number">1</span>  <span class="hljs-number">2018</span><span class="hljs-number">-07</span><span class="hljs-number">-10</span> <span class="hljs-number">19</span>:<span class="hljs-number">45</span>:<span class="hljs-number">39</span> <span class="hljs-number">192.168</span><span class="hljs-number">.204</span><span class="hljs-number">.1</span> root source /etc/profile<br><span class="hljs-number">3</span>、历史操作命令的清除：history -c<br>但此命令并不会清除保存在文件中的记录，因此需要手动删除.bash_profile文件中的记录。<br></code></pre></td></tr></table></figure>

<p><strong>入侵排查：</strong></p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">进入用户目录下<br>cat <span class="hljs-string">.bash_history</span> &gt;&gt; <span class="hljs-keyword">history</span>.txt<br></code></pre></td></tr></table></figure>

<h3 id="异常端口"><a href="#异常端口" class="headerlink" title="异常端口"></a>异常端口</h3><p>使用 netstat 网络连接命令，分析可疑端口、IP、PID</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">netstat -antlp|more<br>查看下pid所对应的进程文件路径，<br>运行ls -l <span class="hljs-regexp">/proc/</span><span class="hljs-variable">$PID</span><span class="hljs-regexp">/exe或file /</span>proc<span class="hljs-regexp">/$PID/</span>exe（<span class="hljs-variable">$PID</span> 为对应的pid 号）<br></code></pre></td></tr></table></figure>

<h3 id="异常进程"><a href="#异常进程" class="headerlink" title="异常进程"></a>异常进程</h3><p>使用 ps 命令，分析进程</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">ps</span> aux | <span class="hljs-keyword">grep</span> pid<br></code></pre></td></tr></table></figure>

<h3 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h3><p><strong>基本使用：</strong></p>
<p>系统运行级别示意图：</p>
<p>查看运行级别命令 runlevel</p>
<p>系统默认允许级别</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">vi  /etc/inittab<br><span class="hljs-attribute">id</span><span class="hljs-operator">=</span><span class="hljs-number">3</span>：initdefault  系统开机后直接进入哪个运行级别<br></code></pre></td></tr></table></figure>

<p>开机启动配置文件</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/etc/</span>rc.local<br><span class="hljs-regexp">/etc/</span>rc.d/rc[<span class="hljs-number">0</span>~<span class="hljs-number">6</span>].d<br></code></pre></td></tr></table></figure>

<p>例子:当我们需要开机启动自己的脚本时，只需要将可执行脚本丢在&#x2F;etc&#x2F;init.d 目录下，然后在&#x2F;etc&#x2F;rc.d&#x2F;rc*.d 中建立软链接即可</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">root@localhost ~]# ln -s <span class="hljs-regexp">/etc/i</span>nit.d<span class="hljs-regexp">/sshd /</span>etc<span class="hljs-regexp">/rc.d/</span>rc3.d/S100ssh<br></code></pre></td></tr></table></figure>

<p>此处 sshd 是具体服务的脚本文件，S100ssh 是其软链接，S 开头代表加载时自启动；如果是 K 开头的脚本文件，代表运行级别加载时需要关闭的。</p>
<p><strong>入侵排查：</strong></p>
<p>启动项文件：</p>
<p>more &#x2F;etc&#x2F;rc.local &#x2F;etc&#x2F;rc.d&#x2F;rc[0~6].d </p>
<p>ls -l &#x2F;etc&#x2F;rc.d&#x2F;rc3.d&#x2F;</p>
<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><p><strong>基本使用</strong></p>
<p>1、利用 crontab 创建计划任务</p>
<ul>
<li>基本命令</li>
</ul>
<p>crontab -l 列出某个用户 cron 服务的详细内容</p>
<p>Tips：默认编写的 crontab 文件会保存在 (&#x2F;var&#x2F;spool&#x2F;cron&#x2F;用户名 例如: &#x2F;var&#x2F;spool&#x2F;cron&#x2F;root</p>
<p>crontab -r 删除每个用户 cront 任务(谨慎：删除所有的计划任务)</p>
<p>crontab -e 使用编辑器编辑当前的 crontab 文件</p>
<p>如：_&#x2F;1 _* echo “hello world” &gt;&gt; &#x2F;tmp&#x2F;test.txt 每分钟写入文件</p>
<p>2、利用 anacron 实现异步定时任务调度</p>
<ul>
<li>使用案例</li>
</ul>
<p>每天运行 &#x2F;home&#x2F;backup.sh 脚本： vi &#x2F;etc&#x2F;anacrontab @daily 10 example.daily &#x2F;bin&#x2F;bash &#x2F;home&#x2F;backup.sh</p>
<p>当机器在 backup.sh 期望被运行时是关机的，anacron 会在机器开机十分钟之后运行它，而不用再等待 7 天。</p>
<p><strong>入侵排查</strong></p>
<p>重点关注以下目录中是否存在恶意脚本</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">解释<br><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/cron/</span>* <br><span class="hljs-regexp">/etc/</span>crontab<br><span class="hljs-regexp">/etc/</span>cron.d/*<br><span class="hljs-regexp">/etc/</span>cron.daily/* <br><span class="hljs-regexp">/etc/</span>cron.hourly/* <br><span class="hljs-regexp">/etc/</span>cron.monthly/*<br><span class="hljs-regexp">/etc/</span>cron.weekly/<br><span class="hljs-regexp">/etc/</span>anacrontab<br><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/anacron/</span>*<br></code></pre></td></tr></table></figure>

<p>小技巧：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">more <span class="hljs-regexp">/etc/</span>cron.daily/*  查看目录下所有文件<br></code></pre></td></tr></table></figure>

<h3 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h3><p><strong>服务自启动</strong></p>
<p>第一种修改方法：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">chkconfig</span><span class="hljs-meta"> [--level 运行级别] [独立服务名] [on|off]</span><br><span class="hljs-attribute">chkconfig</span> –level  <span class="hljs-number">2345</span> httpd <span class="hljs-literal">on</span>  开启自启动<br><span class="hljs-attribute">chkconfig</span> httpd <span class="hljs-literal">on</span> （默认level是<span class="hljs-number">2345</span>）<br></code></pre></td></tr></table></figure>

<p>第二种修改方法：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">修改<span class="hljs-regexp">/etc/</span>re.d/rc.local 文件  <br>加入 <span class="hljs-regexp">/etc/i</span>nit.d/httpd start<br></code></pre></td></tr></table></figure>

<p>第三种修改方法：</p>
<p>使用 ntsysv 命令管理自启动，可以管理独立服务和 xinetd 服务。</p>
<p><strong>入侵排查</strong></p>
<p>1、查询已安装的服务：</p>
<p>RPM 包安装的服务</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim">解释<br>chkconfig  --<span class="hljs-keyword">list</span>  查看服务自启动状态，可以看到所有的RPM包安装的服务<br><span class="hljs-keyword">ps</span> aux | <span class="hljs-keyword">grep</span> crond 查看当前服务<br>系统在<span class="hljs-number">3</span>与<span class="hljs-number">5</span>级别下的启动项 <br>中文环境<br>chkconfig --<span class="hljs-keyword">list</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;3:启用\|5:启用&quot;</span><br>英文环境<br>chkconfig --<span class="hljs-keyword">list</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;3:on\|5:on&quot;</span><br></code></pre></td></tr></table></figure>

<p>源码包安装的服务</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">查看服务安装位置 ，一般是在<span class="hljs-regexp">/user/</span>local/<br>service httpd start<br>搜索<span class="hljs-regexp">/etc/</span>rc.d<span class="hljs-regexp">/init.d/</span>  查看是否存在<br></code></pre></td></tr></table></figure>

<h3 id="异常文件"><a href="#异常文件" class="headerlink" title="异常文件"></a>异常文件</h3><p>1、查看敏感目录，如&#x2F;tmp 目录下的文件，同时注意隐藏文件夹，以“.*”为名的文件夹具有隐藏属性</p>
<p>2、得到发现 WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？</p>
<p>可以使用 find 命令来查找，如 <code> find /opt -iname &quot;*&quot; -atime 1 -type f</code> 找出 &#x2F;opt 下一天前访问过的文件</p>
<p>3、针对可疑文件可以使用 stat 进行创建修改时间。</p>
<h3 id="日志-1"><a href="#日志-1" class="headerlink" title="日志"></a>日志</h3><p>日志默认存放位置：&#x2F;var&#x2F;log&#x2F;</p>
<p>查看日志配置情况：more &#x2F;etc&#x2F;rsyslog.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs bash">定位有多少IP在爆破主机的root帐号：    <br>grep <span class="hljs-string">&quot;Failed password for root&quot;</span> /var/log/secure | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br><br>定位有哪些IP在爆破：<br>grep <span class="hljs-string">&quot;Failed password&quot;</span> /var/log/secure|grep -E -o <span class="hljs-string">&quot;(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)&quot;</span>|<span class="hljs-built_in">uniq</span> -c<br><br>爆破用户名字典是什么？<br> grep <span class="hljs-string">&quot;Failed password&quot;</span> /var/log/secure|perl -e <span class="hljs-string">&#x27;while($_=&lt;&gt;)&#123; /for(.*?) from/; print &quot;$1\n&quot;;&#125;&#x27;</span>|<span class="hljs-built_in">uniq</span> -c|<span class="hljs-built_in">sort</span> -nr<br><br>登录成功的IP有哪些：     <br>grep <span class="hljs-string">&quot;Accepted &quot;</span> /var/log/secure | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br><br>登录成功的日期、用户名、IP：<br>grep <span class="hljs-string">&quot;Accepted &quot;</span> /var/log/secure | awk <span class="hljs-string">&#x27;&#123;print $1,$2,$3,$9,$11&#125;&#x27;</span> <br><br>增加一个用户kali日志：<br>Jul 10 00:12:15 localhost useradd[2382]: new group: name=kali, GID=1001<br>Jul 10 00:12:15 localhost useradd[2382]: new user: name=kali, UID=1001, GID=1001, home=/home/kali, shell=/bin/bash<br>Jul 10 00:12:58 localhost passwd: pam_unix(passwd:chauthtok): password changed <span class="hljs-keyword">for</span> kali<br><span class="hljs-comment">#grep &quot;useradd&quot; /var/log/secure </span><br><br>删除用户kali日志：<br>Jul 10 00:14:17 localhost userdel[2393]: delete user <span class="hljs-string">&#x27;kali&#x27;</span><br>Jul 10 00:14:17 localhost userdel[2393]: removed group <span class="hljs-string">&#x27;kali&#x27;</span> owned by <span class="hljs-string">&#x27;kali&#x27;</span><br>Jul 10 00:14:17 localhost userdel[2393]: removed shadow group <span class="hljs-string">&#x27;kali&#x27;</span> owned by <span class="hljs-string">&#x27;kali&#x27;</span><br>grep <span class="hljs-string">&quot;userdel&quot;</span> /var/log/secure<br><br>su切换用户：<br>Jul 10 00:38:13 localhost su: pam_unix(su-l:session): session opened <span class="hljs-keyword">for</span> user good by root(uid=0)<br><br>sudo授权执行<br>sudo -l<br><br>列出当天访问次数最多的IP命令：<br><span class="hljs-built_in">cut</span> -d- -f 1 log_file|<span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -rn | <span class="hljs-built_in">head</span> -20<br><br>查看当天有多少个IP访问：<br>awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> log_file|<span class="hljs-built_in">sort</span>|<span class="hljs-built_in">uniq</span>|<span class="hljs-built_in">wc</span> -l<br><br>查看某一个页面被访问的次数：<br>grep <span class="hljs-string">&quot;/index.php&quot;</span> log_file | <span class="hljs-built_in">wc</span> -l<br><br>查看每一个IP访问了多少个页面：<br>awk <span class="hljs-string">&#x27;&#123;++S[$1]&#125; END &#123;for (a in S) print a,S[a]&#125;&#x27;</span> log_file<br><br>将每个IP访问的页面数进行从小到大排序：<br>awk <span class="hljs-string">&#x27;&#123;++S[$1]&#125; END &#123;for (a in S) print S[a],a&#125;&#x27;</span> log_file | <span class="hljs-built_in">sort</span> -n<br><br>查看某一个IP访问了哪些页面：<br>grep ^111.111.111.111 log_file| awk <span class="hljs-string">&#x27;&#123;print $1,$7&#125;&#x27;</span><br><br>去掉搜索引擎统计当天的页面：<br>awk <span class="hljs-string">&#x27;&#123;print $12,$1&#125;&#x27;</span> log_file | grep ^\&quot;Mozilla | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> |<span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> | <span class="hljs-built_in">wc</span> -l<br><br>查看2018年6月21日14时这一个小时内有多少IP访问:<br>awk <span class="hljs-string">&#x27;&#123;print $4,$1&#125;&#x27;</span> log_file | grep 21/Jun/2018:14 | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>| <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> | <span class="hljs-built_in">wc</span> -l<br></code></pre></td></tr></table></figure>

<h3 id="应急工具"><a href="#应急工具" class="headerlink" title="应急工具"></a><strong>应急工具</strong></h3><p><strong>BusyBox</strong><br>静态链接库的 BusyBox<br>当命令被替换时使用<br>赋予可执行权限后.\即可</p>
<p><strong>chkrootkit</strong><br>监测 RootKit 的脚本</p>
<p><strong>Rkhunter</strong><br>同上</p>
<p><strong>unhide</strong><br>查找隐藏的 UDP&#x2F;TCP 进程</p>
<p><strong>ClamAV</strong><br>检测各种恶意木马，病毒，进程<br>注意是否存在 so 文件的注入</p>
<p><strong>河马 Webshell</strong></p>
<p><strong>RPM 包</strong></p>
<p><strong>查找文件中的恶意&#x2F;危险函数</strong></p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">PHP</span>: <span class="hljs-function"><span class="hljs-title">eval</span>(、<span class="hljs-title">system</span>(、<span class="hljs-variable">assert</span> (</span><br><span class="hljs-function"><span class="hljs-variable">JSP</span>: <span class="hljs-title">getRunTime</span>(、<span class="hljs-title">FileOutputStream</span>(</span><br><span class="hljs-function"><span class="hljs-variable">ASP</span>: <span class="hljs-title">eval</span>(、<span class="hljs-title"><span class="hljs-built_in">execute</span></span>(、<span class="hljs-variable">ExecuteGlobal</span> (</span><br></code></pre></td></tr></table></figure>

<p><strong>从日志记录中查找</strong><br>查看每个 IP 地址访问次数:<br>cat access.log |awk ‘{print $1}’ |sort|uniq - c<br>访问 URL 排序:<br>cat access.log |awk ‘{print $1}’ |sort|uniq - c |sort -rn|head<br>访问指定资源日志:<br>cat access.log |awk ‘{print $7}’ |grep &#x2F;%25Domain |sort|uniq - c |sort -rn|more</p>
<h1 id="攻击溯源"><a href="#攻击溯源" class="headerlink" title="攻击溯源"></a>攻击溯源</h1><h1 id="Webshell"><a href="#Webshell" class="headerlink" title="Webshell"></a>Webshell</h1><h2 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h2><p>首先，通过浏览器以 HTTP 协议访问 Web Server 上的一个 CGI 文件，是一个合法的 TCP 连接，TCP&#x2F;IP 的应用层之下没有任何特征，只能在<strong>应用层进行检测</strong>。<br>黑客不管是传文件还是改文件，必然有一个文件会包含 webshell 代码，很容易想到从文件代码入手，这是<strong>静态特征检测</strong>。<br>webshell 运行后，B&#x2F;S 数据通过 HTTP 交互，HTTP 请求&#x2F;响应中可以找到蛛丝马迹，这是<strong>动态特征检测</strong>。</p>
<p>【静态检测】</p>
<p>静态检测通过匹配特征码，特征值，危险函数函数来查找 webshell 的方法。</p>
<p>优点是快速方便，对已知的 webshell 查找准确率高，部署方便。</p>
<p>缺点漏报率、误报率高，无法查找 0day 型 webshell，而且容易被绕过。</p>
<p>【静态检测配合人工】<br>一个检查工具 <a target="_blank" rel="noopener" href="https://github.com/he1m4n6a/findWebshell">https://github.com/he1m4n6a/findWebshell</a></p>
<p>【动态检测】</p>
<p>Linux 下就是 nobody 用户起了 bash，Win 下就是 IIS User 启动 cmd，这些都是动态特征。</p>
<p>如果黑客反向连接的话，那很更容易检测了，Agent 和 IDS 都可以抓现行。</p>
<p>Webshell 总有一个 HTTP 请求，如果我在网络层监控 HTTP，并且检测到有人访问了一个从没反问过得文件，而且返回了 200，则很容易定位到 webshell，这便是 http 异常模型检测，就和检测文件变化一样，如果非管理员新增文件，则说明被人入侵了。</p>
<p>缺点也很明显，黑客只要利用原文件就很轻易绕过了，并且部署代价高，网站时常更新的话规则也要不断添加。</p>
<p>【日志检测】</p>
<p>使用 Webshell 一般不会在系统日志中留下记录，但是会在网站的 web 日志中留下 Webshell 页</p>
<p>面的访问数据和数据提交记录。</p>
<p>日志分析检测技术通过大量的日志文件建立请求模型从而检测出异常文件，称之为：HTTP 异常请求模型检测</p>
<p>【寻找 webshell】<br>1.自动化查找：D 盾 河马 fotify<br>2.手动查找：windows sublime 全文件夹查找 IDE PHPSTORM 全局查找<br>Linux 命令查找 <code>grep -rn &quot;eval(&quot; *</code><br>webshell 特征 PHP 的危险函数<br>还有 <code>phar &lt;?php XXXXX</code></p>
<h2 id="防护"><a href="#防护" class="headerlink" title="防护"></a>防护</h2><p>1.限制上传的文件夹解析方式</p>
<p>2.匹配文件夹里的脚本类型文件，将其设置为无法读取及操作。</p>
<p>3.给予上传的文件夹二级域名并且不给予解析权限</p>
<p>4.只能局域网访问</p>
<h1 id="问题处置-1"><a href="#问题处置-1" class="headerlink" title="问题处置"></a>问题处置</h1><h2 id="文件无法删除"><a href="#文件无法删除" class="headerlink" title="文件无法删除"></a><strong>文件无法删除</strong></h2><h3 id="进程占用"><a href="#进程占用" class="headerlink" title="进程占用"></a><strong>进程占用</strong></h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">lsof</span> xxxx.xx<br></code></pre></td></tr></table></figure>

<h3 id="隐藏属性"><a href="#隐藏属性" class="headerlink" title="隐藏属性"></a><strong>隐藏属性</strong></h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">sattr xxxx<span class="hljs-selector-class">.xx</span><br>chattr -<span class="hljs-selector-tag">a</span> xxxx<span class="hljs-selector-class">.xx</span><br>chattr -<span class="hljs-selector-tag">i</span> xxxx.xx<br></code></pre></td></tr></table></figure>

<h3 id="上层文件存在-SBIT-权限"><a href="#上层文件存在-SBIT-权限" class="headerlink" title="上层文件存在 SBIT 权限"></a><strong>上层文件存在 SBIT 权限</strong></h3><p>这种情况只存在于非 root 权限去删除其他用户创建的目录的情况，即使文件权限是 777 也无法进行删除。<br>当目录被设置了粘滞位权限以后，即便用户对该目录有写入权限，也不能删除该目录中其他用户的文件数据，而是只有该文件的所有者和 root 用户才有权将其删除。<br>这种办法可以保持一种动态的平衡：允许各用户在目录中任意写入、删除数据，但是禁止随意删除其他用户的数据。<br>需要注意的是，粘滞位权限只能针对目录设置，对于文件无效。<br>设置了粘滞位权限的目录，使用 ls 命令查看其属性时，其他用户权限处的“x”将变为“t”。<br>粘滞位权限都是针对其他用户设置，使用 chmod 命令设置目录权限时，“o+t”、“o-t”权限模式可分别用于添加、移除粘滞位权限。</p>
<h2 id="netstat-pantu-不显示-pid-而显示"><a href="#netstat-pantu-不显示-pid-而显示" class="headerlink" title="netstat -pantu 不显示 pid 而显示 -"></a><strong>netstat -pantu 不显示 pid 而显示 -</strong></h2><p>可能是使用了 <code>mkdir .hidden 或者 mount -o bind .hidden /proc/PID</code> 来隐藏</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">cat <span class="hljs-string">/proc/</span>$$<span class="hljs-string">/mountinfo</span>   <span class="hljs-string">//</span>查询挂载信息<br>umount <span class="hljs-string">/proc/PID</span>   <span class="hljs-string">//</span>取消挂载<br></code></pre></td></tr></table></figure>

<h2 id="ps-和-top-看不到恶意进程"><a href="#ps-和-top-看不到恶意进程" class="headerlink" title="ps 和 top 看不到恶意进程"></a><strong>ps 和 top 看不到恶意进程</strong></h2><ol>
<li>挂载被隐藏（看上一个的操作）</li>
<li>命令被替换（使用 busybox 进行检修）</li>
<li>LD_PRELOAD 等方法共享库劫持（使用 busybox 进行检修）</li>
</ol>
<h2 id="快速查找文件"><a href="#快速查找文件" class="headerlink" title="快速查找文件"></a><strong>快速查找文件</strong></h2><p>【which】<br>从环境变量查找系统命令的具体文件位置<br>【whereis】<br>从&#x2F;usr 目录快速查找文件<br>【locate】<br>从 locatedb 数据库查找文件路径<br>【find】<br>强大的搜索命令<br><code>find &lt;检索路径&gt; &lt;选项&gt; &lt;搜索内容&gt;</code><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1348438">具体使用方法</a></p>
<h2 id="确定系统信息"><a href="#确定系统信息" class="headerlink" title="确定系统信息"></a><strong>确定系统信息</strong></h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/etc/i</span>ssue   <span class="hljs-regexp">//</span>系统版本<br>uname -m<br>getconf LONG_BIT   <span class="hljs-regexp">//</span>查看系统位数<br>cat <span class="hljs-regexp">/proc/</span>version   <span class="hljs-regexp">//</span>查看内核版本<br>uname -a<br></code></pre></td></tr></table></figure>

<h2 id="系统完整性检测"><a href="#系统完整性检测" class="headerlink" title="系统完整性检测"></a><strong>系统完整性检测</strong></h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">rpm -Va   <span class="hljs-regexp">//</span>Centos<br>apt install debsums   <span class="hljs-regexp">//</span>Ubuntu、Debian<br>debsums --all --changed<br></code></pre></td></tr></table></figure>

<h2 id="系统文件监控工具"><a href="#系统文件监控工具" class="headerlink" title="系统文件监控工具"></a><strong>系统文件监控工具</strong></h2><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livescript">AIDE<span class="hljs-string">\inotify\tripwire</span><br></code></pre></td></tr></table></figure>

<h2 id="查看-glibc-版本"><a href="#查看-glibc-版本" class="headerlink" title="查看 glibc 版本"></a><strong>查看 glibc 版本</strong></h2><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">ldd <span class="hljs-comment">--version</span><br></code></pre></td></tr></table></figure>

<h2 id="误删文件恢复"><a href="#误删文件恢复" class="headerlink" title="误删文件恢复"></a><strong>误删文件恢复</strong></h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">被删除的文件在进程的内存空间还保存着一份，可以通过访问某个目录来找到文件恢复<br>如果正在进行读写操作：<br>lsof   <span class="hljs-regexp">//</span>查找进程文件恢复即可<br>mount   <span class="hljs-regexp">//</span>查看所有挂载点<br>umount   <span class="hljs-regexp">//</span>删除挂载点<br>lsblk -f   <span class="hljs-regexp">//</span>查看所有设备的挂载情况<br>df -T 路径   <span class="hljs-regexp">//</span>可查看该路径的所属挂载点、所在分区、所在分区的文件系统类型<br>cat <span class="hljs-regexp">/proc/</span>filesystems   <span class="hljs-regexp">//</span>查看文件系统的类型<br>常用恢复工具有：Extundelete、Debugfs、R-Linux、Ext3grep、Ext4magic<br></code></pre></td></tr></table></figure>

<h2 id="批量检索文件并打印信息"><a href="#批量检索文件并打印信息" class="headerlink" title="批量检索文件并打印信息"></a><strong>批量检索文件并打印信息</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&quot;内容&quot;</span> | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> line; <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> [ -f <span class="hljs-variable">$line</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">ls</span> -al <span class="hljs-variable">$line</span>; <span class="hljs-keyword">elif</span> [ -d <span class="hljs-variable">$line</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">ls</span> -al ../ | grep <span class="hljs-variable">$line</span>; <span class="hljs-keyword">fi</span>; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>

<h2 id="拷贝取证"><a href="#拷贝取证" class="headerlink" title="拷贝取证"></a><strong>拷贝取证</strong></h2><ol>
<li>使用虚拟化平台存储快照</li>
<li>打包整个系统</li>
<li>全盘拷贝（推荐 clonezilla）</li>
<li>进程拷贝（推荐 CRIU）</li>
<li>组合运用（冻结进程 + 全盘拷贝 + 恢复进程）</li>
</ol>
<h1 id="远控后门"><a href="#远控后门" class="headerlink" title="远控后门"></a>远控后门</h1><h2 id="获取事件告警信息"><a href="#获取事件告警信息" class="headerlink" title="获取事件告警信息"></a><strong>获取事件告警信息</strong></h2><p>监控 EDR、态势感知、防火墙等平台查看威胁告警以及日志。</p>
<h2 id="定位后门文件"><a href="#定位后门文件" class="headerlink" title="定位后门文件"></a><strong>定位后门文件</strong></h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle">根据告警信息定位后门文件位置，查找进程pid<br>lsof | <span class="hljs-keyword">grep</span> xxxx.xx<br>lsof <span class="hljs-regexp">/root/</span>xxxx.xx<br>fuser <span class="hljs-regexp">/root/</span>xxxx.xx<br></code></pre></td></tr></table></figure>

<h2 id="查看外连事件详情"><a href="#查看外连事件详情" class="headerlink" title="查看外连事件详情"></a><strong>查看外连事件详情</strong></h2><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs 1c">根据五元组来查找通信的端口ip对应的pid<br>netstat -pantu <span class="hljs-string">| grep 114.114.114.114</span><br>netstat -pantu <span class="hljs-string">| grep 65533</span><br>lsof -i:<span class="hljs-number">65533</span><br></code></pre></td></tr></table></figure>

<h2 id="查找进程信息"><a href="#查找进程信息" class="headerlink" title="查找进程信息"></a><strong>查找进程信息</strong></h2><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs tcl">查找进程相关文件<br>lsof -p <span class="hljs-number">1234</span>   （需要root权限）<br>pwdx<br>获取<span class="hljs-keyword">pid</span>程序详细信息<br>lsof -p <span class="hljs-keyword">pid</span><br>pwdx <span class="hljs-keyword">pid</span><br>systemctl status <span class="hljs-keyword">pid</span><br>cat /<span class="hljs-keyword">proc</span>/pid/maps<span class="hljs-title"></span><br><span class="hljs-title">ls</span> -al /<span class="hljs-keyword">proc</span>/pid/exe<br></code></pre></td></tr></table></figure>

<h2 id="根据-pid-查看对应线程"><a href="#根据-pid-查看对应线程" class="headerlink" title="根据 pid 查看对应线程"></a><strong>根据 pid 查看对应线程</strong></h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">ps</span> <span class="hljs-built_in">H</span> <span class="hljs-literal">-T</span> <span class="hljs-literal">-p</span> pid<br><span class="hljs-built_in">ps</span> <span class="hljs-literal">-aLf</span> pid<br>pstree <span class="hljs-literal">-agplU</span>（推荐使用）<br></code></pre></td></tr></table></figure>

<h2 id="确定进程运行时间"><a href="#确定进程运行时间" class="headerlink" title="确定进程运行时间"></a><strong>确定进程运行时间</strong></h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">ps</span> -eo pid,lstart,etime,cmd | <span class="hljs-keyword">grep</span> <span class="hljs-symbol">&lt;pid&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="比对恶意文件的创建时间"><a href="#比对恶意文件的创建时间" class="headerlink" title="比对恶意文件的创建时间"></a><strong>比对恶意文件的创建时间</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">stat</span> xxx.xx<br><span class="hljs-built_in">ls</span> -al xxx.xx<br></code></pre></td></tr></table></figure>

<h2 id="样本采集分析"><a href="#样本采集分析" class="headerlink" title="样本采集分析"></a><strong>样本采集分析</strong></h2><p>使用 SCP&#x2F;Xshell 等将样本移出主机，计算哈希值后到威胁情报平台中去搜索<br>certutil -hashfile 文件 MD5</p>
<h2 id="进程查杀"><a href="#进程查杀" class="headerlink" title="进程查杀"></a><strong>进程查杀</strong></h2><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs maxima">【查找子进程】<br>ps ajfx<br>systemctl <span class="hljs-built_in">status</span><br>【杀死进程】<br><span class="hljs-built_in">kill</span> -<span class="hljs-number">9</span> pid   （这样子是杀不死子进程的！！！）<br><span class="hljs-built_in">kill</span> -<span class="hljs-number">9</span> -pid   （杀掉进程组）<br></code></pre></td></tr></table></figure>

<h2 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a><strong>删除文件</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">查看文件占用，解除占用后删除<br>lsof xxxx.xx<br>移除 i, a 属性<br>chattr -ia file.sh<br>查看是否移除成功<br>lsattr file.sh<br>移除文件<br><span class="hljs-built_in">rm</span> -rf file.sh<br>奇怪文件名无法删除，先查inode再删除<br><span class="hljs-built_in">ls</span> -li xxxx.xx<br>find ./* -inum 12327526 -delete<br>find ./ -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> &#123;&#125; \;<br>find ./* -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -i &#123;&#125; \;<br>find ./* -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -f &#123;&#125; \;<br>find ./* -inum 12327526 |xargs <span class="hljs-built_in">rm</span> -f<br><span class="hljs-built_in">rm</span> <br>find ./* -inum 12327526<br>目录挂载无法删除（Device or resource busy）<br>sudo lsblk -a<br>sudo umount /dev/sdb1<br><span class="hljs-built_in">rm</span> -rf xxxx.xx<br></code></pre></td></tr></table></figure>

<h1 id="威胁情报"><a href="#威胁情报" class="headerlink" title="威胁情报"></a>威胁情报</h1><p>威胁情报的获取源</p>
<blockquote>
<p>谷歌：<a target="_blank" rel="noopener" href="http://www.google.com/">www.google.com</a></p>
<p>百度：<a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a></p>
<p>Virustotal：<a target="_blank" rel="noopener" href="http://www.virustotal.com/">www.virustotal.com</a></p>
<p>微步在线：x.threatbook.cn</p>
<p>腾讯哈勃：habo.qq.com</p>
<p>Virscan：virusscan.jotti.org</p>
<p>Freebuf：<a target="_blank" rel="noopener" href="http://www.freebuf.com/">www.freebuf.com</a></p>
<p>Jotti：virusscan.jotti.org</p>
<p>Scandir：<a target="_blank" rel="noopener" href="http://www.scandir.com/">www.scandir.com</a></p>
<p>Alexa排名：<a target="_blank" rel="noopener" href="http://www.alexa.com/">www.alexa.com</a></p>
<p>备案查询：beian.cndns.com</p>
<p>深信服安全中心：sec.sangfor.com.cn</p>
<p>深信服威胁分析平台：wiki.sec.sangfor.com.cn</p>
<p>深信服EDR安全软件中心：edr.sangfor.com.cn</p>
</blockquote>
<p>黑客通过随机域名，动态域名，近期域名，顶级域名，暗网代理域名攻击</p>
<h1 id="病毒"><a href="#病毒" class="headerlink" title="病毒"></a>病毒</h1><ul>
<li><strong>蠕虫：</strong>自动复制自身的副本到其它主机的病毒。</li>
<li><strong>木马：</strong>隐蔽性强，多用于监控用户行为或盗取用户数据的病毒。</li>
<li><strong>感染型病毒：</strong>能将自身恶意代码插入正常文件的病毒。</li>
<li><strong>脚本病毒：</strong>使用脚本编写的病毒。</li>
<li><strong>宏病毒：</strong>宏是微软公司为其Office软件包设计的一个特殊功能，由于其功能强大，使得黑客可以通过精心构造的宏代码来实现恶意操作，这些代码就叫做宏病毒。宏病毒常以垃圾邮件的方式对用户进行攻击，因为伪造的Office文档不容易引起用户的怀疑，所以当用户毫无防备的打开Office文档并启用宏之后，宏病毒便开始了运行，对用户主机进行恶意操作。</li>
<li><strong>僵尸网络病毒：</strong>能形成大型的一对多，多对多控制的远程控制病毒。</li>
<li><strong>后门：</strong>在主机上开放端口允许远程非授权访问。</li>
<li><strong>挖矿病毒</strong>：消耗用户CPU、GPU资源，进行大量运算，获取加密货币的病毒。</li>
<li><strong>勒索病毒</strong>：能对用户文件进行加密的病毒。</li>
</ul>
<h1 id="挖矿排查"><a href="#挖矿排查" class="headerlink" title="挖矿排查"></a>挖矿排查</h1><p><strong>获取信息</strong></p>
<ul>
<li>下线服务器之后从 DNS 服务器、防火墙、态势感知平台等地方获取到攻击事件详细信息</li>
<li>根据上传来源的 IP&#x2F;域名，在威胁情报平台查询确定木马类型</li>
<li>获取异常进程的 pid</li>
</ul>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs perl">CPU占用：<br>top -c -o %CPU<br>ps -eo pid,ppid,%mem,%cpu,cmd --<span class="hljs-keyword">sort</span>=-%cpu | head -n <span class="hljs-number">5</span><br>内存占用：<br>top -c -o %MEM<br>ps -eo pid,ppid,%mem,%cpu,cmd --<span class="hljs-keyword">sort</span>=-%mem | head -n <span class="hljs-number">5</span><br>网络占用：<br>安装后使用nethogs或者jnettop进行查询<br>根据进程名或字符串查询：<br>pidof <span class="hljs-string">&quot;name&quot;</span><br>ps -aux | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;name&quot;</span><br>ps -ef | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;name&quot;</span> | <span class="hljs-keyword">grep</span> -v <span class="hljs-keyword">grep</span> | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span><br>pgrep -f <span class="hljs-string">&quot;name&quot;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>根据 pid 查询详细信息（当查询不到时有可能是&#x2F;proc&#x2F;pid 隐藏了）</li>
</ul>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tcl">lsof -p <span class="hljs-keyword">pid</span><br>pwdx <span class="hljs-keyword">pid</span><br>systemctl status <span class="hljs-keyword">pid</span><br>cat /<span class="hljs-keyword">proc</span>/pid/maps<span class="hljs-title"></span><br><span class="hljs-title">ls</span> -al /<span class="hljs-keyword">proc</span>/pid/exe<br></code></pre></td></tr></table></figure>

<ul>
<li>根据 pid 查看对应线程</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">ps</span> <span class="hljs-built_in">H</span> <span class="hljs-literal">-T</span> <span class="hljs-literal">-p</span> pid<br><span class="hljs-built_in">ps</span> <span class="hljs-literal">-aLf</span> pid<br>pstree <span class="hljs-literal">-agplU</span>（推荐使用）<br></code></pre></td></tr></table></figure>

<ul>
<li>确定进程运行时间</li>
</ul>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">ps</span> -eo pid,lstart,etime,cmd | <span class="hljs-keyword">grep</span> <span class="hljs-symbol">&lt;pid&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>比对恶意文件的创建时间</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">stat</span> xxx.xx<br><span class="hljs-built_in">ls</span> -al xxx.xx<br></code></pre></td></tr></table></figure>

<ul>
<li>样本采集分析</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">使用<span class="hljs-keyword">SCP/Xshell等将样本移出主机，计算哈希值后到威胁情报平台中去搜索</span><br><span class="hljs-keyword"></span>certutil -hashfile 文件 MD5<br></code></pre></td></tr></table></figure>

<ul>
<li>进程查杀</li>
</ul>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs maxima">【查找子进程】<br>ps ajfx<br>systemctl <span class="hljs-built_in">status</span><br>【杀死进程】<br><span class="hljs-built_in">kill</span> -<span class="hljs-number">9</span> pid   （这样子是杀不死子进程的！！！）<br><span class="hljs-built_in">kill</span> -<span class="hljs-number">9</span> -pid   （杀掉进程组）<br></code></pre></td></tr></table></figure>

<ul>
<li>删除文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看文件占用，解除占用后删除</span><br>lsof xxxx.xx<br><span class="hljs-comment"># 移除 i, a 属性</span><br>chattr -ia file.sh<br><span class="hljs-comment"># 查看是否移除成功</span><br>lsattr file.sh<br><span class="hljs-comment"># 移除文件</span><br><span class="hljs-built_in">rm</span> -rf file.sh<br><span class="hljs-comment"># 奇怪文件名无法删除，先查inode再删除</span><br><span class="hljs-built_in">ls</span> -li xxxx.xx<br>find ./* -inum 12327526 -delete<br>find ./ -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> &#123;&#125; \;<br>find ./* -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -i &#123;&#125; \;<br>find ./* -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -f &#123;&#125; \;<br>find ./* -inum 12327526 |xargs <span class="hljs-built_in">rm</span> -f<br><span class="hljs-built_in">rm</span> `find ./* -inum 12327526`<br><span class="hljs-comment"># 目录挂载无法删除（Device or resource busy）</span><br>sudo lsblk -a<br>sudo umount /dev/sdb1<br><span class="hljs-built_in">rm</span> -rf xxxx.xx<br></code></pre></td></tr></table></figure>

<ul>
<li>网页挖矿排查</li>
</ul>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta"># 浏览器查看历史记录，定位到该事件点访问的页面</span><br><span class="hljs-meta"># 进入虚拟机进行访问，并限制进程只允许占用一个cpu</span><br><span class="hljs-meta"># 查看该网页的源码和网络链接调用</span><br><span class="hljs-meta"># 将浏览器缓存文件进行检测（大多数是JS）</span><br><span class="hljs-meta"># 清除浏览数据&gt;清除缓存文件</span><br><span class="hljs-meta"># 解密恶意文件查看矿池地址以及连接条件</span><br><span class="hljs-meta"># 上区块链网站溯源</span><br></code></pre></td></tr></table></figure>

<h1 id="暴力破解"><a href="#暴力破解" class="headerlink" title="暴力破解"></a>暴力破解</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a><strong>介绍</strong></h2><p>暴力破解一般针对</p>
<p>ssh、mysql、ftp、redis、mongodb、smtp</p>
<h2 id="SSH-暴力破解"><a href="#SSH-暴力破解" class="headerlink" title="SSH 暴力破解"></a><strong>SSH 暴力破解</strong></h2><ol>
<li>使用 <code>netstat -pantu</code> 查看网络状态，重点是 PID（当被破解时会有大量的 ESTABLISHED）</li>
<li>使用 <code>awk -F: &#39;&#123;if($3==0) print $1&#125;&#39; /etc/passwd</code> 查找特殊权限账号（默认 root）</li>
<li>查找可以使用 ssh 登录的账号</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">s=$( sudo <span class="hljs-built_in">cat</span> /etc/shadow | grep <span class="hljs-string">&#x27;^[^:]*:[^\*!]&#x27;</span> | awk -F: <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span>);<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$s</span>;<span class="hljs-keyword">do</span> <span class="hljs-built_in">cat</span>/etc/passwd | grep -v <span class="hljs-string">&quot;/bin/false\|/nologin&quot;</span>| grep <span class="hljs-variable">$i</span>;<span class="hljs-keyword">done</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> |awk -F: <span class="hljs-string">&#x27;&#123;print$1&#125;&#x27;</span><br></code></pre></td></tr></table></figure>

<ol>
<li>查看正在连接的 ssh-session</li>
</ol>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs perl">who -a<br>w<br><span class="hljs-keyword">last</span> -p now<br>sudo netstat -tnpa | <span class="hljs-keyword">grep</span> <span class="hljs-string">&#x27;ESTABLISHED.*sshd&#x27;</span><br>pgrep -af sshd<br>echo $SSH_CONNECTION<br>ss | <span class="hljs-keyword">grep</span> ssh<br></code></pre></td></tr></table></figure>

<ol>
<li>查看所有的账号信息</li>
</ol>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arcade">/<span class="hljs-keyword">var</span>/<span class="hljs-built_in">log</span>/auth.<span class="hljs-built_in">log</span>（Ubuntu）<br>/<span class="hljs-keyword">var</span>/<span class="hljs-built_in">log</span>/secure（centOS）<br>列出当前账户         <br>who am i<br></code></pre></td></tr></table></figure>

<ol>
<li>查看登录日志</li>
</ol>
<blockquote>
<p>查看日志 cd &#x2F;var&#x2F;log<br>成功登录 cat &#x2F;var&#x2F;log&#x2F;auth.log | grep “Accept”<br>正常退出 cat &#x2F;var&#x2F;log&#x2F;auth.log | grep “pam_unix(sshd:session): session closed”<br>密码错误 cat &#x2F;var&#x2F;log&#x2F;auth.log | grep “authentication failure”<br>连续错误 cat &#x2F;var&#x2F;log&#x2F;auth.log | grep “message repeated 2 times”</p>
</blockquote>
<ol>
<li>统计数据</li>
</ol>
<blockquote>
<p>登录失败的用户名及其次数<br>grep “Failed password” &#x2F;var&#x2F;log&#x2F;auth.log|perl -e ‘while($_&#x3D;&lt;&gt;){ &#x2F;for(.*?)from&#x2F;; print”$1\n”;}’|sort|uniq -c|sort -nr</p>
<p>登录失败的 IP 及其次数<br>cat &#x2F;var&#x2F;log&#x2F;auth.log | grep “Failed password for” | grep “root” | grep -Po ‘(1\d{2}|2[0-4]\d|25[0-5]|[1-9]\d|[1-9])(.(1\d{2}|2[0-4]\d|25[0-5]|[1-9]\d|\d)){3}’ |sort|uniq -c|sort -nr</p>
</blockquote>
<ol>
<li>加固防护<br>升级 SSH 版本至少为 7.7 版本以上，7.7 及以下版本存在 SSH 用户名枚举<br>加强口令复杂程度<br>禁止 root 用户登录，可以通过其他用户 su 到 root<br>安装 <code>fail2ban</code> 来进行防御</li>
</ol>
<h2 id="Mysql-暴力破解"><a href="#Mysql-暴力破解" class="headerlink" title="Mysql 暴力破解"></a><strong>Mysql 暴力破解</strong></h2><p>Mysql 默认安装会保留登录日志，在 Ubuntu 上默认位置为 <code>/var/og/mysql/error.log</code></p>
<ol>
<li>查看登录失败的用户名</li>
</ol>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mysql/</span>error.log | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;Access denied for user&quot;</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;using password: YES&quot;</span> | awk -F <span class="hljs-string">&quot;&#x27;&quot;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="hljs-keyword">sort</span> | uniq -c | <span class="hljs-keyword">sort</span> -nr<br></code></pre></td></tr></table></figure>

<ol>
<li>查看登录失败的 IP 及次数</li>
</ol>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mysql/</span>error.log | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;Access denied for user&quot;</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;using password: YES&quot;</span> | awk -F <span class="hljs-string">&quot;&#x27;&quot;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="hljs-keyword">sort</span>| uniq | <span class="hljs-keyword">while</span> <span class="hljs-keyword">read</span> line;<span class="hljs-keyword">do</span> echo $line;cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mysql/</span>error.log | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;Access denied for user&quot;</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;using password&quot;</span> | awk -F <span class="hljs-string">&quot;&#x27;&quot;</span> <span class="hljs-string">&#x27;&#123;print $4&#125;&#x27;</span> | <span class="hljs-keyword">sort</span> | uniq -c | <span class="hljs-keyword">sort</span> -nr; done<br></code></pre></td></tr></table></figure>

<h2 id="FTP-暴力破解"><a href="#FTP-暴力破解" class="headerlink" title="FTP 暴力破解"></a><strong>FTP 暴力破解</strong></h2><ol>
<li>查看网络连接（如果有爆破会有大量的 ESTABLISHED 状态和 TIME WAIT 状态的网络连接）</li>
</ol>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">netstat -pantu</span><br></code></pre></td></tr></table></figure>

<ol>
<li>查看最近的一个 ftp 会话（也可以用 ftpwho 查找）</li>
</ol>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-keyword">last</span> -w -t<br></code></pre></td></tr></table></figure>

<ol>
<li>查找日志</li>
</ol>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">cat</span> /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/vsftpd.<span class="hljs-keyword">log</span>   具体的位置可能不太一样，需要自己查找<br></code></pre></td></tr></table></figure>

<ol>
<li>查找登录失败的账号</li>
</ol>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">cat /<span class="hljs-keyword">var</span>/<span class="hljs-built_in">log</span>/vsftpd.<span class="hljs-built_in">log</span> | grep FAIL | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;[&quot;</span> -f <span class="hljs-number">3</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;]&quot;</span> -f <span class="hljs-number">1</span> | <span class="hljs-built_in">sort</span> | uniq -c | <span class="hljs-built_in">sort</span> -nr<br></code></pre></td></tr></table></figure>

<ol>
<li>查找登录失败的 IP</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/vsftpd.log | grep FAIL | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;[&quot;</span> -f 3 | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;]&quot;</span> -f 1 | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> line;<span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> <span class="hljs-variable">$line</span>;<span class="hljs-built_in">cat</span> /var/log/vsftpd.log | grep <span class="hljs-variable">$line</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;:&quot;</span> -f 7 | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27;&quot;&#x27;</span> -f 1 | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>

<ol>
<li>FTP 服务加固<br>禁用 anonymous 和 ftp 两个账号<br>使用 SSL 加密 FTP<br>安装 fail2ban 来进行防御</li>
</ol>
<h2 id="Redis-未授权暴力破解"><a href="#Redis-未授权暴力破解" class="headerlink" title="Redis 未授权暴力破解"></a><strong>Redis 未授权暴力破解</strong></h2><p>将 redis.conf 中的 requirepass 前的注释打开，并且设置一个复杂密码</p>
<p>缩减开放端口，建议仅在本机 127.0.0.1 使用</p>
<p>配置完成后需要重启来生效</p>
<ul>
<li>只有手动设置 logfile 才能保存日志，默认不设置默认的日志级别 notice 是不会记录登录、执行指令、退出的。</li>
<li>loglevel 设置为 verbose 或者 debug 才会记录登录主机</li>
<li>执行的指令 <code>info，set</code> 等即使 loglevel 是 debug 级别也不会记录，但是会记录我们设置了多少个 key， 具体 key 名称以及内容不会记录</li>
</ul>
<p><strong>虽然如此，但是失败成功的登录日志都是一样的……</strong><br><strong>没办法区分是不是攻击行为，只能问有没有人那个时候登过了</strong></p>
<h2 id="MongoDB-暴力破解"><a href="#MongoDB-暴力破解" class="headerlink" title="MongoDB 暴力破解"></a><strong>MongoDB 暴力破解</strong></h2><p>默认配置文件位置为 &#x2F;etc&#x2F;mongodb.conf</p>
<p>默认的的日志位置为 &#x2F;var&#x2F;og&#x2F;mongodb&#x2F;mongodb.log</p>
<p>打开 verbose 后能看到大量的 failed 事件</p>
<p>在&#x2F;var&#x2F;log&#x2F;mongodb&#x2F;mongodb.log 查看</p>
<ol>
<li>登录失败的账户</li>
</ol>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mongodb/m</span>ongodb.log | <span class="hljs-keyword">grep</span> -v <span class="hljs-string">&quot;UserNotFound&quot;</span>|<span class="hljs-keyword">grep</span> failed | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span> | <span class="hljs-keyword">sort</span>|uniq -c|<span class="hljs-keyword">sort</span> -nr<br></code></pre></td></tr></table></figure>

<ol>
<li>登录所有账户失败的 IP 及次数</li>
</ol>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mongodb/m</span>ongodb.log | <span class="hljs-keyword">grep</span> -v <span class="hljs-string">&quot;UserNotFound&quot;</span>|<span class="hljs-keyword">grep</span> failed | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span> |<span class="hljs-keyword">sort</span> | uniq | <span class="hljs-keyword">while</span> <span class="hljs-keyword">read</span> line;<span class="hljs-keyword">do</span> echo $line;cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mongodb/m</span>ongodb.log |<span class="hljs-keyword">grep</span> -v <span class="hljs-string">&quot;UserNotFound&quot;</span> | <span class="hljs-keyword">grep</span> failed | <span class="hljs-keyword">grep</span> $line | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $14&#125;&#x27;</span> | cut -d <span class="hljs-string">&quot;:&quot;</span> -f <span class="hljs-number">1</span> | <span class="hljs-keyword">sort</span> | uniq -c | <span class="hljs-keyword">sort</span> -nr; done<br></code></pre></td></tr></table></figure>

<ol>
<li>不存在账户的爆破事件</li>
</ol>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mongodb/m</span>ongodb.log | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;UserNotFound&quot;</span>|<span class="hljs-keyword">grep</span> failed | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span> |<span class="hljs-keyword">sort</span> | uniq | <span class="hljs-keyword">while</span> <span class="hljs-keyword">read</span> line;<span class="hljs-keyword">do</span> echo $line;cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mongodb/m</span>ongodb.log |<span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;UserNotFound&quot;</span> | <span class="hljs-keyword">grep</span> failed | <span class="hljs-keyword">grep</span> $line | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $14&#125;&#x27;</span> | cut -d <span class="hljs-string">&quot;:&quot;</span> -f <span class="hljs-number">1</span> | <span class="hljs-keyword">sort</span> | uniq -c | <span class="hljs-keyword">sort</span> -nr; done<br></code></pre></td></tr></table></figure>

<h2 id="SMTP-暴力破解"><a href="#SMTP-暴力破解" class="headerlink" title="SMTP 暴力破解"></a><strong>SMTP 暴力破解</strong></h2><p>SMTP 负责发，POP3、IMAP 负责收，POP3 协议客户端收到邮件，服务器端就会将其删除，除非有特殊的配置。</p>
<p>IMAP 则弥补了这一缺陷，客户端该收收，服务端还给你保存着，同时你在客户端的各种配置操作都会在服务器上进行同步</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">验证失败的账户IP<br><span class="hljs-keyword">cat</span> /var/<span class="hljs-built_in">log</span>/mail.<span class="hljs-built_in">log</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;authentication failed&quot;</span> | <span class="hljs-keyword">grep</span> -Po <span class="hljs-string">&#x27;(1\d&#123;2&#125;|2[0-4]\d|25[0-5]|</span><br></code></pre></td></tr></table></figure>

<h1 id="善后处理"><a href="#善后处理" class="headerlink" title="善后处理"></a>善后处理</h1><h2 id="杀死进程"><a href="#杀死进程" class="headerlink" title="杀死进程"></a><strong>杀死进程</strong></h2><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mel">top d1   <span class="hljs-comment">//运行top命令后，键入大写字母P按cpu排序</span><br>ps aux | <span class="hljs-keyword">sort</span> -k4nr   <span class="hljs-comment">//运行top命令后，键入大写字母M按内存排序</span><br><span class="hljs-keyword">ls</span> -la /<span class="hljs-keyword">proc</span>/$pid/exe   <span class="hljs-comment">//查找进程文件</span><br>strace -tt  -T -e  <span class="hljs-keyword">trace</span>=all  -p $pid   <span class="hljs-comment">//跟踪进程运行</span><br>lsof -p $pid   <span class="hljs-comment">//进程打开的文件</span><br>netstat -anltp | grep $pid   <span class="hljs-comment">//查看进程端口情况</span><br></code></pre></td></tr></table></figure>

<h2 id="查看账号"><a href="#查看账号" class="headerlink" title="查看账号"></a><strong>查看账号</strong></h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs stata">awk -F <span class="hljs-string">&quot;:&quot;</span> &#x27;<br><span class="hljs-variable">$3</span>==0&#123;<span class="hljs-keyword">print</span> $<br>1&#125;&#x27; /etc/passwd   <span class="hljs-comment">//查看特权用户</span><br>awk &#x27;/\<br><span class="hljs-variable">$1</span>|\$<br>6/&#123;<span class="hljs-keyword">print</span> <span class="hljs-variable">$1&#125;</span>&#x27; /etc/shadow   <span class="hljs-comment">//可远程登录的账号信息</span><br><span class="hljs-keyword">cat</span> /etc/sudoers | grep -v <span class="hljs-string">&quot;^#\|^$&quot;</span> | grep <span class="hljs-string">&quot;ALL=(ALL)&quot;</span>   <span class="hljs-comment">//sudo的账号</span><br>w   <span class="hljs-comment">//当前用户及其行为</span><br>lastlog   <span class="hljs-comment">//所有用户最后登录时间</span><br>last   <span class="hljs-comment">//所有用户关键信息</span><br>grep <span class="hljs-string">&quot;Accepted &quot;</span> /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/secure* | awk &#x27;&#123;<span class="hljs-keyword">print</span> <br><span class="hljs-variable">$1</span>,$<br>2,<br><span class="hljs-variable">$3</span>,$<br>9,<span class="hljs-variable">$11&#125;</span>&#x27;   <span class="hljs-comment">//成功登录日期、用户名及ip</span><br><span class="hljs-comment">//查看试图爆破主机的ip</span><br>grep refused /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/secure* | awk &#123;&#x27;<span class="hljs-keyword">print</span> <span class="hljs-variable">$9</span>&#x27;&#125; | <span class="hljs-keyword">sort</span> | uniq -c |<span class="hljs-keyword">sort</span> -nr | <span class="hljs-keyword">more</span><br>grep <span class="hljs-string">&quot;Failed password&quot;</span> /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/secure* | grep -<span class="hljs-keyword">E</span> -o <span class="hljs-string">&quot;(([0-9]&#123;1,3&#125;)\.([0-9]&#123;1,3&#125;)\.([0-9]&#123;1,3&#125;)\.([0-9]&#123;1,3&#125;))&quot;</span> | uniq -c <br>grep <span class="hljs-string">&quot;Failed password for root&quot;</span> /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/secure | awk &#x27;&#123;<span class="hljs-keyword">print</span> <span class="hljs-variable">$11&#125;</span>&#x27; | <span class="hljs-keyword">sort</span>   <span class="hljs-comment">//查看爆破root的ip</span><br>grep <span class="hljs-string">&quot;Failed password&quot;</span> /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/secure | awk &#123;&#x27;<span class="hljs-keyword">print</span> <span class="hljs-variable">$9</span>&#x27;&#125; | <span class="hljs-keyword">sort</span> | uniq -c | <span class="hljs-keyword">sort</span> -nr   <span class="hljs-comment">//查看爆破的用户名字典</span><br></code></pre></td></tr></table></figure>

<h2 id="锁定目录"><a href="#锁定目录" class="headerlink" title="锁定目录"></a><strong>锁定目录</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 000 /usr/bin/风险目录<br>chattr +i /usr/bin<br>chattr +i /bin<br>chattr +i /tmp<br></code></pre></td></tr></table></figure>

<h2 id="检查异常文件"><a href="#检查异常文件" class="headerlink" title="检查异常文件"></a><strong>检查异常文件</strong></h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk">【检查特权文件】<br>find <span class="hljs-regexp">/ -perm /</span><span class="hljs-number">6000</span><br>find <span class="hljs-regexp">/ -perm /</span><span class="hljs-number">4000</span><br>find <span class="hljs-regexp">/ -perm /</span><span class="hljs-number">2000</span><br>【检查corn文件】<br><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/cron/</span>*<br><span class="hljs-regexp">/etc/</span>crontab <br><span class="hljs-regexp">/etc/</span>cron.d/* <br><span class="hljs-regexp">/etc/</span>cron.daily/*<br><span class="hljs-regexp">/etc/</span>cron.hourly/* <br><span class="hljs-regexp">/etc/</span>cron.monthly/* <br><span class="hljs-regexp">/etc/</span>cron.weekly/ <br><span class="hljs-regexp">/etc/</span>anacrontab     <br><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/anacron/</span>*<br>【最近被修改的系统文件】<br>find <span class="hljs-regexp">/etc/</span> <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/ /u</span>sr<span class="hljs-regexp">/sbin/</span> <span class="hljs-regexp">/bin/</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>  -type f -mtime -T | xargs ls -la<br>【被替换的命令/动态链接库劫持】<br>echo <span class="hljs-variable">$LD_PRELOAD</span><br>echo <span class="hljs-variable">$LD_LIBRARY_PATH</span><br>注：基本上上面两个命令回显是空白的，如果有回显大概率是被劫持<br>ls -alt <span class="hljs-regexp">/usr/</span>bin <span class="hljs-regexp">/usr/</span>sbin <span class="hljs-regexp">/bin /u</span>sr<span class="hljs-regexp">/local/</span>bin<br>rpm -Va&gt;rpm.log<br></code></pre></td></tr></table></figure>

<h2 id="删除计划任务等"><a href="#删除计划任务等" class="headerlink" title="删除计划任务等"></a><strong>删除计划任务等</strong></h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">rm -f <span class="hljs-regexp">/etc/i</span>nit.d/风险目录<br>rm -f <span class="hljs-regexp">/etc/</span>rc<span class="hljs-comment">#.d/木马连接文件</span><br>cat <span class="hljs-regexp">/etc/</span>rc.local   <span class="hljs-regexp">//</span>开机启动项<br>chkconfig --list   <span class="hljs-regexp">//</span>开机启动项<br>注意：建议使用vim查看，cat有可能显示不全<br></code></pre></td></tr></table></figure>

<h2 id="rootkit-查杀"><a href="#rootkit-查杀" class="headerlink" title="rootkit 查杀"></a><strong>rootkit 查杀</strong></h2><p>rootkit 主要有两种类型：文件级别和内核级别。<br>文件级别的 rootkit: 一般是通过程序漏洞或者系统漏洞进入系统后，通过修改系统的重要文件来达到隐藏自己的目的。<br>内核级 rootkit: 是比文件级 rootkit 更高级的一种入侵方式，它可以使攻击者获得对系统底层的完全控制权，此时攻击者可以修改系统内核，进而截获运行程序向内核提交的命令，并将其重定向到入侵者所选择的程序并运行此程序。内核级 rootkit 主要依附在内核上，它并不对系统文件做任何修改。以防范为主。<br><strong>查杀工具：</strong><br><a target="_blank" rel="noopener" href="http://www.chkrootkit.org/">chkrootkit </a>、<a target="_blank" rel="noopener" href="http://rkhunter.sourceforge.net/"> rkhunter </a>、<a target="_blank" rel="noopener" href="http://www.clamav.net/download.html"> ClamAV</a></p>
<h2 id="其它检查方面"><a href="#其它检查方面" class="headerlink" title="其它检查方面"></a><strong>其它检查方面</strong></h2><ul>
<li>BASH 内置命令</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">compgen -<span class="hljs-selector-tag">b</span><br></code></pre></td></tr></table></figure>

<ul>
<li>BASH 函数</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell">compgen <span class="hljs-operator">-f</span><br>unset <span class="hljs-operator">-f</span> functionName<br></code></pre></td></tr></table></figure>

<ul>
<li>环境变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">env</span><br><span class="hljs-built_in">set</span><br><span class="hljs-built_in">export</span><br><span class="hljs-built_in">cat</span> /proc/<span class="hljs-variable">$PID</span>/environ<br><span class="hljs-built_in">declare</span><br></code></pre></td></tr></table></figure>

<ul>
<li>SSH key</li>
<li>SSH config 文件</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/etc/</span>ssh<span class="hljs-regexp">/ssh_config 和 ~/</span>.ssh/config将<br>LocalCommand 和 ProxyCommand 参数封禁<br></code></pre></td></tr></table></figure>

<ul>
<li>alias 命令替换</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">alias 命令的功能是为命令设置别名<br>alert   <span class="hljs-regexp">//</span>检查是否存在替换<br>unalias alert   <span class="hljs-regexp">//</span>删除别名<br></code></pre></td></tr></table></figure>

<ul>
<li>DNS 配置文件</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/etc/</span>resolv.conf<br></code></pre></td></tr></table></figure>

<ul>
<li>禁止 ptrace_scope 操作</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/kernel/y</span>ama/ptrace_scope<br></code></pre></td></tr></table></figure>

<ul>
<li>ASLR</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/kernel/</span>randomize_va_space   <span class="hljs-regexp">//</span>调成<span class="hljs-number">2</span>减缓溢出攻击<br></code></pre></td></tr></table></figure>

<ul>
<li>capabilities</li>
</ul>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arcade">getcap -r / <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span>   <span class="hljs-comment">//查看对权限的默认情况</span><br>setcap   <span class="hljs-comment">//重新设置权限</span><br></code></pre></td></tr></table></figure>

<ul>
<li>iptables 端口复用</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo iptables -L   <span class="hljs-regexp">//</span>查看默认情况<br></code></pre></td></tr></table></figure>

<ul>
<li>密码填充检查</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/passwd | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;:&quot;</span> -f 2 | grep -v <span class="hljs-string">&quot;x   //默认情况应该是空的</span><br></code></pre></td></tr></table></figure>

<ul>
<li>服务检查</li>
</ul>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">sudo</span> <span class="hljs-string">systemctl</span> <span class="hljs-built_in">list-units</span> <span class="hljs-built_in">--type=service</span> <span class="hljs-built_in">--state=running</span>   //正在运行的服务<br><span class="hljs-string">systemctl</span> <span class="hljs-string">status</span> <span class="hljs-string">xxx</span>.<span class="hljs-string">service</span>   //查看单一服务进程状态<br><span class="hljs-string">systemctl</span> <span class="hljs-string">cat</span> <span class="hljs-string">xxx</span>.<span class="hljs-string">service</span>   //获取服务配置文件<br><span class="hljs-string">systemctl</span> <span class="hljs-string">cat</span><br></code></pre></td></tr></table></figure>

<ul>
<li>MOTD</li>
</ul>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xquery">是Linux中发送问候消息的功能，一般在我们登录服务器后显示<br>每次任意用户登录时都会触发 motd 服务的功能,这个功能的脚本几乎都是使用<span class="hljs-built_in"> root</span> 权限来启动的，所以很适合用来做后门<br></code></pre></td></tr></table></figure>

<ul>
<li>进程启动文件</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">恶意程序执行后，可能会删除本地文件，但是该文件已经被进程加载，可以通过遍历这种情况来排查恶意程序<br>sudo lsof | <span class="hljs-keyword">grep</span> deleted<br>sudo ls -al <span class="hljs-regexp">/proc/</span>*<span class="hljs-regexp">/exe 2&gt;/</span>dev<span class="hljs-regexp">/null | grep deleted   /</span><span class="hljs-regexp">/建议使用这一个命令</span><br></code></pre></td></tr></table></figure>

<ul>
<li>检查系统及应用程序配置文件</li>
<li>sudo 配置文件检查</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/etc/</span>sudo.conf<br><span class="hljs-regexp">/etc/</span>sudoers<br><span class="hljs-regexp">/etc/</span>sudoers.d/<br></code></pre></td></tr></table></figure>

<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">第三方GPG密钥检查<br><br>sudo apt-key list<br>具体存储⽬录为 /etc/apt/<span class="hljs-keyword">trusted</span>.gpg.d/<br></code></pre></td></tr></table></figure>

<p>gpg –quiet –show-keys &#x2F;etc&#x2F;pki&#x2F;rpm-gpg&#x2F;*</p>
<p>具体存储⽬录为 &#x2F;etc&#x2F;pki&#x2F;rpm-gpg&#x2F;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>

<h1 id="靶场"><a href="#靶场" class="headerlink" title="靶场"></a>靶场</h1><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-built_in">find</span> / -<span class="hljs-built_in">type</span> f -<span class="hljs-built_in">name</span> <span class="hljs-string">&quot;.*&quot;</span> -mtime -<span class="hljs-number">20</span> 寻找<span class="hljs-number">20</span>天内修改的隐藏文件（mmin也可以）<br><span class="hljs-built_in">find</span> . -<span class="hljs-built_in">type</span> f -<span class="hljs-built_in">name</span> <span class="hljs-string">&quot;*.php&quot;</span> -<span class="hljs-built_in">exec</span> grep -Hn <span class="hljs-string">&#x27;eval&#x27;</span> &#123;&#125; \;<br></code></pre></td></tr></table></figure>

<p>打印出包含”eval”字符串的行及其所在的文件名（-Hn 选项）。{}代表 find 命令找到的文件名，;表示结束-exec 参数。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cat</span> access.<span class="hljs-built_in">log</span>.<span class="hljs-number">1</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;/index.php&quot;</span> | wc -<span class="hljs-keyword">l</span><br></code></pre></td></tr></table></figure>

<p>Wc -l 统计行数</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">cat access.log.1 |<span class="hljs-string"> grep xx&quot; </span>|<span class="hljs-string"> awk &#x27;&#123;print $x&#125;&#x27; </span>|<span class="hljs-string"> sort </span>|<span class="hljs-string"> uniq -c </span>|<span class="hljs-string"> sort -nr </span>|<span class="hljs-string"> head -n 10</span><br></code></pre></td></tr></table></figure>

<p>head 可以改成 more</p>
<p>sort 排序后 uniq -c 去除重复并且统计次数，最后 sort -n 按数字-r 降序排序</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">查看进程<br>ps -<span class="hljs-selector-tag">A</span> <br>ps aux<br><span class="hljs-attribute">top</span><br></code></pre></td></tr></table></figure>

<p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/GSxkb1iVNo7s3dxL6nkcKAaonYi.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/H3efbvKvloVa4XxGDHWcNcdAnyb.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/JDrebv3Vvo1Gz9xyp6jcOMnJnMf.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p>利用-A -B -C 显示匹配字符串上下文 -rn 查找存在响应字符串的文件</p>
<p>awk ‘匹配规则 {操作}’ 文件</p>
<p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/KzL5bLE0qoJCDoxIYzwcyF5mnQb.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h2 id="linux-挖矿"><a href="#linux-挖矿" class="headerlink" title="linux-挖矿"></a>linux-挖矿</h2><p>netstat -anplt 发现异常外联</p>
<p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/CvxDbdbYoo7e7xxC8xXcx2RSnid.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/G27ob7ITvoTlMCx6wkfc0X0Unzc.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h1 id="溯源"><a href="#溯源" class="headerlink" title="溯源"></a>溯源</h1><h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>溯源思路：</p>
<ol>
<li><p>首先通过系统日志、安全设备截获攻击包等从中分析出攻击者的 ip 和攻击方式，通过 webshell 或者木马去微步分析，</p>
</li>
<li><p>或者去安恒威胁情报中心进行 ip 检测分析，是不是云服务器，基站等，如果是云服务器的话可以直接反渗透，看看开放端口，域名，whois 等进行判断，</p>
</li>
<li><p>获取姓名电话等丢社工库看看能不能找到更多信息然后收工</p>
</li>
</ol>
<p>针对国外 IP 的溯源方法：</p>
<ol>
<li>使用网络安全工具进行溯源：可以使用网络安全工具，如 traceroute、ping 等命令，对目标 IP 进行探测和跟踪。这些工具可以显示出攻击流量经过的路由器、网关和 ISP 等信息，帮助我们了解攻击流量的来源地点。</li>
<li>查找域名信息：通过 WHOIS 查询工具查询目标域名的注册信息，包括注册人、注册机构、联系方式等信息，可以从中了解到攻击来源的大致位置。</li>
<li>联系当地 ISP：如果攻击者使用的是公共网络，如酒店、咖啡厅、机场等，可以联系当地 ISP，寻求协助获取攻击来源的信息。</li>
</ol>
<h2 id="溯源反制"><a href="#溯源反制" class="headerlink" title="溯源反制"></a>溯源反制</h2><p>主要是通过混淆和伪装攻击流量，防止攻击者获取真实的攻击来源和行为信息。具体操作包括：<br>    1.使用代理服务器：通过使用代理服务器，可以改变攻击流量的来源 IP 地址，使得攻击者无法追踪真实的攻击来源。<br>    2.使用 VPN 技术：VPN 技术可以在公网上建立一个私有网络，加密传输数据流量，从而防止攻击者获取敏感信息。<br>    3.使用匿名浏览器：匿名浏览器可以隐藏用户真实的 IP 地址和浏览痕迹，使得攻击者无法追踪用户的真实身份和行为。<br>    4.使用虚假数据：在攻击流量中混入虚假的数据，如虚假的 IP 地址、协议和端口等信息，可以混淆攻击者的追踪。</p>
<h1 id="内存马"><a href="#内存马" class="headerlink" title="内存马"></a>内存马</h1><h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><p>注入型内存马：通过利用漏洞将恶意代码注入到正常进程中，从而在内存中运行。<br>自执行型内存马：将恶意代码写入自启动项，启动后自动运行。<br>进程注入型内存马：利用进程注入技术，在受感染进程的内存中运行恶意代码。<br>Hook 型内存马：利用 Windows API 的 Hook 机制，修改进程中的关键函数，从而运行恶意代码。<br>要判断内存马的类型，可以使用反病毒软件或专门的安全工具对受感染主机进行扫描和分析。一般来说，不同类型的内存马会留下不同的痕迹和特征，比如某些进程的不正常行为、异常的网络连接等等。</p>
<h2 id="防护-1"><a href="#防护-1" class="headerlink" title="防护"></a>防护</h2><p>注入型内存马：修复漏洞、升级软件，加强网络安全防护等方法来预防类似攻击；对已经感染的主机，可以通过杀掉受感染进程或卸载恶意程序等方式来清除内存马。<br>自执行型内存马：可以通过清理自启动项、卸载恶意程序等方式来清除内存马。<br>进程注入型内存马：可以通过杀掉受感染进程或卸载恶意程序等方式来清除内存马。<br>Hook 型内存马：可以通过还原 Hook、修复关键函数、杀掉受感染进程或卸载恶意程序等方式来清除内存马。</p>
<h1 id="基线检查"><a href="#基线检查" class="headerlink" title="基线检查"></a>基线检查</h1><h2 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h2><h3 id="账号管理和授权"><a href="#账号管理和授权" class="headerlink" title="账号管理和授权"></a>账号管理和授权</h3><ul>
<li>检查特殊账号，是否存在空密码的账户和root权限账户</li>
<li>禁用或删除无用账号</li>
<li>添加口令策略:<code>/etc/login.defs</code>修改配置文件，设置过期时间、连续认证失败次数</li>
<li>禁止root远程登录，限制root用户直接登录。</li>
<li>检查su权限。<code>vi /etc/pam.d/su</code>添加<code>auth required pam_wheel.so group=test</code></li>
</ul>
<h3 id="服务-1"><a href="#服务-1" class="headerlink" title="服务"></a>服务</h3><ul>
<li>关闭不必要的服务</li>
<li>SSH服务安全<ul>
<li>不允许root账号直接登录系统，<code>PermitRootLogin=no</code></li>
<li>修改SSH使用的协议版本为2</li>
<li>修改允许密码错误次数（默认6次），<code>MaxAuthTries=3</code></li>
</ul>
</li>
</ul>
<h3 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h3><ul>
<li>设置umask值 <code>vi /etc/profile</code> 添加行 <code>umask 027</code></li>
<li>设置登录超时 <code>vi /etc/profile</code> 修改配置文件，将以 <code>TMOUT=</code> 开头的行注释，设置为 <code>TMOUT=180</code></li>
</ul>
<h3 id="日志-2"><a href="#日志-2" class="headerlink" title="日志"></a>日志</h3><ul>
<li>启用syslogd日志，配置日志目录权限，或者设置日志服务器</li>
<li>记录所有用户的登录和操作日志，通过脚本代码实现记录所有用户的登录操作日志，防止出现安全事件后无据可查。<a target="_blank" rel="noopener" href="https://www.alibabacloud.com/help/zh/faq-detail/49809.htm">https://www.alibabacloud.com/help/zh/faq-detail/49809.htm</a></li>
</ul>
<h3 id="IP协议安全要求"><a href="#IP协议安全要求" class="headerlink" title="IP协议安全要求"></a>IP协议安全要求</h3><ul>
<li>远程登录取消telnet采用ssh</li>
<li>设置&#x2F;etc&#x2F;hosts.allow和deny</li>
<li>禁止ICMP重定向</li>
<li>禁止源路由转发</li>
<li>防ssh破解，iptables(对已经建立的所有链接都放行，限制每分钟连接ssh的次数)+denyhost(添加ip拒绝访问)</li>
</ul>
<h2 id="中间件基线规范（APACHE）"><a href="#中间件基线规范（APACHE）" class="headerlink" title="中间件基线规范（APACHE）"></a>中间件基线规范（APACHE）</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.alibabacloud.com/help/zh/faq-detail/52981.htm">https://www.alibabacloud.com/help/zh/faq-detail/52981.htm</a></p>
</blockquote>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul>
<li>账号</li>
<li>授权</li>
<li>日志</li>
<li>session过期时间（防ddos</li>
<li>绑定监听地址</li>
</ul>
<h3 id="禁止"><a href="#禁止" class="headerlink" title="禁止"></a>禁止</h3><ul>
<li>目录权限</li>
<li>访问外部文件</li>
<li>CGI</li>
<li>非法HTTP方法（PUT DELETE）</li>
</ul>
<h3 id="隐藏"><a href="#隐藏" class="headerlink" title="隐藏"></a>隐藏</h3><ul>
<li>服务版本号</li>
<li>重定向错误页面</li>
</ul>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><ul>
<li>配置文件</li>
<li>默认安装的无用文件</li>
</ul>
<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a><strong>补充</strong></h1><h2 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a><strong>守护进程</strong></h2><p>守护进程是什么？ 其他进程都是在用户登录或运行程序时创建，在运行结束或用户注销时终止，但系统服务进程（守护进程）不受用户登录注销的影响，它们一直在运行着。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 守护进程的本质是什么？ </span><br>守护进程的本职就是孤儿进程，该进程自成会话，自成进程组，一般守护进程与终端无关；（即：<span class="hljs-attribute">pid</span>=sid=gid） <br>后台进程受用户登录注销的影响，而守护进程不受用户登录和注销的影响。但是它们都受关机的影响。<br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 守护进程有什么特点？ </span><br>没有控制终端，终端名设置为？号 <br>父进程不是用户创建的进程，一般由init进程或者systemd（<span class="hljs-attribute">pid</span>=1）的进程为父进程 <br>进程名字通常以字母 d 结束 <br>工作目录为/（根），主要是为了防止占用磁盘导致无法卸载磁盘 <br>以kthreadd内核进程创建的守护进程以kthreadd为父进程<br></code></pre></td></tr></table></figure>

<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 守护进程如何设置？ </span><br>执行一个<span class="hljs-keyword">fork</span>()，之后父进程退出，子进程继续执行。 <br>子进程调用setsid()开启一个新回话并释放它与控制终端之间的所有关联关系。 <br>在setsid()调用之后执行第二个<span class="hljs-keyword">fork</span>()，让父进程退出并让孙进程继续执行。确保了子进程不会成为会话组长。 （根据System V中获取终端的规则，进程永远不会重新请求一个控制终端。多一个<span class="hljs-keyword">fork</span>()调用不会带来任何坏处。） <br>使用 <span class="hljs-keyword">umask</span>(<span class="hljs-number">0</span>); 清除进程的<span class="hljs-keyword">umask</span>以确保当daemon创建文件和目录时拥有所需的权限。 <span class="hljs-number">5</span>. 修改进程的当前工作目录，通常会改为根目录（/）。 <span class="hljs-number">6</span>. 关闭daemon从其父进程继承而来的所有打开着的文件描述符。<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># 守护进程如何删除？ </span><br>首先<span class="hljs-built_in">ps</span> axj | grep 守护进程名字，找到相应的守护进程，然后使用<span class="hljs-built_in">kill</span> <span class="hljs-literal">-9</span> 守护进程名杀掉；<br>利用<span class="hljs-built_in">ps</span> <span class="hljs-literal">-ef</span>命令查找相应的守护进程，再用<span class="hljs-built_in">kill</span> <span class="hljs-literal">-9</span>命令将其杀死；<br>创建shell脚本对进程的启动、关闭、重启进行自动管理。 注：<span class="hljs-built_in">kill</span> <span class="hljs-literal">-9</span> <span class="hljs-literal">-pid</span>   （杀掉进程组）<br></code></pre></td></tr></table></figure>

<h3 id="screen-的原理"><a href="#screen-的原理" class="headerlink" title="screen 的原理"></a><strong>screen 的原理</strong></h3><ul>
<li>当用户启动 Screen 时，它会创建一个守护进程作为后台进程，并与用户终端会话（称为控制终端）分离。</li>
<li>控制终端不再直接处理用户输入和输出，而是由 Screen 守护进程负责接收和处理。</li>
<li>守护进程通过与 Unix 域套接字进行通信，与控制终端保持连接。</li>
<li>用户在控制终端中输入的命令会被发送到守护进程，并由守护进程解析和执行。</li>
<li>守护进程还负责从虚拟终端读取输出内容，并将其发送回控制终端进行显示。</li>
</ul>
<p>通过这种方式，Screen 实现了在控制终端与守护进程之间的交互，并通过守护进程来管理多个虚拟终端、处理窗口切换、保存会话状态等功能。</p>
<p>需要注意的是，虽然 Screen 的守护进程在后台运行，但用户仍然可以通过重新连接到控制终端来恢复与之前会话的交互，即使之前的 SSH 连接断开或终端关闭。这是 Screen 的一个重要特性，允许用户在断开连接后恢复他们的工作环境。</p>
<h3 id="恢复守护进程会话的交互"><a href="#恢复守护进程会话的交互" class="headerlink" title="恢复守护进程会话的交互"></a><strong>恢复守护进程会话的交互</strong></h3><p>可以使用 <code>nohup</code> 命令启动一个守护进程，并将输出重定向到文件中，例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup ./your_daemon &amp;<br></code></pre></td></tr></table></figure>

<p>通过这种方式启动的守护进程不会因为用户退出终端而停止运行。</p>
<p>当用户重新连接到控制终端时，可以使用 <code>jobs</code> 命令查看守护进程的状态，并使用 <code>fg</code> 命令将其调至前台，恢复与之前会话的交互。例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">jobs<br>fg %job_id<br></code></pre></td></tr></table></figure>

<p>其中，<code>job_id</code> 是守护进程的作业号，可以在 <code>jobs</code> 命令的输出中找到</p>
<h2 id="IDS-IPS"><a href="#IDS-IPS" class="headerlink" title="IDS&#x2F;IPS"></a>IDS&#x2F;IPS</h2><p>IDS（Intrusion Detection System）入侵检测系统</p>
<p>IPS (Intrusion Prevention System)  入侵防御系统</p>
<blockquote>
<p>与防火墙相似，IPS 内嵌部署到流量中。IPS 是一个主动的网络组件，会检查每个通过的数据包，并根据其配置和策略采取正确的补救措施。相反，IDS 是一个被动组件，通常不会内嵌部署，而是通过 SPAN 或 TAP 技术监控流量，然后发出通知</p>
</blockquote>
<h3 id="IPS-阻断"><a href="#IPS-阻断" class="headerlink" title="IPS 阻断"></a>IPS 阻断</h3>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%93%9D%E9%98%9F/" class="category-chain-item">蓝队</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E8%93%9D%E9%98%9F/" class="print-no-link">#蓝队</a>
      
        <a href="/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/" class="print-no-link">#应急响应</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>蓝队笔记</div>
      <div>http://example.com/2024/06/27/蓝队笔记/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>z2zQAQ</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年6月27日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" title="内网渗透">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">内网渗透</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/03/21/%E9%9D%B6%E5%9C%BA%E8%AE%B0%E5%BD%95/" title="靶场记录">
                        <span class="hidden-mobile">靶场记录</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>



  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/z2z_custom/custom.js"></script>
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/runtime.min.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<!-- hexo injector body_end start --><script src="/js/backgroundize.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/assets/tororo.model.json"},"display":{"position":"right","width":240,"height":480},"mobile":{"show":false},"react":{"opacityDefault":1,"opacityOnHover":1},"log":false,"tagMode":false});</script></body>
</html>



<!--动态线条背景-->
<script type="text/javascript"
color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>


<!-- 页面点击小红心，在末尾添加，避免找不到 -->
<script type="text/javascript" src="/js/click.js"></script>


